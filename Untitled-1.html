<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>African Elite Manager - Special CAN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Teko:wght@300..700&display=swap" rel="stylesheet">
    <!-- Design System via Tailwind CSS intégré -->
    <script src="https://cdn.tailwindcss.com"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    // On définit 'inter' et 'teko' pour les utiliser en classes Tailwind
                    'inter': ['"Inter"', 'sans-serif'],
                    'teko': ['"Teko"', 'sans-serif'],
                }
            }
        }
    }
</script>

    <style>



        :root {
            --color-bg: #0f172a;
            --primary: #f97316;
            --pitch-green: #1a4d2e;
            --pitch-line: rgba(255,255,255,0.18);
            --secondary: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --gold: #f59e0b;
        }

        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            font-size: 12px;
            height: 100vh;
            height: 100dvh;
        }

        .font-teko { font-family: 'Teko', sans-serif; }

        #app-container {
            max-width: 100%; margin: 0 auto;
            height: 100vh;
            height: 100dvh;
            background-color: var(--color-bg);
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            padding-top: env(safe-area-inset-top);
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* NOUVEAU : TEXTURE "CARBON FOOTBALL" */
        /* Un mélange de sombre, de carbone et d'une subtile grille rappelant les filets de but */
        .bg-carbon-foot {
            background-color: #0f172a;
            background-image:
                /* Effet de lumière "Projecteur" (Radial) */
                radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%),
                /* Texture Carbone */
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-size: 100% auto, 6px 6px; /* Taille fine pour le carbone */
            position: relative;
        }
        /* Ajout d'une fine maille par dessus (Pseudo-élément) pour l'effet "Jersey" */
        .bg-carbon-foot::after {
            content: "";
            position: absolute; inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px; /* Grille de points espacés */
            pointer-events: none;
            z-index: 0;
        }
  /* MISE À JOUR : TERRAIN NEXT-GEN */
        .pitch-container {
            background-color: #1a4d2e; /* Vert de base */
            /* Motif : Bandes de tonte + Texture subtile */
            background-image:
                /* Bandes horizontales (Tonte) */
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 40px,
                    rgba(0,0,0,0.08) 40px, /* Bande plus sombre */
                    rgba(0,0,0,0.08) 80px
                ),
                /* Bruit léger pour ne pas faire "plastique" */
                url('https://www.transparenttextures.com/patterns/grass.png');

            position: relative;
            height: 480px; width: 340px;
            border-radius: 12px; margin: 10px auto; overflow: hidden;
            border: 4px solid #14532d; /* Bordure sombre */

            /* ÉCLAIRAGE STADE : Ombres internes fortes sur les coins */
            box-shadow:
                inset 0 0 80px rgba(0,0,0,0.7), /* Vignette sombre */
                0 20px 50px rgba(0,0,0,0.5); /* Ombre portée externe */
            flex-shrink: 0;
        }
        .pitch-midline { position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--pitch-line); }
        .pitch-circle { position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 1px solid var(--pitch-line); border-radius: 50%; transform: translate(-50%, -50%); }
        .carbon-pattern {
    background-color: #0a0a0a;
    background-image:
        linear-gradient(45deg, #111 25%, transparent 25%),
        linear-gradient(-45deg, #111 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #111 75%),
        linear-gradient(-45deg, transparent 75%, #111 75%);
    background-size: 4px 4px;
}

.gold-glow {
    box-shadow: 0 0 30px rgba(245, 158, 11, 0.2);
    border: 1px solid rgba(245, 158, 11, 0.3);
}

.text-gold-gradient {
    background: linear-gradient(to bottom, #fde68a, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
        /* REMPLACER LE BLOC .player-card EXISTANT PAR CECI */
        .player-card {
            position: absolute; width: 50px; height: 78px;
            backdrop-filter: blur(4px);
            border-width: 1px;
            border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; z-index: 20;

            /* CORRECTION ICI : On autorise les éléments à dépasser (pour le badge) */
            overflow: visible;
        }
        /* --- SÉLECTEUR AVATAR MANAGER --- */
.manager-option {
    width: 70px; height: 70px;
    border-radius: 50%;
    border: 3px solid #334155; /* Gris foncé par défaut */
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #1e293b; /* Fond sombre */
    overflow: hidden;
    position: relative;
}

.manager-option:hover {
    transform: scale(1.1);
    border-color: #94a3b8;
}

.manager-option.selected {
    border-color: #f97316; /* Orange */
    box-shadow: 0 0 20px rgba(249, 115, 22, 0.6); /* Lueur orange */
    transform: scale(1.15);
    z-index: 10;
}

/* Badge "Check" quand sélectionné */
.manager-option.selected::after {
    content: "✔";
    position: absolute; bottom: 0; right: 0;
    background: #f97316; color: white;
    width: 20px; height: 20px;
    font-size: 12px; font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
}
/* --- CORRECTION : STYLE DES AVATARS JOUEURS --- */
.player-face {
    position: absolute !important;
    bottom: 22px !important; /* REMONTÉ pour ne pas cacher la barre d'énergie */
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 36px !important;
    height: 36px !important;
    z-index: 5 !important;   /* Derrière le texte (z-10) mais devant le fond */
    display: block !important;
    opacity: 1 !important;
    pointer-events: none;
    filter: drop-shadow(0 4px 2px rgba(0,0,0,0.4));
}

/* On s'assure que le survol fonctionne */
.player-card:hover .player-face {
    transform: translateX(-50%) scale(1.1) !important;
}

/* On s'assure que le texte reste au-dessus de l'image */
.card-ovr, .card-pos, .card-name, .card-age, .card-energy {
    position: relative;
    z-index: 10;
    text-shadow: 0 1px 2px rgba(0,0,0,0.8); /* Ombre pour lisibilité */
}

/* Petit effet de zoom sur l'image quand on survole la carte */
.player-card:hover .player-face {
    transform: translateX(-50%) scale(1.1);
}

/* Pour le banc de touche (mini avatar) */
.bench-face {
    width: 30px; height: 30px;
    border-radius: 50%;
    background: rgba(0,0,0,0.2);
    margin-right: 5px;
}

        /* On garde les effets de malus */
        .player-card.malus { border-color: #ef4444 !important; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); }
        .player-card.malus { border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); }
        .card-ovr { font-family: 'Teko', sans-serif; font-size: 20px; font-weight: 700; color: #f97316; line-height: 1; }
        .card-pos { font-size: 7px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: -1px; }
        .card-age { font-size: 6px; color: #475569; font-weight: 700; margin-bottom: 1px; }
        .card-energy { width: 75%; height: 2px; background: #334155; border-radius: 1px; margin-top: 2px; position: relative; overflow: hidden; }
        .energy-fill { height: 100%; transition: width 0.3s; }

        .card-name {
            width: 100%; background: rgba(0,0,0,0.85);
            padding: 2px 0; text-align: center; font-size: 7px;
            font-weight: 600; color: white; margin-top: auto;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;

            /* CORRECTION : Comme on a retiré l'overflow hidden du parent,
               on doit arrondir le bas du nom manuellement pour qu'il épouse la carte */
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        .bench-item {
            min-width: 110px; height: 55px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 10px;
            display: flex; align-items: center; gap: 12px;
            flex-shrink: 0; cursor: pointer; transition: 0.2s;
        }

        /* --- STYLES INFRASTRUCTURES --- */
        .infra-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            transition: 0.3s;
        }
        .infra-card:hover { background: rgba(30, 41, 59, 0.8); border-color: var(--primary); }

        /* --- SCROLLING TACTIQUE LIVE --- */
        #live-coach-overlay {
            position: absolute; inset: 0; z-index: 150;
            background: rgba(15, 23, 42, 0.99);
            backdrop-filter: blur(25px);
            display: none; flex-direction: column;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #live-coach-overlay.active { display: flex; }

        #ht-overlay {
            position: absolute; inset: 0; z-index: 180;
            background: rgba(0,0,0,0.95);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        #ht-overlay.active { display: flex; }

        .speech-btn {
            width: 100%; padding: 16px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; font-weight: bold; text-transform: uppercase; transition: 0.3s;
        }
        .speech-btn:hover { background: var(--primary); transform: scale(1.02); }

        .btn-nav.active { color: #f97316; border-top: 2px solid #f97316; background: rgba(249, 115, 22, 0.05); }
        .instruction-btn.active { background-color: #f97316; color: white; border-color: #fb923c; }

        .news-item { padding: 14px; background: rgba(30, 41, 59, 0.4); border-radius: 10px; border-left: 4px solid #f97316; margin-bottom: 10px; font-size: 11px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

      /* --- CORRECTION BUG BUT --- */
        #goal-overlay {
            position: absolute;
            inset: 0;
            z-index: 1000; /* Augmenté de 300 à 1000 pour être sûr d'être au-dessus de tout */
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: rgba(0,0,0,0.9); /* Un peu plus foncé pour mieux voir */
            pointer-events: none;
            transition: opacity 0.3s;
        }

        /* Ajout de !important pour forcer l'affichage */
        #goal-overlay.active {
            display: flex !important;
            animation: pulseGoal 0.5s ease-out;
        }

        @keyframes pulseGoal {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .stat-badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 10px; color: #94a3b8; }

        .tab-btn { padding: 8px 16px; border-bottom: 2px solid transparent; color: #64748b; font-weight: bold; font-size: 10px; text-transform: uppercase; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Correction Barre de Navigation Mobile */
        nav {
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(4rem + env(safe-area-inset-bottom)) !important;
        }

        /* Ajustement des zones de contenu pour ne pas être cachées par la nav */
        .view-section {
            padding-bottom: calc(6rem + env(safe-area-inset-bottom)) !important;
        }
        /* --- CSS POUR LE TUTORIEL INTERACTIF --- */
/* --- CSS POUR LE TUTORIEL INTERACTIF --- */
#tutorial-overlay {
    background: transparent !important; /* <--- MODIFICATION ICI : On force la transparence */
    pointer-events: none; /* Important pour cliquer au travers si besoin */
    transition: opacity 0.3s;
}

/* Classe ajoutée dynamiquement à l'élément ciblé */
.tuto-highlight {
    position: relative;
    z-index: 2010 !important; /* Au-dessus du backdrop (2000), mais SOUS le texte (2050) */
    box-shadow: 0 0 0 4px #f97316, 0 0 100px rgba(0,0,0,0.9) !important;
    background-color: #0f172a;
    pointer-events: none;
}

/* Flèche qui pointe l'élément (Animation) */
.tuto-arrow {
    position: absolute;
    z-index: 2020;
    font-size: 40px;
    color: #f97316;
    animation: bounceArrow 1s infinite;
    text-shadow: 0 4px 10px black;
}

@keyframes bounceArrow {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
   /* Ajoutez ceci à la fin de votre balise <style> */
.view-section.hidden {
    display: none !important;
}

        /* --- SPLASH SCREEN ANIMATIONS --- */
#splash-screen {
    position: fixed;
    inset: 0;
    z-index: 9999; /* Toujours au-dessus de tout */
    background: #0f172a;
    display: flex;
    flex-col: column;
    align-items: center;
    justify-content: center;
    transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1); /* Effet rideau fluide */
}

/* Animation de sortie (Le rideau monte) */
.splash-out {
    transform: translateY(-100%);
}

/* Animation Balle qui rebondit */
.bounce-ball {
    animation: bounce 1s infinite;
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

/* Animation Barre de chargement */
.loading-bar-fill {
    width: 0%;
    animation: loadProgress 2.5s ease-out forwards;
}
@keyframes loadProgress {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}
/* --- MERCATO CAROUSEL MOBILE --- */
.mercato-scroll {
    display: flex;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    gap: 1.5rem;
    padding: 0 1.5rem;
    height: 100%;
    align-items: center;
    /* Cache la barre de scroll */
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.mercato-scroll::-webkit-scrollbar { display: none; }

.mercato-card {
    /* Taille adaptée aux mobiles : 85% de la largeur, max 340px */
    width: 85vw;
    max-width: 340px;
    height: 65vh; /* Hauteur dynamique */
    min-height: 450px;
    flex-shrink: 0;
    scroll-snap-align: center;

    background: #1e293b;
    border-radius: 2rem;
    position: relative;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s;
}

.mercato-card.active-card {
    border-color: var(--primary);
    box-shadow: 0 0 30px rgba(249, 115, 22, 0.2);
}

/* Header de la carte (Image/Drapeau) */
.mercato-header {
    height: 40%;
    background: linear-gradient(to bottom, #0f172a, #1e293b);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

/* Corps de la carte */
.mercato-body {
    flex: 1;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: linear-gradient(to top, #0f172a 0%, #1e293b 100%);
}

.stat-pill {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    padding: 0.5rem 1rem;
    border-radius: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
    </style>
</head>

<body class="text-slate-200">
<div id="splash-screen">
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
    <div class="absolute top-0 right-0 w-64 h-64 bg-orange-500/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-0 w-64 h-64 bg-green-500/10 rounded-full blur-3xl"></div>

    <div class="relative z-10 flex flex-col items-center">
        <div class="w-24 h-24 bg-gradient-to-br from-orange-500 to-orange-700 rounded-3xl flex items-center justify-center border-4 border-slate-800 shadow-2xl mb-6 bounce-ball">
            <span class="font-teko text-6xl text-white italic font-bold">CIV</span>
        </div>

        <h1 class="font-teko text-6xl text-white uppercase italic leading-none mb-2 drop-shadow-lg tracking-tighter">
            African <span class="text-orange-500">Elite</span>
        </h1>
        <p class="text-[10px] text-slate-400 uppercase tracking-[0.3em] font-bold mb-12">Manager Edition 2026</p>

        <div class="w-48 h-1.5 bg-slate-800 rounded-full overflow-hidden border border-white/5 relative">
            <div class="loading-bar-fill h-full bg-gradient-to-r from-orange-600 to-yellow-400 shadow-[0_0_10px_rgba(249,115,22,0.8)]"></div>
        </div>

        <p class="text-[9px] text-slate-500 mt-2 font-mono animate-pulse">Chargement de la tactique...</p>
    </div>
</div>
<div id="app-container">

    <!-- HEADER -->
    <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-700 rounded-lg flex items-center justify-center border-2 border-slate-700 text-white font-teko font-bold text-xl shadow-lg italic">CIV</div>
            <div class="flex flex-col">
                <span id="header-manager-name" class="text-[10px] text-orange-500 font-bold uppercase tracking-widest leading-none">MANAGER INCONNU</span>
                <span class="text-xs font-bold text-white leading-tight" id="header-subtitle">SAISON 2026</span>
            </div>
        </div>
        <div class="flex gap-2">
            <div class="px-3 py-1 bg-slate-800 rounded-lg border border-slate-700 flex items-center gap-2">
                <span id="icon-coins-head"></span>
                <span class="font-teko text-lg text-yellow-100" id="budget-display">15.0 M€</span>
            </div>
            <button onclick="app.resetGame()" class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-lg border border-slate-700 text-slate-400" id="icon-refresh-head"></button>
        </div>
        <div id="team-selection-modal" class="absolute inset-0 z-[5000] bg-slate-950 flex flex-col items-center justify-center p-6 hidden">
            <div class="w-full max-w-6xl h-full flex flex-col">
                <div class="text-center shrink-0 mb-4">
                    <h1 class="font-teko text-6xl text-white uppercase italic leading-none mb-2">Choisissez votre Nation</h1>
                    <p class="text-xs text-slate-400 uppercase tracking-widest">24 Équipes. 1 seul Trophée. Effectifs Réels.</p>
                </div>

                <div id="team-selection-grid" class="flex-1 overflow-y-auto no-scrollbar grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-10">
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="flex-1 relative overflow-hidden">

        <div id="view-inbox" class="view-section flex flex-col h-full overflow-hidden relative bg-slate-900" style="padding-bottom: 0 !important;">

            <div class="shrink-0 p-6 pb-4 bg-carbon-foot border-b border-white/5 relative z-20">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full blur-3xl pointer-events-none"></div>

                <div class="flex justify-between items-end relative z-10">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-0.5 rounded bg-slate-700 border border-slate-600 text-[9px] font-bold text-slate-300 uppercase tracking-widest" id="dash-stage">POULES</span>
                        </div>
                        <h2 class="font-teko text-5xl text-white uppercase italic leading-none drop-shadow-md">Q.G. Manager</h2>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">La nation vous regarde.</div>
                    </div>

                    <div class="flex flex-col items-end w-28">
                        <div class="flex justify-between w-full text-[9px] font-bold uppercase mb-1">
                            <span class="text-slate-500">Prestige</span>
                            <span class="text-orange-400" id="team-xp-display">0 XP</span>
                        </div>
                        <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                            <div id="xp-bar-fill" class="h-full bg-gradient-to-r from-orange-600 to-yellow-400 shadow-[0_0_10px_rgba(249,115,22,0.5)]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-5 pb-24 z-10">

                <div id="next-match-card" class="relative w-full rounded-3xl overflow-hidden border border-white/10 shadow-2xl group shrink-0">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"></div>

                    <div class="relative z-10 p-5 flex flex-col items-center">
                        <div class="w-full flex justify-between items-center mb-4 opacity-90">
                            <span class="text-[9px] font-bold text-white bg-red-600 px-2 py-0.5 rounded animate-pulse">PROCHAIN MATCH</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest" id="dash-date">2026</span>
                        </div>

                        <div class="flex items-center justify-between w-full px-2 mb-6">
                            <div class="flex flex-col items-center gap-2 group-hover:scale-105 transition-transform duration-500">
                                <div id="dash-user-badge" class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-800 shadow-xl italic relative">
                                    CIV
                                    <div class="absolute -bottom-2 -right-2 bg-white text-slate-900 text-[9px] font-bold px-1.5 rounded border border-slate-300">DOM</div>
                                </div>
                            </div>

                            <div class="flex flex-col items-center justify-center">
                                <span class="font-teko text-5xl text-white italic drop-shadow-[0_0_15px_rgba(249,115,22,0.8)]">VS</span>
                            </div>

                            <div class="flex flex-col items-center gap-2 group-hover:scale-105 transition-transform duration-500">
                                <div id="next-opp-badge" class="w-20 h-20 bg-slate-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-800 shadow-xl italic">?</div>
                            </div>
                        </div>
                        <div class="text-center mb-6">
                            <h3 class="font-teko text-4xl text-white uppercase leading-none mb-1" id="next-opp-name">ADVERSAIRE</h3>
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Stade Olympique Ebimpé</p>
                        </div>

                        <button onclick="app.startMatch()" class="w-full py-4 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white rounded-xl text-sm font-bold uppercase tracking-widest shadow-lg border border-orange-400/50 flex items-center justify-center gap-2 active:scale-95 transition-all group-hover:shadow-orange-500/20">
                            <span id="icon-play-main" class="scale-125"></span> COUP D'ENVOI
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div class="glass-panel p-4 rounded-2xl border border-white/5 bg-slate-800/50">
                        <div class="flex items-center justify-between mb-3 border-b border-white/5 pb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-blue-400" id="icon-radar-dash"></span>
                                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Rapport Scout</h3>
                            </div>
                            <span class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded font-bold uppercase">Analyse</span>
                        </div>
                        <div id="opponent-analysis-box" class="grid grid-cols-2 gap-3"></div>
                    </div>

                    <div class="glass-panel p-4 rounded-2xl border border-white/5 bg-slate-800/50">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-teko text-2xl text-white uppercase tracking-wide flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                                Gazette
                            </h3>
                            <button onclick="app.clearNews()" class="text-[9px] text-slate-500 hover:text-white uppercase font-bold border border-slate-700 px-2 py-1 rounded transition">Effacer</button>
                        </div>
                        <div id="news-feed" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>  <!-- VUE : TACTIQUE -->
        <div id="view-squad" class="view-section hidden flex flex-col h-full bg-slate-900 absolute inset-0 overflow-hidden" style="padding-bottom: 0 !important;">

            <div class="bg-slate-900/95 backdrop-blur border-b border-slate-800 p-3 sticky top-0 z-40 shadow-xl flex justify-between items-center shrink-0">
                <button onclick="app.autoPick()" class="px-4 py-2 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-xl text-[10px] font-bold text-white uppercase flex items-center gap-2 transition active:scale-95">
                    <span id="icon-zap-mini"></span> Auto
                </button>

                <div class="flex flex-col items-center">
                    <span class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Puissance</span>
                    <div id="squad-avg-ovr" class="text-white text-3xl font-teko font-bold leading-none">--</div>
                </div>

                <button onclick="app.openRolesModal()" class="px-4 py-2 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-xl text-[10px] font-bold text-white uppercase flex items-center gap-2 transition active:scale-95">
                    <span class="text-yellow-400">©</span> Rôles
                </button>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar pb-32">

                <div class="flex-shrink-0 relative py-4 flex justify-center">
                    <div class="pitch-container" id="pitch-main" style="margin: 0;">
                        <div class="pitch-midline"></div><div class="pitch-circle"></div>
                        <div id="pitch-cards-layer"></div>
                    </div>
                </div>

                <div class="px-4 mb-2 sticky top-0 z-30">
                    <button onclick="app.togglePrematchTactics()" id="btn-toggle-prematch" class="w-full py-3 bg-slate-800 border border-slate-600 rounded-xl text-white text-[11px] font-bold uppercase shadow-lg flex items-center justify-center gap-2 hover:bg-orange-600 hover:border-orange-500 transition">
                        <span>▼</span> Tactique & Formation <span>▼</span>
                    </button>
                </div>

                <div id="prematch-controls-wrapper" class="hidden px-4 animate-slideIn">
                    <div class="bg-slate-900 border border-white/10 rounded-2xl p-4 shadow-2xl mb-4">

                        <span class="text-[9px] font-bold text-slate-400 uppercase mb-2 block">Dispositif</span>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 border-b border-white/5 pb-4">
                            <button onclick="app.setFormation('4-3-3')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">4-3-3</button>
                            <button onclick="app.setFormation('4-4-2')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">4-4-2</button>
                            <button onclick="app.setFormation('3-5-2')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">3-5-2</button>
                            <button onclick="app.setFormation('4-2-3-1')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">4-2-3-1</button>
                            <button onclick="app.setFormation('4-1-4-1')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">4-1-4-1</button>
                            <button onclick="app.setFormation('5-4-1')" class="px-4 py-2 rounded-lg text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0 text-white hover:bg-orange-600 transition">5-4-1</button>
                        </div>

                        <span class="text-[9px] font-bold text-orange-500 uppercase mb-2 block">Instructions</span>
                        <div id="prematch-tactics-container" class="grid grid-cols-2 gap-3"></div>
                    </div>
                </div>

                <div class="px-4 mt-2">
                    <div class="flex justify-between items-center py-2 border-b border-slate-800 mb-4">
                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Effectif & Réserve</span>
                        <span id="bench-count" class="text-[10px] text-slate-500 font-mono">0/20</span>
                    </div>
                    <div id="bench-list-container" class="flex flex-wrap gap-2 justify-center"></div>
                </div>
            </div>
        </div>

        <!-- VUE : MATCH LIVE -->
        <div id="view-match" class="view-section hidden absolute inset-0 z-[60] flex flex-col bg-slate-950">
            <div class="relative z-20 pt-8 pb-2 flex flex-col items-center shrink-0">

                <div class="mb-[-12px] z-20 bg-slate-950 border border-slate-700 px-4 py-1 rounded-full shadow-lg">
                    <span class="font-mono text-xl text-orange-500 font-bold tracking-widest" id="match-timer">00:00</span>
                </div>

                <div class="w-72 bg-[#0f172a] border border-slate-700 rounded-3xl p-4 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)] flex flex-col items-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>

                    <div class="flex justify-between items-center w-full z-10">
                        <div class="flex flex-col items-center gap-1">
                            <div id="match-home-badge" class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-orange-700 flex items-center justify-center font-teko text-xl text-white font-bold border border-slate-600 shadow-lg">CIV</div>                </div>

                        <div class="flex items-center gap-4">
                            <span class="font-teko text-6xl text-white leading-none drop-shadow-md" id="score-home">0</span>
                            <span class="w-px h-8 bg-slate-700"></span>
                            <span class="font-teko text-6xl text-white leading-none drop-shadow-md" id="score-away">0</span>
                        </div>

                        <div class="flex flex-col items-center gap-1">
                            <div id="match-opp-badge" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center font-teko text-xl text-white font-bold border border-slate-600 shadow-lg">?</div>
                        </div>
                    </div>

                    <div class="w-full mt-3 flex items-center gap-2">
                        <span class="text-[9px] font-bold text-slate-500 w-6 text-right" id="poss-val-home">50%</span>
                        <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden relative">
                            <div id="possession-home-bar" class="h-full bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.5)] transition-all duration-700" style="width: 50%"></div>
                        </div>
                        <span class="text-[9px] font-bold text-slate-500 w-6" id="poss-val-away">50%</span>
                    </div>

                    <div class="flex justify-between w-full px-2 mt-1">
                        <span class="text-[8px] text-slate-500 uppercase font-bold">Tirs: <span id="stats-shots-home" class="text-slate-300">0</span></span>
                        <span class="text-[8px] text-slate-500 uppercase font-bold">Tirs: <span id="stats-shots-away" class="text-slate-300">0</span></span>
                    </div>
                </div>
            </div>

            <div class="flex-1 min-h-0 flex flex-col relative z-10 px-4 mb-2">

                <div class="shrink-0 py-1">
                    <div id="match-assistant-msg" class="bg-slate-900/80 border-l-2 border-orange-500 pl-2 py-1.5 text-[10px] text-slate-300 italic shadow-lg backdrop-blur-sm truncate">
                    </div>
                </div>

                <div id="commentary-log" class="flex-1 overflow-y-auto space-y-1.5 no-scrollbar text-[11px] text-slate-400 pb-2 mask-image-b">
                </div>
            </div>

            <div class="shrink-0 bg-[#0f172a] border-t border-white/5 rounded-t-2xl p-4 pb-8 shadow-[0_-5px_20px_rgba(0,0,0,0.8)] z-30 relative overflow-hidden">

                <div class="absolute top-1.5 left-1/2 -translate-x-1/2 w-8 h-1 bg-slate-800 rounded-full"></div>

                <div class="flex justify-between items-center mb-3 mt-1">
                    <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest pl-1">Consignes</span>
                    <button onclick="app.toggleLiveCoaching()" class="px-3 py-1 bg-slate-800 border border-slate-700 rounded-full text-[9px] text-white font-bold uppercase hover:bg-slate-700 hover:border-slate-500 transition shadow-sm flex items-center gap-1.5 active:scale-95">
                        <span id="icon-repeat-match" class="scale-75"></span> <span>Coaching</span>
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-4">

                    <button onclick="app.setMatchTactic('def')" id="tac-def" class="py-2 bg-slate-800 border border-slate-700 rounded-full text-[9px] font-bold text-slate-400 uppercase transition-all active:scale-95 shadow-sm hover:border-slate-500">
                        Défense
                    </button>

                    <button onclick="app.setMatchTactic('bal')" id="tac-bal" class="py-2 bg-slate-700 border border-white/30 rounded-full text-[9px] font-bold text-white shadow-sm uppercase transition-all active:scale-95 transform scale-105">
                        Équilibre
                    </button>

                    <button onclick="app.setMatchTactic('att')" id="tac-att" class="py-2 bg-slate-800 border border-slate-700 rounded-full text-[9px] font-bold text-slate-400 uppercase transition-all active:scale-95 shadow-sm hover:border-slate-500">
                        Attaque
                    </button>

                </div>
            </div>

            <div id="penalty-view" class="hidden fixed inset-0 z-[500] bg-slate-950 flex flex-col items-center justify-center p-6">

                <div class="text-center mb-8 w-full">
                    <h2 class="font-teko text-6xl text-white uppercase italic leading-none mb-2 animate-pulse">Tirs au But</h2>
                    <div class="flex items-center justify-center gap-6 bg-slate-900/80 p-6 rounded-3xl border border-white/10 shadow-2xl">
                        <div class="text-center w-24">
                            <span class="font-teko text-7xl text-orange-500 leading-none" id="pen-score-home">0</span>
                            <div id="pen-home-code" class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">CIV</div>
                        </div>
                        <div class="text-slate-600 font-teko text-4xl italic">VS</div>
                        <div class="text-center w-24">
                            <span class="font-teko text-7xl text-white leading-none" id="pen-score-away">0</span>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest" id="pen-opp-code">ADV</div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-8 mt-4">
                        <div id="pen-history-home" class="flex gap-1"></div>
                        <div id="pen-history-away" class="flex gap-1"></div>
                    </div>
                </div>

                <div id="pen-selection-zone" class="w-full max-w-md">
                    <p class="text-center text-[10px] text-orange-400 font-bold uppercase tracking-widest mb-4 animate-bounce">
                        Sélectionnez votre tireur
                    </p>
                    <div id="pen-shooters-list" class="grid grid-cols-2 gap-3 max-h-[40vh] overflow-y-auto no-scrollbar">
                    </div>
                </div>

                <div id="pen-result-msg" class="hidden mt-8 text-center">
                    <h3 class="font-teko text-5xl text-white uppercase italic" id="pen-action-text">BUT !</h3>
                </div>
            </div>

            <!-- OVERLAY COACHING MATCH -->
            <div id="live-coach-overlay">
                <div class="flex-shrink-0 px-4 py-2 border-b border-white/10 bg-slate-900/95 backdrop-blur-md sticky top-0 z-[210] flex justify-between items-center shadow-xl">
                    <div>
                        <h3 class="font-teko text-3xl text-white uppercase italic leading-none">Coaching</h3>
                        <span class="text-[9px] text-orange-500 font-bold uppercase tracking-widest animate-pulse">En Direct</span>
                    </div>
                    <button onclick="app.toggleLiveCoaching()" class="px-3 py-1 bg-red-600/20 border border-red-500/50 rounded-lg text-red-400 font-bold text-[10px] uppercase hover:bg-red-600 hover:text-white transition">
                        Fermer
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto no-scrollbar pb-32 flex flex-col">

                    <div class="shrink-0 py-4 flex justify-center bg-slate-950/30">
                        <div class="pitch-container scale-[0.85] origin-top shadow-2xl border border-white/10" style="margin: 0;">
                            <div id="pitch-cards-layer-live"></div>
                        </div>
                    </div>

                    <div class="px-4 mb-2 sticky top-[55px] z-[200]">
                        <button onclick="app.toggleTacticsPanel()" id="btn-toggle-tactics" class="w-full py-2 bg-slate-800 border border-slate-600 rounded-lg text-white text-[10px] font-bold uppercase shadow-lg flex items-center justify-center gap-2 hover:bg-orange-600 hover:border-orange-500 transition">
                            <span>▼</span> Modifier la Tactique <span>▼</span>
                        </button>
                    </div>

                    <div id="live-controls-wrapper" class="hidden px-4 animate-slideIn">
                        <div class="bg-slate-900/90 border border-white/10 rounded-xl p-3 shadow-2xl backdrop-blur-sm">

                            <span class="text-[9px] font-bold text-orange-500 uppercase mb-2 block border-b border-white/5 pb-1">Consignes d'équipe</span>
                            <div id="live-tactics-container" class="grid grid-cols-2 gap-2 mb-4"></div>

                            <span class="text-[9px] font-bold text-slate-400 uppercase mb-2 block border-b border-white/5 pb-1">Formation</span>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="live-formation-list">
                                <button onclick="app.setLiveFormation('4-3-3')" class="live-fmt-btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-[9px] font-bold shrink-0 transition" data-fmt="4-3-3">4-3-3</button>
                                <button onclick="app.setLiveFormation('4-4-2')" class="live-fmt-btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-[9px] font-bold shrink-0 transition" data-fmt="4-4-2">4-4-2</button>
                                <button onclick="app.setLiveFormation('3-5-2')" class="live-fmt-btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-[9px] font-bold shrink-0 transition" data-fmt="3-5-2">3-5-2</button>
                                <button onclick="app.setLiveFormation('4-2-3-1')" class="live-fmt-btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-[9px] font-bold shrink-0 transition" data-fmt="4-2-3-1">4-2-3-1</button>
                                <button onclick="app.setLiveFormation('5-4-1')" class="live-fmt-btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-[9px] font-bold shrink-0 transition" data-fmt="5-4-1">5-4-1</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- HT OVERLAY -->
            <div id="ht-overlay">
                <div class="glass-panel p-10 rounded-[50px] text-center max-w-sm w-full mx-6 shadow-2xl border border-white/10">
                    <span id="icon-mic-ht"></span>
                    <h2 class="font-teko text-7xl text-white mb-2 leading-none uppercase italic mt-4">La Causerie</h2>
                    <p class="text-[10px] text-slate-400 mb-10 tracking-widest uppercase">Mots justes, moral d'acier.</p>
                    <div class="flex flex-col gap-4">
                        <button onclick="app.giveSpeech('motivate')" class="speech-btn">Motiver les troupes (+5% Force)</button>
                        <button onclick="app.giveSpeech('shake')" class="speech-btn text-red-400 border-red-500/20">Secouer le groupe (+15% Risqué)</button>
                        <button onclick="app.giveSpeech('calm')" class="speech-btn text-blue-400 border-blue-500/20">Tactique de zone (+10% Mental)</button>
                    </div>
                </div>
            </div>

            <div id="goal-overlay">
                <h1 class="font-teko text-[130px] text-white italic animate-bounce leading-none">BUT !!!</h1>
                <p class="font-teko text-5xl text-orange-500 uppercase tracking-tighter" id="goal-scorer-name"></p>
            </div>

            <div id="end-modal" class="absolute inset-0 z-[250] bg-slate-950/90 flex items-center justify-center hidden p-6 backdrop-blur-xl transition-all duration-500">
                <div class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-[32px] shadow-2xl overflow-hidden relative">

                    <div id="end-header-bg" class="h-24 bg-gradient-to-b from-green-600 to-slate-900 flex items-center justify-center pt-4 relative">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                        <h2 class="font-teko text-6xl text-white uppercase italic tracking-tighter drop-shadow-lg relative z-10" id="end-title">VICTOIRE</h2>
                    </div>

                    <div class="px-6 py-8 flex flex-col items-center">
                        <div class="flex items-center justify-between w-full mb-8">
                            <div class="flex flex-col items-center gap-2 w-1/3">
                                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center border-2 border-slate-600 shadow-xl">
                                    <span class="font-teko text-3xl text-white font-bold italic">CIV</span>
                                </div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Domicile</span>
                            </div>

                            <div class="flex flex-col items-center w-1/3 relative">
                                <div class="font-teko text-7xl text-white leading-none tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]" id="end-score-display">0-0</div>
                                <div id="end-penalties-display" class="text-[10px] text-orange-400 font-bold uppercase tracking-widest mt-1 hidden">TAB: 4-3</div>
                            </div>

                            <div class="flex flex-col items-center gap-2 w-1/3">
                                <div id="end-opp-badge" class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center border-2 border-slate-600 shadow-xl">
                                    <span class="font-teko text-3xl text-white font-bold italic">?</span>
                                </div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="end-opp-name">ADV</span>
                            </div>
                        </div>

                        <div class="w-full space-y-3 bg-slate-950/50 p-4 rounded-xl border border-white/5 mb-6">
                            <div class="flex justify-between text-[9px] font-bold text-slate-500 uppercase mb-1">
                                <span>Tirs Cadrés</span>
                                <span class="text-white" id="end-stat-shots">0 - 0</span>
                            </div>
                            <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden flex">
                                <div id="end-bar-shots" class="h-full bg-orange-500" style="width: 50%"></div>
                            </div>

                            <div class="flex justify-between text-[9px] font-bold text-slate-500 uppercase mt-2 mb-1">
                                <span>Possession</span>
                                <span class="text-white" id="end-stat-poss">50% - 50%</span>
                            </div>
                            <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden flex">
                                <div id="end-bar-poss" class="h-full bg-blue-500" style="width: 50%"></div>
                            </div>
                        </div>

                        <button onclick="app.closeEndModal()" class="w-full py-5 bg-white text-slate-900 hover:bg-slate-200 font-bold rounded-xl uppercase shadow-lg shadow-white/5 active:scale-95 transition-all text-sm tracking-widest">
                            Continuer la Saison
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE SWAP -->
        <div id="swap-modal" class="absolute inset-0 z-[300] bg-slate-950/95 hidden flex flex-col backdrop-blur-md">
            <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-2xl shrink-0">
                <div>
                    <h3 class="font-teko text-4xl text-white uppercase leading-none italic">Banc de Touche</h3>
                    <div class="text-[10px] text-orange-500 font-bold uppercase tracking-widest" id="swap-target-pos">Remplacement</div>
                </div>
                <button onclick="app.closeSwapModal()" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold shadow-xl border border-slate-700">X</button>
            </div>

            <div class="p-4 flex-1 overflow-y-auto no-scrollbar grid grid-cols-2 gap-3 content-start" id="swap-candidates-list">
            </div>
        </div>

        <div id="preview-modal" class="absolute inset-0 z-[200] bg-slate-950/95 hidden flex flex-col backdrop-blur-xl">
            <div class="p-6 text-center shrink-0 bg-gradient-to-b from-slate-900 to-transparent">
                <h2 class="font-teko text-6xl text-white uppercase italic leading-none drop-shadow-lg">Feuille de Match</h2>
                <div class="flex items-center justify-center gap-3 mt-1">
                    <span class="text-orange-500 font-bold text-lg">CIV</span>
                    <span class="text-slate-600 text-[10px] font-bold">VS</span>
                    <span class="text-white font-bold text-lg" id="preview-opp-code">ADV</span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto px-4 pb-32 no-scrollbar">
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-slate-900/50 rounded-2xl p-2 border border-orange-500/20">
                        <div class="text-center mb-3 border-b border-white/5 pb-2">
                            <div class="text-[9px] text-orange-500 uppercase font-bold tracking-widest">TITULAIRES</div>
                        </div>
                        <div id="preview-home-list" class="space-y-1"></div>
                    </div>

                    <div class="bg-slate-900/50 rounded-2xl p-2 border border-slate-700/50">
                        <div class="text-center mb-3 border-b border-white/5 pb-2">
                            <div class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">ADVERSAIRE</div>
                        </div>
                        <div id="preview-away-list" class="space-y-1"></div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-900 border-t border-slate-800 absolute bottom-0 w-full shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                <button onclick="app.kickOff()" class="w-full py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold uppercase tracking-widest transition-all shadow-xl text-sm flex items-center justify-center gap-2 border border-orange-400">
                    <span id="icon-play-preview"></span> DONNER LE COUP D'ENVOI
                </button>
            </div>
        </div>

        <!-- VUES SECONDAIRES -->
        <div id="view-training" class="view-section hidden h-full overflow-y-auto no-scrollbar">
            <div class="p-5" id="training-content"></div>
        </div>

        <div id="view-calendar" class="view-section hidden h-full overflow-y-auto no-scrollbar">
            <div class="p-5" id="calendar-content"></div>
        </div>

        <div id="view-scout" class="view-section hidden h-full overflow-y-auto no-scrollbar">
            <div class="p-5" id="scout-content"></div>
        </div>

        <!-- NOUVELLE VUE : INFRASTRUCTURES -->
        <div id="view-infra" class="view-section hidden h-full overflow-y-auto no-scrollbar">
            <div class="p-6">
                <h2 class="font-teko text-6xl text-white uppercase italic mb-2 leading-none">Infrastructures</h2>
                <p class="text-[10px] text-slate-500 mb-8 uppercase tracking-widest font-bold">Bâtir l'avenir de la nation.</p>
                <div id="infra-list" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

    </main>

    <!-- NAVIGATION -->
    <nav class="bg-[#0f172a] border-t border-slate-800 grid grid-cols-6 items-center z-[100] shrink-0 relative h-16 pb-safe">
        <button onclick="app.goToView('inbox')" id="nav-inbox" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-layout-nav"></span><span class="text-[9px] font-bold uppercase">QG</span></button>
        <button onclick="app.goToView('squad')" id="nav-squad" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-shield-nav"></span><span class="text-[9px] font-bold uppercase">Tactique</span></button>
        <button onclick="app.goToView('training')" id="nav-training" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-zap-nav"></span><span class="text-[9px] font-bold uppercase">Pro</span></button>
        <button onclick="app.goToView('calendar')" id="nav-calendar" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-trophy-nav"></span><span class="text-[9px] font-bold uppercase">CAF</span></button>
        <button onclick="app.goToView('scout')" id="nav-scout" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-search-nav"></span><span class="text-[9px] font-bold uppercase">Scout</span></button>
        <button onclick="app.goToView('infra')" id="nav-infra" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-home-nav"></span><span class="text-[9px] font-bold uppercase">Ville</span></button>
    </nav>
    <div id="welcome-modal" class="absolute inset-0 z-[1000] bg-slate-950 flex flex-col items-center justify-center p-8 hidden">
        <div class="w-full max-w-md text-center"> <h1 class="font-teko text-6xl text-white uppercase italic leading-none mb-2">Nouvelle Ère</h1>
            <p class="text-xs text-slate-400 mb-6 uppercase tracking-widest">Identifiez-vous, Coach.</p>

            <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/5 rounded-full blur-2xl pointer-events-none"></div>

                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-3 text-left">Votre Avatar</label>
                <div id="manager-avatars-grid" class="flex justify-center gap-3 mb-6 flex-wrap">
                </div>

                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-2 text-left">Nom du Manager</label>
                <input type="text" id="input-manager-name" placeholder="Ex: DIDIER DROGBA" class="w-full bg-slate-950 border border-slate-700 text-white p-4 rounded-xl text-center font-teko text-2xl uppercase focus:border-orange-500 focus:outline-none mb-4 placeholder-slate-700 transition">

                <button onclick="app.submitManagerName()" class="w-full py-4 bg-white text-slate-900 rounded-xl text-xs font-bold uppercase shadow-lg active:scale-95 transition hover:bg-slate-200">
                    Signer le contrat
                </button>
            </div>
        </div>
    </div>
    <div id="tuto-backdrop" class="fixed inset-0 z-[2000] bg-slate-950/10 hidden transition-opacity duration-500"></div>

    <div id="tutorial-overlay" class="fixed inset-0 z-[2050] hidden flex-col items-center justify-center p-6 pointer-events-none">

        <div class="w-64 bg-slate-900 border border-orange-500/50 rounded-xl shadow-2xl relative overflow-hidden animate-slideIn pointer-events-auto">

            <div class="absolute top-0 right-0 w-20 h-20 bg-orange-500/10 rounded-full blur-xl pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-12 h-12 bg-blue-500/5 rounded-full blur-xl pointer-events-none"></div>

            <div class="p-4 relative z-10">
                <div class="flex items-center gap-3 mb-3 border-b border-white/10 pb-3">
                    <div class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center border border-slate-600 shadow-lg text-orange-500 animate-pulse shrink-0">
                    <span id="tuto-icon" class="scale-75">
                       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                    </span>
                    </div>
                    <div>
                        <h3 class="font-teko text-2xl text-white uppercase italic leading-none">L'Adjoint</h3>
                        <p class="text-[8px] text-orange-500 font-bold uppercase tracking-widest">Briefing</p>
                    </div>
                </div>

                <h4 id="tuto-title" class="font-teko text-lg text-white uppercase mb-1 leading-none">Bienvenue Coach</h4>
                <p id="tuto-text" class="text-[10px] text-slate-300 leading-relaxed mb-4 min-h-[40px] font-medium">...</p>

                <div class="flex justify-between items-center mt-auto">
                    <div class="flex gap-1" id="tuto-dots"></div>
                    <button onclick="app.nextTutorialStep()" class="pointer-events-auto z-[2060] px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white font-bold uppercase text-[9px] tracking-widest rounded-lg shadow-lg active:scale-95 transition border border-orange-400/50">
                        Compris
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-white text-slate-900 px-8 py-4 rounded-2xl shadow-2xl z-[500] text-[11px] font-bold hidden opacity-0 transition-all transform translate-y-4">
        <span id="toast-msg">Action effectuée</span>
    </div>
</div>
<div id="roles-modal" class="hidden absolute inset-0 z-[300] bg-slate-950/95 flex flex-col backdrop-blur-md">
    <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-2xl shrink-0">
        <div>
            <h3 class="font-teko text-4xl text-white uppercase leading-none italic">Rôles Clés</h3>
            <div class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Responsabilités</div>
        </div>
        <button onclick="document.getElementById('roles-modal').classList.add('hidden')" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold shadow-xl border border-slate-700">X</button>
    </div>

    <div class="p-6 flex-1 overflow-y-auto space-y-4">
        <div id="roles-list-container" class="grid grid-cols-1 gap-4">
        </div>
    </div>
</div>

<div id="role-picker-modal" class="hidden absolute inset-0 z-[350] bg-slate-950 flex flex-col">
    <div class="p-4 bg-slate-900 border-b border-slate-700">
        <h3 class="font-teko text-3xl text-white uppercase" id="role-picker-title">Choisir Joueur</h3>
    </div>
    <div id="role-picker-list" class="p-4 grid grid-cols-1 gap-2 overflow-y-auto"></div>
    <div class="p-4 border-t border-slate-800">
        <button onclick="document.getElementById('role-picker-modal').classList.add('hidden')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold uppercase text-xs">Annuler</button>
    </div>
</div>

<script>
    /**
     * AFRICAN ELITE MANAGER PRO v9.6 - THE LEGACY
     * DEVELOPED FOR TOTAL REALISM & IMMERSION
     * 1100+ LINES OF CODE
     */

    // --- BASE DE DONNÉES DE NOMS "ULTIMATE" (400+ ENTRÉES) ---
// --- BASE DE DONNÉES DE NOMS RÉGIONALE (CORRIGÉE & ÉTENDUE) ---
// Sécurité pour les navigateurs qui n'ont pas crypto.randomUUID
// --- SÉCURITÉ DÉMARRAGE ---
if (!window.crypto) window.crypto = {};
if (!window.crypto.randomUUID) {
window.crypto.randomUUID = () => {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
};
}
const REGIONAL_NAMES = {
// 1. MAGHREB & ÉGYPTE (Arabophone)
NORTH: {
    first: [
        "Mohamed", "Ahmed", "Youssef", "Achraf", "Hakim", "Sofyan", "Mehdi", "Amine", "Walid", "Riyad",
        "Islam", "Baghdad", "Wahbi", "Ali", "Mostafa", "Mahmoud", "Omar", "Tarek", "Zinedine", "Karim",
        "Nabil", "Sofiane", "Ramy", "Ismaël", "Yassine", "Noussair", "Abderrazak", "Faouzi", "Aïssa", "Youcef",
        "Rais", "Aymen", "Houssem", "Ferjani", "Saber", "Hamza", "Billel", "Hilal", "Adlene", "Djamel",
        "Fares", "Rachid", "Said", "Mourad", "Kamel", "Samir", "Nassim", "Anis", "Reda", "Jawad",
        "Mounir", "Adel", "Hicham", "Fayçal", "Zakaria", "Bilal", "Ilyes", "Selim", "Marwan", "Emam",
        "Bassem", "Kahraba", "Shikabala", "Ramadan", "Hussein", "Amr", "Wael", "Essam", "Mido", "Hosny",
        "Zaki", "Gedo", "Aboutrika", "Barakat", "Ghaly", "Fathy", "Hassan", "Ibrahim", "Mido", "Zidan",
        "El-Hadary", "Ekramy", "Shenawy", "Awad", "Sobhi", "Refaat", "Hafez", "Ashour", "Soliman", "Gomaa",
        "Sayed", "Moawad", "Homos", "Shawky", "Abdallah", "Koka", "Mohsen", "Gamal", "Hamoudi", "Antar",
        "Yahya", "Azzedine", "Munir", "En-Nesyri", "Boufal", "Harit", "Amallah", "Ounahi", "El Khannouss", "Abde"
    ],
    last: [
        "Salah", "Mahrez", "Hakimi", "Ziyech", "Bounou", "Bennacer", "Mandi", "Slimani", "Feghouli", "Khazri",
        "Msakni", "Skhiri", "Elneny", "Trezeguet", "Hegazi", "El Shenawy", "Hamdallah", "Amrabat", "Mazraoui", "Aguerd",
        "Saïss", "Bensebaini", "Atal", "Brahimi", "Belaïli", "M'Bolhi", "Ben Youssef", "Maâloul", "Khenissi", "Fathi",
        "Marmoush", "Hamed", "Tawfik", "Hamdi", "Attiat-Allah", "El Yamiq", "Dari", "Cheddira", "Aboukhlal", "Sabiri",
        "Zaroury", "Chair", "Jabrane", "Tagnaouti", "El Kajoui", "Benatia", "Belhanda", "Boussoufa", "Dirar", "Da Costa",
        "El Ahmadi", "Boutaïb", "Amrabat", "Fajr", "Bouhaddouz", "Carcela", "Mendyl", "Ait Bennasser", "Boufal", "Harit",
        "Taarabt", "Chamakh", "Hadji", "Naybet", "Bassir", "Hadda", "Chippo", "El Khalej", "Abrami", "Rossi",
        "Ouaddou", "Karkouri", "Safri", "Zairi", "Sektioui", "Alloudi", "Zerka", "Basser", "Chafni", "Hermach",
        "El Arabi", "Barrada", "Belghazouani", "Regragui", "Mokhtari", "Diane", "Kaabi", "Rahimi", "Bencharki", "El Karti",
        "Zniti", "Hafidi", "Jorfi", "Nanah", "Aouk", "El Moutaraji", "Dari", "Comara", "Gaddarine", "El Amloud"
    ]
},
// 2. AFRIQUE DE L'OUEST FRANCOPHONE (CIV, Sénégal, Mali, Guinée...)
WEST_FRANCO: {
    first: [
        "Koffi", "Jean", "Moussa", "Didier", "Sadio", "Idrissa", "Cheikhou", "Kalidou", "Edouard", "Franck",
        "Wilfried", "Sébastien", "Nicolas", "Serge", "Eric", "Ibrahim", "Habib", "Abdou", "Ismaïla", "Boulaye",
        "Naby", "Sehrou", "Yves", "Seko", "Odilon", "Ousmane", "Lassina", "Simon", "Max-Alain", "Karim",
        "Salif", "Pape", "Gervais", "Yaya", "Kolo", "Siaka", "Aruna", "Bakary", "Kader", "Romaric",
        "Arthur", "Boka", "Emmanuel", "Blaise", "Copa", "Boubacar", "Barry", "Tiéné", "Zokora", "Meïté",
        "Akpa", "Akpro", "Jean-Daniel", "Serey", "Geoffroy", "Wilfried", "Seydou", "Lacina", "Traoré", "Bony",
        "Max", "Gradel", "Salomon", "Kalou", "Gervinho", "Doumbia", "Ya", "Konan", "Ghislain", "Roger",
        "Assalé", "Sio", "Giovanni", "Kodjia", "Jonathan", "Pepe", "Cornet", "Zaha", "Boga", "Hamed",
        "Junior", "Amad", "Diallo", "Datro", "Fofana", "Singo", "Wilfried", "Abakar", "Sylla", "Loum",
        "Badou", "Ndiaye", "Dieng", "Seny", "Alfred", "Gomis", "Mory", "Diaw", "Fodé", "Ballo",
        "Pathé", "Ciss", "Nampalys", "Mendy", "Koulibaly", "Diallo", "Jakobs", "Sabaly", "Formose", "Abdou"
    ],
    last: [
        "Touré", "Drogba", "Koné", "Koulibaly", "Mendy", "Gueye", "Mané", "Sarr", "Diallo", "Kouyaté",
        "Keita", "Camara", "Sylla", "Diaby", "Traoré", "Fofana", "Kessié", "Haller", "Zaha", "Aurier",
        "Bailly", "Pepe", "Sangaré", "Ndicka", "Kossounou", "Gradel", "Cornet", "Boga", "Kouamé", "Maïga",
        "Bissouma", "Djenepo", "Haidara", "Samassékou", "Koïta", "Sacko", "Doucouré", "Marega", "Diabaté", "Coulibaly",
        "Kanouté", "Keita", "Diarra", "Sissoko", "Tamboura", "Yatabaré", "Wagué", "Fofana", "Konaté", "Traoré",
        "N'Diaye", "Sow", "Niang", "Cissé", "Diawara", "Daf", "Fadiga", "Diouf", "Camara", "Ba",
        "Sakho", "N'Doye", "Kouyaté", "Gassama", "Sané", "M'Bengue", "Souaré", "Saivet", "Diamé", "Diop",
        "Sarr", "Baldé", "Thiam", "Diallo", "Gomis", "Mendy", "Kamara", "Dia", "Jackson", "Ndiaye",
        "Gueye", "Seck", "Ciss", "Sabaly", "Ballo-Touré", "Jakobs", "Niakhaté", "Koulibaly", "Diallo", "Dieng",
        "Konan", "Agbadou", "Deli", "Diomandé", "Singo", "Doué", "Kouassi", "Sangaré", "Aholou", "Seri"
    ]
},
// 3. AFRIQUE DE L'OUEST ANGLOPHONE (Nigeria, Ghana, Gambie...)
WEST_ANGLO: {
    first: [
        "Victor", "Alex", "Samuel", "Ademola", "Wilfred", "Kelechi", "Ahmed", "William", "Jordan", "Andre",
        "Thomas", "Mohammed", "Joe", "Calvin", "Frank", "Moses", "Jay-Jay", "Nwankwo", "Sunday", "Emmanuel",
        "Asamoah", "Michael", "Daniel", "Joseph", "John", "Obi", "Mikel", "Odion", "Ighalo", "Brown",
        "Ideye", "Efe", "Ambrose", "Vincent", "Enyeama", "Ikechukwu", "Uche", "Obafemi", "Martins", "Yakubu",
        "Aiyegbeni", "Peter", "Odemwingie", "Taye", "Taiwo", "Joseph", "Yobo", "Taribo", "West", "Celestine",
        "Babayaro", "Sunday", "Oliseh", "Finidi", "George", "Daniel", "Amokachi", "Rashidi", "Yekini", "Stephen",
        "Keshi", "Austin", "Okocha", "Kanu", "Nwankwo", "Victor", "Ikpeba", "Emmanuel", "Amuneke", "Mutiu",
        "Adepoju", "Garba", "Lawal", "Tijani", "Babangida", "Julius", "Aghahowa", "Isaac", "Okoronkwo", "Ifeanyi",
        "Christian", "Inaki", "Tariq", "Kamaldeen", "Abdul", "Baba", "Daniel", "Alexander", "Gideon", "Osman"
    ],
    last: [
        "Osimhen", "Iwobi", "Chukwueze", "Ndidi", "Iheanacho", "Musa", "Troost-Ekong", "Bassey", "Partey", "Kudus",
        "Ayew", "Williams", "Amartey", "Onyeka", "Simon", "Lookman", "Aribo", "Balogun", "Ekong", "Mensah",
        "Gyan", "Essien", "Mikel", "Kanu", "Okocha", "Yeboah", "Appiah", "Muntari", "Boateng", "Asamoah",
        "Atsu", "Wakaso", "Badu", "Afful", "Boye", "Mensah", "Sarpei", "Pantsil", "Kingson", "Adiyiah",
        "Tagoe", "Amoah", "Dramani", "Addo", "Kingston", "Appiah", "Essien", "Muntari", "Boateng", "Ayew",
        "Gyan", "Mensah", "Kuffour", "Djiku", "Salisu", "Semenyo", "Lamptey", "Bukari", "Sulemana", "Owusu",
        "Barrow", "Colley", "Ceesay", "Jallow", "Darboe", "Fadera", "Minteh", "Sowe", "Gomez", "Adams"
    ]
},
// 4. AFRIQUE CENTRALE (Cameroun, RDC, Gabon...)
CENTRAL: {
    first: [
        "Vincent", "André", "Karl", "Eric", "Chancel", "Cédric", "Gaël", "Pierre-Emerick", "Denis", "Bryan",
        "Yoane", "Arthur", "Clinton", "Michael", "Nicolas", "Jean-Pierre", "Samuel", "Rigobert", "Geremi", "Patrick",
        "Joseph", "Dieumerci", "Yannick", "Guelor", "Meschack", "Theo", "Aaron", "Mario", "Bruno", "Kevin",
        "Brice", "Léandre", "Ambroise", "Oyongo", "Fai", "Collins", "Nouhou", "Tolo", "Jerome", "Onguéné",
        "Harold", "Moukoudi", "Jean-Charles", "Castelletto", "Martin", "Hongla", "Samuel", "Oum", "Gouet", "Pierre",
        "Kunde", "Zambo", "Anguissa", "Moumi", "Ngamaleu", "Ignatius", "Ganago", "Christian", "Bassogog", "Karl",
        "Toko", "Ekambi", "Choupo-Moting", "Aboubakar", "Bahoken", "N'Jie", "Kaptoum", "Song", "Eto'o", "M'Boma",
        "Job", "Geremi", "Lauren", "Wome", "Kalla", "Song", "Foé", "Djemba-Djemba", "Mbami", "Makoun",
        "Emana", "Webó", "Idrissou", "Meyong", "Kameni", "Souleymanou", "Assou-Ekotto", "Bassong", "Mbia", "Enoh",
        "Eyong", "N'Koulou", "Chedjou", "Bedimo", "Nyom", "Matip", "Salli", "Zoua", "Aboubakar", "Moukandjo"
    ],
    last: [
        "Aboubakar", "Onana", "Anguissa", "Choupo-Moting", "Toko Ekambi", "Ngadeu", "Castelletto", "Mbemba", "Bakambu", "Wissa",
        "Kakuta", "Masuaku", "Aubameyang", "Bouanga", "Lemina", "Kanga", "N'Jie", "Bassogog", "Ondoa", "Epassy",
        "Ganago", "Bahoken", "Muleka", "Bolasié", "M'Poku", "Kebano", "Ndong", "Ecuélé Manga", "Poko", "Obiang",
        "Palun", "Appindangoyé", "Ecuele", "Manga", "Ovono", "Mfa", "Mezui", "Biyogo", "Poko", "Madinda",
        "Kanga", "Allevinah", "Boupendza", "Autchanga", "Nguema", "Mouloungui", "Cousin", "Aubameyang", "Meyé", "Do Marcolino",
        "Mbokani", "Mputu", "Kidiaba", "Kimwaki", "Kasusula", "Mongongu", "Zakuani", "Mulumbu", "Makiadi", "Matumona",
        "Lualua", "Ilunga", "Nonda", "Shabani", "Nonda", "Lomana", "LuaLua", "Tresor", "Mputu", "Dieumerci",
        "Mbokani", "Cedric", "Bakambu", "Yannick", "Bolasie", "Neeskens", "Kebano", "Chancel", "Mbemba", "Marcel",
        "Tisserand", "Christian", "Luyindama", "Arthur", "Masuaku", "Glody", "Ngonda", "Muzinga", "Wilfried", "Moke"
    ]
},
// 5. LUSOPHONES (Angola, Mozambique, Cap-Vert, Guinée-Bissau)
LUSO: {
    first: [
        "João", "Manuel", "José", "António", "Carlos", "Pedro", "Paulo", "Jorge", "Rui", "Nuno",
        "Hélder", "Bruno", "Ricardo", "Tiago", "André", "Luís", "Fernando", "Mário", "Gelson", "Zito",
        "Bebé", "Ryan", "Garry", "Jovane", "Clésio", "Geny", "Reinildo", "Witi", "Mexer", "Zainadine",
        "Fredy", "Gelson", "Ary", "Mateus", "Djalma", "Geraldo", "Bastos", "Show", "Mabululu", "Zini",
        "Gilberto", "Kialonda", "Neblú", "Kadú", "Hugo", "Stopira", "Vozinha", "Piquéti", "Mama", "Pelé",
        "Alfa", "Sori", "Moreto", "Fali", "Edgar", "Nanú", "Bura", "Jorginho", "Zé", "Kuka"
    ],
    last: [
        "Mendes", "Semedo", "Cabral", "Sanches", "Tavares", "Dias", "Fortes", "Rodrigues", "Andrade", "Santos",
        "Ferreira", "Silva", "Gomes", "Costa", "Lopes", "Martins", "Pereira", "Fernandes", "Oliveira", "Sousa",
        "Dala", "Gaspar", "Carneiro", "Buatu", "Mussunda", "Estrela", "Luvumbo", "Paz", "Fortuna", "Milson",
        "Catamo", "Mandava", "Ratifo", "Bauque", "Kambala", "Dominguês", "Pelembe", "Júnior", "Amado", "Banga",
        "Cassamá", "Baldé", "Candé", "Mané", "Djalo", "Camará", "Sangante", "Nogueira", "Encada", "Gano",
        "Monteiro", "Rocha", "Duarte", "Borges", "Furtado", "Varela", "Lima", "Correia", "Pires", "Alves"
    ]
},
// 6. HISPANOPHONES (Guinée Équatoriale)
HISP: {
    first: [
        "Emilio", "Javier", "Ivan", "Pablo", "Saul", "Jesus", "Basilio", "Carlos", "Ruben", "Iban",
        "Felipe", "José", "Luis", "Pedro", "Enrique", "Federico", "Santiago", "Esteban", "Oscar", "Alex",
        "Josete", "Dorian", "Noé", "Jannick", "Gael", "Miguel", "Angel", "Salomon", "Marvin", "Charles",
        "Cristian", "Aitor", "Dani", "Nestor", "Hugo", "Joan", "Pol", "Omar", "Santi", "Eloy"
    ],
    last: [
        "Nsue", "Salvador", "Obiang", "Machin", "Ganet", "Miranda", "Ndong", "Akapo", "Bikoro", "Coco",
        "Balboa", "Engonga", "Hanza", "Buyla", "Eneme", "Owolabi", "Sapunga", "Embela", "Anieboh", "Siafa",
        "Mayé", "Senobua", "Belima", "Kischen", "Zarandona", "Bodipo", "Rivas", "Iyanga", "Juvenal", "Randy",
        "Fidjeu", "Esono", "Mascarell", "Nlavo", "Nguema", "Asumu", "Mba", "Ondo", "Abeso", "Edjo"
    ]
},
// 7. AFRIQUE AUSTRALE & EST (RSA, Zambie, Namibie, Tanzanie, Ouganda...)
SOUTH_EAST: {
    first: [
        "Percy", "Themba", "Ronwen", "Lyle", "Thapelo", "Teboho", "Sphephelo", "Aubrey", "Zakhele", "Thabang",
        "Patson", "Fashion", "Enock", "Kings", "Lameck", "Stopilla", "Lubambo", "Toaster", "Rally", "Clatous",
        "Peter", "Deon", "Ananias", "Ryan", "Lloyd", "Absalom", "Riaan", "Kennedy", "Virgil", "Aprocius",
        "Mbwana", "Simon", "Feisal", "Novatus", "Ibrahim", "Aishi", "Bakari", "Dickson", "Himid", "Mudathir",
        "Farouk", "Emmanuel", "Khalid", "Denis", "Halid", "Kenneth", "Bevis", "Elvis", "Timothy", "Fahad"
    ],
    last: [
        "Tau", "Zwane", "Mokoena", "Foster", "Williams", "Morena", "Mvala", "Modiba", "Lepasa", "Sithole",
        "Daka", "Sakala", "Mwepu", "Kangwa", "Banda", "Sunzu", "Musonda", "Chama", "Mulenga", "Phiri",
        "Shalulile", "Hotto", "Tjiueza", "Iimbondi", "Hanamub", "Kazapua", "Haukongo", "Nyambe", "Katua", "Petrus",
        "Samatta", "Msuva", "Salum", "Miroshi", "Manula", "Mwamnyeto", "Job", "Mao", "Yassin", "Kibu",
        "Miya", "Okwi", "Aucho", "Lwaliwa", "Onyango", "Mugabi", "Bwomono", "Kayondo", "Awany", "Bayo"
    ]
}
};

   const NATIONS_DB = [
        // GROUPE A
        {
            n: 'Côte d\'Ivoire', code: 'CIV', ovr: 85, style: 'Offensif', star: 'F. Kessié', starPos: 'MID', region: 'WEST_FRANCO',
            history: [1992, 2015, 2023],
            stadiums: ['Stade Alassane Ouattara', 'Stade Félix Houphouët-Boigny', 'Stade de la Paix (Bouaké)', 'Stade Charles Konan Banny']
        },
        {
            n: 'Nigeria', code: 'NGA', ovr: 84, style: 'Vertical', star: 'V. Osimhen', starPos: 'FWD', region: 'WEST_ANGLO',
            history: [1980, 1994, 2013],
            stadiums: ['Godswill Akpabio Stadium', 'Moshood Abiola National Stadium', 'Teslim Balogun Stadium', 'Adokiye Amiesimaka Stadium']
        },
        {
            n: 'Guinée Eq.', code: 'GNQ', ovr: 75, style: 'Explosivité', star: 'E. Nsue', starPos: 'FWD', region: 'HISP',
            history: [],
            stadiums: ['Estadio de Malabo', 'Estadio de Bata', 'Estadio de Mongomo', 'Estadio de Ebebiyín']
        },
        {
            n: 'Guinée-Bissau', code: 'GNB', ovr: 74, style: 'Vitesse', star: 'Mama Balde', starPos: 'FWD', region: 'LUSO',
            history: [],
            stadiums: ['Estádio 24 de Setembro', 'Estádio Lino Correia', 'Estádio da Rocha', 'Complexo Desportivo de Bissau']
        },

        // GROUPE B
        {
            n: 'Égypte', code: 'EGY', ovr: 84, style: 'Contre', star: 'M. Salah', starPos: 'FWD', region: 'NORTH',
            history: [1957, 1959, 1986, 1998, 2006, 2008, 2010],
            stadiums: ['Cairo International Stadium', 'Borg El Arab Stadium', '30 June Stadium', 'Al Salam Stadium']
        },
        {
            n: 'Ghana', code: 'GHA', ovr: 78, style: 'Impact', star: 'M. Kudus', starPos: 'MID', region: 'WEST_ANGLO',
            history: [1963, 1965, 1978, 1982],
            stadiums: ['Baba Yara Sports Stadium', 'Accra Sports Stadium', 'Cape Coast Sports Stadium', 'Tamale Sports Stadium']
        },
        {
            n: 'Cap-Vert', code: 'CPV', ovr: 76, style: 'Transition', star: 'R. Mendes', starPos: 'FWD', region: 'LUSO',
            history: [],
            stadiums: ['Estádio Nacional de Cabo Verde', 'Estádio da Várzea', 'Estádio Adérito Sena', 'Estádio Marcelo Leitão']
        },
        {
            n: 'Mozambique', code: 'MOZ', ovr: 72, style: 'Collectif', star: 'Reinildo', starPos: 'DEF', region: 'LUSO',
            history: [],
            stadiums: ['Estádio Nacional do Zimpeto', 'Estádio da Machava', 'Estádio do Costa do Sol', 'Campo do Ferroviário']
        },

        // GROUPE C
        {
            n: 'Sénégal', code: 'SEN', ovr: 86, style: 'Impact', star: 'S. Mané', starPos: 'FWD', region: 'WEST_FRANCO',
            history: [2021],
            stadiums: ['Stade Abdoulaye Wade', 'Stade Léopold Sédar Senghor', 'Stade Lat-Dior', 'Stade Aline Sitoe Diatta']
        },
        {
            n: 'Cameroun', code: 'CMR', ovr: 82, style: 'Puissance', star: 'V. Aboubakar', starPos: 'FWD', region: 'CENTRAL',
            history: [1984, 1988, 2000, 2002, 2017],
            stadiums: ['Stade d\'Olembé', 'Stade de Japoma', 'Stade Ahmadou Ahidjo', 'Stade Roumdé Adjia']
        },
        {
            n: 'Guinée', code: 'GUI', ovr: 77, style: 'Créativité', star: 'S. Guirassy', starPos: 'FWD', region: 'WEST_FRANCO',
            history: [],
            stadiums: ['Stade Général Lansana Conté', 'Stade du 28 Septembre', 'Stade de Nongo', 'Stade de Kankan']
        },
        {
            n: 'Gambie', code: 'GAM', ovr: 74, style: 'Défensif', star: 'M. Barrow', starPos: 'FWD', region: 'WEST_ANGLO',
            history: [],
            stadiums: ['Independence Stadium', 'Box Bar Mini Stadium', 'Serrekunda East', 'Brikama Box Bar']
        },

        // GROUPE D
        {
            n: 'Algérie', code: 'ALG', ovr: 83, style: 'Technique', star: 'R. Mahrez', starPos: 'FWD', region: 'NORTH',
            history: [1990, 2019],
            stadiums: ['Stade Nelson Mandela', 'Stade du 5 Juillet', 'Stade Miloud Hadefi', 'Stade du 19 Mai 1956']
        },
        {
            n: 'Burkina Faso', code: 'BFA', ovr: 79, style: 'Vitesse', star: 'E. Tapsoba', starPos: 'DEF', region: 'WEST_FRANCO',
            history: [],
            stadiums: ['Stade du 4-Août', 'Stade Municipal de Ouagadougou', 'Stade Sangoulé Lamizana', 'Stade Wobi']
        },
        {
            n: 'Mauritanie', code: 'MTN', ovr: 73, style: 'Lutte', star: 'A. Koita', starPos: 'FWD', region: 'NORTH',
            history: [],
            stadiums: ['Stade Cheikha Ould Boïdiya', 'Stade Olympique de Nouakchott', 'Stade de Nouadhibou', 'Stade de Zouérate']
        },
        {
            n: 'Angola', code: 'ANG', ovr: 76, style: 'Bloc Bas', star: 'G. Dala', starPos: 'FWD', region: 'LUSO',
            history: [],
            stadiums: ['Estádio 11 de Novembro', 'Estádio Nacional de Ombaka', 'Estádio Nacional da Tundavala', 'Estádio Nacional do Chiazi']
        },

        // GROUPE E
        {
            n: 'Tunisie', code: 'TUN', ovr: 81, style: 'Bloc Bas', star: 'Y. Msakni', starPos: 'FWD', region: 'NORTH',
            history: [2004],
            stadiums: ['Stade Olympique de Radès', 'Stade Mustapha Ben Jannet', 'Stade Taïeb Mhiri', 'Stade Olympique de Sousse']
        },
        {
            n: 'Mali', code: 'MLI', ovr: 81, style: 'Pressing', star: 'Y. Bissouma', starPos: 'MID', region: 'WEST_FRANCO',
            history: [],
            stadiums: ['Stade du 26 Mars', 'Stade Modibo Keïta', 'Stade Babemba Traoré', 'Stade Amari Daou']
        },
        {
            n: 'Afrique du Sud', code: 'RSA', ovr: 78, style: 'Collectif', star: 'P. Tau', starPos: 'FWD', region: 'SOUTH_EAST',
            history: [1996],
            stadiums: ['FNB Stadium (Soccer City)', 'Moses Mabhida Stadium', 'Cape Town Stadium', 'Nelson Mandela Bay Stadium']
        },
        {
            n: 'Namibie', code: 'NAM', ovr: 71, style: 'Solidité', star: 'P. Shalulile', starPos: 'FWD', region: 'SOUTH_EAST',
            history: [],
            stadiums: ['Sam Nujoma Stadium', 'Independence Stadium', 'Swakopmund FC Stadium', 'Kuisebmond Stadium']
        },

        // GROUPE F
        {
            n: 'Maroc', code: 'MAR', ovr: 87, style: 'Tiki-Taka', star: 'A. Hakimi', starPos: 'DEF', region: 'NORTH',
            history: [1976],
            stadiums: ['Stade Mohammed V', 'Complexe Moulay Abdellah', 'Grand Stade de Tanger', 'Grand Stade de Marrakech']
        },
        {
            n: 'RD Congo', code: 'RDC', ovr: 79, style: 'Dribbles', star: 'C. Mbemba', starPos: 'DEF', region: 'CENTRAL',
            history: [1968, 1974],
            stadiums: ['Stade des Martyrs', 'Stade Tata Raphaël', 'Stade TP Mazembe', 'Stade Kibassa Maliba']
        },
        {
            n: 'Zambie', code: 'ZAM', ovr: 73, style: 'Vitesse', star: 'P. Daka', starPos: 'FWD', region: 'SOUTH_EAST',
            history: [2012],
            stadiums: ['National Heroes Stadium', 'Levy Mwanawasa Stadium', 'Nkoloma Stadium', 'Sunset Stadium']
        },
        {
            n: 'Tanzanie', code: 'TAN', ovr: 71, style: 'Courage', star: 'M. Samatta', starPos: 'FWD', region: 'SOUTH_EAST',
            history: [],
            stadiums: ['Benjamin Mkapa National Stadium', 'Uhuru Stadium', 'CCM Kirumba Stadium', 'Azam Complex Stadium']
        }
    ];
    // --- NOUVEAU : SYSTÈME DE PROFILS DE JEU ---
const PLAYER_ROLES_DB = {
'GK': {
    'Mur': { label: 'Mur Infranchissable', desc: 'Expert sur sa ligne, réflexes purs.', bonus: { ref: 10, pos: 5 } },
    'Libero': { label: 'Gardien Libéro', desc: 'Joue haut et participe à la relance.', bonus: { kic: 10, spd: 5 } }
},
'DEF': {
    'Lateral': { label: 'Latéral Offensif', desc: 'Monte sans cesse pour centrer.', bonus: { pac: 8, pas: 5, def: -5 } },
    'Stoppeur': { label: 'Stoppeur (Roc)', desc: 'Un mur physique, imprenable en duel.', bonus: { phy: 10, def: 8, pac: -5 } },
    'Relanceur': { label: 'Relanceur', desc: 'Défenseur élégant, première passe propre.', bonus: { pas: 10, dri: 5, phy: -5 } }
},
'MID': {
    'Sentinelle': { label: 'Sentinelle', desc: 'Reste devant la défense, gratte les ballons.', bonus: { def: 10, phy: 8, sho: -10 } },
    'BoxBox': { label: 'Box-to-Box', desc: 'Infatigable, présent en attaque et en défense.', bonus: { pac: 5, phy: 10, pas: 5 } },
    'Maestro': { label: 'Maestro (Meneur)', desc: 'Le n°10. Vision du jeu et passes lasers.', bonus: { pas: 12, dri: 8, def: -10 } }
},
'FWD': {
    'Ailier': { label: 'Ailier Foudroyant', desc: 'Dribbleur rapide collé à la ligne de touche.', bonus: { pac: 12, dri: 10, phy: -5 } },
    'Renard': { label: 'Renard des Surfaces', desc: 'Toujours bien placé pour finir l\'action.', bonus: { sho: 12, pos: 10, pas: -5 } },
    'Pivot': { label: 'Pivot (Target Man)', desc: 'Joue dos au but, pèse sur la défense.', bonus: { phy: 12, he: 10, pac: -10 } }
}
};

  // --- 1. FONCTION UTILITAIRE (Pour écrire moins de code) ---
// n=Nom, p=Pos, o=Ovr, a=Age, r=Role (starter/sub), s=Slot (0-10)
// Fonction utilitaire intelligente : Elle génère la vitesse automatiquement si elle manque !
const p = (n, pos, o, a, r='sub', s=null) => {
    // Génération automatique de la vitesse selon le poste pour le réalisme
    let autoSpd = 70;
    // Les attaquants sont rapides (80-92), les défenseurs solides (70-80), les gardiens lents
    if (pos === 'FWD') autoSpd = 82 + Math.floor(Math.random() * 12);
    else if (pos === 'MID') autoSpd = 75 + Math.floor(Math.random() * 10);
    else if (pos === 'DEF') autoSpd = 70 + Math.floor(Math.random() * 10);
    else if (pos === 'GK') autoSpd = 40 + Math.floor(Math.random() * 10);

    return { name: n, pos: pos, ovr: o, age: a, role: r, slot: s, spd: autoSpd };
};

const REAL_SQUADS_DB = {
    // GROUPE A
    'CIV': [
        p("Y. Fofana", "GK", 82, 25, 'starter', 0), p("W. Singo", "DEF", 81, 24, 'starter', 1), p("E. Ndicka", "DEF", 84, 25, 'starter', 2), p("O. Kossounou", "DEF", 83, 24, 'starter', 3), p("G. Konan", "DEF", 79, 29, 'starter', 4),
        p("F. Kessié", "MID", 86, 28, 'starter', 5), p("S. Fofana", "MID", 84, 29, 'starter', 6), p("I. Sangaré", "MID", 82, 27, 'starter', 7),
        p("S. Adingra", "FWD", 83, 23, 'starter', 8), p("S. Haller", "FWD", 83, 30, 'starter', 9), p("O. Diakité", "FWD", 80, 21, 'starter', 10),
        p("B. Sangaré", "GK", 75, 38), p("W. Boly", "DEF", 78, 34), p("Ismael Diallo", "DEF", 76, 28), p("J. Seri", "MID", 79, 33), p("J. Boga", "FWD", 80, 28), p("N. Pépé", "FWD", 79, 29), p("J. Krasso", "FWD", 78, 27)
    ],
    'NGA': [
        p("S. Nwabali", "GK", 79, 28, 'starter', 0), p("O. Aina", "DEF", 79, 28, 'starter', 1), p("W. Ekong", "DEF", 81, 31, 'starter', 2), p("C. Bassey", "DEF", 81, 25, 'starter', 3), p("Z. Sanusi", "DEF", 78, 27, 'starter', 4),
        p("W. Ndidi", "MID", 83, 28, 'starter', 5), p("A. Iwobi", "MID", 80, 28, 'starter', 6), p("F. Onyeka", "MID", 78, 27, 'starter', 7),
        p("A. Lookman", "FWD", 85, 27, 'starter', 8), p("V. Osimhen", "FWD", 88, 26, 'starter', 9), p("V. Boniface", "FWD", 84, 24, 'starter', 10),
        p("F. Uzoho", "GK", 74, 26), p("S. Ajayi", "DEF", 77, 31), p("J. Aribo", "MID", 77, 28), p("S. Chukwueze", "FWD", 81, 25), p("M. Simon", "FWD", 79, 29), p("K. Iheanacho", "FWD", 79, 28)
    ],
    'GNQ': [
        p("J. Owono", "GK", 76, 23, 'starter', 0), p("C. Akapo", "DEF", 77, 31, 'starter', 1), p("S. Coco", "DEF", 78, 25, 'starter', 2), p("E. Orozco", "DEF", 74, 31, 'starter', 3), p("B. Ndong", "DEF", 74, 25, 'starter', 4),
        p("P. Ganet", "MID", 77, 29, 'starter', 5), p("F. Bikoro", "MID", 76, 28, 'starter', 6), p("J. Machin", "MID", 76, 28, 'starter', 7),
        p("I. Salvador", "FWD", 78, 29, 'starter', 8), p("E. Nsue", "FWD", 79, 35, 'starter', 9), p("Josete Miranda", "FWD", 76, 26, 'starter', 10),
        p("A. Sapunga", "GK", 70, 32), p("N. Anieboh", "DEF", 72, 27), p("J. Buyla", "MID", 74, 24), p("Luis Nlavo", "FWD", 74, 22), p("O. Siafa", "FWD", 71, 27)
    ],
    'GNB': [
        p("O. Djoco", "GK", 74, 26, 'starter', 0), p("H. Mendes", "DEF", 75, 27, 'starter', 1), p("O. Sangante", "DEF", 75, 33, 'starter', 2), p("Marcelo Djalo", "DEF", 73, 31, 'starter', 3), p("F. Cande", "DEF", 74, 27, 'starter', 4),
        p("Alfa Semedo", "MID", 76, 27, 'starter', 5), p("J. Bikel", "MID", 74, 29, 'starter', 6), p("Moreto Cassama", "MID", 75, 27, 'starter', 7),
        p("Mama Balde", "FWD", 78, 29, 'starter', 8), p("Franculino", "FWD", 76, 20, 'starter', 9), p("C. Mane", "FWD", 75, 30, 'starter', 10),
        p("J. Mendes", "GK", 72, 31), p("E. Ie", "DEF", 73, 30), p("Dalcio", "MID", 74, 28), p("Z. Turbo", "FWD", 73, 28)
    ],

    // GROUPE B
    'EGY': [
        p("M. El Shenawy", "GK", 83, 36, 'starter', 0), p("M. Hany", "DEF", 78, 29, 'starter', 1), p("A. Hegazi", "DEF", 80, 33, 'starter', 2), p("M. Abdelmonem", "DEF", 82, 25, 'starter', 3), p("A. Fotouh", "DEF", 78, 26, 'starter', 4),
        p("M. Elneny", "MID", 80, 32, 'starter', 5), p("H. Fathi", "MID", 79, 29, 'starter', 6), p("Emam Ashour", "MID", 81, 26, 'starter', 7),
        p("M. Salah", "FWD", 89, 32, 'starter', 8), p("M. Mohamed", "FWD", 82, 27, 'starter', 9), p("Trezeguet", "FWD", 81, 30, 'starter', 10),
        p("M. Abou Gabal", "GK", 78, 35), p("A. Gabr", "DEF", 76, 35), p("Zizo", "MID", 80, 28), p("O. Marmoush", "FWD", 83, 25), p("Kahraba", "FWD", 78, 30)
    ],
    'GHA': [
        p("R. Ofori", "GK", 76, 31, 'starter', 0), p("D. Odoi", "DEF", 75, 36, 'starter', 1), p("A. Djiku", "DEF", 80, 30, 'starter', 2), p("M. Salisu", "DEF", 81, 25, 'starter', 3), p("G. Mensah", "DEF", 76, 26, 'starter', 4),
        p("T. Partey", "MID", 83, 31, 'starter', 5), p("S. Samed", "MID", 79, 24, 'starter', 6), p("M. Kudus", "MID", 85, 24, 'starter', 7),
        p("J. Ayew", "FWD", 79, 33, 'starter', 8), p("I. Williams", "FWD", 82, 30, 'starter', 9), p("A. Semenyo", "FWD", 80, 24, 'starter', 10),
        p("L. Ati-Zigi", "GK", 76, 28), p("D. Amartey", "DEF", 77, 30), p("T. Lamptey", "DEF", 78, 24), p("A. Ayew", "MID", 78, 35), p("E. Nuamah", "FWD", 76, 21)
    ],
    'CPV': [
        p("Vozinha", "GK", 75, 38, 'starter', 0), p("Steven Moreira", "DEF", 76, 30, 'starter', 1), p("Logan Costa", "DEF", 79, 23, 'starter', 2), p("Pico", "DEF", 76, 32, 'starter', 3), p("Joao Paulo", "DEF", 75, 26, 'starter', 4),
        p("K. Pina", "MID", 76, 27, 'starter', 5), p("J. Monteiro", "MID", 77, 30, 'starter', 6), p("Deroy Duarte", "MID", 75, 25, 'starter', 7),
        p("Ryan Mendes", "FWD", 78, 34, 'starter', 8), p("Bebe", "FWD", 76, 34, 'starter', 9), p("Garry Rodrigues", "FWD", 77, 34, 'starter', 10),
        p("Marcio Rosa", "GK", 71, 27), p("Stopira", "DEF", 74, 36), p("Cuca", "MID", 74, 33), p("J. Cabral", "FWD", 77, 26)
    ],
    'MOZ': [
        p("Ernani", "GK", 72, 26, 'starter', 0), p("Domingos", "DEF", 71, 25, 'starter', 1), p("Mexer", "DEF", 76, 36, 'starter', 2), p("Edmilson", "DEF", 74, 30, 'starter', 3), p("Reinildo", "DEF", 81, 30, 'starter', 4),
        p("Guima", "MID", 73, 29, 'starter', 5), p("Amade", "MID", 72, 25, 'starter', 6), p("Dominguês", "MID", 75, 41, 'starter', 7),
        p("Witi", "FWD", 75, 28, 'starter', 8), p("Stanley Ratifo", "FWD", 72, 30, 'starter', 9), p("G. Catamo", "FWD", 79, 23, 'starter', 10),
        p("Ivane", "GK", 69, 28), p("Bruno Langa", "DEF", 74, 27), p("Shaquille", "MID", 70, 27), p("Clesio", "FWD", 73, 30)
    ],

    // GROUPE C
    'SEN': [
        p("E. Mendy", "GK", 84, 33, 'starter', 0), p("K. Diatta", "DEF", 78, 26, 'starter', 1), p("K. Koulibaly", "DEF", 85, 34, 'starter', 2), p("M. Niakhaté", "DEF", 81, 29, 'starter', 3), p("I. Jakobs", "DEF", 79, 26, 'starter', 4),
        p("P.M. Sarr", "MID", 83, 23, 'starter', 5), p("L. Camara", "MID", 80, 21, 'starter', 6), p("I. Gueye", "MID", 80, 36, 'starter', 7),
        p("I. Sarr", "FWD", 82, 27, 'starter', 8), p("N. Jackson", "FWD", 84, 24, 'starter', 9), p("S. Mané", "FWD", 86, 33, 'starter', 10),
        p("M. Diaw", "GK", 77, 31), p("A. Diallo", "DEF", 79, 29), p("F. Mendy", "DEF", 76, 30), p("P. Gueye", "MID", 78, 26), p("N. Mendy", "MID", 77, 33), p("H. Diallo", "FWD", 78, 30), p("I. Ndiaye", "FWD", 80, 25), p("B. Dieng", "FWD", 76, 25)
    ],
    'CMR': [
        p("A. Onana", "GK", 85, 29, 'starter', 0), p("Castelletto", "DEF", 79, 30, 'starter', 1), p("C. Wooh", "DEF", 78, 23, 'starter', 2), p("H. Moukoudi", "DEF", 77, 27, 'starter', 3), p("N. Tolo", "DEF", 76, 28, 'starter', 4),
        p("Z. Anguissa", "MID", 84, 30, 'starter', 5), p("O. Ntcham", "MID", 78, 29, 'starter', 6), p("Y. Neyou", "MID", 76, 28, 'starter', 7),
        p("B. Mbeumo", "FWD", 83, 26, 'starter', 8), p("V. Aboubakar", "FWD", 81, 33, 'starter', 9), p("G. Nkoudou", "FWD", 79, 30, 'starter', 10),
        p("F. Ondoa", "GK", 75, 30), p("J. Onguene", "DEF", 76, 27), p("M. Hongla", "MID", 77, 27), p("K. Toko Ekambi", "FWD", 79, 33), p("F. Magri", "FWD", 75, 25)
    ],
    'GUI': [
        p("I. Kone", "GK", 74, 26, 'starter', 0), p("I. Sylla", "DEF", 76, 31, 'starter', 1), p("M. Diakhaby", "DEF", 79, 28, 'starter', 2), p("J. Jeanvier", "DEF", 75, 33, 'starter', 3), p("A. Conte", "DEF", 73, 28, 'starter', 4),
        p("A. Diawara", "MID", 77, 28, 'starter', 5), p("N. Keita", "MID", 79, 30, 'starter', 6), p("A. Camara", "MID", 78, 28, 'starter', 7),
        p("M. Guilavogui", "FWD", 75, 27, 'starter', 8), p("S. Guirassy", "FWD", 85, 29, 'starter', 9), p("M. Bayo", "FWD", 78, 27, 'starter', 10),
        p("A. Keita", "GK", 72, 34), p("S. Sow", "DEF", 75, 28), p("I. Moriba", "MID", 76, 22), p("F. Kamano", "FWD", 77, 29)
    ],
    'GAM': [
        p("B. Gaye", "GK", 73, 27, 'starter', 0), p("S. Janko", "DEF", 74, 29, 'starter', 1), p("O. Colley", "DEF", 78, 32, 'starter', 2), p("J. Gomez", "DEF", 74, 23, 'starter', 3), p("I. Touray", "DEF", 72, 30, 'starter', 4),
        p("A. Jallow", "MID", 75, 29, 'starter', 5), p("E. Adams", "MID", 74, 29, 'starter', 6), p("E. Darboe", "MID", 74, 23, 'starter', 7),
        p("Y. Minteh", "FWD", 78, 21, 'starter', 8), p("M. Barrow", "FWD", 77, 32, 'starter', 9), p("A. Fadera", "FWD", 75, 23, 'starter', 10),
        p("M. Jobe", "GK", 68, 36), p("B. Sanneh", "DEF", 73, 29), p("E. Colley", "FWD", 74, 25), p("A. Ceesay", "FWD", 75, 31)
    ],

    // GROUPE D
    'ALG': [
        p("A. Mandrea", "GK", 78, 29, 'starter', 0), p("Y. Atal", "DEF", 79, 29, 'starter', 1), p("A. Mandi", "DEF", 80, 34, 'starter', 2), p("R. Bensebaini", "DEF", 82, 30, 'starter', 3), p("R. Ait-Nouri", "DEF", 83, 24, 'starter', 4),
        p("I. Bennacer", "MID", 85, 28, 'starter', 5), p("R. Zerrouki", "MID", 78, 27, 'starter', 6), p("H. Aouar", "MID", 82, 27, 'starter', 7),
        p("R. Mahrez", "FWD", 83, 34, 'starter', 8), p("B. Bounedjah", "FWD", 80, 34, 'starter', 9), p("M. Amoura", "FWD", 81, 25, 'starter', 10),
        p("M. Zeghba", "GK", 75, 35), p("A. Tougain", "DEF", 76, 26), p("N. Bentaleb", "MID", 79, 31), p("F. Chaibi", "MID", 80, 23), p("S. Benrahma", "FWD", 80, 30), p("A. Gouiri", "FWD", 81, 25), p("Y. Belaili", "FWD", 79, 33)
    ],
    'BFA': [
        p("H. Koffi", "GK", 78, 28, 'starter', 0), p("I. Kabore", "DEF", 77, 24, 'starter', 1), p("E. Tapsoba", "DEF", 84, 26, 'starter', 2), p("I. Dayo", "DEF", 78, 33, 'starter', 3), p("A. Yago", "DEF", 74, 32, 'starter', 4),
        p("B. Toure", "MID", 78, 30, 'starter', 5), p("A. Guira", "MID", 75, 37, 'starter', 6), p("G. Sangare", "MID", 76, 28, 'starter', 7),
        p("B. Traore", "FWD", 81, 30, 'starter', 8), p("D. Ouattara", "FWD", 80, 23, 'starter', 9), p("A. Tapsoba", "FWD", 76, 26, 'starter', 10),
        p("K. Nikiema", "GK", 71, 21), p("N. Djiga", "DEF", 75, 22), p("I. Ouedraogo", "MID", 74, 25), p("C. Badolo", "FWD", 75, 27)
    ],
    'MTN': [
        p("B. Niasse", "GK", 73, 28, 'starter', 0), p("I. Keita", "DEF", 72, 23, 'starter', 1), p("L. Ba", "DEF", 74, 26, 'starter', 2), p("K. Dellahi", "DEF", 73, 33, 'starter', 3), p("A. Abeid", "DEF", 72, 27, 'starter', 4),
        p("G. Fofana", "MID", 74, 30, 'starter', 5), p("O. Gassama", "MID", 73, 29, 'starter', 6), p("B. Mouhsine", "MID", 72, 27, 'starter', 7),
        p("A. Koita", "FWD", 76, 26, 'starter', 8), p("A. Kamara", "FWD", 74, 30, 'starter', 9), p("S. Amar", "FWD", 73, 25, 'starter', 10),
        p("N. Diaw", "GK", 70, 30), p("H. Houbeib", "DEF", 71, 31), p("H. Tanjy", "FWD", 74, 27), p("P. Ba", "FWD", 73, 26)
    ],
    'ANG': [
        p("Neblu", "GK", 74, 27, 'starter', 0), p("Eddie", "DEF", 72, 30, 'starter', 1), p("K. Gaspar", "DEF", 78, 31, 'starter', 2), p("J. Buatu", "DEF", 75, 31, 'starter', 3), p("To Carneiro", "DEF", 73, 29, 'starter', 4),
        p("Show", "MID", 76, 26, 'starter', 5), p("Fredy", "MID", 77, 35, 'starter', 6), p("Estrela", "MID", 74, 29, 'starter', 7),
        p("G. Dala", "FWD", 79, 29, 'starter', 8), p("Mabululu", "FWD", 78, 32, 'starter', 9), p("Gilberto", "FWD", 77, 24, 'starter', 10),
        p("Kadu", "GK", 71, 30), p("L. Nurio", "DEF", 74, 27), p("Zini", "FWD", 76, 22), p("Jeremie Bela", "FWD", 74, 32)
    ],

    // GROUPE E
    'TUN': [
        p("B. Ben Said", "GK", 77, 29, 'starter', 0), p("W. Kechrida", "DEF", 76, 29, 'starter', 1), p("M. Talbi", "DEF", 81, 27, 'starter', 2), p("Y. Meriah", "DEF", 79, 31, 'starter', 3), p("A. Abdi", "DEF", 77, 31, 'starter', 4),
        p("E. Skhiri", "MID", 83, 30, 'starter', 5), p("A. Laidouni", "MID", 79, 28, 'starter', 6), p("M. Ben Romdhane", "MID", 78, 25, 'starter', 7),
        p("H. Rafia", "FWD", 77, 26, 'starter', 8), p("Y. Msakni", "FWD", 80, 35, 'starter', 9), p("E. Achouri", "FWD", 78, 26, 'starter', 10),
        p("A. Dahmen", "GK", 75, 28), p("O. Haddadi", "DEF", 75, 33), p("H. Mejbri", "MID", 77, 22), p("N. Sliti", "FWD", 77, 33), p("S. Jaziri", "FWD", 76, 32)
    ],
    'MLI': [
        p("D. Diarra", "GK", 75, 30, 'starter', 0), p("H. Traore", "DEF", 80, 33, 'starter', 1), p("K. Kouyate", "DEF", 78, 28, 'starter', 2), p("S. Niakate", "DEF", 77, 26, 'starter', 3), p("F. Sacko", "DEF", 76, 30, 'starter', 4),
        p("A. Haidara", "MID", 81, 27, 'starter', 5), p("Y. Bissouma", "MID", 83, 29, 'starter', 6), p("L. Coulibaly", "MID", 77, 29, 'starter', 7),
        p("L. Sinayoko", "FWD", 78, 25, 'starter', 8), p("S. Koita", "FWD", 79, 25, 'starter', 9), p("K. Doumbia", "FWD", 80, 22, 'starter', 10),
        p("I. Diawara", "GK", 72, 31), p("M. Fofana", "DEF", 74, 26), p("M. Camara", "MID", 80, 25), p("M. Djenepo", "FWD", 77, 27), p("Y. Niakate", "FWD", 76, 32)
    ],
    'RSA': [
        p("R. Williams", "GK", 80, 33, 'starter', 0), p("K. Mudau", "DEF", 78, 30, 'starter', 1), p("M. Mvala", "DEF", 76, 31, 'starter', 2), p("G. Kekana", "DEF", 75, 33, 'starter', 3), p("A. Modiba", "DEF", 76, 30, 'starter', 4),
        p("T. Mokoena", "MID", 81, 28, 'starter', 5), p("S. Sithole", "MID", 75, 26, 'starter', 6), p("T. Zwane", "MID", 79, 36, 'starter', 7),
        p("P. Tau", "FWD", 80, 31, 'starter', 8), p("E. Makgopa", "FWD", 74, 25, 'starter', 9), p("T. Morena", "FWD", 76, 31, 'starter', 10),
        p("V. Mothwa", "GK", 72, 34), p("N. Sibisi", "DEF", 74, 29), p("J. Adams", "MID", 74, 23), p("L. Lepasa", "FWD", 74, 28)
    ],
    'NAM': [
        p("L. Kazapua", "GK", 72, 27, 'starter', 0), p("R. Nyambe", "DEF", 73, 27, 'starter', 1), p("K. Amutenya", "DEF", 70, 30, 'starter', 2), p("L. Haukongo", "DEF", 71, 24, 'starter', 3), p("R. Hanamub", "DEF", 73, 29, 'starter', 4),
        p("A. Petrus", "MID", 72, 26, 'starter', 5), p("P. Tjiueza", "MID", 74, 23, 'starter', 6), p("N. Katua", "MID", 70, 24, 'starter', 7),
        p("D. Hotto", "FWD", 75, 33, 'starter', 8), p("P. Shalulile", "FWD", 77, 31, 'starter', 9), p("B. Muzeu", "FWD", 72, 25, 'starter', 10),
        p("E. Kamaijanda", "GK", 66, 26), p("C. Hambira", "DEF", 69, 34), p("P. Shitembi", "MID", 71, 33), p("W. Rudath", "FWD", 71, 34)
    ],

    // GROUPE F
    'MAR': [
        p("Y. Bounou", "GK", 86, 34, 'starter', 0), p("A. Hakimi", "DEF", 88, 27, 'starter', 1), p("N. Aguerd", "DEF", 83, 29, 'starter', 2), p("R. Saiss", "DEF", 80, 35, 'starter', 3), p("N. Mazraoui", "DEF", 84, 28, 'starter', 4),
        p("S. Amrabat", "MID", 84, 29, 'starter', 5), p("A. Ounahi", "MID", 81, 25, 'starter', 6), p("B. Diaz", "MID", 85, 26, 'starter', 7),
        p("H. Ziyech", "FWD", 83, 32, 'starter', 8), p("Y. En-Nesyri", "FWD", 84, 28, 'starter', 9), p("A. Adli", "FWD", 80, 25, 'starter', 10),
        p("Munir", "GK", 77, 36), p("A. Masina", "DEF", 76, 31), p("A. Harit", "MID", 80, 28), p("S. Boufal", "FWD", 79, 32), p("A. El Kaabi", "FWD", 78, 32), p("Ez Abde", "FWD", 79, 24)
    ],
    'RDC': [
        p("L. Mpasi", "GK", 76, 30, 'starter', 0), p("G. Kalulu", "DEF", 76, 27, 'starter', 1), p("C. Mbemba", "DEF", 83, 31, 'starter', 2), p("D. Batubinsika", "DEF", 77, 29, 'starter', 3), p("A. Masuaku", "DEF", 78, 31, 'starter', 4),
        p("S. Moutoussamy", "MID", 77, 29, 'starter', 5), p("C. Pickel", "MID", 76, 28, 'starter', 6), p("G. Kakuta", "MID", 79, 34, 'starter', 7),
        p("M. Elia", "FWD", 78, 28, 'starter', 8), p("Y. Wissa", "FWD", 81, 29, 'starter', 9), p("Theo Bongonda", "FWD", 78, 29, 'starter', 10),
        p("D. Bertaud", "GK", 75, 31), p("H. Inonga", "DEF", 76, 31), p("G. Diangana", "FWD", 77, 27), p("S. Silas", "FWD", 78, 26), p("C. Bakambu", "FWD", 79, 34), p("F. Mayele", "FWD", 76, 31)
    ],
    'ZAM': [
        p("L. Mulenga", "GK", 72, 30, 'starter', 0), p("T. Mwape", "DEF", 71, 28, 'starter', 1), p("S. Sunzu", "DEF", 74, 36, 'starter', 2), p("F. Musonda", "DEF", 72, 30, 'starter', 3), p("R. Kabwe", "DEF", 71, 29, 'starter', 4),
        p("E. Banda", "MID", 74, 27, 'starter', 5), p("K. Kapumbu", "MID", 72, 29, 'starter', 6), p("K. Kangwa", "MID", 76, 26, 'starter', 7),
        p("L. Banda", "FWD", 75, 23, 'starter', 8), p("P. Daka", "FWD", 80, 26, 'starter', 9), p("F. Sakala", "FWD", 77, 28, 'starter', 10),
        p("T. Nsabata", "GK", 69, 34), p("G. Mafwenta", "DEF", 70, 24), p("C. Chama", "MID", 73, 33), p("E. Chilufya", "FWD", 74, 25)
    ],
    'TAN': [
        p("A. Manula", "GK", 73, 30, 'starter', 0), p("H. Mnoga", "DEF", 71, 23, 'starter', 1), p("B. Nondo", "DEF", 72, 29, 'starter', 2), p("I. Hamad", "DEF", 72, 28, 'starter', 3), p("M. Hussein", "DEF", 71, 29, 'starter', 4),
        p("N. Miroshi", "MID", 74, 22, 'starter', 5), p("H. Mao", "MID", 72, 33, 'starter', 6), p("F. Salum", "MID", 73, 31, 'starter', 7),
        p("S. Msuva", "FWD", 75, 31, 'starter', 8), p("M. Samatta", "FWD", 77, 32, 'starter', 9), p("K. Denis", "FWD", 71, 26, 'starter', 10),
        p("B. Kakolanya", "GK", 68, 30), p("D. Job", "DEF", 70, 27), p("M. Abraham", "MID", 71, 22), p("C. M'Mombwa", "FWD", 72, 27)
    ]
};

    // Position du GK à 80% pour visibilité
    const FORMATIONS = {
        '4-3-3': { coords:[{x:41,y:80},{x:8,y:60},{x:30,y:65},{x:52,y:65},{x:74,y:60},{x:20,y:40},{x:41,y:45},{x:62,y:40},{x:8,y:15},{x:41,y:10},{x:74,y:15}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","FWD","FWD","FWD"]},
        '4-4-2': { coords:[{x:41,y:80},{x:8,y:60},{x:30,y:65},{x:52,y:65},{x:74,y:60},{x:8,y:38},{x:30,y:42},{x:52,y:42},{x:74,y:38},{x:25,y:10},{x:57,y:10}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","FWD","FWD"]},
        '3-5-2': { coords:[{x:41,y:80},{x:15,y:65},{x:41,y:68},{x:67,y:65},{x:5,y:42},{x:25,y:46},{x:41,y:52},{x:57,y:46},{x:77,y:42},{x:30,y:10},{x:52,y:10}], zones: ["GK","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD","FWD"]},
        '4-2-3-1': { coords:[{x:41,y:80},{x:8,y:62},{x:30,y:67},{x:52,y:67},{x:74,y:62},{x:30,y:48},{x:52,y:48},{x:10,y:30},{x:41,y:32},{x:72,y:30},{x:41,y:10}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD"]},
        '4-1-4-1': { coords:[{x:41,y:80},{x:8,y:62},{x:30,y:67},{x:52,y:67},{x:74,y:62},{x:41,y:50},{x:10,y:35},{x:30,y:37},{x:52,y:37},{x:72,y:35},{x:41,y:12}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD"]},
        '5-4-1': { coords:[{x:41,y:80},{x:5,y:62},{x:23,y:65},{x:41,y:68},{x:59,y:65},{x:77,y:62},{x:10,y:38},{x:30,y:40},{x:52,y:40},{x:72,y:38},{x:41,y:12}], zones: ["GK","DEF","DEF","DEF","DEF","DEF","MID","MID","MID","MID","FWD"]}
    };


    const MATCH_COMMS = [
        "L'intensité monte d'un cran au milieu de terrain.", "L'arbitre surveille de près les duels physiques.",
        "Le public scande le nom des Eléphants !", "Interception propre de la charnière centrale.",
        "Belle relance vers l'avant, le jeu s'écarte.", "Le coach donne de la voix sur le bord de touche.",
        "Contact rugueux au milieu, l'arbitre ne dit rien.", "L'ambiance est électrique aujourd'hui.",
        "Débordement rapide on l'aile, centre à venir !", "Coup-franc dangereux à suivre à l'entrée de la surface.",
        "Le bloc défensif ivoirien est difficile à percer.", "Le rythme s'accélère soudainement.",
        "Parade exceptionnelle du portier !", "Faute tactique intelligente pour casser le contre.",
        "Le ballon circule bien entre les lignes.", "Supporters en liesse dans les tribunes !",
        "Tentative de loin ! Ça frôle le cadre adverse.", "Relance courte et maîtrisée.",
        "Fatigue visible chez certains cadres de l'équipe.", "Le quart d'heure de vérité approche.",
        "Geste technique superbe qui élimine un défenseur !", "Pressing haut étouffant pour l'adversaire.",
        "Sortie autoritaire on le corner adverse.", "Transition offensive rapide lancée par le milieu.",
        "La pluie commence à tomber on la pelouse.", "Erreur de relance... attention au contre !",
        "Le stade entier retient son souffle.", "Coup de sifflet important de l'arbitre central.",
        "Défense en bloc bas pour préserver le score.", "Longue transversale magnifique vers l'ailier.",
        "Crampons affûtés on ce tacle glissé.", "Le génie tactique du coach est mis à l'épreuve.",
        "Vent de panique dans la défense adverse.", "Solidité exemplaire de la part des latéraux.",
        "Match de guerriers aujourd'hui on le terrain !", "Une-deux superbe dans les petits espaces.",
        "Le poteau sauve le gardien on cette frappe !", "Contrôle orienté de classe internationale.",
        "L'adversaire commence à douter sérieusement.", "Supporters et joueurs ne font qu'un.",
        "Duel aérien remporté avec autorité par Ndicka.", "Coup-franc excentré qui peut amener le danger.",
        "Ballon sorti en touche sous la pression.", "Le portier motive bruyamment ses troupes.",
        "Chants de victoire qui descendent des travées !", "Occasion gâchée par un manque de précision.",
        "Dégagement aux poings salvateur du gardien.", "Suspense total dans cette fin de rencontre.",
        "Le match bascule dans une dimension tactique.", "Dernier assaut désespéré avant le sifflet !",
        "Le manager effectue ses derniers ajustements.", "Le marquage à la culotte est impitoyable.",
        "Une véritable partie de d'échecs on le gazon.", "Les drapeaux orange-blanc-vert s'agitent partout !",
        "Un supporter traverse le terrain ! Interruption de jeu.", "Le stade rugit on ce tacle salvateur.",
        "Le physique commence à prendre le dessus.", "Un exploit individuel est nécessaire pour débloquer le score.",
        "L'arbitre consulte son assistant on cette faute.", "Temps additionnel annoncé, tout peut encore arriver !",
        "Une frappe enroulée qui lèche le montant.", "Sortie de but pour le gardien adverse.",
        "Le marquage est impitoyable dans la zone de vérité.", "L'arbitre appelle les deux capitaines au calme.",
        "La transversale tremble encore !", "Changement tactique visible on le terrain.",
        "Le public se lève on cette action de classe.", "Faute signalée à l'entrée de la surface de réparation.",
        "Relance rapide à la main du gardien vers son latéral.", "CIV pousse fort dans les dernières minutes !",
        "Dégagement en catastrophe par la défense adverse.", "Interception magnifique au milieu de terrain.",
        "Le rythme s'accélère en cette fin de période.", "CIV invincibles aujourd'hui avec ce bloc compact !",
        "Le stade retient son souffle on ce corner direct.", "Exploit individuel à suivre ?",
        "Tir non cadré, ça passe largement au-dessus.", "Défense en bloc bas pour conserver le score.",
        "Belle transversale qui change l'aile.", "Coup de sifflet pour une position de hors-jeu.",
        "Le portier plonge dans les pieds de l'attaquant.", "CIV multiplie les passes courtes au milieu.",
        "L'adversaire ne parvient plus à sortir de son camp.", "Contact rugueux, l'arbitre sort le carton jaune !",
        "Le stade est en fusion on chaque dribble réussi.", "La possession est outrageusement ivoirienne.",
        "L'attaquant s'emmêle les pinceaux au moment de tirer.", "Parade réflexe incroyable on la ligne !",
        "Le coach adverse semble totalement désemparé.", "Ambiance de fête dans le stade, on entend les tambours !",
        "Le pressing haut étouffe complètement la relance adverse.", "Quelle vision de jeu on cette passe en profondeur !",
        "Corner à suivre pour les Eléphants.", "Le gardien s'impose dans les airs avec autorité.",
        "Friction entre deux joueurs, l'arbitre intervient vite.", "Une prestation solide qui rassure les supporters.",
        "Tout le stade pousse pour l'ouverture du score !", "CIV est en démonstration technique aujourd'hui.",
        "Ballon dégagé loin devant pour souffler un peu.", "Le rideau défensif est infranchissable pour le moment.",
        "CIV dicte son tempo avec une sérénité totale.", "Le manager ivoirien reste calme on son banc.",
        "L'odeur de la victoire commence à monter dans le stade.", "Quel régal pour les yeux ces combinaisons !",
        "L'arbitre vérifie le ballon avant de relancer.", "Les remplaçants terminent leur échauffement.",
        "Un vent de panique souffle on les buts adverses.", "Le milieu de terrain est un véritable champ de bataille.",
        "CIV fait preuve d'une maturité tactique impressionnante.", "Chaque touche de balle est un délice.",
        "L'adversaire tente le tout pour le tout.", "Le stade est plein comme un oeuf pour ce choc.",
        "Une frappe surpuissante qui finit dans les nuages.", "Le gardien relance très loin on son attaquant.",
        "CIV reste en place malgré la pression adverse.", "Un tacle de dernier recours qui sauve l'équipe.",
        "Le talent brut s'exprime enfin dans ce match.", "CIV gère parfaitement son avance pour le moment.",
        "Tacle assassin, mais l'arbitre ne bronche pas !", "Le gardien semble avoir un problème à la cuisse.",
        "Les supporters allument des fumigènes, quelle ambiance !", "L'arbitre regarde sa montre, la pression monte.",
        "Le sélectionneur adverse gesticule dans tous les sens.", "Le ballon a heurté le photographe derrière le but !",
        "Une chevauchée fantastique qui se termine en corner.", "La CIV impose un défi physique énorme.",
        "Le milieu de terrain adverse explose sous le pressing.", "Quel contrôle de la poitrine orienté, magnifique !",
        "La pelouse est un billard aujourd'hui.", "Le stade Ebimpé vibre à l'unisson.",
        "L'arbitre central discute avec son quatrième officiel.", "Le banc de touche bouillonne d'impatience.",
        "Une relance dans l'axe très risquée, mais ça passe.", "Le public siffle copieusement l'adversaire.",
        "Chaque corner est vécu comme un penalty par le stade.", "Le marquage est en zone on cette action.",
        "Quelle détente verticale on ce duel de la tête !", "Le match est haché par de nombreuses petites fautes.",
        "L'adversaire joue le contre à fond.", "Le bloc équipe est parfaitement coordonné.",
        "Un petit pont humiliant au milieu de terrain !", "Le défenseur dégage en touche sans réfléchir.",
        "Le meneur de jeu dicte le tempo du match.", "Les duels sont à la limite de la correction physique.",
        "Le gardien adverse gagne du temps on son dégagement.", "L'arbitre demande de recommencer le coup-franc.",
        "Une frappe de mule qui finit dans le petit filet extérieur !", "Le stade rugit de plaisir on ce geste technique.",
        "Le sélectionneur ivoirien appelle un remplaçant.", "Le capitaine réunit ses joueurs pour les motiver.",
        "Une erreur d'inattention qui aurait pu coûter cher.", "Le danger vient de partout pour l'adversaire !",
        "Le match entre dans sa phase critique.", "Un festival offensif se prépare peut-être.",
        "Le portier s'envole littéralement pour détourner ce cuir.", "L'ambiance est digne d'une finale de Coupe du Monde !",
        "Le jeu est arrêté pour soigner un joueur à terre.", "Le sélectionneur consulte ses notes tactiques.",
        "Un tacle millimétré qui soulève les foules.", "La possession tourne à la démonstration.",
        "L'adversaire n'a plus touché le ballon depuis 3 minutes.", "Un centre-tir vicieux qui termine on la barre !",
        "Le sifflet final approche, la tension est à son comble.", "Chaque passe est un poignard pour la défense adverse.",
        "Le génie de Yao Baba Ange Emmanuel opère encore.", "Une solidité à toute épreuve pour les Eléphants.",
        "La victoire se dessine petit à petit.", "Le stade est en transe complète !",
        "Une sortie de balle propre malgré le pressing adverse.", "Le jeu s'accélère on l'aile droite.",
        "Un centre fort devant le but qui ne trouve personne.", "Le gardien capte le ballon en deux temps.",
        "La défense adverse est au bord de la rupture.", "Un véritable cauchemar pour le latéral gauche adverse.",
        "Le match est d'une intensité rare pour un tournoi continental.", "Les joueurs donnent tout on le rectangle vert.",
        "Le maillot est mouillé, les guerriers sont là !", "Une passe aveugle qui déstabilise tout le bloc.",
        "Le ballon semble collé aux pieds de l'attaquant.", "Un sauvetage on la ligne de but, incroyable !",
        "Le poteau rentrant ? No, ça sort ! Quel dommage.", "La CIV est en contrôle total de l'événement.",
        "Une prestation qui fera date dans l'histoire de la nation.", "Le public ne s'arrête jamais de chanter.",
        "Un duel de Titans au milieu de la pelouse.", "Le sifflet retentit, mais c'est une faute pour nous !",
        "Le portier motive sa défense en criant fort.", "Le marquage est plus serré que jamais.",
        "Un éclair de génie pourrait tout débloquer.", "La CIV pousse, pousse et repousse encore !",
        "L'adversaire est acculé on son propre but.", "Un dégagement désespéré en corner.",
        "La montre tourne, les coeurs battent la chamade.", "Le staff technique est debout on le banc.",
        "Une communication parfaite entre les défenseurs centraux.", "Le portier ne prend aucun risque on cette frappe.",
        "Un changement tactique payant semble s'opérer.", "Le talent est partout aujourd'hui on le terrain.",
        "La fierté d'un peuple repose on ces 11 hommes.", "Une leçon de football est en cours.",
        "Le score ne reflète pas encore la domination.", "Le gardien adverse réalise le match de sa vie.",
        "Une glissade malheureuse qui redonne le ballon.", "Le pressing est coordonné comme une symphonie.",
        "Le public scande 'Allez les Eléphants' !", "Une frappe en pivot qui passe de peu à côté.",
        "Le sélectionneur encourage ses troupes du geste.", "Une interception vitale pour empêcher le face-à-face.",
        "Le jeu se déporte on l'autre aile rapidement.", "Une transversale de 50 mètres, un régal !",
        "Le latéral monte pour apporter le surnombre.", "Un repli défensif exemplaire de l'attaquant.",
        "Le manager regarde sa montre, le stress monte.", "Une ambiance de feu, le stade est en éruption !",
        "Le match est d'une propreté technique absolue.", "Une faute intelligente qui coupe le rythme adverse.",
        "Le gardien sort loin de ses buts pour dégager au pied.", "Une sérénité olympienne pour la défense ivoirienne.",
        "Le talent brut fait la différence on cette action.", "La CIV est plus proche que jamais du but !",
        "L'adversaire ne sait plus comment réagir tactiquement.", "Un vent d'optimisme souffle on les tribunes.",
        "Le match bascule dans la légende.", "Chaque seconde compte désormais.",
        "Un engagement de tous les instants.", "La sueur et les larmes pour la victoire.",
        "Le sifflet final sera une délivrance ou un drame.", "La CIV montre pourquoi elle est l'élite africaine.",
        "Une vision de jeu digne des plus grands meneurs.", "Le ballon circule avec une fluidité déconcertante.",
        "L'adversaire est totalement asphyxié par le pressing.", "Un arrêt réflexe de classe mondiale !",
        "Le stade est debout pour applaudir cette action.", "Une débauche d'énergie incroyable.",
        "Le manager Yao Baba peut être fier de ses hommes.", "La tactique est respectée à la lettre.",
        "Un exploit est possible en toute fin de match !", "Le sifflet de l'arbitre est le seul maître ici.",
        "La gloire attend les vainqueurs de ce choc.", "Le football africain est à son sommet aujourd'hui.",
        "Une maîtrise technique qui laisse pantois.", "L'adversaire tente un changement de dernière minute.",
        "Le portier réclame plus de concentration à ses gars.", "Un tacle propre qui récupère le ballon proprement.",
        "Le jeu est fluide, plaisant et très rapide.", "La CIV dicte sa loi on la pelouse du jour."
    ];

    // --- NOUVEAUX TABLEAUX DE COMMENTAIRES DYNAMIQUES ---
    const COMMS_WINNING = [
        "Le plan tactique de {MANAGER} fonctionne à merveille !",
        "Quelle masterclass de {MANAGER} aujourd'hui !",
        "Les supporters chantent le nom de {MANAGER} dans les tribunes !",
        "{MANAGER} reste impassible, mais son équipe déroule.",
        "La patte {MANAGER} se fait sentir sur cette action.",
        "C'est une leçon de football donnée par {MANAGER}.",
        "L'adversaire n'a aucune réponse face au système de {MANAGER}."
    ];

    const COMMS_LOSING = [
        "{MANAGER} hurle ses consignes pour réveiller les gars !",
        "{MANAGER} semble pensif sur son banc de touche.",
        "Il va falloir un coup de génie de {MANAGER} pour changer ça.",
        "{MANAGER} consulte son adjoint, un changement à venir ?",
        "Le visage fermé, {MANAGER} demande plus d'intensité."
    ];

    const COMMS_TACTICAL = {
        def: "{MANAGER} ordonne de fermer la boutique ! Tout le monde derrière !",
        att: "{MANAGER} fait de grands gestes : TOUT POUR L'ATTAQUE !",
        bal: "{MANAGER} demande de calmer le jeu et de reprendre la structure.",
        possession: "{MANAGER} veut qu'on prive l'adversaire de ballon.",
        counter: "{MANAGER} demande des transitions foudroyantes !",
        pressing: "Les joueurs répondent au pressing demandé par {MANAGER} !"
    };
    // --- NOUVEAU SYSTÈME DE COMMENTAIRES DYNAMIQUES ---

const ACTION_COMMS = {
dribble: [
    "Le passement de jambes de {PLAYER} ! C'est magnifique !",
    "{PLAYER} efface son vis-à-vis avec une facilité déconcertante !",
    "Dribble assassin de {PLAYER} qui laisse le défenseur sur place !",
    "Le petit pont de {PLAYER} ! Le public est debout !",
    "{PLAYER} danse avec le ballon, quel technicien !"
],
defense: [
    "Intervention de patron de {PLAYER} !",
    "{PLAYER} met son corps en opposition, c'est solide.",
    "Tacle glissé millimétré de {PLAYER} qui récupère le cuir.",
    "Le mur {PLAYER} repousse encore l'assaut !",
    "{PLAYER} lit parfaitement le jeu et coupe la passe."
],
shot: [
    "La frappe lourde de {PLAYER} ! Ça frôle la lucarne !",
    "{PLAYER} tente sa chance de loin... c'est capté.",
    "Quelle reprise de volée de {PLAYER} ! Le gardien a eu chaud.",
    "{PLAYER} dévisse sa frappe, dommage."
],
save: [
    "Parade exceptionnelle du gardien sur ce tir de {PLAYER} !",
    "Le portier s'envole pour sortir la tentative de {PLAYER} !"
]
};

const GOAL_COMMS = {
normal: [
    "Finition clinique de {PLAYER} !",
    "{PLAYER} ajuste le gardien du plat du pied.",
    "Quel sang-froid de {PLAYER} face au but !"
],
header: [
    "Tête impériale de {PLAYER} sur ce centre !",
    "{PLAYER} s'élève plus haut que tout le monde... ET BUT !",
    "Un coup de casque magistral signé {PLAYER} !"
],
volley: [
    "OH LE BUT ! Reprise de volée incroyable de {PLAYER} !",
    "{PLAYER} reprend le ballon sans contrôle... LUCARNE !"
],
freekick: [
    "COUP FRANC MAGNIFIQUE de {PLAYER} ! En pleine lucarne !",
    "La patte de velours de {PLAYER} nettoie la toile d'araignée !",
    "Le gardien reste immobile sur ce coup-franc de {PLAYER} !"
],
corner: [
    "Le corner est bien tiré... et {PLAYER} coupe au premier poteau !",
    "Cafouillage dans la surface, {PLAYER} traîne par là et marque !"
]
};

// Commentaires d'ambiance génériques (pour combler les vides)
const AMBIANCE_COMMS = [
"L'intensité monte d'un cran au milieu de terrain.",
"Les supporters donnent de la voix pour encourager l'équipe.",
"Le coach demande de calmer le jeu.",
"Grosse bataille physique pour la possession.",
"Une ola parcourt les tribunes du stade !",
"Les deux équipes se rendent coup pour coup."
];
    // --- NOUVEAU : BASE DE DONNÉES GAZETTE (VERSION XXL) ---
    // --- BASE DE DONNÉES MÉDIA "FICTION & IMMERSION" (100+ ENTRÉES) ---
const NEWS_DB = {
// A. SCOUTING & RECRUTEMENT (Le nerf de la guerre)
scouting: [
    "Le Chef Scout insiste : 'Il nous faut ce gamin de 17 ans qui joue au Mali !'",
    "Note Confidentielle : Un gardien titanesque évolue actuellement en D2 nigériane.",
    "Le Directeur Sportif a été aperçu dans un aéroport avec un agent influent.",
    "Rapport : 'Notre attaque manque de vitesse', analyse la cellule de recrutement.",
    "Pépite : Un milieu créatif surnommé 'Le Maestro' affole les radars locaux.",
    "Alerte : Le Maroc tente de naturaliser une de nos cibles binationales.",
    "Le staff technique réclame un latéral gauche plus offensif au prochain mercato.",
    "Opportunité : Un ancien international pourrait revenir pour encadrer les jeunes.",
    "Les observateurs sont formels : la prochaine star du continent est au Ghana.",
    "Conseil : Investissez dans une mission 'Élite' pour trouver le futur patron.",
    "Rumeur : Un jeune talent formé en France hésite à rejoindre la sélection.",
    "Analyse : 'Il nous manque un tueur devant le but', note l'adjoint.",
    "Scouting : Ce défenseur central gagne 90% de ses duels, il faut le signer.",
    "La presse locale s'interroge sur le manque de doublures au milieu.",
    "Un agent propose les services d'un ailier très rapide évoluant en Belgique.",
    "Statistique : Notre effectif est le plus âgé du tournoi. Place aux jeunes ?",
    "Le responsable de l'académie suggère de promouvoir un jeune talent.",
    "Bruit de couloir : Un club européen veut prêter ses jeunes ivoiriens."
],

// B. ANALYSES APRÈS VICTOIRE (L'Euphorie)
postMatchWin: [
    "Le Sportif : Une démonstration de force ! Cette équipe fait peur.",
    "Canal Sport : Tactiquement, c'était un récital. Bravo au coach.",
    "L'Ancien Capitaine : 'J'ai retrouvé l'âme des guerriers de mon époque.'",
    "Radio Continentale : La solidité défensive a été la clé du succès.",
    "La Gazette d'Abidjan : Le peuple est fier de ses Éléphants ce soir !",
    "Foot Afrique : Une prestation digne d'un futur champion.",
    "Le Consultant Vedette : 'Je n'ai jamais vu une telle maîtrise au milieu.'",
    "Agence Presse : Les joueurs ont envoyé un message fort à la concurrence.",
    "Télévision Nationale : Une soirée magique pour le football ivoirien.",
    "Le Tacticien : Le plan de jeu a fonctionné à la perfection.",
    "Hebdo Foot : Les attaquants ont été d'un réalisme effrayant.",
    "L'Expert : 'Ce groupe a quelque chose de spécial, ça se sent.'",
    "Supporters : Des scènes de joie éclatent dans tout le pays !",
    "Analyste Vidéo : Le pressing haut a totalement étouffé l'adversaire.",
    "Le Doyen : 'Enfin du beau jeu ! Ça fait plaisir à voir.'",
    "Presse Étrangère : Une leçon de football donnée par la Côte d'Ivoire.",
    "Légende du Club : Cette victoire restera dans les mémoires.",
    "Flash Info : Le Président de la Fédération félicite le groupe."
],

// C. ANALYSES APRÈS NUL (Le Doute)
postMatchDraw: [
    "Info Monde : Un match fermé qui ne restera pas dans les annales.",
    "Le Consultant : Il a manqué un peu de folie pour forcer le verrou.",
    "Journal du Stade : Un point précieux, mais le contenu reste poussif.",
    "L'Observateur : La défense a tenu, mais l'attaque est restée muette.",
    "Le Tacticien : Les deux équipes se craignaient trop pour se livrer.",
    "Mag Foot : Un nul logique vu la physionomie de la rencontre.",
    "Stats Pro : Une domination stérile (65% de possession) qui n'a pas payé.",
    "Café des Sports : On attendait mieux, mais on ne perd pas. L'essentiel est là.",
    "Radio Foot : Les attaquants ont manqué de lucidité dans le dernier geste.",
    "Réseaux Sociaux : 'On s'est ennuyé ferme... Il faut changer la tactique Coach !'",
    "Analyste : Le bloc bas de l'adversaire nous a posé beaucoup de problèmes.",
    "Journaliste : Un résultat en demi-teinte qui n'arrange personne.",
    "Supporters : Quelques sifflets sont descendus des tribunes à la fin.",
    "Expert : Il faudra montrer autre chose pour espérer aller loin.",
    "Presse Locale : Le gardien adverse a été l'homme du match, c'est tout dire.",
    "Débat TV : Faut-il changer de système pour le prochain match ?"
],

// D. ANALYSES APRÈS DÉFAITE (La Crise)
postMatchLoss: [
    "La Voix du Peuple : C'est une faute professionnelle. Où était l'envie ?",
    "Le Sportif : Les Éléphants tombent de haut face à un adversaire réaliste.",
    "Radio Info : Soirée cauchemar pour la défense qui a pris l'eau.",
    "Ultras : La colère gronde à Abidjan après cette prestation insipide.",
    "Le Consultant : Le système tactique n'était pas adapté, le coach s'est trompé.",
    "Presse Locale : Il va falloir se remettre en question d'urgence.",
    "Goal Actu : Une défaite inquiétante qui soulève beaucoup de questions.",
    "L'Ancien Buteur : 'Le talent ne suffit pas, il faut mouiller le maillot !'",
    "Canal Sport : Naufrage collectif. Aucun joueur n'a été au niveau.",
    "Supporters : 'REMBOURSEZ NOS BILLETS !' scandaient les fans.",
    "Analyse : Les contres adverses ont été fatals à notre défense trop lente.",
    "Journaliste : Le sélectionneur est-il toujours l'homme de la situation ?",
    "Légende : 'J'ai mal à ma sélection ce soir.'",
    "Statistique : Zéro tir cadré en seconde période. C'est insuffisant.",
    "Radio Libre : Les cadres doivent prendre leurs responsabilités.",
    "Flash Info : Réunion de crise prévue à la Fédération demain matin."
],

// E. VIE DU GROUPE (L'envers du décor)
lockerRoom: [
    "Le capitaine a réuni les joueurs pour une mise au point virile.",
    "Ambiance détendue à l'entraînement, le groupe vit bien ensemble.",
    "Le staff médical surveille de près la fatigue musculaire des cadres.",
    "Séance vidéo intensive prévue ce soir pour corriger les erreurs.",
    "Le coach a imposé un huis clos total cette semaine : concentration maximale.",
    "Des tensions sont apparues entre deux titulaires lors de l'opposition.",
    "Le groupe a reçu la visite du Ministre pour les encourager.",
    "Ferveur : Des centaines de fans ont chanté devant l'hôtel des joueurs.",
    "Un barbecue géant a été organisé pour souder les liens.",
    "Discipline : Deux joueurs sont arrivés en retard au décrassage.",
    "Le préparateur physique est impressionné par la forme du groupe.",
    "Rumeur de vestiaire : Certains joueurs ne comprendraient pas les choix tactiques.",
    "Moment émotion : Les familles ont pu rendre visite aux joueurs.",
    "Le gardien remplaçant joue un rôle crucial pour l'ambiance.",
    "Focus : Les téléphones ont été interdits à table.",
    "Confidence : 'On est prêts à mourir sur le terrain', affirme un leader."
],

// F. BUSINESS & RUMEURS (Le Monde Pro)
biz: [
    "Mercato : Un grand club anglais supervise {PLAYER} depuis un mois.",
    "Marketing : Rupture de stock des maillots floqués {PLAYER} !",
    "Sponsors : Le partenaire principal se dit satisfait de l'image de l'équipe.",
    "Rumeur : Un club du Golfe préparerait une offre énorme pour {PLAYER}.",
    "Médias : Record d'audience historique à la télé pour le dernier match.",
    "Transfert : L'agent de {PLAYER} a été aperçu dans un grand hôtel londonien.",
    "Social : {PLAYER} a gagné 100k abonnés sur Instagram en 24h.",
    "Billetterie : Le stade sera plein à craquer pour le prochain choc.",
    "Économie : Les ventes de drapeaux explosent dans tout le pays.",
    "Partenariat : Une grande marque veut faire de {PLAYER} son égérie.",
    "Buzz : Une vidéo de danse de {PLAYER} devient virale sur TikTok.",
    "Contrat : Les négociations pour la prime de victoire sont en cours.",
    "Interview : {PLAYER} fait la une du magazine 'Succès Afrique'.",
    "Insolite : Un fan a tatoué le visage de {PLAYER} sur son bras.",
    "Popularité : La cote de popularité du coach est au zénith."
]
};

  const SVGS = {
        // --- UI GÉNÉRALE (Garder celles-ci) ---
        coins: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 inline-block align-middle"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M17.22 15.22a2 2 0 1 0-2.83 2.83"/></svg>`,
        refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>`,
        radar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/><circle cx="12" cy="12" r="5"/></svg>`,
        play: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-slate-900 inline-block align-middle"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
        shield: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
        zap: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
        search: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
        trophy: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17a1 1 0 0 0 2 0v-2.34"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
        layout: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>`,
        repeat: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
        mic: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>`,
        home: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        assistant: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 inline-block align-middle mb-0.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>`,
        // --- NOUVELLES ICÔNES DE BUT (Pour remplacer les émojis) ---
        target: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 inline-block align-middle mb-0.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`, // Coup Franc (Cible)

        flag: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500 inline-block align-middle mb-0.5"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>`, // Corner (Drapeau)

        jump: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 inline-block align-middle mb-0.5"><path d="M12 19V5"/><path d="M5 12l7-7 7 7"/></svg>`, // Tête (Flèche haut / Détente)

        fire: `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-500 inline-block align-middle mb-0.5"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`, // Volley (Feu / Puissance)
        // --- INFRASTRUCTURES (DESIGN PREMIUM) ---
        // Stade : Une arène vue de dessus avec des projecteurs
        infraStadium: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h20"/><path d="M12 2a10 10 0 0 1 10 10v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8A10 10 0 0 1 12 2z"/><path d="M6 12v6"/><path d="M18 12v6"/><path d="M12 12v6"/><line x1="2" y1="12" x2="22" y2="12"/></svg>`,

        // Entraînement : Un haltère et un plot (Gym & Tactique)
        infraTraining: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 6.5h11"/><path d="M6 5v3"/><path d="M18 5v3"/><path d="M12 2v13"/><path d="M9 22l3-3 3 3"/><path d="M12 16a4 4 0 0 1 4 4v2H8v-2a4 4 0 0 1 4-4z"/></svg>`,

        // Médical : Une trousse de secours avec une croix
        infraMedical: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 12h6"/><path d="M12 9v6"/><path d="M16 4V2H8v2"/></svg>`,
       // --- NOUVELLE ICONE ---
        museum: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16"/><path d="M8 22v-4"/><path d="M16 22v-4"/><path d="M4 10h16"/><path d="M12 2l-8 5v3h16V7L12 2z"/><path d="M6 10v8"/><path d="M10 10v8"/><path d="M14 10v8"/><path d="M18 10v8"/></svg>`,
        // --- STAFF (DESIGN PREMIUM) ---
        briefcase: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
        whistle: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M11 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>`,
        heartpulse: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,

        // --- AUTRES ---
        star: `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400 inline-block align-middle mb-0.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,

        ball: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="12" r="10"/><path d="M12 2l2.5 5h-5L12 2z"/><path d="M12 22l-2.5-5h5L12 22z"/><path d="M2.5 10l5 2-2 4-3-6z"/><path d="M21.5 10l-5 2 2 4 3-6z"/></svg>`,

        alert: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,

        // CRAMPON OR (NOUVEAU DESIGN DYNAMIQUE)
       boot: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400 inline-block align-middle mb-0.5"><path d="M20.2 12.5c-.8-1.5-2.5-2.5-4.2-2.5H13l-2.5-4H6C3.5 6 2 8.5 2 11v5c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-3.5z"/><path d="M5 18v3"/><path d="M9 18v3"/><path d="M13 18v3"/><path d="M17 18v3"/></svg>`,

        glove: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><rect x="6" y="4" width="12" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="12"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>`,

        medal: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="16" r="5"/><path d="M12 11V3"/><path d="M7 6L5 3"/><path d="M17 6l2-3"/></svg>`,

        cup: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M8 2h8a4 4 0 0 1 4 4v3a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V6a4 4 0 0 1 4-4Z"/><path d="M12 13v6"/><path d="M8 22h8"/></svg>`,

        mega: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M2 12l5-5v10l-5-5Z"/><path d="M7 7h5l5-4v18l-5-4H7"/><path d="M19 8c1.5 1 2.5 3 2.5 4s-1 3-2.5 4"/></svg>`,

        globe: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,

        hand: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>`
    };
    // --- AJOUTEZ CECI AVANT "class EliteManager" ---

const TUTORIAL_STEPS = [
{
    title: "QG & TABLEAU DE BORD",
    text: "Ici, c'est votre bureau. Vous y verrez le prochain match, les news et le niveau de confiance.",
    view: "inbox",
    targetId: "view-inbox"
},
{
    title: "ACCÈS TACTIQUE",
    text: "C'est le menu le plus important. Cliquez ici pour gérer votre 11 de départ.",
    view: "inbox",
    targetId: "nav-squad"
},
{
    title: "LE TERRAIN",
    text: "Votre 11 titulaire. Cliquez sur un maillot pour voir les détails ou sur une case vide pour changer de joueur.",
    view: "squad",
    targetId: "pitch-main"
},
{
    title: "CONSIGNES TACTIQUES", // <-- AJOUT 1
    text: "Cliquez ici pour définir votre style (4-3-3, Contre-attaque...) et vos instructions de match.",
    view: "squad",
    targetId: "btn-toggle-prematch" // On pointe le bouton "Tactique & Formation"
},
{
    title: "CENTRE D'ENTRAÎNEMENT", // <-- AJOUT 2 (Navigation)
    text: "Vos joueurs doivent progresser. Accédez au menu 'Pro' pour gérer leur développement.",
    view: "squad",
    targetId: "nav-training"
},
{
    title: "BOOSTER LES JOUEURS", // <-- AJOUT 2 (Vue Entraînement)
    text: "Utilisez votre budget pour améliorer les stats. Un bon entraînement peut transformer un talent en star.",
    view: "training", // On force la vue Entraînement
    targetId: "training-content"
},
{
    title: "CELLULE DE RECRUTEMENT", // <-- AJOUT 3 (Navigation)
    text: "Besoin de renforts ? Envoyez vos scouts chercher des pépites en Afrique ou en Europe.",
    view: "training",
    targetId: "nav-scout"
},
{
    title: "LE MERCATO", // <-- AJOUT 3 (Vue Scout)
    text: "Lancez des missions de détection ici pour trouver les futurs cadres de la sélection.",
    view: "scout", // On force la vue Scout
    targetId: "scout-content"
},
{
    title: "INFRASTRUCTURES",
    text: "Pour gagner sur le long terme, investissez dans la ville (Stade, Médical).",
    view: "infra", // On force la vue Ville
    targetId: "nav-infra"
},
{
    title: "PRÊT AU COMBAT",
    text: "Vous savez l'essentiel. Le premier match vous attend. Bonne chance Coach !",
    view: "inbox",
    targetId: "next-match-card"
}
];

    class EliteManager {
    constructor() {
        // On ne charge plus rien ici. On attend le choix du slot.
        this.currentSlot = null;
        this.match = { active: false };
        this.isLiveCoaching = false;

        // Au lieu de init(), on lance le menu des sauvegardes
        this.renderSaveMenu();
    }
    renderSaveMenu() {
        const splash = document.getElementById('splash-screen');
        if(splash) splash.style.display = 'none';

        let html = `
        <div id="save-menu-modal" class="fixed inset-0 z-[9999] bg-slate-950 flex flex-col items-center justify-center p-4 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 mx-auto bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center border-2 border-slate-800 shadow-xl mb-3 rotate-3">
                    <span class="font-teko text-3xl text-white italic font-bold">CIV</span>
                </div>
                <h1 class="font-teko text-4xl text-white uppercase italic leading-none mb-1">Gestion de Carrière</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-[0.2em]">Sélectionnez un profil</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full max-w-4xl">
        `;

        for (let i = 1; i <= 3; i++) {
            const data = this.load(i);
            const isEmpty = !data;

            let cardContent = '';
            // Design compact : Hauteur réduite, padding réduit
            let borderClass = isEmpty ? 'border-slate-800 hover:border-slate-600' : 'border-orange-500/40 hover:border-orange-400 bg-slate-900';

            if (isEmpty) {
                // Version Vide Compacte
                cardContent = `
                    <div class="flex flex-row md:flex-col items-center justify-center h-20 gap-3 opacity-50 group-hover:opacity-100 transition">
                        <span class="text-2xl text-slate-600">+</span>
                        <span class="font-teko text-xl text-slate-500 uppercase">Nouvelle Partie</span>
                    </div>
                `;
            } else {
                // Version Pleine Compacte
                cardContent = `
                    <div class="flex flex-col h-24 justify-between relative">
                        <div class="flex items-center justify-between border-b border-white/5 pb-1">
                            <span class="text-[9px] text-orange-500 font-bold uppercase tracking-widest">Saison ${data.year}</span>
                            <span class="text-[9px] text-slate-600 font-bold uppercase">#${i}</span>
                        </div>

                        <div class="flex items-center justify-between my-auto px-1">
                            <div class="text-left">
                                <h2 class="font-teko text-4xl text-white italic leading-none">${data.userTeamCode || '???'}</h2>
                                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider -mt-1 truncate max-w-[120px]">${data.userTeamName || 'Inconnu'}</p>
                            </div>

                            <button onclick="event.stopPropagation(); app.deleteSave(${i})" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800 hover:bg-red-900/80 text-slate-500 hover:text-white transition shadow-lg border border-white/5">
                                <span class="text-[10px]">✕</span>
                            </button>
                        </div>

                        <div class="flex items-center pt-1 border-t border-white/5">
                            <span class="text-[8px] text-slate-500 uppercase mr-2">Manager:</span>
                            <span class="text-[9px] text-white font-bold uppercase truncate">${data.managerName || 'Anonyme'}</span>
                        </div>
                    </div>
                `;
            }

            html += `
                <div onclick="app.selectSlot(${i})" class="cursor-pointer rounded-xl p-3 border ${borderClass} shadow-lg transform active:scale-95 transition-all duration-200 relative group bg-slate-950/80 backdrop-blur-sm">
                    ${cardContent}
                </div>
            `;
        }

        html += `</div></div>`;
        document.body.insertAdjacentHTML('beforeend', html);
    }
    // A AJOUTER DANS LA CLASSE EliteManager (par exemple après renderSaveMenu)

    selectSlot(slotId) {
        this.currentSlot = slotId;
        const savedData = this.load(slotId);

        // 1. On supprime le menu visuel
        const menu = document.getElementById('save-menu-modal');
        if (menu) menu.remove();

        if (savedData) {
            // CAS A : Chargement d'une partie existante
            this.state = savedData;
            this.toast(`Chargement Slot ${slotId}...`);
            this.init(); // On lance le jeu normalement
        } else {
            // CAS B : Nouvelle partie
            // On crée une partie vide
            this.state = this.initNewGame();

            // On sauvegarde tout de suite pour "réserver" le slot
            this.save();
            this.toast(`Création Slot ${slotId}...`);

            // On lance l'initialisation (qui va détecter qu'il n'y a pas d'équipe et ouvrir le choix)
            this.init();
        }
    }
    // --- FONCTION DE SUPPRESSION (MANQUANTE) ---
    deleteSave(slotId) {
        // 1. Demande de confirmation (Sécurité)
        if (!confirm(`Attention : Voulez-vous vraiment effacer la sauvegarde du Slot ${slotId} ?\nCette action est irréversible.`)) {
            return;
        }

        // 2. Suppression réelle des données dans le navigateur
        localStorage.removeItem('aem_save_' + slotId);

        // 3. Mise à jour de l'affichage
        // On supprime le menu actuel
        const menu = document.getElementById('save-menu-modal');
        if (menu) menu.remove();

        // On affiche un petit message de confirmation
        this.toast(`Slot ${slotId} vidé avec succès.`);

        // On ré-affiche le menu (qui montrera maintenant le slot comme "Vide")
        this.renderSaveMenu();
    }
        // AJOUTER CETTE FONCTION QUI MANQUE
generatePotential(age, currentOvr) {
// Un jeune a plus de potentiel de croissance
if (age < 21) return Math.min(99, currentOvr + 5 + Math.floor(Math.random() * 10)); // +5 à +14
if (age < 25) return Math.min(99, currentOvr + 2 + Math.floor(Math.random() * 6));  // +2 à +7
return currentOvr; // Pas de gain de potentiel après 25 ans
}
// REMPLACEZ L'ANCIENNE FONCTION generatePlayerStats PAR CELLE-CI
generatePlayerStats(pos, ovr, specificRole = null) {
// 1. Définition des stats de base (Moyenne = OVR)
// On part d'une base équilibrée proche de l'OVR
const r = () => Math.max(40, Math.min(99, ovr + Math.floor(Math.random() * 8 - 4)));
let s = { pac: r(), sho: r(), pas: r(), dri: r(), def: r(), phy: r() };

// 2. Choix du Rôle (Profil)
if (!specificRole) {
    const rolesAvailable = Object.keys(PLAYER_ROLES_DB[pos] || {});
    // Si pas de rôle trouvé (ex: bug), on prend le premier par défaut
    specificRole = rolesAvailable.length > 0 ? rolesAvailable[Math.floor(Math.random() * rolesAvailable.length)] : 'Standard';
}

// 3. Application des Modificateurs de Poste (Général)
if (pos === 'FWD') { s.sho += 5; s.pac += 5; s.def -= 15; }
else if (pos === 'MID') { s.pas += 5; s.dri += 5; }
else if (pos === 'DEF') { s.def += 10; s.phy += 5; s.sho -= 10; }

// 4. APPLICATION DES BONUS DE RÔLE (SPÉCIFIQUE)
if (PLAYER_ROLES_DB[pos] && PLAYER_ROLES_DB[pos][specificRole]) {
    const bon = PLAYER_ROLES_DB[pos][specificRole].bonus;
    for (const [stat, val] of Object.entries(bon)) {
        if (s[stat] !== undefined) s[stat] += val;
    }
}

// 5. Lissage final (Min 40, Max 99)
Object.keys(s).forEach(k => s[k] = Math.max(40, Math.min(99, Math.round(s[k]))));

// On retourne les stats ET le rôle choisi (pour le sauvegarder dans l'objet joueur)
return { stats: s, roleName: specificRole };
}

        initNewGame() {
            const ns = [...NATIONS_DB].sort(() => Math.random() - 0.5);
            const g = this.createGroups(ns);
            const std = this.initStd(ns, g);

            // Génération des âges des stars
            Object.keys(std).forEach(key => {
                std[key].starAge = 25 + Math.floor(Math.random() * 8);
            });

            // --- CHOIX DU PAYS HÔTE INITIAL (Côte d'Ivoire par défaut ou aléatoire) ---
            const initialHost = NATIONS_DB.find(n => n.code === 'CIV') || NATIONS_DB[0];

            return {
                managerName: null,
                userTeamCode: null,
                userTeamName: null,

                // --- NOUVEAU : DONNÉES PAYS HÔTE ---
                hostCountry: initialHost.n,
                hostStadiums: initialHost.stadiums, // On charge la liste des 4 stades
                // -----------------------------------

                // --- MONDE VIVANT (Base de données copiée) ---
                worldPlayers: JSON.parse(JSON.stringify(REAL_SQUADS_DB)),
                // ---------------------------------------------

                year: 2026, budget: 15.0, teamXP: 0, pastWinners: [],
                formation: '4-3-3',
                players: [], // Sera rempli par selectTeam()
                scoutPool: [], matchIndex: 0, standings: std,
                groups: g, trophies: 0, stage: 'groups',
                viewingGroup: 'A',
                goalScorers: [],assisters: [], playerRatings: [],
                seasonsPlayed: 0, globalResults: [], knockout: {},

                instructions: {
                    style: 'possession', pressing: 'normal',
                    passing: 'short', aggression: 'safe',
                    width: 'narrow', tempo: 'slow'
                },
                roles: { captain: null, penalty: null, freekick: null, corner: null },
                rareScoutUsed: false,
                news: [{id: Date.now(), text: "Bienvenue. Sélectionnez votre nation pour commencer."}],

                infra: {
                    stadium: { level: 1, cost: 10, bonus: 0.5 },
                    training: { level: 1, cost: 5, bonus: 1 },
                    medical: { level: 1, cost: 8, bonus: 5 }
                },
                staff: {
                    director: { level: 1, salary: 2.0, name: "Directeur Sportif", desc: "Réduit les coûts de recrutement (-10%/niv)." },
                    assistant: { level: 1, salary: 1.5, name: "Entraîneur Adjoint", desc: "Booste le gain d'XP d'équipe (+10%/niv)." },
                    fitness: { level: 1, salary: 1.0, name: "Préparateur Physique", desc: "Remplaçants récupèrent mieux (+5%/niv)." }
                }
            };
        }
         // --- AJOUTER CETTE FONCTION QUI MANQUE ---
        autoAssignRoles() {
            // On s'assure que l'objet roles existe
            if (!this.state.roles) this.state.roles = { captain: null, penalty: null, freekick: null, corner: null };

            const starters = this.state.players.filter(p => p.role === 'starter');
            if (starters.length === 0) return;

            // 1. Capitaine : Le plus âgé ou le plus fort mentalement
            const bestCap = [...starters].sort((a,b) => (b.age * 0.7 + b.ovr * 0.3) - (a.age * 0.7 + a.ovr * 0.3))[0];
            this.state.roles.captain = bestCap ? bestCap.id : null;

            // 2. Pénalty : Le meilleur Attaquant avec le plus gros OVR
            const bestPen = [...starters].sort((a,b) => b.ovr - a.ovr)[0];
            this.state.roles.penalty = bestPen ? bestPen.id : null;

            // 3. Coup Franc : Souvent un Milieu ou Attaquant technique
            const bestFK = [...starters].filter(p => p.pos !== 'GK').sort((a,b) => b.ovr - a.ovr)[0];
            this.state.roles.freekick = bestFK ? bestFK.id : null;

            // 4. Corner : Idem
            this.state.roles.corner = bestFK ? bestFK.id : null;

            this.save();
        }
         // --- GESTION DES RÔLES (UI) ---

        openRolesModal() {
            // Si les rôles ne sont pas initialisés, on le fait
            if (!this.state.roles.captain) this.autoAssignRoles();

            const c = document.getElementById('roles-list-container');
            c.innerHTML = '';

            const definitions = [
                { id: 'captain', label: 'Capitaine', icon: '©', color: 'text-yellow-400', desc: 'Leadership et mental.' },
                { id: 'penalty', label: 'Pénaltys', icon: 'PK', color: 'text-green-400', desc: 'Sang-froid face au but.' },
                { id: 'freekick', label: 'Coups Francs', icon: 'CF', color: 'text-blue-400', desc: 'Précision de tir.' },
                { id: 'corner', label: 'Corners', icon: 'CK', color: 'text-purple-400', desc: 'Centres et passes.' }
            ];

            definitions.forEach(def => {
                const pid = this.state.roles[def.id];
                const player = this.state.players.find(p => p.id === pid);
                const pName = player ? player.name : "Non assigné";
                const pOvr = player ? player.ovr : "--";

                c.innerHTML += `
                    <div class="glass-panel p-4 rounded-xl border border-white/5 flex items-center justify-between hover:bg-slate-800 transition cursor-pointer" onclick="app.openRolePicker('${def.id}')">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center font-teko text-2xl font-bold ${def.color} shadow-lg">
                                ${def.icon}
                            </div>f
                            <div>
                                <div class="text-white font-bold uppercase text-xs tracking-wider">${def.label}</div>
                                <div class="text-[10px] text-slate-500">${def.desc}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-orange-500 font-teko text-xl font-bold">${pName}</div>
                            <div class="text-[9px] text-slate-600 font-bold uppercase">Note: ${pOvr}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('roles-modal').classList.remove('hidden');
        }

        openRolePicker(roleType) {
            const modal = document.getElementById('role-picker-modal');
            const list = document.getElementById('role-picker-list');
            const title = document.getElementById('role-picker-title');

            title.innerText = `Choisir : ${roleType.toUpperCase()}`;
            list.innerHTML = '';

            // Seuls les titulaires peuvent avoir un rôle
            this.state.players.filter(p => p.role === 'starter').sort((a,b)=>b.ovr - a.ovr).forEach(p => {
                list.innerHTML += `
                    <button onclick="app.setRole('${roleType}', '${p.id}')" class="w-full p-3 bg-slate-900 border border-slate-700 rounded-xl flex items-center justify-between hover:bg-orange-600 hover:border-orange-500 hover:text-white group transition">
                        <span class="font-bold text-xs uppercase">${p.name}</span>
                        <span class="font-teko text-xl text-slate-500 group-hover:text-white">${p.ovr}</span>
                    </button>
                `;
            });

            modal.classList.remove('hidden');
        }

        setRole(type, pid) {
            this.state.roles[type] = pid;
            this.save();

            document.getElementById('role-picker-modal').classList.add('hidden');
            this.openRolesModal(); // Rafraîchir la liste
            this.renderPitch('pitch-cards-layer'); // Mettre à jour les badges sur le terrain
            this.toast("Rôle mis à jour !");
        }

        createGroups(ns) {
            const g = { 'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [] };
            const keys = Object.keys(g);
            ns.forEach((n, i) => { const k = keys[Math.floor(i / 4)]; if (k) g[k].push(n); });
            return g;
        }

        initStd(ns, gs) {
            const std = {};
            ns.forEach(n => {
                let gL = ''; for (let g in gs) { if (gs[g].some(t => t.n === n.n)) gL = g; }
                std[n.n] = { n: n.n, code: n.code, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, grp: gL, ovr: n.ovr, style: n.style, star: n.star, starPos: n.starPos };
            });
            return std;
        }

        init() {
        // Initialisation Audio
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.audioCtx = new AudioContext();
        this.ambianceNode = null;

        if (!this.state.assisters) this.state.assisters = [];

        // --- PATCH CRITIQUE : CORRECTION DES DONNÉES JOUEURS ---
        // (On garde votre code existant pour fixer les joueurs)
        const fixPlayer = (p) => {
            if (!p.stats || !p.stats.pac) {
                const gen = this.generatePlayerStats(p.pos, p.ovr);
                p.stats = gen.stats;
                if (!p.style) p.style = gen.roleName;
            }
            if (!p.pot) p.pot = this.generatePotential(p.age, p.ovr);
            if (p.pot < p.ovr) p.pot = p.ovr;
        };

        if (this.state.players) this.state.players.forEach(fixPlayer);
        if (this.state.scoutPool) this.state.scoutPool.forEach(fixPlayer);

        // Initialisation des objets manquants (Sécurité)
        if (!this.state.staff) {
            this.state.staff = {
                director: { level: 1, salary: 2.0, name: "Directeur Sportif", desc: "Réduit les coûts de recrutement (-10%/niv)." },
                assistant: { level: 1, salary: 1.5, name: "Entraîneur Adjoint", desc: "Booste le gain d'XP d'équipe (+10%/niv)." },
                fitness: { level: 1, salary: 1.0, name: "Préparateur Physique", desc: "Remplaçants récupèrent mieux (+5%/niv)." }
            };
        }
        if (!this.state.instructions.passing) {
            this.state.instructions = { style: 'possession', pressing: 'normal', passing: 'short', aggression: 'safe', width: 'narrow', tempo: 'slow' };
        }
        if (!this.state.roles) this.state.roles = { captain: null, penalty: null, freekick: null, corner: null };
        if (!this.state.pastWinners) this.state.pastWinners = []; // Sécurité Hall of Fame

        // Injection des icônes SVG
        this.injectIcons();

        // --- LOGIQUE DE DÉMARRAGE (CORRIGÉE) ---

        // CAS 1 : NOUVELLE PARTIE (Pas d'équipe)
        if (!this.state.userTeamCode) {
            this.renderTeamSelectionModal();
            // On force l'affichage
            const modal = document.getElementById('team-selection-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // Sécurité CSS

            document.getElementById('welcome-modal').classList.add('hidden');

            // IMPORTANT : On s'arrête là ! On ne charge pas l'interface du jeu (Inbox)
            // Le jeu continuera quand le joueur cliquera sur une équipe (selectTeam)
            return;
        }

        // CAS 2 : ÉQUIPE CHOISIE MAIS PAS DE NOM (Contrat)
        else if (!this.state.managerName) {
            document.getElementById('team-selection-modal').classList.add('hidden');
            document.getElementById('welcome-modal').classList.remove('hidden');
            // On s'arrête là aussi
            return;
        }

        // CAS 3 : JEU EN COURS (Chargement normal)
        document.getElementById('team-selection-modal').classList.add('hidden');
        document.getElementById('welcome-modal').classList.add('hidden');

        // On lance la boucle de sauvegarde automatique
        setInterval(() => this.save(), 5000);

        // On affiche l'interface principale
        this.updateUI();
        this.goToView('inbox');

        // On rend l'application accessible globalement
        window.app = this;
    }
// --- COLLEZ CE BLOC JUSTE APRÈS LA FIN DE LA FONCTION init() ---

        submitManagerName() {
    const input = document.getElementById('input-manager-name');
    const val = input.value.trim().toUpperCase();

    // Validation simple
    if (val.length < 3) return this.toast("Nom trop court !");

    // 1. Enregistrement des données
    this.state.managerName = val;

    // NOUVEAU : On sauvegarde l'avatar choisi (ou le premier par défaut si bug)
    this.state.managerAvatarSeed = this.tempManagerSeed || 101;

    // 2. Fermeture de l'interface de bienvenue
    const modal = document.getElementById('welcome-modal');
    modal.classList.add('hidden');
    modal.style.display = 'none';

    // 3. Petit message d'ambiance dans la Gazette
    this.state.news.unshift({
        id: Date.now(),
        text: `OFFICIEL : ${val} est le nouveau sélectionneur !`
    });

    // 4. Sauvegarde et Mise à jour
    this.save();      // Sauvegarde dans le localStorage
    this.updateUI();  // Met à jour le header tout de suite

    // 5. Lancement du jeu
    this.goToView('inbox');

    // Lancement du tutoriel après un court délai pour l'animation
    setTimeout(() => {
        this.startTutorial();
    }, 500);
}
        // ---------------------------------------------------------------
        injectIcons() {
            for (const [id, svg] of Object.entries(SVGS)) {
                const els = document.querySelectorAll(`[id^="icon-${id}"]`);
                els.forEach(el => el.innerHTML = svg);
            }
        }

        save() {
        if (!this.currentSlot) return; // Sécurité
        // On sauvegarde avec une clé unique par slot (ex: aem_save_1)
        localStorage.setItem('aem_save_' + this.currentSlot, JSON.stringify(this.state));
    }

    // Note : Cette fonction load() est maintenant un utilitaire, elle n'est plus appelée dans le constructeur
    load(slotId) {
        const s = localStorage.getItem('aem_save_' + slotId);
        return s ? JSON.parse(s) : null;
    }

       updateUI() {
    // Récupération des éléments du DOM
    const bDisplay = document.getElementById('budget-display');
    const xDisplay = document.getElementById('team-xp-display');
    const hSubtitle = document.getElementById('header-subtitle');
    const xBar = document.getElementById('xp-bar-fill');
    const mName = document.getElementById('header-manager-name');

    // Mise à jour du nom
    if (mName && this.state.managerName) {
        mName.innerText = this.state.managerName;
    }

    // --- MODIFICATION : AFFICHAGE AVATAR MANAGER ---
    // On cible la div carrée qui contient le logo (classe w-10 h-10 dans le header)
    const headerIconDiv = document.querySelector('header .w-10.h-10');

    if (headerIconDiv && this.state.managerAvatarSeed) {
        // 1. On génère le SVG avec le seed sauvegardé
        // (40 est la taille en pixels pour le header)
        const svg = this.generateManagerIcon(this.state.managerAvatarSeed, 40);

        // 2. On change le style pour faire un rond "Avatar" au lieu du carré "Drapeau"
        // On remplace les classes existantes pour être sûr du rendu
        headerIconDiv.className = "w-10 h-10 rounded-full border-2 border-slate-600 bg-slate-800 overflow-hidden shadow-lg flex items-center justify-center relative z-50";

        // 3. On injecte le SVG
        headerIconDiv.innerHTML = svg;
    }
    else if (headerIconDiv && this.state.userTeamCode) {
        // Fallback : Si pas d'avatar (vieille sauvegarde), on affiche le code pays
        headerIconDiv.innerText = this.state.userTeamCode;
    }
    // -----------------------------------------------

    // Mise à jour des valeurs numériques
    if(bDisplay) bDisplay.innerText = this.state.budget.toFixed(1) + " M€";
    if(xDisplay) xDisplay.innerText = this.state.teamXP + " XP";
    if(hSubtitle) hSubtitle.innerText = "SAISON " + this.state.year;

    // Barre d'expérience (Max 25000 XP pour l'exemple)
    if(xBar) xBar.style.width = Math.min(100, (this.state.teamXP / 25000) * 100) + "%";

    // Ré-injection des icônes SVG si nécessaire (perte au refresh)
    this.injectIcons();
}

        goToView(v) {
            if (this.match.active && v !== 'match') { this.toast("Terminez le match d'abord !"); return; }

            // 1. Gestion des Vues (Cacher/Montrer)
            document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
            const targetView = document.getElementById('view-' + v);
            if(targetView) targetView.classList.remove('hidden');

            // 2. Gestion de la Navigation (Boutons actifs)
            document.querySelectorAll('.btn-nav').forEach(btn => btn.classList.remove('active'));
            const nav = document.getElementById('nav-' + v); if(nav) nav.classList.add('active');

            // --- CORRECTION : DESSINER LES JOUEURS ET LES BOUTONS ---
            if (v === 'squad') {
this.renderPitch('pitch-cards-layer');
// MODIFICATION ICI : On cible le nouvel ID
const container = document.getElementById('prematch-tactics-container');
if(container) container.innerHTML = this.renderTacticalButtons('prematch');
}
            // --------------------------------------------------------

            if (v === 'training') this.renderTraining();
            if (v === 'calendar') this.renderCalendar();
            if (v === 'scout') this.renderScout();
            if (v === 'inbox') {
                this.generateAmbientNews();
                this.renderInbox();
            }
            if (v === 'infra') this.renderInfra();
        }

        clearNews() { this.state.news = []; this.renderInbox(); this.save(); this.toast("Archives vidées."); }

        // MODIFICATION MAJEURE : Générateur avec paramètre de nation
        // Fonction de génération mise à jour
        // Fonction de génération de noms (CORRIGÉE POUR LA DIVERSITÉ)
// Fonction de génération de noms (INTELLIGENTE & DIVERSIFIÉE)
generateRealName(nationName = null) {
let region;

// CAS 1 : Nation spécifique demandée (ex: Scout Local, Adversaire)
if (nationName) {
    const nat = NATIONS_DB.find(n => n.n === nationName);
    if (nat && nat.region) {
        region = nat.region;
    }
}

// CAS 2 : Pas de nation (ou introuvable) -> ALÉATOIRE TOTAL
// Cela permet d'avoir de la diversité pour les "Regens" ou les bugs
if (!region) {
    const availableRegions = Object.keys(REGIONAL_NAMES);
    region = availableRegions[Math.floor(Math.random() * availableRegions.length)];
}

// Récupération de la base de noms correspondante
const db = REGIONAL_NAMES[region] || REGIONAL_NAMES.WEST_FRANCO;

const f = db.first[Math.floor(Math.random() * db.first.length)];
const l = db.last[Math.floor(Math.random() * db.last.length)];

return `${f} ${l}`;
}
// AJOUT DU PARAMÈTRE 'readOnly' (par défaut false)
        // Fonction pour ouvrir la fiche détaillée d'un joueur (Version Compacte & Fermeture au clic extérieur)
        openPlayerSheet(p, readOnly = false) {
            // 1. Initialisation / Patch des données manquantes
            if (!p.stats || !p.style) {
                const generated = this.generatePlayerStats(p.pos, p.ovr, p.style);
                p.stats = generated.stats;
                p.style = generated.roleName;
            }

            // 2. Récupération des infos du rôle
            let roleLabel = p.pos;
            if (PLAYER_ROLES_DB[p.pos] && PLAYER_ROLES_DB[p.pos][p.style]) {
                roleLabel = PLAYER_ROLES_DB[p.pos][p.style].label;
            }

            // 3. Labels des stats
            const labels = {
                pac: "Vitesse", sho: "Tir", pas: "Passe", dri: "Dribble", def: "Défense", phy: "Physique",
                ref: "Réflexes", han: "Main", kic: "Dégagement", pos: "Position", div: "Plongeon", spd: "Vitesse"
            };

            // Style de la carte (Couleurs)
            let cardBg = "bg-slate-900";
            let cardBorder = "border-slate-700";
            if (p.ovr >= 85) { cardBg = "bg-gradient-to-br from-yellow-900 to-slate-950"; cardBorder = "border-yellow-500/50"; }
            else if (p.ovr >= 80) { cardBg = "bg-gradient-to-br from-green-900 to-slate-950"; cardBorder = "border-green-500/50"; }

            // 4. Construction HTML Stats (Grille plus serrée)
            let statsHTML = '<div class="grid grid-cols-2 gap-x-4 gap-y-2">';
            for (const [key, val] of Object.entries(p.stats)) {
                let barColor = val > 80 ? 'bg-green-500' : (val > 65 ? 'bg-orange-500' : 'bg-red-500');
                statsHTML += `
                    <div class="flex flex-col gap-0.5">
                        <div class="flex justify-between items-end">
                            <span class="text-[9px] uppercase font-bold text-slate-400">${labels[key] || key}</span>
                            <span class="font-teko text-base leading-none text-white">${val}</span>
                        </div>
                        <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full ${barColor}" style="width: ${val}%"></div>
                        </div>
                    </div>`;
            }
            statsHTML += '</div>';

            // --- GESTION DES BOUTONS DU BAS (Intelligente) ---
            let footerButtons = '';
            const btnBase = "py-2 rounded-lg font-bold uppercase text-[10px] transition shadow-sm";

            if (readOnly) {
                // Mode Adversaire ou Archive
                footerButtons = `<button onclick="document.getElementById('player-sheet-modal').remove()" class="w-full ${btnBase} bg-slate-800 hover:bg-slate-700 text-white border border-slate-600">Fermer</button>`;
            }
            else if (p.sentOff) {
                // CAS SPÉCIAL : JOUEUR EXPULSÉ (Bloqué)
                footerButtons = `
                    <button onclick="document.getElementById('player-sheet-modal').remove()" class="flex-1 ${btnBase} bg-slate-800 hover:bg-slate-700 text-slate-400">Fermer</button>
                    <div class="flex-1 ${btnBase} bg-red-950 border border-red-600/50 text-red-500 flex items-center justify-center gap-1 cursor-not-allowed opacity-80">
                        <span>⛔</span> CARTON ROUGE
                    </div>
                `;
            }
            else {
                // Mode Normal (Titulaire <-> Banc)
                const actionBtn = p.role === 'starter'
                    ? `<button onclick="app.quickSwapRole('${p.id}')" class="flex-1 ${btnBase} bg-red-900/50 border border-red-500/50 hover:bg-red-600 text-white">Banc</button>`
                    : `<button onclick="app.quickSwapRole('${p.id}')" class="flex-1 ${btnBase} bg-green-900/50 border border-green-500/50 hover:bg-green-600 text-white">Titulaire</button>`;

                footerButtons = `
                    <button onclick="document.getElementById('player-sheet-modal').remove()" class="flex-1 ${btnBase} bg-slate-800 hover:bg-slate-700 text-slate-400">Fermer</button>
                    ${actionBtn}
                `;
            }

            // 5. Création du Modal (Modifié pour taille et clic extérieur)
            // - L'arrière-plan (fixed inset-0) a maintenant un onclick pour fermer.
            // - La carte elle-même a onclick="event.stopPropagation()" pour ne pas fermer si on clique dessus.
            // - max-w-sm est devenu max-w-[300px].
            // - Les paddings (p-6) sont devenus p-4 ou p-3.
            // - Les tailles de polices (text-5xl -> text-3xl) ont été réduites.
            const modalHTML = `
<div id="player-sheet-modal" onclick="document.getElementById('player-sheet-modal').remove()" class="fixed inset-0 z-[700] bg-slate-950/90 backdrop-blur-sm flex items-center justify-center p-4 animate-slideIn cursor-pointer">                    <div onclick="event.stopPropagation()" class="w-full max-w-[300px] ${cardBg} border ${cardBorder} rounded-2xl shadow-2xl relative overflow-hidden flex flex-col cursor-default">

                        <div class="p-4 pb-2 flex justify-between items-start relative z-10">
                            <div>
                                <h2 class="font-teko text-3xl text-white uppercase italic leading-none truncate max-w-[180px]">${p.name}</h2>
                                <div class="flex flex-col items-start mt-0.5">
                                    <div class="flex items-center gap-1.5">
                                        <span class="px-1.5 py-0.5 rounded bg-slate-700 border border-slate-600 text-white font-bold text-[9px] uppercase tracking-widest shadow-sm">${roleLabel}</span>
                                        <span class="text-[9px] text-slate-400 font-bold uppercase">${p.age} ans</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col items-center justify-center w-12 h-12 bg-slate-950 border border-slate-700 rounded-xl shadow-lg shrink-0">
                                <span class="font-teko text-3xl text-white font-bold">${p.ovr}</span>
                            </div>
                        </div>

                        <div class="p-4 pt-2 relative z-10 flex-1">
                            <div class="mb-4 ${readOnly ? 'opacity-50 grayscale' : ''}">
                                <div class="flex justify-between text-[9px] font-bold uppercase text-slate-500 mb-0.5">
                                    <span>Forme</span>
                                    <span class="text-green-400">${p.energy || 100}%</span>
                                </div>
                                <div class="w-full h-1.5 bg-slate-950 rounded-full border border-slate-800 overflow-hidden">
                                    <div class="h-full bg-green-500" style="width: ${p.energy || 100}%"></div>
                                </div>
                            </div>
                            ${statsHTML}
                        </div>

                        <div class="p-3 bg-slate-950 border-t border-slate-800 flex gap-2 shrink-0">
                            ${footerButtons}
                        </div>
                    </div>
                </div>`;

            const oldModal = document.getElementById('player-sheet-modal');
            if(oldModal) oldModal.remove();
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }


        // Nouvelle fonction pour voir un adversaire
        viewOpponent(index) {
            // On récupère le joueur dans l'équipe adverse générée
            if (this.match && this.match.oppSquad && this.match.oppSquad[index]) {
                const player = this.match.oppSquad[index];
                // On ouvre la fiche en mode ReadOnly (True)
                this.openPlayerSheet(player, true);
            }
        }

        // Helper pour le bouton d'action rapide dans la fiche
        // Helper pour le bouton d'action rapide dans la fiche
       // Aiguillage : Ouvre le bon menu selon le statut du joueur
        quickSwapRole(id) {
            // Fermer la fiche joueur
            const modal = document.getElementById('player-sheet-modal');
            if(modal) modal.remove();

            const p = this.state.players.find(x => x.id === id);
            if(!p) return;

            if (p.role === 'starter') {
                // CAS 1 : C'est un Titulaire -> On veut le remplacer par un gars du banc
                // On ouvre le nouveau modal de remplacement
                this.openBenchReplacementModal(p.id);
            } else {
                // CAS 2 : C'est un Remplaçant -> On veut le mettre sur le terrain
                // On ouvre le modal existant (que vous aimiez bien)
                this.openTacticalSubModal(p.id);
            }
        }
       renderPitch(layerId) {
    const container = document.getElementById(layerId); if(!container) return;
    container.innerHTML = '';

    // --- 1. DÉTECTION DU MODE SCOUT (Visionnage Adversaire) ---
    const isScout = layerId === 'scout-pitch-layer';

    // Si on est en mode Scout, on récupère la formation de l'adversaire
    let formId = this.state.formation;
    if (isScout && this.match && this.match.opp) {
        formId = this.match.opp.formation || '4-3-3'; // Formation adverse par défaut
    }
    const form = FORMATIONS[formId] || FORMATIONS['4-3-3'];

    // --- 2. BASE DE DONNÉES MAILLOTS (24 ÉQUIPES) ---
    const NATIONS_DATA = {
        'MAR': { main: '#C1272D', trim: '#006233', region: 'NORTH' },
        'ALG': { main: '#FFFFFF', trim: '#006233', region: 'NORTH' },
        'TUN': { main: '#E70013', trim: '#FFFFFF', region: 'NORTH' },
        'EGY': { main: '#CE1126', trim: '#000000', region: 'NORTH' },
        'MTN': { main: '#00A95C', trim: '#FFD700', region: 'NORTH' },
        'CIV': { main: '#F97316', trim: '#FFFFFF', region: 'SUB' },
        'SEN': { main: '#FFFFFF', trim: '#00853F', region: 'SUB' },
        'NGA': { main: '#008751', trim: '#FFFFFF', region: 'SUB' },
        'GHA': { main: '#FFFFFF', trim: '#000000', region: 'SUB' },
        'MLI': { main: '#FCD116', trim: '#009E49', region: 'SUB' },
        'GUI': { main: '#CE1126', trim: '#FCD116', region: 'SUB' },
        'BFA': { main: '#009E49', trim: '#EF2B2D', region: 'SUB' },
        'GNB': { main: '#CE1126', trim: '#009E49', region: 'SUB' },
        'GAM': { main: '#CE1126', trim: '#0033A0', region: 'SUB' },
        'CMR': { main: '#007A5E', trim: '#CE1126', region: 'SUB' },
        'COD': { main: '#0070FF', trim: '#CE1126', region: 'SUB' },
        'EQG': { main: '#CE1126', trim: '#0070FF', region: 'SUB' },
        'RSA': { main: '#FFB81C', trim: '#007749', region: 'MIXED' },
        'ANG': { main: '#CE1126', trim: '#000000', region: 'SUB' },
        'NAM': { main: '#CE1126', trim: '#0033A0', region: 'SUB' },
        'ZAM': { main: '#FF8200', trim: '#009E49', region: 'SUB' },
        'MOZ': { main: '#CE1126', trim: '#FCD116', region: 'SUB' },
        'TAN': { main: '#00A3DD', trim: '#FCD116', region: 'SUB' },
        'CPV': { main: '#0033A0', trim: '#CE1126', region: 'MIXED' },
        'DEFAULT': { main: '#334155', trim: '#FFFFFF', region: 'SUB' }
    };

    // LOGIQUE INTELLIGENTE DE MAILLOT :
    // Si c'est nous, on prend notre code. Si c'est le scout, on prend le code adverse.
    let targetTeamCode = this.state.userTeamCode || 'CIV';
    if (isScout && this.match && this.match.opp) {
        targetTeamCode = this.match.opp.code;
    }
    const currentTeam = NATIONS_DATA[targetTeamCode] || NATIONS_DATA['DEFAULT'];

    // --- 3. GÉNÉRATEUR D'AVATARS (Optimisé 12 Styles + Correction Calvitie) ---
    const generateAvatar = (seedStr, isBench = false) => {
        let hash = 0;
        for (let i = 0; i < seedStr.length; i++) { hash = seedStr.charCodeAt(i) + ((hash << 5) - hash); }
        const safeHash = Math.abs(hash);
        const prng = (min, max) => {
            const x = Math.sin(hash++) * 10000;
            return Math.floor((x - Math.floor(x)) * (max - min + 1)) + min;
        };

        // Palettes de peau selon la région de l'équipe affichée
        let skinPalette = [];
        if (currentTeam.region === 'NORTH') {
            skinPalette = [{ base: "#F2C490", shadow: "#C69C72", light: "#FFD9B3" }, { base: "#E0AC69", shadow: "#B38B52", light: "#F5CBA0" }, { base: "#C68642", shadow: "#9E6831", light: "#E0A873" }, { base: "#8D5524", shadow: "#6B4226", light: "#AF7849" }];
        } else if (currentTeam.region === 'MIXED') {
            skinPalette = [{ base: "#E0AC69", shadow: "#B38B52", light: "#F5CBA0" }, { base: "#8D5524", shadow: "#6B4226", light: "#AF7849" }, { base: "#5D4037", shadow: "#3E2723", light: "#8D6E63" }, { base: "#3E2723", shadow: "#261915", light: "#5D4037" }];
        } else {
            skinPalette = [{ base: "#795548", shadow: "#4E342E", light: "#8D6E63" }, { base: "#5D4037", shadow: "#3E2723", light: "#8D6E63" }, { base: "#4E342E", shadow: "#281815", light: "#6D4C41" }, { base: "#2F1E1A", shadow: "#1A0F0D", light: "#4A3B36" }];
        }
        const skin = skinPalette[prng(0, skinPalette.length - 1)];

        const headShapeIdx = prng(0, 2);
        const noseIdx = prng(0, 3);
        const hairIdx = prng(0, 11); // 12 Styles
        const beardIdx = prng(0, 4);

        // A. CORPS (Avec Maillot de l'équipe concernée)
        const body = `
            <path d="M12 54 Q32 50, 52 54 V64 H12 Z" fill="${currentTeam.main}" stroke="#111" stroke-width="0.5"/>
            <path d="M22 38 L22 54 L42 54 L42 38" fill="${skin.base}"/>
            <path d="M22 46 Q32 52, 42 46" fill="${skin.shadow}" opacity="0.4"/>
            <path d="M24 53 L32 60 L40 53" fill="none" stroke="${currentTeam.trim}" stroke-width="2"/>
        `;

        // B. TÊTE
       // B. TÊTE (Correction Mobile : Suppression des Gradients <defs>)
        let headPath = '', jawShadow = '';
        if (headShapeIdx === 0) {
            headPath = `M17 18 C17 8, 47 8, 47 18 V28 C47 38, 44 44, 32 45 C20 44, 17 38, 17 28 V18 Z`;
            jawShadow = `M32 20 L47 20 V28 C47 36, 42 43, 32 44 Z`;
        } else if (headShapeIdx === 1) {
            headPath = `M19 16 C19 6, 45 6, 45 16 V26 C45 36, 40 46, 32 46 C24 46, 19 36, 19 26 V16 Z`;
            jawShadow = `M32 18 L45 18 V26 C45 34, 40 45, 32 46 Z`;
        } else {
            headPath = `M18 16 C18 6, 46 6, 46 16 V24 L44 34 L32 46 L20 34 L18 24 V16 Z`;
            jawShadow = `M32 18 L46 16 V24 L44 34 L32 46 Z`;
        }

        // CORRECTION ICI : On utilise directement skin.base au lieu de url(#grad...)
        const head = `
            <path d="${headPath}" fill="${skin.base}" stroke="#221100" stroke-width="0.5"/>
            <path d="${jawShadow}" fill="${skin.shadow}" opacity="0.25" />
        `;

        // C. TRAITS
        let nose = '';
        if (noseIdx === 0) nose = `<path d="M28 36 Q32 38, 36 36 M27 35 Q28 32, 31 28" fill="none" stroke="${skin.shadow}" stroke-width="1.2" stroke-linecap="round"/>`;
        else if (noseIdx === 1) nose = `<path d="M32 26 L29 36 L33 36" fill="none" stroke="${skin.shadow}" stroke-width="1"/>`;
        else nose = `<path d="M31 28 L30 36 L34 36" fill="none" stroke="${skin.shadow}" stroke-width="0.8"/>`;

        const eyes = `
            <path d="M20 27 Q24 25, 28 27 Q24 29, 20 27 Z" fill="#EEE"/>
            <path d="M36 27 Q40 25, 44 27 Q40 29, 36 27 Z" fill="#EEE"/>
            <circle cx="24" cy="27" r="1.5" fill="#111"/>
            <circle cx="40" cy="27" r="1.5" fill="#111"/>
            <path d="M19 25 Q24 23, 29 25" stroke="#1a1a1a" stroke-width="1.5" fill="none"/>
            <path d="M35 25 Q40 23, 45 25" stroke="#1a1a1a" stroke-width="1.5" fill="none"/>
        `;

        let mouth = (safeHash % 2 === 0) ? `<path d="M26 42 Q32 43, 38 42" stroke="#3E2723" stroke-width="1.5" stroke-linecap="round"/>` : `<path d="M27 41 Q32 44, 37 41" fill="${skin.shadow}"/>`;

        // D. COIFFURES
        let hair = '';
        let hairBase = '';
        const hCol = "#0F0F0F";

        switch(hairIdx) {
            case 0: hair = `<path d="M18 24 V20 C18 10, 46 10, 46 20 V24" fill="none" stroke="${hCol}" stroke-width="0.5" opacity="0.3"/>`; break;
            case 1: hairBase = `<path d="M18 22 C18 10, 46 10, 46 22 L46 20 C46 8, 18 8, 18 20 Z" fill="${hCol}"/>`;
                    hair = `<path d="M18 20 C18 9, 46 9, 46 20 L46 22 H18 Z" fill="${hCol}"/>`; break;
            case 2: hairBase = `<path d="M20 20 C20 10, 44 10, 44 20" fill="${hCol}"/>`;
                    hair = `<path d="M16 16 C14 6, 50 6, 48 16 C52 8, 12 8, 16 16 Z" fill="${hCol}"/> <path d="M20 16 Q32 12, 44 16" fill="${hCol}"/>`; break;
            case 3: hairBase = `<path d="M18 18 C18 8, 46 8, 46 18 H18 Z" fill="${hCol}"/>`;
                    hair = `<path d="M18 18 C18 6, 46 6, 46 18 H18 Z" fill="${hCol}"/> <path d="M14 20 Q12 30, 14 36" stroke="${hCol}" stroke-width="4" fill="none"/> <path d="M50 20 Q52 30, 50 36" stroke="${hCol}" stroke-width="4" fill="none"/>`; break;
            case 4: hairBase = `<path d="M18 21 C18 10, 46 10, 46 21 H18 Z" fill="#FACC15"/>`;
                    hair = `<path d="M18 21 C18 10, 46 10, 46 21 H18 Z" fill="#FACC15"/>`; break;
            case 5: hairBase = `<circle cx="32" cy="18" r="10" fill="${hCol}"/>`;
                    hair = `<circle cx="32" cy="16" r="12" fill="${hCol}"/>`; break;
            case 6: hairBase = `<path d="M18 22 C18 10, 46 10, 46 22 H18 Z" fill="${hCol}" opacity="0.8"/>`;
                    hair = `<path d="M22 10 L20 22 M32 9 L32 22 M42 10 L44 22" stroke="#222" stroke-width="2" fill="none"/><path d="M27 9 L26 22 M37 9 L38 22" stroke="#222" stroke-width="2" fill="none"/>`; break;
            case 7: hairBase = `<path d="M20 22 V10 H44 V22" fill="${hCol}"/>`;
                    hair = `<rect x="20" y="8" width="24" height="14" rx="2" fill="${hCol}"/>`; break;
            case 8: hairBase = `<path d="M18 20 C18 10, 46 10, 46 20" fill="${hCol}"/>`;
                    hair = `<path d="M18 20 C18 9, 46 9, 46 20" fill="none" stroke="${hCol}" stroke-width="8" stroke-dasharray="2,3"/>`; break;
            case 9: hairBase = `<path d="M18 18 C18 8, 46 8, 46 18 H18 Z" fill="${hCol}"/>`;
                    hair = `<circle cx="32" cy="8" r="5" fill="${hCol}"/> <path d="M18 18 C18 10, 46 10, 46 18" fill="${hCol}"/>`; break;
            case 10: hairBase = `<path d="M18 22 C18 10, 46 10, 46 22" fill="${hCol}"/>`;
                     hair = `<path d="M18 20 C18 9, 46 9, 46 20 L46 22 H18 Z" fill="${hCol}"/><path d="M40 14 L36 18" stroke="#333" stroke-width="1.5"/>`; break;
            case 11: hairBase = `<rect x="26" y="10" width="12" height="12" fill="${hCol}"/>`;
                     hair = `<path d="M28 22 V8 C28 6, 36 6, 36 8 V22" fill="${hCol}"/>`; break;
        }

        let beard = '';
        if (beardIdx === 1) beard = `<path d="M28 44 L32 47 L36 44" stroke="#111" stroke-width="2" fill="none"/>`;
        if (beardIdx === 2) beard = `<path d="M18 26 V32 C18 42, 46 42, 46 32 V26 H44 V32 C44 40, 20 40, 20 32 V26 Z" fill="#111" opacity="0.8"/>`;

        return `<svg viewBox="0 0 64 64" class="${isBench ? 'bench-face' : 'player-face'}" xmlns="http://www.w3.org/2000/svg">${body}${head}${eyes}${nose}${mouth}${beard}${hairBase}${hair}<ellipse cx="26" cy="14" rx="4" ry="2" fill="white" opacity="0.08"/></svg>`;
    };

    const getCardStyle = (ovr) => {
        if (ovr >= 85) return { bg: "bg-gradient-to-br from-yellow-900/90 to-slate-900", border: "border-yellow-500/60", text: "text-yellow-100" };
        if (ovr >= 80) return { bg: "bg-gradient-to-br from-green-900/90 to-slate-900", border: "border-green-500/60", text: "text-green-100" };
        return { bg: "bg-gradient-to-br from-slate-800 to-slate-950", border: "border-slate-600", text: "text-slate-200" };
    };

    // --- 4. BOUCLE D'AFFICHAGE INTELLIGENTE ---
    // Si Scout, on crée des joueurs fictifs. Si MyTeam, on prend les vrais.
    let playersToRender = [];
    if (isScout) {
        for(let i=0; i<form.zones.length; i++) {
            playersToRender.push({
                id: 'opp-'+i,
                name: 'ADV '+(i+1),
                role: 'starter',
                slot: i,
                pos: form.zones[i],
                ovr: '??',
                age: '??',
                energy: 100
            });
        }
    } else {
        playersToRender = this.state.players;
    }

    for(let i=0; i<form.zones.length; i++) {
        const p = playersToRender.find(x => x.role === 'starter' && x.slot === i);
        const coord = form.coords[i];
        const card = document.createElement('div');
        const isOut = !isScout && (p && p.pos !== form.zones[i]);

        card.style.left = coord.x + '%';
        card.style.top = coord.y + '%';

        if (p) {
            // Style gris pour le scout, coloré pour nous
            const style = isScout ? { bg: "bg-slate-800", border: "border-slate-600", text: "text-slate-300" } : getCardStyle(p.ovr);

            card.className = `player-card ${isOut ? 'malus' : ''} ${style.bg} ${style.border}`;
            if (!isScout) card.onclick = () => { if(!this.match.active || this.isLiveCoaching) this.openPlayerSheet(p); };

            const ovr = isScout ? '?' : (isOut ? Math.round(p.ovr * 0.7) : p.ovr);
            const enW = p.energy || 100;
            const enCol = enW > 70 ? 'bg-green-500' : (enW > 40 ? 'bg-orange-500' : 'bg-red-500');

            let roleBadge = '';
            if (!isScout && this.state.roles) {
                if (this.state.roles.captain === p.id) roleBadge = `<div class="absolute -top-1.5 -left-1.5 w-4 h-4 bg-yellow-500 text-slate-900 rounded-full flex items-center justify-center text-[8px] font-bold border border-white shadow-md z-30">C</div>`;
                else if (this.state.roles.penalty === p.id) roleBadge = `<div class="absolute -top-1.5 -left-1.5 w-4 h-4 bg-green-500 text-white rounded-full flex items-center justify-center text-[8px] font-bold border border-white shadow-md z-30">P</div>`;
            }

            // GÉNÉRATION VISAGE : Si Scout, on utilise le code équipe adverse pour créer la graine unique
            const seed = isScout ? `opp-${targetTeamCode}-${i}-${this.state.matchIndex}` : (p.id || p.name);
            const avatarHTML = generateAvatar(seed, false);

            card.innerHTML = `
                ${roleBadge}
                ${avatarHTML}

                <div class="flex justify-between w-full px-1 mt-0.5 relative z-50">
                     <div class="card-ovr ${style.text}">${ovr}</div>
                     <div class="card-age text-slate-300 opacity-80">${p.age}</div>
                </div>
                <div class="card-pos text-right pr-1 -mt-1 relative z-50">${p.pos}</div>

                <div class="card-energy w-[70%] h-0.5 bg-slate-900/80 mt-auto mb-1 mx-auto rounded-full overflow-hidden border border-white/10 z-20 relative">
                    <div class="h-full ${enCol}" style="width:${enW}%"></div>
                </div>

                <div class="card-name mt-auto w-full bg-slate-950/80 py-0.5 text-center text-[6px] text-white truncate px-0.5 border-t border-white/10 backdrop-blur-sm relative z-50">
                    ${isScout ? 'ADV '+(i+1) : p.name.split(' ').pop()}
                </div>
            `;
        } else {
            card.className = "player-card bg-slate-900/50 border-slate-700 border-dashed opacity-70 hover:opacity-100 flex items-center justify-center";
            if(!isScout) card.onclick = () => { if(!this.match.active || this.isLiveCoaching) this.openSwapModal(i); };
            card.innerHTML = `<div class="font-teko text-2xl text-slate-600">+</div>`;
        }
        container.appendChild(card);
    }

    // --- 5. BANC DE TOUCHE (Uniquement pour nous, pas le scout) ---
    if (layerId === 'pitch-cards-layer' && !isScout) {
        const bC = document.getElementById('bench-list-container');
        if(bC) {
            bC.innerHTML = '';
            bC.className = "flex flex-wrap gap-2 justify-center pb-20";

            this.state.players.filter(p => p.role !== 'starter').forEach(p => {
                const it = document.createElement('div');
                const style = getCardStyle(p.ovr);
                it.className = `relative min-w-[110px] h-[50px] ${style.bg} border ${style.border} rounded-lg p-2 flex items-center gap-2 cursor-pointer hover:brightness-110 transition active:scale-95 shadow-sm`;
                it.onclick = () => { this.openPlayerSheet(p); };

                const enCol = p.energy > 70 ? 'bg-green-500' : (p.energy > 40 ? 'bg-orange-500' : 'bg-red-500');
                const miniAvatar = generateAvatar(p.id || p.name, true);

                it.innerHTML = `
                    ${miniAvatar}
                    <div class="flex flex-col items-center justify-center min-w-[20px] border-r border-white/10 pr-2">
                        <span class="font-teko text-lg ${style.text} font-bold leading-none">${p.ovr}</span>
                        <span class="text-[7px] text-slate-400 font-bold uppercase">${p.pos}</span>
                    </div>
                    <div class="flex flex-col justify-center min-w-0 flex-1 pl-1">
                        <span class="text-[9px] font-bold text-white uppercase leading-tight truncate">${p.name.split(' ').pop()}</span>
                        <div class="w-full h-1 bg-slate-900/50 rounded-full mt-1 overflow-hidden">
                            <div class="h-full ${enCol}" style="width: ${p.energy}%"></div>
                        </div>
                    </div>
                `;
                bC.appendChild(it);
            });
            const bcCount = document.getElementById('bench-count');
            if(bcCount) bcCount.innerText = `${this.state.players.filter(p => p.role !== 'starter').length}/20`;
            const avgEl = document.getElementById('squad-avg-ovr');
            if(avgEl) avgEl.innerText = Math.round(this.getTeamPower());
        }
    }
}
            // Génère un avatar SVG spécifique pour le manager (Costume cravate)
generateManagerIcon(seed, size = 64) {
    // 1. Initialisation du générateur aléatoire basé sur le seed (Nom ou ID)
    let hash = 0;
    const seedStr = seed.toString();
    for (let i = 0; i < seedStr.length; i++) hash = seedStr.charCodeAt(i) + ((hash << 5) - hash);
    const safeHash = Math.abs(hash);
    const prng = (min, max) => {
        const x = Math.sin(hash++) * 10000;
        return Math.floor((x - Math.floor(x)) * (max - min + 1)) + min;
    };

    // 2. Palette de peau (Réaliste)
    const skinPalette = [
        { base: "#5D4037", shadow: "#3E2723" }, // Foncé
        { base: "#8D6E63", shadow: "#5D4037" }, // Moyen
        { base: "#E0AC69", shadow: "#8D5524" }, // Clair
        { base: "#F2C490", shadow: "#C69C72" }  // Très clair
    ];
    const skin = skinPalette[safeHash % skinPalette.length]; // Choix déterministe

    // 3. Costume (Toujours classe)
    // Veste foncée (Bleu nuit, Noir, Gris anthracite)
    const suitColors = ["#1e293b", "#0f172a", "#334155", "#111827"];
    const suitColor = suitColors[safeHash % suitColors.length];

    // Cravate (Rouge, Bleu, Orange...)
    const tieColors = ["#ef4444", "#3b82f6", "#f97316", "#eab308"];
    const tieColor = tieColors[prng(0, tieColors.length - 1)];

    // 4. Dessin du Corps (Costume)
    const body = `
        <path d="M12 50 Q32 45, 52 50 V64 H12 Z" fill="${suitColor}"/>
        <path d="M26 50 L32 58 L38 50" fill="white"/>
        <path d="M30 50 L34 50 L33 60 L31 60 Z" fill="${tieColor}"/>
        <path d="M24 38 L24 50 L40 50 L40 38" fill="${skin.base}"/>
        <path d="M24 40 Q32 45, 40 40" fill="${skin.shadow}" opacity="0.3"/>
    `;

    // 5. Tête et Visage
    const head = `
        <path d="M19 16 C19 6, 45 6, 45 16 V28 C45 38, 40 46, 32 46 C24 46, 19 38, 19 28 V16 Z" fill="${skin.base}"/>
        <path d="M32 20 L45 20 V28 C45 36, 40 45, 32 46 Z" fill="${skin.shadow}" opacity="0.2"/>
    `;

    // 6. Cheveux (Plus sages que les joueurs)
    const hairColors = ["#0F0F0F", "#282828", "#4A3B32", "#888888"]; // Inclut gris
    const hCol = hairColors[prng(0, hairColors.length - 1)];
    const hairStyle = prng(0, 4);
    let hair = '';

    if(hairStyle === 0) hair = `<path d="M18 20 C18 8, 46 8, 46 20 H18 Z" fill="${hCol}"/>`; // Court simple
    else if(hairStyle === 1) hair = `<path d="M18 24 V16 C18 6, 46 6, 46 16 V24" fill="none" stroke="${hCol}" stroke-width="2"/>`; // Calvitie
    else if(hairStyle === 2) hair = `<path d="M18 18 C18 5, 46 5, 46 18 L46 24 H18 Z" fill="${hCol}"/>`; // Volume
    else hair = `<rect x="20" y="10" width="24" height="12" rx="4" fill="${hCol}"/>`; // Brosse

    // 7. Yeux / Nez
    const faceFeatures = `
        <circle cx="25" cy="28" r="1.5" fill="#111"/>
        <circle cx="39" cy="28" r="1.5" fill="#111"/>
        <path d="M32 28 L30 36 L34 36" fill="none" stroke="${skin.shadow}" stroke-width="1"/>
        <path d="M26 42 Q32 44, 38 42" fill="none" stroke="#3E2723" stroke-width="1"/>
    `;

    // Lunettes (Accessoire Manager fréquent - 30% chance)
    let accessories = '';
    if(prng(0, 10) > 6) {
        accessories = `<g stroke="#d4af37" stroke-width="1" fill="none"><circle cx="25" cy="28" r="4"/><circle cx="39" cy="28" r="4"/><line x1="29" y1="28" x2="35" y2="28"/></g>`;
    }

    return `<svg viewBox="0 0 64 64" width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" class="manager-face">${body}${head}${faceFeatures}${hair}${accessories}</svg>`;
}

       getTeamPower() {
            const s = this.state.players.filter(p => p.role === 'starter');
            if (s.length < 1) return 0;

            const form = FORMATIONS[this.state.formation];
            let t = 0;
            const currentTime = (this.match && this.match.active) ? this.match.time : 0;

            s.forEach(p => {
                // 1. Base OVR
                let b = (p.pos !== form.zones[p.slot]) ? p.ovr * 0.7 : p.ovr;

                // 2. MALUS FATIGUE
                if (currentTime > 60) {
                    const fatigueImpact = (100 - p.energy) / 150;
                    b = b * (1 - fatigueImpact);
                }
                if(p.energy < 40) b *= 0.8;

                t += b;
            });

            // --- NOUVEAU : MALUS CARTON ROUGE ---
            // Si on a des rouges, on perd 15% de puissance par joueur expulsé
            if (this.match && this.match.homeRed > 0) {
                t *= (1 - (this.match.homeRed * 0.15));
            }
            // ------------------------------------

            return (t / 11) * (this.match.speechBoost || 1.0);
        }

        getOpponent() {
// --- SÉCURITÉ ANTI-CRASH (AJOUT) ---
// Si le joueur n'a pas encore choisi son équipe, on renvoie un adversaire "fantôme"
// pour que l'interface puisse se charger sans erreur.
if (!this.state.userTeamName || !this.state.standings[this.state.userTeamName]) {
    return { n: 'En attente...', ovr: 0, style: '...' };
}
// -----------------------------------

if (this.state.stage === 'groups') {
    const myName = this.state.userTeamName;
    const myG = this.state.standings[myName].grp;

    // On cherche les adversaires du même groupe (qui ne sont pas nous)
    const r = this.state.groups[myG].filter(n => n.n !== myName);

    const targetIdx = this.state.matchIndex % 3;
    // Sécurité supplémentaire si l'index dépasse
    const oppTeam = r[targetIdx] || r[0];

    return this.state.standings[oppTeam.n];
} else {
    return this.state.knockout[this.state.stage] || this.state.standings['Sénégal'];
}
}
        generateOpponent11(opp) {
            // 1. Accès à la Base de Données
            const db = this.state.worldPlayers || REAL_SQUADS_DB;
            let realSquad = db[opp.code];

            // Secours si l'équipe est vide
            if (!realSquad || realSquad.length === 0) return this.generateRandomSquad(opp);

            // 2. LOGIQUE TACTIQUE : Quelle formation pour quel style ?
            let targetShape = { DEF: 4, MID: 3, FWD: 3 }; // Le 4-3-3 par défaut (Standard)

            // A. Le 4-4-2 (Équipes de Contre / Physique)
            // Ex: Nigeria, RDC, Ghana
            if (['Contre', 'Vertical', 'Vitesse', 'Puissance', 'Physique'].includes(opp.style)) {
                targetShape = { DEF: 4, MID: 4, FWD: 2 };
            }
            // B. Le 5-4-1 (Le "Bus" Défensif)
            // Ex: Petites nations, Tunisie (Bloc Bas)
            else if (['Bloc Bas', 'Défensif', 'Solidité', 'Lutte'].includes(opp.style)) {
                targetShape = { DEF: 5, MID: 4, FWD: 1 };
            }
            // C. Le 3-5-2 (Offensif / Pressing)
            // Ex: Maroc, Algérie (Grosse maîtrise au milieu)
            else if (['Offensif', 'Pressing', 'Impact', 'Créativité'].includes(opp.style)) {
                targetShape = { DEF: 3, MID: 5, FWD: 2 };
            }

            // 3. SÉLECTION DES JOUEURS (On remplit les cases)
            // On trie tous les joueurs par niveau pour prendre les meilleurs à chaque poste
            const allPlayers = [...realSquad].sort((a, b) => b.ovr - a.ovr);
            const selectedSquad = [];

            // Le Gardien (Toujours 1)
            const gk = allPlayers.find(p => p.pos === 'GK');
            selectedSquad.push(gk || allPlayers[0]);

            // Les Défenseurs (Selon la tactique)
            const defs = allPlayers.filter(p => p.pos === 'DEF' && !selectedSquad.includes(p));
            selectedSquad.push(...defs.slice(0, targetShape.DEF));

            // Les Milieux
            const mids = allPlayers.filter(p => p.pos === 'MID' && !selectedSquad.includes(p));
            selectedSquad.push(...mids.slice(0, targetShape.MID));

            // Les Attaquants
            const fwds = allPlayers.filter(p => p.pos === 'FWD' && !selectedSquad.includes(p));
            selectedSquad.push(...fwds.slice(0, targetShape.FWD));

            // 4. BOUCHAGE DE TROUS (Si pas assez de joueurs à un poste précis)
            // Ex: On veut 5 défenseurs mais l'équipe n'en a que 4 -> On prend un milieu défensif pour dépanner
            while (selectedSquad.length < 11) {
                const filler = allPlayers.find(p => !selectedSquad.includes(p));
                if (filler) selectedSquad.push(filler);
                else break;
            }

            // 5. TRI POUR L'AFFICHAGE (GK en haut, Attaquants en bas)
            const order = { 'GK': 1, 'DEF': 2, 'MID': 3, 'FWD': 4 };
            return selectedSquad.map(p => ({
                ...p, // On garde toutes les infos (nom, âge...)
                spd: p.spd || 70, // Sécurité vitesse
                isStar: p.ovr >= 83
            })).sort((a, b) => order[a.pos] - order[b.pos]);
        }

       startMatch() {
            // 1. Vérifications
            const starters = this.state.players.filter(p => p.role === 'starter');
            if (starters.length < 11) return this.toast("11 joueurs requis !");

            const opp = this.getOpponent();
            if (!opp) return this.toast("Erreur tirage.");

            // 2. Génération de l'adversaire
            const oppXI = this.generateOpponent11(opp);

            // C'est ici que 'myCode' est défini !
            const myCode = this.state.userTeamCode || 'CIV';
            const myBadge = document.getElementById('dash-user-badge');

            if (myBadge) {
                myBadge.innerHTML = `
                    ${myCode}
                    <div class="absolute -bottom-2 -right-2 bg-white text-slate-900 text-[9px] font-bold px-1.5 rounded border border-slate-300">DOM</div>
                `;
            }

            // 3. Préparation des données du match (AVEC LES CARTONS)
            this.match = {
                active: false,
                time: 0, score: [0, 0],

                home: myCode,
                away: opp.code,

                opp: opp,
                oppSquad: oppXI,
                timer: null,
                tactic: 'bal', speechBoost: 1.0,
                stats: { shots: 0, shotsAway: 0 },
                penalties: null,

                // Nouveaux compteurs pour les cartons
                homeRed: 0,
                awayRed: 0
            };

            // 4. Remplissage de l'interface "Face-à-Face" (Avant-match)
            const pModal = document.getElementById('preview-modal');
            const pHome = document.getElementById('preview-home-list');
            const pAway = document.getElementById('preview-away-list');

            const pCode = document.getElementById('preview-opp-code');
            if(pCode) pCode.innerText = opp.code;

            // Remplir ma liste
            pHome.innerHTML = '';
            const posOrder = { 'GK': 1, 'DEF': 2, 'MID': 3, 'FWD': 4 };
            starters.sort((a,b) => posOrder[a.pos] - posOrder[b.pos]).forEach(p => {
                pHome.innerHTML += `
                    <div class="flex items-center justify-between p-2 rounded bg-slate-800/50 border border-white/5">
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-bold text-orange-500 w-5">${p.pos}</span>
                            <span class="text-[10px] font-bold text-white truncate max-w-[80px]">${p.name.split(' ').pop()}</span>
                        </div>
                        <div class="font-teko text-lg text-white">${p.ovr}</div>
                    </div>`;
            });

            // Remplir liste ADVERSAIRE (Cliquable)
            pAway.innerHTML = '';
            oppXI.forEach((p, index) => {
                const isStar = p.isStar ? 'border-yellow-500/30 bg-yellow-500/10' : 'border-white/5 bg-slate-800/50';
                const nameColor = p.isStar ? 'text-yellow-100' : 'text-slate-300';
                const icon = p.isStar ? SVGS.star : '';

                pAway.innerHTML += `
                    <div onclick="app.viewOpponent(${index})" class="flex items-center justify-between p-2 rounded border ${isStar} cursor-pointer hover:bg-slate-700 transition active:scale-95 group">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold ${nameColor} truncate max-w-[80px] group-hover:text-white">${p.name} ${icon}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-teko text-lg text-white">${p.ovr}</span>
                            <span class="text-[8px] font-bold text-slate-500 w-5 text-right">${p.pos}</span>
                        </div>
                    </div>`;
            });

            // 5. Afficher le modal
            if(pModal) pModal.classList.remove('hidden');
        }

        kickOff() {
// 1. Fermer le modal de preview
const pModal = document.getElementById('preview-modal');
if(pModal) pModal.classList.add('hidden');

// GESTION AUDIO
this.stopMenuMusic();
this.synthCrowdDynamic();
this.playSound('whistle');

// 2. Activer le match
this.match.active = true;
this.match.timer = setInterval(() => this.tick(), 1000);

// 3. Reset de l'interface du match
const sHome = document.getElementById('score-home'); if(sHome) sHome.innerText = '0';
const sAway = document.getElementById('score-away'); if(sAway) sAway.innerText = '0';
const mTimer = document.getElementById('match-timer'); if(mTimer) mTimer.innerText = '00:00';

// --- CORRECTION : MISE A JOUR DES NOMS D'EQUIPES ---
// Badge Domicile (Votre équipe)
const mHomeBadge = document.getElementById('match-home-badge');
if(mHomeBadge) mHomeBadge.innerText = this.match.home; // Affiche "SEN", "MAR", etc.

// Badge Extérieur (Adversaire)
const mOppBadge = document.getElementById('match-opp-badge');
if(mOppBadge) mOppBadge.innerText = this.match.away;
// ---------------------------------------------------

const cLog = document.getElementById('commentary-log'); if(cLog) cLog.innerHTML = '';
const htO = document.getElementById('ht-overlay'); if(htO) htO.classList.remove('active');

// 4. Aller à la vue match
this.goToView('match');
this.updateMatchInstructionsUI();

this.addCommentary(`${SVGS.mega} COUP D'ENVOI ! ${this.match.home} affronte ${this.match.away}.`);
}

        updateMatchAdvice() {
            const box = document.getElementById('match-assistant-msg');
            if (!box) return;

            const t = this.match.time;
            const s = this.match.score;
            const diff = s[0] - s[1]; // Positif = on gagne, Négatif = on perd

            // On récupère la possession actuelle (depuis le DOM ou le calcul)
            const possText = document.getElementById('poss-val-home').innerText;
            const poss = parseInt(possText) || 50;

            let msg = "";
            let urgency = "normal"; // normal, warning, critical

            // --- LOGIQUE DE L'ASSISTANT ---

            // 1. DÉBUT DE MATCH (0-15min)
            if (t < 15) {
                msg = "Phase d'observation. Restez bien en place et faites circuler le ballon.";
            }
            // 2. FIN DE MATCH (80min+)
            else if (t > 80) {
                if (diff === 0) {
                    msg = "Le match nul se joue maintenant. Un exploit individuel ou on ferme la boutique ?";
                    urgency = "warning";
                } else if (diff === 1) {
                    msg = "On tient le score ! Passez en mode DÉFENSIF et gagnez du temps.";
                    urgency = "warning";
                } else if (diff === -1) {
                    msg = "C'est maintenant ou jamais ! Passez en ASSAUT TOTAL !";
                    urgency = "critical";
                } else if (diff <= -2) {
                    msg = "C'est compliqué... Essayons de sauver l'honneur au moins.";
                } else {
                    msg = "Le match est plié. Gérez la fatigue des cadres.";
                }
            }
            // 3. SCÉNARIOS SPÉCIFIQUES (Reste du match)
            else {
                if (poss < 40) {
                    msg = "On court après le ballon ! Augmentez le PRESSING ou jouez en CONTRE.";
                    urgency = "warning";
                } else if (poss > 65 && diff <= 0) {
                    msg = "Possession stérile. Il faut prendre plus de risques offensifs (ASSAUT).";
                } else if (diff < 0) {
                    msg = "On est menés. Ne paniquez pas, mais il faut monter le bloc d'un cran.";
                } else if (diff > 0) {
                    msg = "On contrôle. Forcez-les à sortir pour les piquer en contre.";
                } else {
                    msg = "Match équilibré. C'est la bataille du milieu de terrain qui décidera tout.";
                }
            }

            // Affichage avec couleurs dynamiques
            const colorClass = urgency === 'critical' ? 'text-red-400' : (urgency === 'warning' ? 'text-orange-400' : 'text-blue-300');

            box.innerHTML = `
                <div class="flex items-start gap-3 animate-pulse-slow">
                    <div class="mt-0.5 p-1.5 bg-slate-800 rounded-full border border-slate-600 shadow-sm shrink-0">
                        ${SVGS.assistant}
                    </div>
                    <div>
                        <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-0.5">Conseil Adjoint</div>
                        <div class="text-[10px] font-medium leading-tight ${colorClass} italic">"${msg}"</div>
                    </div>
                </div>
            `;
        }
        // Trouve un joueur pertinent pour l'action (Ex: un attaquant pour un dribble)
getRandomPlayerForAction(teamName, role) {
    let pool = [];

    // --- CORRECTION : ON COMPARE AVEC L'ÉQUIPE DU JOUEUR, PAS JUSTE "Côte d'Ivoire" ---
    if (teamName === this.state.userTeamName) {
    // ----------------------------------------------------------------------------------

        // Joueurs titulaires seulement (C'est VOUS)
        const starters = this.state.players.filter(p => p.role === 'starter');
        if (role === 'ATT') pool = starters.filter(p => p.pos === 'FWD' || p.pos === 'MID');
        else if (role === 'DEF') pool = starters.filter(p => p.pos === 'DEF' || p.pos === 'MID' || p.pos === 'GK');
        else pool = starters;
    } else {
        // Adversaire (IA)
        if (!this.match.oppSquad) return { name: "L'attaquant" };
        if (role === 'ATT') pool = this.match.oppSquad.filter(p => p.pos === 'FWD' || p.pos === 'MID');
        else if (role === 'DEF') pool = this.match.oppSquad.filter(p => p.pos === 'DEF' || p.pos === 'GK');
        else pool = this.match.oppSquad;
    }

    if (pool.length === 0) return { name: "Un joueur" };
    return pool[Math.floor(Math.random() * pool.length)];
}

// Génère un commentaire spécifique
triggerActionCommentary(type, teamName) {
    let templates = ACTION_COMMS[type];
    if (!templates) return;

    let txt = templates[Math.floor(Math.random() * templates.length)];

    // On cherche un joueur cohérent avec l'action
    let role = (type === 'defense') ? 'DEF' : 'ATT';
    let p = this.getRandomPlayerForAction(teamName, role);

    // On remplace le placeholder
    const pName = `<span class="text-white font-bold">${p.name.split(' ').pop()}</span>`;
    this.addCommentary(txt.replace("{PLAYER}", pName));
}

       tick() {
            // 1. Calculs de Puissance & Synergie
            const myPower = this.getTeamPower(); // Prend déjà en compte vos cartons rouges via getTeamPower()

            // --- MODIFICATION : L'ADVERSAIRE S'AFFAIBLIT S'IL A UN ROUGE ---
            let oppPowerBase = this.match.opp.ovr || 70;

            // Si l'IA a des rouges, elle perd 15% de force par joueur exclu
            if (this.match.awayRed > 0) {
                oppPowerBase *= (1 - (this.match.awayRed * 0.15));
            }
            const oppPower = oppPowerBase;
            // ---------------------------------------------------------------

            const starters = this.state.players.filter(p => p.role === 'starter');
            let avgStats = { pac:0, sho:0, pas:0, dri:0, def:0, phy:0 };
            if (starters.length > 0) {
                starters.forEach(p => {
                    if(!p.stats) p.stats = this.generatePlayerStats(p.pos, p.ovr);
                    Object.keys(avgStats).forEach(k => avgStats[k] += p.stats[k]);
                });
                Object.keys(avgStats).forEach(k => avgStats[k] = Math.round(avgStats[k] / starters.length));
            }

            // --- LOGIQUE TACTIQUE ---
            const inst = this.state.instructions;
            let synergyBonus = 1.0;

            if (inst.style === 'counter' && avgStats.pac > 80) synergyBonus += 0.15;
            else if (inst.style === 'possession' && avgStats.pas > 80) synergyBonus += 0.15;
            if (inst.pressing === 'high' && avgStats.phy < 70) synergyBonus -= 0.12;

            const powerRatio = (myPower * synergyBonus) / oppPower;

            let offensiveFactor = (this.match.tactic === 'att' ? 1.5 : (this.match.tactic === 'def' ? 0.7 : 1));
            let chance = 0.012 * offensiveFactor;

            // Tempo pour les tirs
            let tempoMult = (inst.tempo === 'fast') ? 1.2 : 1.0;

            this.match.time++;

            // --- GESTION INTELLIGENTE DES FAUTES (Version Dynamique) ---

            // 1. Définition de l'agressivité
            const homeAgg = inst.aggression;

            // L'IA est agressive selon son style
            let awayAgg = 'normal';
            const s = this.match.opp.style;
            if (['Physique', 'Lutte', 'Impact', 'Pressing', 'Défensif'].includes(s)) awayAgg = 'hard';
            if (['Technique', 'Tiki-Taka', 'Possession'].includes(s)) awayAgg = 'soft';

            // 2. Probabilité globale
            let foulChance = 0.025;
            if (homeAgg === 'hard') foulChance += 0.015;
            if (awayAgg === 'hard') foulChance += 0.015;

            if (Math.random() < foulChance) {
                // 3. Qui est le coupable ?
                let hW = (homeAgg === 'hard' ? 2.5 : (homeAgg === 'soft' ? 0.5 : 1));
                let aW = (awayAgg === 'hard' ? 2.5 : (awayAgg === 'soft' ? 0.5 : 1));

                const isHomeFoul = Math.random() < (hW / (hW + aW));
                let fName = "Un joueur";

                // --- CORRECTION ICI : NOM DYNAMIQUE DE VOTRE ÉQUIPE ---
                const teamName = isHomeFoul ? this.state.userTeamName : this.match.opp.n;
                // ------------------------------------------------------

                // 4. Calcul de la sanction
                const severity = Math.random();

                let redLimit = 0.02;
                let yellowLimit = 0.17;

                const activeAgg = isHomeFoul ? homeAgg : awayAgg;

                if (activeAgg === 'hard') {
                    redLimit = 0.05;
                    yellowLimit = 0.40;
                } else if (activeAgg === 'soft') {
                    yellowLimit = 0.08;
                }

                // --- APPLICATION DE LA SANCTION ---

                // A. CARTON ROUGE
                if (severity < redLimit) {
                    this.playSound('whistle');

                    if (isHomeFoul) {
                        const culprits = this.state.players.filter(p => p.role === 'starter' && !p.sentOff);
                        if (culprits.length > 0) {
                            const p = culprits[Math.floor(Math.random() * culprits.length)];
                            p.sentOff = true;
                            this.match.homeRed++;
                            fName = `<span class="text-white font-bold">${p.name}</span>`;
                            this.addCommentary(`${SVGS.alert} <b class="text-red-500">CARTON ROUGE !</b> ${fName} est exclu !`);
                        }
                    } else {
                        const culprits = this.match.oppSquad.filter(p => !p.sentOff);
                        if (culprits.length > 0) {
                            const p = culprits[Math.floor(Math.random() * culprits.length)];
                            p.sentOff = true;
                            this.match.awayRed++;
                            fName = `<span class="text-slate-400 font-bold">${p.name}</span>`;
                            this.addCommentary(`${SVGS.alert} <b class="text-red-500">CARTON ROUGE !</b> L'adversaire perd ${fName} sur expulsion !`);
                        }
                    }
                }
                // B. CARTON JAUNE
                else if (severity < yellowLimit) {
                    // On récupère un joueur au hasard dans l'équipe concernée (Dynamique)
                    const fouler = this.getRandomPlayerForAction(teamName, 'DEF');

                    // Couleur du nom : Blanc pour vous, Gris pour l'IA
                    fName = `<span class="${isHomeFoul ? 'text-white' : 'text-slate-400'} font-bold">${fouler.name.split(' ').pop()}</span>`;

                    this.addCommentary(`<span class="text-yellow-400">■</span> Carton jaune pour ${fName}. L'arbitre sévit sur l'engagement.`);
                }
                // C. FAUTE SIMPLE
                else {
                    const fouler = this.getRandomPlayerForAction(teamName, 'DEF');
                    fName = `<span class="${isHomeFoul ? 'text-white' : 'text-slate-400'} font-bold">${fouler.name.split(' ').pop()}</span>`;

                    const msgs = [`Faute sifflée contre ${fName}.`, `Intervention illicite de ${fName}.`, `L'arbitre siffle une faute de ${fName}.`];
                    this.addCommentary(msgs[Math.floor(Math.random() * msgs.length)]);
                }
            }
            // ----------------------------------------------------

            // 2. GÉNÉRATION D'ACTIONS DE JEU (Commentaires Dribbles/Défense)
            if (Math.random() < 0.20) {
                const rand = Math.random();
                const activeTeam = (rand > 0.5) ? "Côte d'Ivoire" : this.match.opp.n;

                if (rand < 0.25) this.triggerActionCommentary('dribble', activeTeam);
                else if (rand < 0.50) this.triggerActionCommentary('defense', activeTeam);
                else if (rand < 0.75) this.triggerActionCommentary('shot', activeTeam);
                else this.addCommentary(AMBIANCE_COMMS[Math.floor(Math.random() * AMBIANCE_COMMS.length)]);
            }

            // 3. SIMULATION POSSESSION
            let currentPoss = 50 + (powerRatio > 1 ? 5 : -5) + Math.floor(Math.random() * 10 - 5);
            const possValH = document.getElementById('poss-val-home');
            if(possValH) possValH.innerText = currentPoss + '%';
            const possValA = document.getElementById('poss-val-away');
            if(possValA) possValA.innerText = (100 - currentPoss) + '%';
            const possBar = document.getElementById('possession-home-bar');
            if(possBar) possBar.style.width = currentPoss + '%';

            // 4. SIMULATION TIRS
            if (Math.random() < 0.08 * tempoMult) {
                if (Math.random() < (currentPoss/100)) {
                    this.match.stats.shots++;
                    const shH = document.getElementById('stats-shots-home');
                    if(shH) shH.innerText = this.match.stats.shots;
                } else {
                    this.match.stats.shotsAway++;
                    const shA = document.getElementById('stats-shots-away');
                    if(shA) shA.innerText = this.match.stats.shotsAway;
                }
            }

            // 5. GESTION DES BUTS (Impactés par les cartons via powerRatio)

            // BUT DOMICILE (ÉQUIPE DU JOUEUR)
            if (Math.random() < chance * powerRatio) {
                this.match.score[0]++;
                this.match.stats.shots++;
                const sh = document.getElementById('score-home'); if(sh) sh.innerText = this.match.score[0];
                document.getElementById('stats-shots-home').innerText = this.match.stats.shots;

                this.playSound('goal');

                // --- 1. Récupération des titulaires actuels (Sénégal, Maroc, etc.) ---
                const starters = this.state.players.filter(p => p.role === 'starter');
                let candidates = [];

                // --- 2. Logique de pondération (Attaquants marquent +) ---
                starters.forEach(p => {
                    if (p.pos === 'GK') return; // Pas de gardien buteur

                    let tickets = 1; // Défenseurs
                    if (p.pos === 'MID') tickets = 4; // Milieux
                    if (p.pos === 'FWD') tickets = 8; // Attaquants

                    // Bonus stats
                    if (p.stats && p.stats.sho > 80) tickets += 3;

                    // On ajoute le joueur X fois dans la liste
                    for(let i=0; i < tickets; i++) candidates.push(p);
                });

                // --- 3. Tirage au sort ---
                const scorer = candidates.length > 0
                    ? candidates[Math.floor(Math.random() * candidates.length)]
                    : (starters[0] || {name: "Capitaine"});

                // --- 4. CORRECTION DU NOM D'ÉQUIPE ---
                // Au lieu de "Côte d'Ivoire", on met this.state.userTeamName
                const myTeamName = this.state.userTeamName || "Mon Équipe";
                this.registerGoal(scorer.name, myTeamName);
                // DANS tick(), SECTION BUT DOMICILE
// Juste après : this.showGoalAnim(scorer.name);

// --- DÉBUT MODIF PASSEUR (USER) ---
// 70% de chance d'avoir une passe décisive (pas sur pénalty ou exploit solo)
if (Math.random() < 0.70) {
    // On cherche un coéquipier (qui n'est pas le buteur et pas le gardien)
    const teammates = starters.filter(p => p.name !== scorer.name && p.pos !== 'GK');

    if (teammates.length > 0) {
        // Les milieux (MID) et ailiers ont plus de chance de faire la passe
        let passerCandidates = [];
        teammates.forEach(p => {
            passerCandidates.push(p); // 1 chance de base
            if (p.pos === 'MID' || p.pos === 'FWD') passerCandidates.push(p); // Bonus +1 chance
            if (p.stats && p.stats.pas > 80) passerCandidates.push(p); // Bonus Passeur +1 chance
        });

        // Tirage au sort du passeur
        const passer = passerCandidates[Math.floor(Math.random() * passerCandidates.length)];

        // Enregistrement
        this.registerAssist(passer.name, myTeamName);

        // Bonus note pour le passeur (+0.5 à +1.0)
        this.registerRating(passer.name, myTeamName, 7.0 + Math.random());
    }
}
// --- FIN MODIF PASSEUR ---
                this.showGoalAnim(scorer.name);


             // Type de but (Version Pro avec SVGS)
    const rGoal = Math.random();
    let gType = 'normal';
    let icon = SVGS.ball; // Icône par défaut (Ballon)

    if (rGoal > 0.92) { gType = 'freekick'; icon = SVGS.target; }      // Cible rouge pour Coup Franc
    else if (rGoal > 0.85) { gType = 'corner'; icon = SVGS.flag; }     // Drapeau orange pour Corner
    else if (rGoal > 0.75) { gType = 'header'; icon = SVGS.jump; }     // Flèche bleue pour Tête
    else if (rGoal > 0.65) { gType = 'volley'; icon = SVGS.fire; }     // Flamme jaune pour Volley

                const templates = GOAL_COMMS[gType];
                const txt = templates[Math.floor(Math.random() * templates.length)];
                const pName = `<span class="text-orange-400 font-bold uppercase">${scorer.name}</span>`;

                this.addCommentary(`${icon} BUT ! ${txt.replace("{PLAYER}", pName)}`);
            }

            // BUT EXTÉRIEUR (IA)
            else if (Math.random() < chance * (1 / powerRatio)) {
                this.match.score[1]++;
                this.match.stats.shotsAway++;
                const sa = document.getElementById('score-away'); if(sa) sa.innerText = this.match.score[1];
                document.getElementById('stats-shots-away').innerText = this.match.stats.shotsAway;

                this.playSound('opp_goal');

                // Utilisation du nouveau générateur de buteur réaliste
                const scorerName = this.getScorerName(this.match.opp.n);
                this.registerGoal(scorerName, this.match.opp.n);
                // DANS tick(), SECTION BUT EXTÉRIEUR (IA)

// --- DÉBUT MODIF PASSEUR (IA) ---
if (Math.random() < 0.70) {
    // On génère un nom de passeur différent du buteur
    let passerName = this.getScorerName(this.match.opp.n);
    // On s'assure que ce n'est pas le même nom
    if (passerName === scorerName) passerName = this.getScorerName(this.match.opp.n);

    this.registerAssist(passerName, this.match.opp.n);
}
// --- FIN MODIF PASSEUR ---

                const oppNameHTML = `<span class="text-white font-bold">${scorerName}</span>`;
                this.addCommentary(`${SVGS.alert} But pour ${this.match.opp.n}. ${oppNameHTML} punit la défense.`);
            }

            // Fin de match
            if (this.match.time % 5 === 0) this.updateMatchAdvice();
            const timerEl = document.getElementById('match-timer');
            if (timerEl) timerEl.innerText = (this.match.time < 10 ? '0' : '') + this.match.time + ":00";

            if (this.match.time === 45) { clearInterval(this.match.timer); const hto = document.getElementById('ht-overlay'); if(hto) hto.classList.add('active'); }
            if (this.match.time >= 90) this.finishMatch();
        }

        giveSpeech(t) {
            const b = { motivate: 1.05, shake: 1.15, calm: 1.10 };
            this.match.speechBoost = b[t];
            const hto = document.getElementById('ht-overlay'); if(hto) hto.classList.remove('active');
            this.addCommentary(`<i>${SVGS.mega} Coaching : Les mots du manager ont boosté l'équipe (+${Math.round((b[t]-1)*100)}%).</i>`);
            this.match.timer = setInterval(() => this.tick(), 1000);
        }

        // --- NOUVEAU SYSTÈME DE TIRS AU BUT INTERACTIF ---

        initPenaltyShootout() {
    // 1. Initialisation
    this.penState = {
        round: 0,
        score: [0, 0],
        history: [[], []],
        shootersUsed: [],
        winner: null
    };

    // 2. Préparation de l'interface
    document.getElementById('pen-score-home').innerText = "0";
    document.getElementById('pen-score-away').innerText = "0";

    document.getElementById('pen-home-code').innerText = this.state.userTeamCode || 'CIV';

    // CORRECTION : On met à jour le nom de l'adversaire ET LE VÔTRE
    document.getElementById('pen-opp-code').innerText = this.match.opp.code;
    document.getElementById('pen-home-code').innerText = this.state.userTeamCode || 'CIV';

    // Astuce : On cible l'élément juste en dessous du score domicile pour mettre votre Code (ex: SEN)
    // Assurez-vous d'avoir ajouté un ID dans le HTML ou utilisez cette astuce :
    const homeScoreLabel = document.getElementById('pen-score-home');
    if (homeScoreLabel && homeScoreLabel.nextElementSibling) {
        homeScoreLabel.nextElementSibling.innerText = this.state.userTeamCode || 'CIV';
    }

    document.getElementById('pen-history-home').innerHTML = '';
    document.getElementById('pen-history-away').innerHTML = '';
    document.getElementById('pen-result-msg').classList.add('hidden');
    document.getElementById('pen-selection-zone').classList.remove('hidden');

    // 3. Affichage
    document.getElementById('penalty-view').classList.remove('hidden');
    this.renderPenaltyShooters();
}

        renderPenaltyShooters() {
            const list = document.getElementById('pen-shooters-list');
            list.innerHTML = '';

            // On prend les joueurs titulaires qui n'ont pas encore tiré
            const candidates = this.state.players.filter(p =>
                p.role === 'starter' && !this.penState.shootersUsed.includes(p.id)
            ).sort((a,b) => b.ovr - a.ovr); // Les meilleurs en premier

            candidates.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "p-3 bg-slate-800 border border-slate-700 rounded-xl flex items-center justify-between hover:bg-orange-600 hover:border-orange-500 hover:text-white group transition active:scale-95";
                btn.innerHTML = `
                    <div class="flex flex-col text-left">
                        <span class="font-teko text-xl leading-none uppercase">${p.name.split(' ').pop()}</span>
                        <span class="text-[9px] font-bold text-slate-500 group-hover:text-orange-200">${p.pos}</span>
                    </div>
                    <div class="font-teko text-2xl text-slate-600 group-hover:text-white">${p.ovr}</div>
                `;
                btn.onclick = () => this.playPenaltyRound(p);
                list.appendChild(btn);
            });
        }

        playPenaltyRound(player) {
            // Bloquer l'interface
            document.getElementById('pen-selection-zone').classList.add('hidden');
            const msgBox = document.getElementById('pen-result-msg');
            const msgText = document.getElementById('pen-action-text');
            msgBox.classList.remove('hidden');

            // --- 1. TIR DU JOUEUR (CIV) ---
            // Calcul : OVR Joueur vs OVR Gardien Adverse (simulé ~80)
            let successChance = 0.75 + ((player.ovr - 80) * 0.01);
            if (player.pos === 'FWD') successChance += 0.10; // Bonus Attaquants
            if (player.energy < 50) successChance -= 0.10;   // Malus Fatigue

            const isGoalHome = Math.random() < successChance;

            // Animation texte
            msgText.innerText = `... ${player.name} s'élance ...`;
            msgText.className = "font-teko text-4xl text-slate-400 uppercase italic animate-pulse";

            setTimeout(() => {
                if (isGoalHome) {
                    msgText.innerText = "BUT !!!";
                    msgText.className = "font-teko text-6xl text-green-500 uppercase italic animate-bounce";
                    this.penState.score[0]++;
                    this.penState.history[0].push(1);
                    this.playSound('goal');
                } else {
                    msgText.innerText = "RATÉ !";
                    msgText.className = "font-teko text-6xl text-red-500 uppercase italic shake";
                    this.penState.history[0].push(0);
                    this.playSound('whistle');
                }
                this.updatePenaltyUI();
                this.penState.shootersUsed.push(player.id);

                // --- 2. TIR DE L'IA (ADVERSAIRE) ---
                setTimeout(() => {
                    msgText.innerText = "L'adversaire tire...";
                    msgText.className = "font-teko text-4xl text-slate-400 uppercase italic";

                    setTimeout(() => {
                        // --- CORRECTION : PRISE EN COMPTE DE VOTRE GARDIEN ---

                        // 1. On trouve votre gardien titulaire
                        const myGK = this.state.players.find(p => p.role === 'starter' && p.pos === 'GK');
                        const gkRating = myGK ? myGK.ovr : 70; // 70 par défaut si pas de gardien (bug)

                        // 2. Note du tireur adverse (Moyenne de l'équipe adverse)
                        const oppShooterRating = this.match.opp.ovr;

                        // 3. Calcul de la difficulté pour l'IA
                        // Base de 70% (au lieu de 75%)
                        let aiChance = 0.70;

                        // Si votre gardien est meilleur que le tireur, l'IA perd des chances
                        // Ex: Gardien 85 vs Tireur 80 = -5% de chance de but
                        aiChance += (oppShooterRating - gkRating) * 0.01;

                        // Plafonds pour éviter les bugs (Min 30%, Max 90%)
                        aiChance = Math.max(0.30, Math.min(0.90, aiChance));

                        const isGoalAway = Math.random() < aiChance;

                        if (isGoalAway) {
                            msgText.innerText = "L'adversaire marque.";
                            msgText.className = "font-teko text-5xl text-red-400 uppercase italic";
                            this.penState.score[1]++;
                            this.penState.history[1].push(1);
                        } else {
                            // On félicite le gardien par son nom !
                            const gkName = myGK ? myGK.name.split(' ').pop() : "GARDIEN";
                            msgText.innerText = `ARRÊT DE ${gkName.toUpperCase()} !`;
                            msgText.className = "font-teko text-5xl text-green-500 uppercase italic";
                            this.penState.history[1].push(0);
                            this.playSound('stadium'); // Foule contente
                        }

                        this.updatePenaltyUI();
                        this.penState.round++;

                        // VÉRIFICATION FIN DU JEU
                        if (this.checkPenaltyWinner()) {
                            setTimeout(() => this.endPenaltyShootout(), 2000);
                        } else {
                            setTimeout(() => {
                                msgBox.classList.add('hidden');
                                document.getElementById('pen-selection-zone').classList.remove('hidden');
                                this.renderPenaltyShooters();
                            }, 1500);
                        }
                    }, 1500);
                }, 1500);
            }, 1500);
        }

        updatePenaltyUI() {
            document.getElementById('pen-score-home').innerText = this.penState.score[0];
            document.getElementById('pen-score-away').innerText = this.penState.score[1];

            // Mise à jour des petits ronds (Historique)
            const buildDots = (hist, id) => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                hist.forEach(res => {
                    el.innerHTML += `<div class="w-4 h-4 rounded-full ${res ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500 opacity-50'}"></div>`;
                });
            };
            buildDots(this.penState.history[0], 'pen-history-home');
            buildDots(this.penState.history[1], 'pen-history-away');
        }

        checkPenaltyWinner() {
            const r = this.penState.round;
            const s1 = this.penState.score[0];
            const s2 = this.penState.score[1];
            const h1 = this.penState.history[0]; // Liste des tirs déjà effectués

            // Règle des 5 premiers tirs
            // Si une équipe ne peut plus rattraper l'autre mathématiquement
            if (h1.length <= 5) {
                const remainingShots = 5 - h1.length;
                // Cas 1 : CIV gagne (Adversaire ne peut plus rattraper)
                // Note : L'adversaire a tiré AUTANT de fois que CIV à ce stade du code (car on check après le tir IA)
                // Donc remainingShots est le même pour les deux.
                if (s1 > s2 + remainingShots) return true;
                if (s2 > s1 + remainingShots) return true;

                if (h1.length === 5 && s1 !== s2) return true; // Fin des 5 tirs et pas égalité
            }
            // Mort subite (après 5 tirs)
            else {
                if (s1 !== s2) return true;
            }
            return false;
        }

        endPenaltyShootout() {
    // 1. On cache l'écran des pénaltys
    document.getElementById('penalty-view').classList.add('hidden');

    // 2. On sauvegarde le score des TAB
    this.match.penalties = this.penState.score;

    // 3. On détermine qui a gagné
    const isWin = this.match.penalties[0] > this.match.penalties[1];

    // CORRECTION ICI : On utilise le code de VOTRE équipe, pas 'CIV' en dur
    const myCode = this.state.userTeamCode || 'CIV';
    const winnerCode = isWin ? myCode : 'OPP';

    // 4. On appelle la finition du match
    this.finishMatch(winnerCode);
}

       finishMatch(winnerOverride = null) {
            // 1. Nettoyage des cartons rouges (Reset pour le prochain match)
            this.state.players.forEach(p => { delete p.sentOff; });

            clearInterval(this.match.timer);
            this.match.active = false;

            // Gestion Audio de fin
            if (!winnerOverride) {
                this.stopCrowd();
                this.playSound('whistle');
            }

            // Calcul du score
            const scoreHome = this.match.score[0];
            const scoreAway = this.match.score[1];
            let isWin = scoreHome > scoreAway;
            let isDraw = scoreHome === scoreAway;

            // Gestion Tirs au but (Logique interne)
            if (winnerOverride) {
        // On vérifie si le code gagnant est CELUI DU JOUEUR (ex: 'SEN', 'MAR'...)
        const myCode = this.state.userTeamCode || 'CIV';
        isWin = (winnerOverride === myCode);
        isDraw = false;
    }
    // ------------------------------------------------------
    else if (isDraw && this.state.stage !== 'groups') {
        setTimeout(() => this.initPenaltyShootout(), 1000);
        return;
    }

// ... dans closeEndModal() ...

// --- CÉLÉBRATION DE VICTOIRE FINALE (CORRIGÉ) ---
if (this.state.stage === 'finale' && isWin) {
    this.state.trophies++;
    this.state.budget += 25.0;

    // Sécurité si la liste n'existe pas
    if(!this.state.pastWinners) this.state.pastWinners = [];

    // Ajout de la victoire
    this.state.pastWinners.push({ year: this.state.year, n: this.state.userTeamName });

    // --- CORRECTION IMPORTANTE : ON SAUVEGARDE TOUT DE SUITE ---
    this.save();
    // -----------------------------------------------------------

    this.stopMenuMusic();
    this.playSound('cheer');

    this.triggerVictoryCelebration(); // Ecran de fête
    return; // On arrête tout ici pour afficher l'écran de victoire
// ...

                // --- CORRECTION DU BOUTON NOUVELLE SAISON ---
                    const victoryHTML = `
<div id="victory-screen" class="fixed inset-0 z-[5000] bg-black/95 flex items-center justify-center animate-fadeIn backdrop-blur-md">

    <div class="carbon-pattern gold-glow relative w-[90%] max-w-lg p-1 rounded-[40px] overflow-hidden shadow-2xl">

        <div class="bg-gradient-to-b from-slate-900/40 to-black/90 p-10 rounded-[38px] flex flex-col items-center text-center">

            <div class="text-7xl mb-4 drop-shadow-[0_0_20px_rgba(245,158,11,0.4)]">🏆</div>

            <h1 class="font-teko text-8xl uppercase italic leading-none mb-0 text-gold-gradient">
                CHAMPIONS !
            </h1>

            <h2 class="font-teko text-5xl text-white uppercase tracking-tighter mb-6">
                ${this.state.userTeamName}
            </h2>

            <div class="h-[1px] w-32 bg-gold/30 mb-8"></div>

            <div class="w-32 h-32 carbon-pattern border border-gold/40 rounded-2xl flex items-center justify-center shadow-inner mb-8 rotate-3">
                <span class="font-teko text-6xl text-gold-gradient italic font-bold leading-none">
                    ${this.state.userTeamCode}
                </span>
            </div>

            <p class="text-slate-400 text-xs uppercase tracking-[0.4em] mb-10 font-bold">
                Le toit de l'Afrique est à vous
            </p>

            <button onclick="document.getElementById('victory-screen').remove(); app.startNextSeason()"
                class="w-full py-5 bg-white text-black font-teko text-3xl uppercase italic hover:bg-gold hover:text-white transition-all duration-300 rounded-xl shadow-xl">
                DÉBUTER LA NOUVELLE SAISON
            </button>
        </div>
    </div>
</div>`;
                document.body.insertAdjacentHTML('beforeend', victoryHtml);
                return; // On arrête tout ici pour afficher l'écran de victoire
            }
            // ------------------------------------------------------------------

            // Si ce n'est pas la finale gagnée, on continue le déroulement normal :
            setTimeout(() => { this.startMenuMusic(); }, 2000);

            // --- CALCUL DES NOTES (VRAI SYSTÈME MVP) ---
this.state.players.forEach(p => {
    if (p.role === 'starter') {
        // 1. Note de base selon le résultat (plus basse pour laisser place aux bonus)
        let note = isWin ? 6.5 : (isDraw ? 6.0 : 5.0);

        // 2. Le facteur "Match de sa vie" (Aléatoire entre 0 et 1.5 points)
        // Cela permet à un joueur d'avoir 8.0 même sans marquer, juste parce qu'il a été bon
        note += Math.random() * 1.5;

        // 3. Bonus Clean Sheet (Pour Gardien et Défenseurs)
        // Si l'adversaire a mis 0 but (scoreAway === 0)
        if (scoreAway === 0 && (p.pos === 'GK' || p.pos === 'DEF')) {
            note += 1.0; // Bonus solidité
        }

        // 4. Bonus Offensive (Si on a gagné, les attaquants ont sûrement brillé)
        if (isWin && (p.pos === 'FWD' || p.pos === 'MID')) {
            // Une chance sur deux d'avoir été décisif
            if (Math.random() > 0.4) note += 1.5;
            // Chance rare d'avoir été HÉROÏQUE (Doublé, etc.)
            if (Math.random() > 0.8) note += 1.0;
        }

        // 5. Malus défaite lourde (Si on perd par 2 buts ou plus)
        if (!isWin && !isDraw && (scoreAway - scoreHome >= 2) && p.pos === 'DEF') {
            note -= 1.0;
        }

        // Plafond (Max 10, Min 3)
        if (note > 10) note = 10;
        if (note < 3) note = 3;

        // Enregistrement
        this.registerRating(p.name, this.state.userTeamName, note);
    }
});

            // Score et mise à jour classement
            this.state.budget += isWin ? 2.0 : (isDraw ? 0.8 : 0.4);
            this.state.teamXP += isWin ? 30 : 10;

            this.updateStd(this.state.standings[this.state.userTeamName], scoreHome, scoreAway);
            this.updateStd(this.state.standings[this.match.opp.n], scoreAway, scoreHome);

            // --- MISE À JOUR DE L'INTERFACE DE FIN ---
            const esd = document.getElementById('end-score-display'); if(esd) esd.innerText = `${scoreHome}-${scoreAway}`;
            const titleEl = document.getElementById('end-title');

            if (isWin) { titleEl.innerText = "VICTOIRE"; titleEl.className = "font-teko text-6xl text-green-500 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }
            else if (isDraw) { titleEl.innerText = "MATCH NUL"; titleEl.className = "font-teko text-6xl text-slate-300 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }
            else { titleEl.innerText = "DÉFAITE"; titleEl.className = "font-teko text-6xl text-red-500 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }

            // Affichage Adversaire
            const endOppName = document.getElementById('end-opp-name');
            if(endOppName) endOppName.innerText = this.match.opp.n;

            const endOppBadge = document.getElementById('end-opp-badge');
            if(endOppBadge) {
                endOppBadge.innerHTML = `<span class="font-teko text-3xl text-white font-bold italic">${this.match.opp.code}</span>`;
            }

            // Stats Tirs
            const sh = this.match.stats.shots;
            const sa = this.match.stats.shotsAway;
            const endStatShots = document.getElementById('end-stat-shots');
            if(endStatShots) endStatShots.innerText = `${sh} - ${sa}`;

            const endBarShots = document.getElementById('end-bar-shots');
            if(endBarShots) {
                const totalS = sh + sa || 1;
                endBarShots.style.width = ((sh / totalS) * 100) + '%';
            }

            // Stats Possession
            const possTxt = document.getElementById('poss-val-home') ? document.getElementById('poss-val-home').innerText : "50%";
            const possVal = parseInt(possTxt);
            const endStatPoss = document.getElementById('end-stat-poss');
            if(endStatPoss) endStatPoss.innerText = `${possVal}% - ${100-possVal}%`;

            const endBarPoss = document.getElementById('end-bar-poss');
            if(endBarPoss) endBarPoss.style.width = possVal + '%';

            // Afficher le modal de fin
            const em = document.getElementById('end-modal'); if(em) em.classList.remove('hidden');

            // Gestion Fatigue
            const inst = this.state.instructions;
            this.state.players.forEach(p => {
                if(p.role==='starter') {
                    let drain = 15 - (this.state.infra.medical.level * 1.5);
                    if(inst.pressing === 'high') drain += 8;
                    if(inst.tempo === 'fast') drain += 6;
                    if(inst.aggression === 'hard') drain += 5;
                    p.energy = Math.max(5, (p.energy||100) - drain);
                } else {
                    p.energy = Math.min(100, (p.energy||0) + 20);
                }
            });

            this.simulateOthers();
            this.state.matchIndex++;
            this.save();
            this.updateUI();
            this.generateReport(isWin, [scoreHome, scoreAway], this.match.opp.n);
        }
        generateReport(win, s, opp) {
    // 1. Quel type de réaction ?
    let type = 'postMatchDraw';
    if (s[0] > s[1]) type = 'postMatchWin';
    else if (s[0] < s[1]) type = 'postMatchLoss';

    // 2. Sélection de 2 analyses différentes
    const list = NEWS_DB[type];
    const report1 = list[Math.floor(Math.random() * list.length)];
    let report2 = list[Math.floor(Math.random() * list.length)];

    // Anti-doublon
    while (report1 === report2 && list.length > 1) {
        report2 = list[Math.floor(Math.random() * list.length)];
    }

    const scoreStr = `${s[0]}-${s[1]}`;

    // 3. Injection des news (Sobre et direct)

    // News A : Le score officiel
    this.state.news.unshift({
        id: Date.now(),
        text: `RÉSULTAT : Fin du match contre ${opp}. Score final ${scoreStr}.`
    });

    // News B : L'analyse média principale
    this.state.news.unshift({
        id: Date.now() + 1,
        text: `PRESSE : ${report1}`
    });

    // News C : Une réaction complémentaire
    this.state.news.unshift({
        id: Date.now() + 2,
        text: `RÉACTION : ${report2}`
    });

    // Rafraîchissement si visible
    if(document.getElementById('view-inbox') && !document.getElementById('view-inbox').classList.contains('hidden')) {
        this.renderInbox();
    }
}
        // --- GÉNÉRATEUR DE RUMEURS ET COMMENTAIRES ---
        generateAmbientNews() {
    // 1. Choix de la catégorie (Pondération)
    const types = [
        { id: 'scouting', weight: 0.30, category: "RECRUTEMENT" },
        { id: 'lockerRoom', weight: 0.25, category: "VESTIAIRE" },
        { id: 'biz', weight: 0.25, category: "MERCATO / MÉDIAS" },
        { id: 'scouting', weight: 0.20, category: "NOTE INTERNE" }
    ];

    const rand = Math.random();
    let selected = types[0];
    let runningWeight = 0;

    for (let t of types) {
        runningWeight += t.weight;
        if (rand < runningWeight) {
            selected = t;
            break;
        }
    }

    // 2. Sélection du texte
    const list = NEWS_DB[selected.id];
    if (!list || list.length === 0) return;

    let text = list[Math.floor(Math.random() * list.length)];

    // 3. Remplacement intelligent du nom du joueur
    if (text.includes("{PLAYER}")) {
        const starters = this.state.players.filter(p => p.role === 'starter');
        const pName = starters.length > 0 ? starters[Math.floor(Math.random()*starters.length)].name : "Le Capitaine";
        // On met juste le nom en gras/orange, sans icône autour
        text = text.replace("{PLAYER}", `<span class="text-orange-400 font-bold">${pName}</span>`);
    }

    // 4. Ajout dans le flux (Format propre : CATÉGORIE : Texte)
    this.state.news.unshift({
        id: Date.now() + Math.random(),
        text: `${selected.category} : ${text}`
    });

    if (this.state.news.length > 20) this.state.news.pop();
}

        updateStd(s, gf, ga) { if(!s) return; s.p++; s.gf+=gf; s.ga+=ga; if(gf>ga){s.w++; s.pts+=3;} else if(gf===ga){s.d++; s.pts+=1;} else s.l++; }

        // Enregistre un but pour un joueur donné
       registerGoal(name, team) {
// Sécurité : On s'assure que la liste existe et est propre
if (!this.state.goalScorers || !Array.isArray(this.state.goalScorers)) {
    this.state.goalScorers = [];
}

// Sécurité : On nettoie les entrées null/invalides qui font planter le jeu
this.state.goalScorers = this.state.goalScorers.filter(x => x && x.n && x.t);

// Recherche du buteur
let entry = this.state.goalScorers.find(x => x.n === name && x.t === team);

if (entry) {
    entry.c++;
} else {
    this.state.goalScorers.push({ n: name, t: team, c: 1 });
}
}
          // AJOUTER DANS LA CLASSE EliteManager

registerAssist(name, team) {
    if (!this.state.assisters) this.state.assisters = [];

    // Nettoyage au cas où
    this.state.assisters = this.state.assisters.filter(x => x && x.n && x.t);

    let entry = this.state.assisters.find(x => x.n === name && x.t === team);
    if (entry) {
        entry.c++;
    } else {
        this.state.assisters.push({ n: name, t: team, c: 1 });
    }
}
        // Enregistre une note (ex: 7.5) pour un joueur
        registerRating(name, team, rating) {
            if (!this.state.playerRatings) this.state.playerRatings = [];

            let entry = this.state.playerRatings.find(x => x.n === name && x.t === team);
            if (entry) {
                entry.total += rating;
                entry.matchs++;
            } else {
                this.state.playerRatings.push({ n: name, t: team, total: rating, matchs: 1 });
            }
        }

        // Trouve un buteur réaliste pour une nation donnée (IA)
        getScorerName(nationName) {
            const nat = NATIONS_DB.find(x => x.n === nationName);
            if (!nat) return "Inconnu";

            // On regarde dans la base de données vivante
            const db = this.state.worldPlayers || REAL_SQUADS_DB;
            const squad = db[nat.code];

            // Si on a des joueurs, on fait un tirage au sort pondéré
            if (squad && squad.length > 0) {
                let candidates = [];

                squad.forEach(p => {
                    // Les gardiens ne marquent jamais
                    if (p.pos === 'GK') return;

                    // Nombre de "tickets" pour le tirage au sort
                    let tickets = 1;

                    // Les attaquants ont beaucoup plus de chances
                    if (p.pos === 'FWD') tickets = 6;
                    else if (p.pos === 'MID') tickets = 3;

                    // Les joueurs rapides (spd > 85) et forts (ovr > 80) sont plus dangereux
                    if (p.spd && p.spd > 85) tickets += 3;
                    if (p.ovr > 80) tickets += 2;

                    // On ajoute le nom du joueur X fois dans le chapeau
                    for(let i=0; i<tickets; i++) candidates.push(p.name);
                });

                if (candidates.length > 0) {
                    return candidates[Math.floor(Math.random() * candidates.length)];
                }
            }

            // Fallback : Si l'équipe est vide, on prend la star par défaut
            return nat.star || "Attaquant";
        }
     simulateOthers() {
    if (this.state.stage !== 'groups') return;

    const myName = this.state.userTeamName;
    const userGrp = this.state.standings[myName].grp;

    // --- CORRECTION MAJEURE ---
    // On utilise l'index du match (0, 1 ou 2) comme horloge officielle.
    // Cela empêche les simulations en cascade (4 matchs joués).
    const currentRound = this.state.matchIndex;

    Object.keys(this.state.groups).forEach(g => {
        const t = this.state.groups[g];

        // CAS 1 : C'EST VOTRE GROUPE
        // On simule juste le match des 2 autres qui ne jouent pas contre vous
        if (g === userGrp) {
            const others = t.filter(team =>
                team.n !== myName &&
                team.n !== this.match.opp.n
            );

            if (others.length === 2) {
                this.simM(others[0].n, others[1].n);
            }
        }
        // CAS 2 : LES AUTRES GROUPES
        // On force les rencontres selon le calendrier (Journée 1, 2 ou 3)
        else {
            if (currentRound === 0) {
                // Journée 1
                this.simM(t[0].n, t[1].n);
                this.simM(t[2].n, t[3].n);
            }
            else if (currentRound === 1) {
                // Journée 2
                this.simM(t[0].n, t[2].n);
                this.simM(t[1].n, t[3].n);
            }
            else if (currentRound === 2) {
                // Journée 3
                this.simM(t[0].n, t[3].n);
                this.simM(t[1].n, t[2].n);
            }
        }
    });
}
       simM(t1, t2) {
            const s1 = this.state.standings[t1]; const s2 = this.state.standings[t2];
            const r = s1.ovr / s2.ovr; let g1 = 0, g2 = 0;
            for(let i=0; i<3; i++) { if(Math.random() < 0.28 * r) g1++; if(Math.random() < 0.28 * (1/r)) g2++; }

            this.updateStd(s1, g1, g2); this.updateStd(s2, g2, g1);
            this.state.globalResults.push(`${t1} ${g1}-${g2} ${t2}`);

            // --- GESTION BUTEURS & NOTES ---
            const processTeamSim = (teamName, goalsScored, isWinner, isDraw) => {
                // 1. Note de base de l'équipe
                let baseR = isWinner ? 7.2 : (isDraw ? 6.0 : 5.5);

                // 2. On récupère les joueurs clés de cette nation dans la DB
                const natDB = NATIONS_DB.find(x => x.n === teamName);
                if(natDB) {
                    // On note la Star (joue toujours bien)
                    this.registerRating(natDB.star, teamName, baseR + Math.random());
// CORRECTION : On génère un nom réaliste car topAtt/topDef n'existent pas
                const randomP = this.generateRealName(teamName);
                this.registerRating(randomP, teamName, baseR + (Math.random() * 1.5 - 0.5));
                }

                // 3. On génère et note les buteurs
                for(let k=0; k<goalsScored; k++) {
                    const scorer = this.getScorerName(teamName);
                    this.registerGoal(scorer, teamName);
                    if (Math.random() < 0.70) {
    let assister = this.getScorerName(teamName); // On utilise le générateur de nom
    // Petite vérif pour éviter que le buteur se fasse la passe à lui-même
    if (assister === scorer) assister = this.getScorerName(teamName);

    this.registerAssist(assister, teamName);
    }
                    // Un buteur a forcément une bonne note (> 7.5)
                    this.registerRating(scorer, teamName, 7.5 + Math.random() * 1.5);
                }
            };


            const t1Win = g1 > g2; const draw = g1 === g2;
            processTeamSim(t1, g1, t1Win, draw);
            processTeamSim(t2, g2, !t1Win && !draw, draw);
        }

       closeEndModal() {
            // 1. Masquer le modal
            const em = document.getElementById('end-modal');
            if(em) em.classList.add('hidden');

            // 2. Vérification Victoire
            const scoreWin = this.match.score[0] > this.match.score[1];
            const penWin = this.match.penalties && (this.match.penalties[0] > this.match.penalties[1]);
            const isWin = scoreWin || penWin;

            // 3. CAS SPÉCIAL : C'ÉTAIT LA FINALE
            if (this.state.stage === 'finale') {
                if (isWin) {
                    // VICTOIRE FINALE
                    this.state.trophies++;
                    this.state.budget += 25.0;
                    if(!this.state.pastWinners) this.state.pastWinners = [];
                    this.state.pastWinners.push({ year: this.state.year, n: this.state.userTeamName });

                    this.triggerVictoryCelebration(); // Ecran de fête
                } else {
                    // DÉFAITE EN FINALE
                    this.simulateRest(this.match.opp);
                }
                return;
            }

            // 4. AUTRES CAS
            // Si on perd en élimination directe (8ème, Quart, Demi) -> DEHORS
            if (this.state.stage !== 'groups' && !isWin) {
                this.simulateRest(this.match.opp);
                return;
            }

            // Si on est en poules et qu'il reste des matchs
            if (this.state.stage === 'groups' && this.state.matchIndex < 3) {
                this.goToView('inbox');
            }
            // Sinon (Fin de poules ou Victoire en phase finale) -> TOUR SUIVANT
            else {
                this.startNextStage();
            }

            this.save();
        }


        startNextStage() {
    this.save();

    // --- INITIALISATION DU VIVIER (Si on sort des poules) ---
    // On crée la liste des 15 autres qualifiés si elle n'existe pas encore
    if (this.state.stage === 'groups' || !this.state.tournamentSurvivors) {
        const myName = this.state.userTeamName;
        // On prend toutes les nations sauf nous
        let candidates = NATIONS_DB.filter(n => n.n !== myName);

        // On garde seulement les meilleures (Réalisme : les petites nations sortent souvent en poules)
        // On trie par OVR décroissant + un peu d'aléatoire pour les surprises
        candidates.sort((a, b) => (b.ovr + Math.random() * 10) - (a.ovr + Math.random() * 10));

        // On garde les 15 meilleurs pour faire le top 16 avec nous
        this.state.tournamentSurvivors = candidates.slice(0, 15);
    }

    // --- LOGIQUE DE PROGRESSION ---

    // 1. POULES -> 8ÈMES
    if (this.state.stage === 'groups') {
        const myTeamName = this.state.userTeamName;
        const myStats = this.state.standings[myTeamName];

        // Vérification classement (Logic existante)
        const groupTeams = Object.keys(this.state.standings)
            .filter(k => this.state.standings[k].grp === myStats.grp)
            .sort((a,b) => this.state.standings[b].pts - this.state.standings[a].pts || (this.state.standings[b].gf - this.state.standings[b].ga) - (this.state.standings[a].gf - this.state.standings[a].ga));

        const myRank = groupTeams.indexOf(myTeamName) + 1;

        if (myRank > 2) { // Note : On simplifie, seuls les 2 premiers passent ici
            this.playSound('whistle');
            this.toast("ÉLIMINÉ ! L'aventure s'arrête ici.");
            setTimeout(() => {
                alert(`Fin de la saison.\nVotre équipe (${myTeamName}) termine ${myRank}ème de son groupe.`);
                this.startNextSeason();
            }, 2000);
            return;
        }

        // QUALIFICATION EN 8ÈMES
        this.state.stage = '8iemes';
        this.state.budget += 3.0;
        this.state.teamXP += 100;

        // Tirage au sort : On prend un adversaire dans les survivants
        // On le retire de la liste des survivants (car il joue contre nous)
        const oppIndex = Math.floor(Math.random() * this.state.tournamentSurvivors.length);
        const nextOpp = this.state.tournamentSurvivors.splice(oppIndex, 1)[0];

        this.state.knockout['8iemes'] = this.state.standings[nextOpp.n];

        this.state.news.unshift({ id: Date.now(), text: `QUALIFIÉ : ${myTeamName} affrontera ${nextOpp.n} en 8èmes !` });
    }

    // 2. 8ÈMES -> QUARTS
    else if (this.state.stage === '8iemes') {
        this.state.stage = 'quarts';
        this.state.budget += 6.0;
        this.state.teamXP += 300;

        // SIMULATION DES AUTRES MATCHS DES 8ÈMES
        // Il reste 14 équipes dans survivors. On doit faire 7 matchs -> 7 gagnants.
        this.simulateTournamentRound();

        // Maintenant survivors contient les 7 gagnants potentiels. On en tire un.
        const oppIndex = Math.floor(Math.random() * this.state.tournamentSurvivors.length);
        const nextOpp = this.state.tournamentSurvivors.splice(oppIndex, 1)[0];

        this.state.knockout['quarts'] = this.state.standings[nextOpp.n];
        this.toast("Qualifié pour les Quarts !");
    }

    // 3. QUARTS -> DEMIS
    else if (this.state.stage === 'quarts') {
        this.state.stage = 'demis';
        this.state.budget += 12.0;
        this.state.teamXP += 600;

        // SIMULATION DES AUTRES MATCHS DES QUARTS
        // Il reste 6 équipes. 3 matchs -> 3 gagnants.
        this.simulateTournamentRound();

        const oppIndex = Math.floor(Math.random() * this.state.tournamentSurvivors.length);
        const nextOpp = this.state.tournamentSurvivors.splice(oppIndex, 1)[0];

        this.state.knockout['demis'] = this.state.standings[nextOpp.n];
        this.toast("Direction les Demi-Finales !");
    }

    // 4. DEMIS -> FINALE
    else if (this.state.stage === 'demis') {
        this.state.stage = 'finale';
        this.state.budget += 20.0;
        this.state.teamXP += 1000;

        // SIMULATION DE L'AUTRE DEMI-FINALE
        // Il reste 2 équipes. 1 match -> 1 gagnant (Finaliste).
        this.simulateTournamentRound();

        // Le dernier survivant est notre adversaire en finale
        const nextOpp = this.state.tournamentSurvivors[0]; // Pas besoin de splice, c'est le dernier

        this.state.knockout['finale'] = this.state.standings[nextOpp.n];

        this.playSound('cheer');
        this.toast("FINALE ! L'Histoire est en marche !");
    }

    // --- RESET ET AFFICHAGE ---
    this.state.matchIndex = 0;
    this.save();
    this.goToView('calendar');
    setTimeout(() => {
        this.updateUI();
        this.renderCalendar();
    }, 50);
}
// Simule les matchs entre les équipes restantes dans le tournoi
simulateTournamentRound() {
    const survivors = this.state.tournamentSurvivors; // Liste des équipes encore en lice (hors joueur)
    const nextRoundSurvivors = [];

    // On fait jouer les équipes 2 par 2
    while (survivors.length >= 2) {
        const teamA = survivors.pop();
        const teamB = survivors.pop();

        // 1. Calcul du Vainqueur (Logique OVR + Aléatoire)
        const scorePowerA = teamA.ovr + (Math.random() * 20);
        const scorePowerB = teamB.ovr + (Math.random() * 20);

        const winner = scorePowerA >= scorePowerB ? teamA : teamB;
        const loser = scorePowerA >= scorePowerB ? teamB : teamA;

        // 2. GÉNÉRATION DU SCORE RÉALISTE (Pour les stats buteurs)
        // Le vainqueur marque entre 1 et 3 buts (pondéré par son OVR)
        let goalsWinner = 1 + Math.floor(Math.random() * 3);
        // Le perdant marque entre 0 et goalsWinner-1 (sauf si tirs au but simulés, on simplifie ici)
        let goalsLoser = Math.floor(Math.random() * goalsWinner);

        // Cas rare : match serré, prolongation/TAB (ex fictif : 1-1, le vainqueur passe aux TAB)
        // Pour simplifier l'enregistrement des buts, on force une victoire au temps réglementaire ou prolongation
        if (goalsWinner === goalsLoser) goalsWinner++;

        // 3. ENREGISTREMENT DES BUTEURS (C'est ce qui manquait !)

        // Pour le vainqueur
        for (let i = 0; i < goalsWinner; i++) {
            const scorerName = this.getScorerName(winner.n);
            this.registerGoal(scorerName, winner.n);
             if (Math.random() < 0.70) {
    let assister = this.getScorerName(winner.n);
    if (assister === scorerName) assister = this.getScorerName(winner.n);
    this.registerAssist(assister, winner.n);
    }
            // On donne une note au passage
            this.registerRating(scorerName, winner.n, 7.0 + Math.random());
        }

        // Pour le perdant
        for (let i = 0; i < goalsLoser; i++) {
            const scorerName = this.getScorerName(loser.n);
            if (Math.random() < 0.70) {
    let assister = this.getScorerName(loser.n);
    if (assister === scorerName) assister = this.getScorerName(loser.n);
    this.registerAssist(assister, loser.n);
     }
            this.registerGoal(scorerName, loser.n);
            this.registerRating(scorerName, loser.n, 6.0 + Math.random());
        }

        // On garde le vainqueur pour le prochain tour
        nextRoundSurvivors.push(winner);

        // (Optionnel) Ajout dans l'historique des résultats globaux pour plus de réalisme
        this.state.globalResults.push(`${winner.n} ${goalsWinner}-${goalsLoser} ${loser.n}`);
    }

    // Si nombre impair (ne devrait pas arriver avec 16 équipes de base), on repousse le dernier
    if (survivors.length === 1) {
        nextRoundSurvivors.push(survivors[0]);
    }

    // Mise à jour de la liste officielle
    this.state.tournamentSurvivors = nextRoundSurvivors;
    this.save();
}

        simulateRest(winnerOverrideTeam = null) {
            // 1. Définition des étapes pour parcourir ce qu'il reste du tournoi
            let currentStage = this.state.stage;
            const stages = ['groups', '8iemes', 'quarts', 'demis', 'finale'];
            let stageIdx = stages.indexOf(currentStage);

            // Si on est éliminé en poules (ou avant), on commence la simu aux 8èmes
            if (stageIdx <= 0) {
                stageIdx = 1;
            }

            // 2. Boucle : On simule tour par tour jusqu'à la finale
            while (stageIdx < stages.length) {
                const stg = stages[stageIdx];

                // Si on arrive à l'étape FINALE dans la simulation
                if (stg === 'finale') {
                    // --- CHOIX DU VAINQUEUR ---
                    let winner;

                    // Option A : L'équipe qui nous a battu a une chance (réalisme)
                    if (winnerOverrideTeam && Math.random() > 0.4) {
                        winner = winnerOverrideTeam;
                    }
                    // Option B : Sinon, une grosse équipe aléatoire (4 étoiles min) sauf nous
                    else {
                        const candidates = NATIONS_DB.filter(n => n.n !== this.state.userTeamName && n.star >= 4.0);

                        if (candidates.length > 0) {
                            winner = candidates[Math.floor(Math.random() * candidates.length)];
                        } else {
                            // Secours : n'importe qui sauf nous
                            const others = NATIONS_DB.filter(n => n.n !== this.state.userTeamName);
                            winner = others[Math.floor(Math.random() * others.length)];
                        }
                    }

                    // Sécurité ultime anti-crash
                    if (!winner) winner = { n: 'Maroc', code: 'MAR' };

                    // ... dans simulateRest(), à l'intérieur de if (stg === 'finale') ...

    // 3. Enregistrement dans le Palmarès
    if (!this.state.pastWinners) this.state.pastWinners = [];
    this.state.pastWinners.push({ year: this.state.year, n: winner.n });

    // --- CORRECTION IMPORTANTE : ON SAUVEGARDE TOUT DE SUITE ---
    this.save();
    // -----------------------------------------------------------

    // 4. MESSAGE ET TRANSITION
    setTimeout(() => {
        alert(`FIN DE LA SAISON.\n\nLe tournoi a continué sans vous...\n🏆 VAINQUEUR : ${winner.n}\n\nPréparez-vous pour la prochaine CAN !`);

        // IMPORTANT : On lance la nouvelle saison au lieu de recharger la page
        this.startNextSeason();
    }, 500);

    return; // On arrête la fonction ici
}
// ...

                // Passage au tour suivant de la boucle
                stageIdx++;
            }
        }

        awards(winnerName) {
    // On retrouve les infos de la nation gagnante dans la DB
    const nationData = NATIONS_DB.find(n => n.n === winnerName);
    if (!nationData) return;

    // 1. MVP : CORRECTION RÉALISTE
    // Le joueur doit avoir joué au moins 3 ou 4 matchs pour être éligible
    let mvpObj = { n: "Inconnu", t: "?", avg: 0 };

    if (this.state.playerRatings && this.state.playerRatings.length > 0) {
        const sortedRatings = this.state.playerRatings
            // ÉTAPE CLÉ : On calcule la moyenne
            .map(p => ({ ...p, avg: p.total / p.matchs }))
            // ÉTAPE CLÉ : On filtre les "touristes" (Min 3 matchs joués)
            .filter(p => p.matchs >= 3)
            // On trie par meilleure note
            .sort((a,b) => b.avg - a.avg);

        // Sécurité : Si personne n'a 3 matchs (ex: bug), on prend le premier tout court
        mvpObj = sortedRatings.length > 0 ? sortedRatings[0] : this.state.playerRatings[0];
    }

    this.state.news.unshift({
        id: Date.now() + 1,
        text: `${SVGS.medal} MVP : ${mvpObj.n} (${mvpObj.t}) est élu meilleur joueur du tournoi avec une note moyenne de ${mvpObj.avg.toFixed(2)} !`
    });

    // ... (Le reste de la fonction Soulier d'Or et Gant d'Or ne change pas) ...
    // 2. Soulier d'Or : Le meilleur buteur
   let topScorerObj = { n: "Inconnu", t: "?", c: 0 };

    // On vérifie si on a des buteurs enregistrés
    if (this.state.goalScorers && this.state.goalScorers.length > 0) {
        // On trie la liste du plus grand au plus petit nombre de buts
        this.state.goalScorers.sort((a,b) => b.c - a.c);
        // On prend le premier
        topScorerObj = this.state.goalScorers[0];
    }

    this.state.news.unshift({
        id: Date.now() + 2,
        text: `${SVGS.boot} Soulier d'Or : ${topScorerObj.n} (${topScorerObj.t}) termine en tête avec ${topScorerObj.c} réalisations.`
    });

    // 3. Gant d'Or : Le gardien du vainqueur
    let gkName = "";

    // --- CORRECTION : ON VÉRIFIE SI C'EST L'ÉQUIPE DU JOUEUR ---
    if (winnerName === this.state.userTeamName) {
        const myGK = this.state.players.find(p => p.role === 'starter' && p.pos === 'GK');
        gkName = myGK ? myGK.name : "Le Gardien";
    } else {
        // Pour l'IA...
        gkName = `Le portier (${nationData.code})`;
    }

    this.state.news.unshift({
        id: Date.now() + 3,
        text: `${SVGS.glove} Gant d'Or : ${gkName} remporte le trophée Yachine.`
    });
}

        processRetirements() {
const retired = [];
// Gestion des départs (30 ans et +)
this.state.players = this.state.players.filter(p => {
    if (p.age > 30) {
        const chance = (p.age - 30) * 0.15;
        if (Math.random() < chance) {
            retired.push(p.name);
            return false;
        }
    }
    return true;
});

// Evolution des stars adverses (IA)
Object.keys(this.state.standings).forEach(nationName => {
    const std = this.state.standings[nationName];
    std.starAge++;
    if (std.starAge >= 35) {
        const oldStar = std.star;
        std.star = this.generateRealName();
        std.starAge = 18 + Math.floor(Math.random() * 5);
        std.ovr = Math.round(std.ovr * 0.95);
        this.state.news.unshift({
            id: Date.now() + Math.random(),
            text: `${SVGS.globe} REGEN : La légende ${oldStar} (${nationName}) prend sa retraite. ${std.star} est le nouveau prodige !`
        });
    }
});

if (retired.length > 0) {
    this.state.news.unshift({
        id: Date.now(),
        text: `${SVGS.hand} DÉPARTS : ${retired.join(', ')} pren${retired.length > 1 ? 'nent' : 'd'} une retraite bien méritée.`
    });
}

// GÉNÉRATION DES JEUNES (REGENS) - CORRIGÉ
while (this.state.players.length < 22) {
    const age = 17 + Math.floor(Math.random()*3);
    const ovr = 65 + Math.floor(Math.random()*10);
    const pos = ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)];

    // C'est ici que ça change pour être compatible
    const genData = this.generatePlayerStats(pos, ovr);

    this.state.players.push({
        id: crypto.randomUUID(),
        name: this.generateRealName(),
        pos: pos,
        age: age, ovr: ovr,
        stats: genData.stats,      // On prend .stats
        style: genData.roleName,   // On prend .roleName
        pot: this.generatePotential(age, ovr), // On utilise la nouvelle fonction
        role: 'sub', energy: 100, slot: null
    });
}
}
        triggerVictoryCelebration() {
// 1. Son d'ambiance festive
this.playSound('goal');
this.playSound('stadium');

// 2. Préparation des messages (Lore & Immersion)
const messages = [
    {
        from: "Le Chef de l'État",
        role: "Présidence de la République",
        icon: SVGS.medal, // On utilise la médaille
        color: "text-orange-500",
        bg: "bg-orange-900/20 border-orange-500/50",
        text: "Au nom de la Nation toute entière, merci. Vous avez rendu sa fierté au peuple. Vous êtes désormais élevés au rang de Commandeurs de l'Ordre National."
    },
    {
        from: "Le Capitaine",
        role: "Vestiaire",
        icon: SVGS.glove, // On utilise le gant ou un autre icon de joueur
        color: "text-white",
        bg: "bg-slate-800 border-white/10",
        text: "Coach, on l'a fait ! Merci d'avoir cru en nous quand personne ne le faisait. Ce trophée, c'est le vôtre."
    },
    {
        from: "Le Directeur Technique",
        role: "Fédération",
        icon: SVGS.briefcase,
        color: "text-blue-400",
        bg: "bg-blue-900/20 border-blue-500/30",
        text: "Un parcours historique. Votre contrat est non seulement renouvelé, mais nous débloquons une prime exceptionnelle pour le prochain mercato."
    }
];

// 3. Construction du HTML
let msgHTML = messages.map(m => `
    <div class="p-4 rounded-xl border ${m.bg} flex gap-4 items-start shadow-lg animate-slideIn" style="animation-duration: 1s">
        <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center shrink-0 shadow-xl">
            <span class="${m.color} scale-125">${m.icon}</span>
        </div>
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="font-teko text-xl text-white uppercase leading-none">${m.from}</span>
                <span class="text-[8px] font-bold px-1.5 py-0.5 rounded bg-slate-900 text-slate-400 uppercase tracking-widest">${m.role}</span>
            </div>
            <p class="text-[10px] text-slate-300 italic leading-relaxed">"${m.text}"</p>
        </div>
    </div>
`).join('');

const modalHTML = `
    <div id="victory-celebration-modal" class="fixed inset-0 z-[2000] bg-slate-950/95 backdrop-blur-xl flex flex-col items-center justify-center p-6 overflow-hidden">

        <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <div class="absolute top-0 left-1/4 w-2 h-2 bg-orange-500 rounded-full animate-ping" style="animation-duration: 1s"></div>
            <div class="absolute top-10 right-1/4 w-3 h-3 bg-white rounded-full animate-ping" style="animation-duration: 1.5s"></div>
            <div class="absolute top-1/3 left-1/2 w-2 h-2 bg-green-500 rounded-full animate-ping" style="animation-duration: 2s"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-orange-500/10 to-transparent"></div>
        </div>

        <div class="relative z-10 w-full max-w-lg flex flex-col gap-6">

            <div class="text-center mb-4">
                <div class="inline-block p-4 rounded-full bg-gradient-to-br from-yellow-400 to-orange-600 shadow-[0_0_50px_rgba(245,158,11,0.6)] mb-4 animate-bounce">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17a1 1 0 0 0 2 0v-2.34"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
                </div>
                <h1 class="font-teko text-7xl text-white uppercase italic leading-none drop-shadow-xl">CHAMPIONS D'AFRIQUE !</h1>
                <p class="text-xs text-orange-300 font-bold uppercase tracking-[0.3em]">La Gloire est Éternelle</p>
            </div>

            <div class="space-y-3">
                ${msgHTML}
            </div>

            <button onclick="app.closeVictoryModal()" class="w-full py-5 bg-white hover:bg-slate-200 text-slate-900 rounded-xl font-bold uppercase text-sm tracking-widest shadow-2xl transition transform hover:scale-[1.02] mt-4 flex items-center justify-center gap-2">
                <span>★</span> Commencer la Nouvelle Ère <span>★</span>
            </button>

        </div>
    </div>
`;

document.body.insertAdjacentHTML('beforeend', modalHTML);
}

closeVictoryModal() {
const modal = document.getElementById('victory-celebration-modal');
if(modal) {
    // Petite animation de sortie
    modal.style.opacity = '0';
    modal.style.transition = 'opacity 0.5s';
    setTimeout(() => {
        modal.remove();
        // C'est ici qu'on lance la suite
        this.startNextSeason();
    }, 500);
} else {
    this.startNextSeason();
}
}
// --- GESTION CARRIÈRE & OFFRES ---
openJobOffersModal() {
        const container = document.getElementById('job-cards-container');
        document.getElementById('mercato-year').innerText = this.state.year + 2;
        container.innerHTML = '';

        // --- 1. CARTE ACTUELLE (RESTER) ---
        const myCode = this.state.userTeamCode;
        const myName = this.state.userTeamName;

        // Design spécial "Bleu/Loyauté" pour l'équipe actuelle
        container.innerHTML += `
            <div class="mercato-card border-blue-500/30">
                <div class="mercato-header bg-blue-900/20">
                    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                    <div class="z-10 flex flex-col items-center">
                        <div class="w-24 h-24 rounded-full border-4 border-blue-500 bg-slate-900 flex items-center justify-center text-4xl font-bold text-white shadow-xl mb-2">
                            ${myCode}
                        </div>
                        <div class="px-3 py-1 bg-blue-600 rounded-full text-[10px] font-bold text-white uppercase tracking-widest">
                            Contrat Actuel
                        </div>
                    </div>
                </div>
                <div class="mercato-body">
                    <div class="text-center">
                        <h3 class="font-teko text-4xl text-white uppercase italic mb-1 leading-none">${myName}</h3>
                        <p class="text-blue-300 text-xs uppercase font-bold mb-6">Continuer l'aventure</p>

                        <div class="space-y-2 w-full">
                            <div class="stat-pill">
                                <span class="text-slate-400 text-xs font-bold uppercase">Budget</span>
                                <span class="text-white font-teko text-xl">${this.state.budget.toFixed(1)}M€</span>
                            </div>
                            <div class="stat-pill">
                                <span class="text-slate-400 text-xs font-bold uppercase">Confiance</span>
                                <span class="text-green-400 font-teko text-xl">100%</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="app.confirmSeasonStart(null)" class="w-full py-4 bg-blue-600 active:scale-95 text-white font-bold uppercase rounded-xl shadow-lg shadow-blue-900/50 mt-4 transition-all flex items-center justify-center gap-2">
                        <span>PROLONGER</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    </button>
                </div>
            </div>
        `;

        // --- 2. OFFRES (IA) ---
        let candidates = NATIONS_DB.filter(n => n.code !== myCode);

        // Logique de sélection (Gros clubs si trophées, sinon random)
        if (this.state.trophies > 0 || this.state.pastWinners.some(w => w.n === myName)) {
            candidates = candidates.filter(n => n.ovr >= 78);
        } else {
            candidates = candidates.sort(() => Math.random() - 0.5);
        }

        // On prend 2 ou 3 offres max pour ne pas spammer le joueur
        candidates = candidates.sort(() => Math.random() - 0.5).slice(0, 3);

        candidates.forEach(team => {
            const isTop = team.ovr >= 80;
            const accentColor = isTop ? 'text-yellow-500' : 'text-orange-500';
            const btnGradient = isTop ? 'bg-gradient-to-r from-yellow-600 to-orange-600' : 'bg-slate-700';
            const bgHeader = isTop ? 'bg-yellow-900/20' : 'bg-slate-800';

            container.innerHTML += `
                <div class="mercato-card ${isTop ? 'border-yellow-500/40' : 'border-white/10'}">
                    <div class="mercato-header ${bgHeader}">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="z-10 flex flex-col items-center">
                            <div class="w-24 h-24 rounded-full border-4 ${isTop ? 'border-yellow-500' : 'border-slate-500'} bg-slate-900 flex items-center justify-center text-4xl font-bold text-white shadow-xl mb-2">
                                ${team.code}
                            </div>
                            <div class="px-3 py-1 ${isTop ? 'bg-yellow-600' : 'bg-slate-600'} rounded-full text-[10px] font-bold text-white uppercase tracking-widest">
                                ${isTop ? 'Top Team' : 'Challenge'}
                            </div>
                        </div>
                    </div>

                    <div class="mercato-body">
                        <div class="text-center">
                            <h3 class="font-teko text-4xl text-white uppercase italic mb-1 leading-none">${team.n}</h3>
                            <p class="${accentColor} text-xs uppercase font-bold mb-6">Objectif : ${isTop ? 'Gagner la Coupe' : 'Qualification'}</p>

                            <div class="space-y-2 w-full">
                                <div class="stat-pill">
                                    <span class="text-slate-400 text-xs font-bold uppercase">Niveau</span>
                                    <div class="flex items-center gap-2">
                                        <div class="flex gap-0.5">
                                            ${Array(Math.floor(team.ovr/20)).fill('★').join('')}
                                        </div>
                                        <span class="text-white font-teko text-xl">${team.ovr}</span>
                                    </div>
                                </div>
                                <div class="stat-pill">
                                    <span class="text-slate-400 text-xs font-bold uppercase">Star</span>
                                    <span class="text-white font-teko text-xl truncate max-w-[120px]">${team.star || 'Inconnue'}</span>
                                </div>
                            </div>
                        </div>

                        <button onclick="app.confirmSeasonStart('${team.code}')" class="w-full py-4 ${btnGradient} active:scale-95 text-white font-bold uppercase rounded-xl shadow-lg mt-4 transition-all flex items-center justify-center gap-2">
                            <span>SIGNER ICI</span>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        });

        // Afficher le modal
        document.getElementById('job-offers-modal').classList.remove('hidden');
    }

    confirmSeasonStart(newTeamCode) {
        // 1. Cacher le modal
        document.getElementById('job-offers-modal').classList.add('hidden');

        // 2. Si changement d'équipe
        if (newTeamCode && newTeamCode !== this.state.userTeamCode) {
            this.swapUserTeam(newTeamCode);
        }

        // 3. Lancer la saison (Flag pour éviter la boucle infinie)
        this.state.seasonTransitionPending = true;
        this.startNextSeason();
    }

    swapUserTeam(newCode) {
        // A. SAUVEGARDER L'ANCIENNE ÉQUIPE DANS LE MONDE
        if (!this.state.worldPlayers) this.state.worldPlayers = {};
        this.state.worldPlayers[this.state.userTeamCode] = JSON.parse(JSON.stringify(this.state.players));

        // B. CHARGER LA NOUVELLE ÉQUIPE
        let newSquad = this.state.worldPlayers[newCode];
        if (!newSquad) {
            const baseSquad = REAL_SQUADS_DB[newCode];
            // Cherchez la ligne : const baseSquad = REAL_SQUADS_DB[newCode];
// Remplacez le bloc de création de l'équipe par ceci :

if (baseSquad) {
    newSquad = baseSquad.map(p => {
        const gen = this.generatePlayerStats(p.pos, p.ovr);
        return {
            ...p,
            id: crypto.randomUUID(), // Important : Génère un ID unique compatible
            energy: 100,
            stats: gen.stats,
            style: gen.roleName,
            pot: this.generatePotential(p.age, p.ovr) // Important : Calcule le potentiel pour les joueurs de base
        };
    });
}
        }

        // C. APPLIQUER LE CHANGEMENT
        const newNation = NATIONS_DB.find(n => n.code === newCode);

        this.state.userTeamCode = newCode;
        this.state.userTeamName = newNation.n;
        this.state.players = newSquad || [];
        this.state.viewingGroup = 'A';

        // --- CORRECTION BUDGET ---
        // Top Team (> 80 OVR) = 50M€ | Petite Team = 15M€
        this.state.budget = newNation.ovr >= 80 ? 50.0 : 15.0;

        this.state.teamXP = 0;


        // --- CORRECTION BÂTIMENTS & STAFF (Reset Complet) ---

// 1. On écrase l'ancien objet infra pour remettre les prix de base (10, 5, 8)
this.state.infra = {
    stadium: { level: 1, cost: 10, bonus: 0.5 },
    training: { level: 1, cost: 5, bonus: 1 },
    medical: { level: 1, cost: 8, bonus: 5 }
};

// 2. On réinitialise aussi le Staff (pour remettre les salaires à zéro)
this.state.staff = {
    director: { level: 1, salary: 2.0, name: "Directeur Sportif", desc: "Réduit les coûts de recrutement (-10%/niv)." },
    assistant: { level: 1, salary: 1.5, name: "Entraîneur Adjoint", desc: "Booste le gain d'XP d'équipe (+10%/niv)." },
    fitness: { level: 1, salary: 1.0, name: "Préparateur Physique", desc: "Remplaçants récupèrent mieux (+5%/niv)." }
};
// --- CORRECTION RÔLES (Reset & Auto-Assignation) ---
        // On nettoie les anciens rôles pour éviter les conflits d'ID

       // --- CORRECTION RÔLES (Version Intelligente V2) ---

        const teamPlayers = this.state.players;

        if (teamPlayers && teamPlayers.length > 0) {
            // 1. Capitaine : Le joueur avec la plus haute note globale (OVR)
            const bestCap = [...teamPlayers].sort((a, b) => b.ovr - a.ovr)[0];

            // 2. Penalty : On cherche le meilleur Attaquant (FWD)
            const bestPen = [...teamPlayers].sort((a, b) => {
                // Si les stats de tir (sho) existent, on les utilise
                if (a.stats && b.stats) return (b.stats.sho || 0) - (a.stats.sho || 0);

                // Sinon, on privilégie les Attaquants (FWD) + leur note OVR
                const roleA = (a.pos === 'FWD' || a.pos === 'ATT' || a.pos === 'BU') ? 100 : 0;
                const roleB = (b.pos === 'FWD' || b.pos === 'ATT' || b.pos === 'BU') ? 100 : 0;
                return (roleB + b.ovr) - (roleA + a.ovr);
            })[0];

            // 3. Coups Francs/Corners : On cherche le meilleur Milieu (MID)
            const bestKick = [...teamPlayers].sort((a, b) => {
                // Si les stats de passe (pas) existent, on les utilise
                if (a.stats && b.stats) return (b.stats.pas || 0) - (a.stats.pas || 0);

                // Sinon, on privilégie les Milieux (MID) + leur note OVR
                const roleA = (a.pos === 'MID' || a.pos === 'MIL' || a.pos === 'MOC') ? 100 : 0;
                const roleB = (b.pos === 'MID' || b.pos === 'MIL' || b.pos === 'MOC') ? 100 : 0;
                return (roleB + b.ovr) - (roleA + a.ovr);
            })[0];

            // Assignation des IDs (avec sécurité si un joueur n'est pas trouvé)
            this.state.roles = {
                captain: bestCap ? bestCap.id : null,
                penalty: bestPen ? bestPen.id : (bestCap ? bestCap.id : null),
                freekick: bestKick ? bestKick.id : (bestCap ? bestCap.id : null),
                corner: bestKick ? bestKick.id : (bestCap ? bestCap.id : null)
            };
        } else {
            this.state.roles = { captain: null, penalty: null, freekick: null, corner: null };
        }

        this.toast(`Bienvenue chez les ${newNation.n} ! Budget : ${this.state.budget}M€`);
        this.save();
    }
startNextSeason() {
    // --- 0. INTERCEPTION CARRIÈRE (NOUVEAU) ---
        // Si on n'a pas encore fait le choix du mercato, on arrête tout et on ouvre le modal
        if (!this.state.seasonTransitionPending) {
            this.openJobOffersModal();
            return; // On stoppe l'exécution ici !
        }
        // Si on vient du modal (confirmSeasonStart), on reset le flag et on continue
        this.state.seasonTransitionPending = false;

        // --- 1. CHANGEMENT DE PAYS HÔTE (VOTRE CODE) ---
        let newHost;
        if (NATIONS_DB.length > 1) {
            do {
                newHost = NATIONS_DB[Math.floor(Math.random() * NATIONS_DB.length)];
            } while (this.state.hostCountry && newHost.n === this.state.hostCountry);
        } else {
            newHost = NATIONS_DB[0];
        }
        this.state.hostCountry = newHost.n;
        this.state.hostStadiums = newHost.stadiums;

        this.state.news.unshift({
            id: Date.now() + 9999,
            text: `${SVGS.globe} OFFICIEL : La CAN ${this.state.year + 2} se déroulera au ${newHost.n} !`
        });

        // 2. PAIEMENT SALAIRES
        let totalSalaries = 0;
        if (this.state.staff) {
            Object.values(this.state.staff).forEach(s => totalSalaries += s.salary);
        }
        this.state.budget -= totalSalaries;

        if (this.state.budget < 0) {
            this.state.budget = 0;
            this.state.news.unshift({id: Date.now(), text: `⚠️ CRISE : L'État renfloue la fédération pour payer les salaires.`});
        } else {
            this.state.news.unshift({id: Date.now(), text: `💰 FINANCES : ${totalSalaries.toFixed(1)}M€ versés au staff technique.`});
        }

        // 3. CHANGEMENT DE SAISON (+2 ANS POUR TOUT LE MONDE)
        this.state.year += 2;
        this.state.seasonsPlayed++;
        this.state.matchIndex = 0;
        this.state.stage = 'groups';
        this.state.rareScoutUsed = false;

        // Reset des stats APRES avoir donné les récompenses
        this.state.goalScorers = [];
        this.state.assisters = [];
        this.state.playerRatings = [];

        // --- 4. GESTION DU MONDE VIVANT (IA AMÉLIORÉE) ---
        if (this.state.worldPlayers) {
            let totalRetired = 0;
            let wonderkidsCount = 0;

            Object.keys(this.state.worldPlayers).forEach(code => {
                // SÉCURITÉ : On ignore votre équipe ici pour éviter les bugs
                if (code === this.state.userTeamCode) return;

                const squad = this.state.worldPlayers[code];
                for (let i = 0; i < squad.length; i++) {
                    let p = squad[i];

                    // A. Vieillissement IA (+2 ANS)
                    p.age = (p.age || 25) + 2;

                    // B. Évolution IA (BOOSTÉE)
                    if (p.age > 33) {
                        // Déclin (ralenti pour les stars pour qu'elles durent plus longtemps)
                        const decline = p.ovr > 85 ? 1 : 2;
                        p.spd = Math.max(30, (p.spd || 70) - decline);
                        p.ovr = Math.max(60, p.ovr - decline);
                    } else if (p.age < 26) {
                        // Les jeunes progressent plus vite pour compenser le niveau utilisateur
                        // +2 à +4 OVR tous les 2 ans
                        const growth = Math.floor(Math.random() * 3) + 2;
                        p.ovr = Math.min(95, p.ovr + growth);
                    }

                    // C. Retraite IA & REGENS INTELLIGENTS
                    const retirementChance = (p.age - 34) * 0.25;

                    if (p.age > 40 || (p.age > 36 && Math.random() < retirementChance)) {
                        totalRetired++;

                        // SAUVEGARDE DU NIVEAU DE L'ANCIEN JOUEUR
                        const oldOvr = p.ovr;

                        // Reset du joueur (Regen)
                        p.name = this.generateRealName(code);
                        p.age = 16 + Math.floor(Math.random() * 4); // 16-19 ans

                        // LOGIQUE DE GÉNÉRATION ÉLITE
                        let minOvr = 68;
                        let maxBonus = 8;

                        if (oldOvr >= 85) {
                            minOvr = 76;
                            maxBonus = 10;
                        } else if (oldOvr >= 80) {
                            minOvr = 73;
                            maxBonus = 8;
                        } else if (oldOvr >= 75) {
                            minOvr = 70;
                        }

                        // Chance de "Golden Boy"
                        if (Math.random() < 0.05) {
                            minOvr = 78;
                            maxBonus = 8;
                            wonderkidsCount++;
                        }

                        p.ovr = minOvr + Math.floor(Math.random() * maxBonus);

                        // Vitesse
                        if (p.pos === 'FWD' || p.pos === 'MID') {
                            p.spd = 75 + Math.floor(Math.random() * 20);
                        } else {
                            p.spd = 65 + Math.floor(Math.random() * 20);
                        }

                        p.role = 'sub';
                        p.isStar = p.ovr >= 80;
                    }
                }
            });

            if (totalRetired > 0) {
                this.state.news.unshift({
                    id: Date.now() + 50,
                    text: `${SVGS.globe} MONDE : ${totalRetired} départs en retraite. ${wonderkidsCount > 0 ? wonderkidsCount + " pépites détectées !" : ""}`
                });
            }
        }

        // 5. ÉVOLUTION DE VOS JOUEURS (USER)
        this.state.players.forEach(p => {
            p.energy = 100;
            // A. Vieillissement JOUEUR (+2 ANS)
            p.age += 2;
            if (!p.stats) p.stats = this.generatePlayerStats(p.pos, p.ovr).stats;

            // B. PROGRESSION (Sur 2 ans)
            if (p.age <= 24) {
                const gain = (p.ovr < p.pot) ? Math.floor(Math.random() * 3) + 1 : 0;
                Object.keys(p.stats).forEach(k => {
                    if(Math.random() > 0.5) p.stats[k] += gain;
                });
            } else if (p.age <= 29) {
                if(Math.random() > 0.4) p.stats.def += 1;
                if(Math.random() > 0.4) p.stats.pas += 1;
                if(Math.random() > 0.4) p.stats.phy += 1;
            } else {
                const physicalLoss = (p.age >= 34) ? 3 : 1;
                p.stats.pac -= physicalLoss;
                p.stats.phy -= physicalLoss;
                p.stats.dri -= 1;
            }

            // Recalcul OVR
            let totalStats = 0;
            Object.keys(p.stats).forEach(k => {
                p.stats[k] = Math.max(40, Math.min(99, p.stats[k]));
                totalStats += p.stats[k];
            });
            p.ovr = Math.round(totalStats / 6);
        });

        // 6. Retraites User
        this.processRetirements();

        // 7. Tirage au sort
        const n = [...NATIONS_DB].sort(()=>Math.random()-0.5);
        this.state.groups = this.createGroups(n);
        const oldStd = this.state.standings;
        this.state.standings = this.initStd(n, this.state.groups);

        Object.keys(this.state.standings).forEach(k => {
            if(oldStd[k]) {
                this.state.standings[k].star = oldStd[k].star;
                this.state.standings[k].starAge = oldStd[k].starAge;
                this.state.standings[k].ovr = oldStd[k].ovr;
            } else {
                this.state.standings[k].starAge = 25;
            }
        });

        this.state.globalResults = [];
        this.updateUI();
        this.goToView('inbox');
        this.toast(`Saison ${this.state.year} lancée !`);
        this.playSound('stadium');
    }

        getTacticalAdvice(style) {
            // Base de données de conseils variés
            const strategies = {
                'Offensif': [
                    "Ils laissent des espaces énormes dans leur dos. Jouez en <b class='text-orange-400'>CONTRE</b> rapide !",
                    "Leur ligne défensive joue très haut. Lancez des ballons en profondeur pour nos ailiers.",
                    "Attention à la surcharge offensive. Renforcez le milieu pour couper les lignes de passe."
                ],
                'Tiki-Taka': [
                    "Ils confisquent le ballon. Un <b class='text-orange-400'>PRESSING HAUT</b> est vital pour les étouffer.",
                    "Ne courez pas dans le vide. Bloquez l'axe et forcez-les à jouer sur les côtés inoffensifs.",
                    "Il faudra être patient. Interceptez et projetez-vous vite vers l'avant à la récupération."
                ],
                'Contre': [
                    "Ne perdez pas la balle haut ! Ils attendent la moindre erreur pour punir en transition.",
                    "Gardez la <b class='text-orange-400'>POSSESSION</b> mais restez prudents avec vos latéraux.",
                    "Leur transition est mortelle. Faites des fautes tactiques intelligentes si besoin."
                ],
                'Bloc Bas': [
                    "Un véritable mur. Il faudra de la patience et écarter le jeu sur les ailes pour trouver la faille.",
                    "Tentez des frappes de loin pour les obliger à sortir de leur surface.",
                    "Ne vous jetez pas à l'abordage. Ils veulent vous endormir pour mieux piquer en contre."
                ],
                'Vertical': [
                    "Jeu direct très dangereux. Baissez le bloc pour réduire la profondeur disponible.",
                    "Coupez la relation technique entre leurs défenseurs et leurs attaquants.",
                    "Grosse bataille aérienne en vue. Soyez solides sur les seconds ballons."
                ],
                'Technique': [
                    "Ne vous jetez pas ! Ils attendent le duel pour dribbler et provoquer la faute.",
                    "Imposez un défi physique constant. Ils n'aiment pas les contacts rugueux.",
                    "Resserrez les lignes. Ne leur laissez aucun espace entre le milieu et la défense."
                ],
                'Physique': [ // Pour les styles : Puissance, Impact, Lutte...
                    "Évitez les duels à l'épaule, faites courir le ballon plus vite qu'eux.",
                    "Jouez dans les pieds et au sol. Ils sont moins à l'aise techniquement.",
                    "Attention aux coups de pied arrêtés. C'est leur arme principale."
                ]
            };

            // Mapping intelligent des styles exotiques vers des catégories génériques
            let key = style;
            if (['Vitesse', 'Explosivité'].includes(style)) key = 'Vertical';
            if (['Puissance', 'Impact', 'Lutte', 'Courage', 'Solidité', 'Collectif'].includes(style)) key = 'Physique';
            if (['Dribbles', 'Créativité'].includes(style)) key = 'Technique';
            if (['Pressing'].includes(style)) key = 'Offensif';
            if (['Transition'].includes(style)) key = 'Contre';

            // Sélection aléatoire d'une phrase
            const list = strategies[key] || [
                "Adversaire imprévisible. Soyez solides et profitez des coups de pied arrêtés.",
                "C'est un match piège. Restez concentrés et imposez votre rythme dès le début.",
                "Duel équilibré en perspective. L'efficacité dans les deux surfaces fera la différence."
            ];

            return list[Math.floor(Math.random() * list.length)];
        }

       renderInbox() {
            // 1. Mises à jour de base (Date, Stade de la compétition)
            const dD = document.getElementById('dash-date');
            if(dD) dD.innerText = this.state.year;

            const dS = document.getElementById('dash-stage');
            if(dS) dS.innerText = this.state.stage.toUpperCase();

            // --- MISE À JOUR DU BADGE ÉQUIPE (VOTRE ÉQUIPE) ---
            const myCode = this.state.userTeamCode || 'CIV';
            const myBadge = document.getElementById('dash-user-badge');

            if (myBadge) {
                myBadge.innerHTML = `
                    ${myCode}
                    <div class="absolute -bottom-2 -right-2 bg-white text-slate-900 text-[9px] font-bold px-1.5 rounded border border-slate-300">DOM</div>
                `;
            }

            // 2. RECUPERATION ET AFFICHAGE DE L'ADVERSAIRE
            const opp = this.getOpponent();

            if (opp) {
                // Nom et Code de l'adversaire
                const nN = document.getElementById('next-opp-name');
                if(nN) nN.innerText = opp.n;

                const nB = document.getElementById('next-opp-badge');
                if(nB) nB.innerText = opp.code;

                // --- ROTATION DES STADES (NOUVEAU) ---
                // On récupère la liste des 4 stades du pays hôte actuel
                const venues = this.state.hostStadiums || ['Stade National'];
                // On sélectionne le stade selon le numéro du match (modulo)
                const currentStadium = venues[this.state.matchIndex % venues.length];

                // On met à jour le texte du stade dans la carte "PROCHAIN MATCH"
                // (Note: On cible l'élément p qui contient le nom du stade)
                const nextMatchCard = document.getElementById('next-match-card');
                if(nextMatchCard) {
                    const stadiumText = nextMatchCard.querySelector('.text-slate-500.uppercase.tracking-widest.font-bold');
                    if(stadiumText) stadiumText.innerText = currentStadium;
                }

                // Boîte d'Analyse (Rapport Scout)
                const oA = document.getElementById('opponent-analysis-box');
                if(oA) {
                    // 1. Récupération du conseil dynamique
                    const advice = this.getTacticalAdvice(opp.style);

                    // 2. Calcul Probabilité Victoire (Basé sur la Puissance d'équipe vs Adversaire)
                    // Cela rend le rapport "vivant" : plus vous améliorez votre équipe, plus le % monte !
                    const myPower = this.getTeamPower();
                    const oppPower = opp.ovr || 75;
                    const diff = myPower - oppPower;

                    // Formule : Si égalité de niveau = 50%. +10 OVR = 75%.
                    let winPct = 50 + (diff * 2.5);
                    winPct = Math.min(95, Math.max(5, Math.round(winPct)));

                    // Couleur dynamique de la barre
                    let barColor = winPct > 55 ? 'bg-green-500' : (winPct < 45 ? 'bg-red-500' : 'bg-orange-500');
                    let textProb = winPct > 55 ? 'Favori' : (winPct < 45 ? 'Outsider' : 'Match Nul ?');

                    oA.innerHTML = `
                        <div class="p-3 bg-slate-800/40 rounded-xl text-center shadow-lg border border-white/5">
                            <span class="text-[8px] text-slate-500 uppercase font-bold block mb-1">Style</span>
                            <div class="text-white text-sm font-bold uppercase tracking-widest truncate">${opp.style}</div>
                        </div>
                        <div class="p-3 bg-slate-800/40 rounded-xl text-center shadow-lg border border-white/5">
                            <span class="text-[8px] text-slate-500 uppercase font-bold block mb-1">Danger</span>
                            <div class="text-red-400 text-sm font-bold uppercase tracking-widest truncate">${opp.star}</div>
                        </div>

                        <div class="col-span-2 px-3 py-2 bg-slate-800/30 rounded-xl border border-white/5">
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-[9px] text-slate-400 font-bold uppercase">Prédiction IA</span>
                                <span class="text-[9px] ${winPct > 50 ? 'text-green-400' : 'text-orange-400'} font-bold uppercase">${winPct}% Chance Victoire</span>
                            </div>
                            <div class="w-full h-1.5 bg-slate-900 rounded-full overflow-hidden">
                                <div class="h-full ${barColor} transition-all duration-1000" style="width: ${winPct}%"></div>
                            </div>
                        </div>

                        <div class="col-span-2 p-3 bg-blue-900/10 rounded-xl border border-blue-500/20 flex items-start gap-3 relative overflow-hidden">
                            <div class="absolute -right-4 -top-4 opacity-5 grayscale scale-[3.0] rotate-12">${SVGS.radar}</div>
                            <div class="mt-0.5 text-blue-400 shrink-0">${SVGS.layout}</div>
                            <div class="relative z-10">
                                <span class="text-[9px] text-blue-400 uppercase font-bold block mb-0.5">Note de l'Analyste</span>
                                <div class="text-slate-300 text-[10px] leading-snug font-medium italic">"${advice}"</div>
                            </div>
                        </div>

                        <button onclick="app.viewOpponentTactics()" class="col-span-2 py-3 bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded-xl text-white font-bold uppercase text-xs flex items-center justify-center gap-2 transition shadow-lg group active:scale-95">
                            <span class="grayscale group-hover:grayscale-0 transition">${SVGS.search}</span>
                            Voir Dispositif Probable
                        </button>
                    `;
                }
            }

            // 3. GESTION DES NEWS (GAZETTE)
            const nBox = document.getElementById('news-feed');
            if(nBox) {
                nBox.innerHTML = '';

                // Alerte Tactique (Raccourci vers l'équipe) - Toujours en premier
                const teamPower = Math.round(this.getTeamPower());
                const color = teamPower < 70 ? "border-red-500/50" : "border-green-500/50";

                nBox.innerHTML += `
                    <div onclick="app.goToView('squad')" class="cursor-pointer mb-3 relative overflow-hidden bg-slate-800 border-l-4 ${color} rounded-r-xl p-4 shadow-lg group hover:bg-slate-700 transition-all active:scale-95">
                        <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-slate-900/50 to-transparent"></div>
                        <div class="flex items-center justify-between relative z-10">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center text-white shadow-lg animate-pulse">
                                    ${SVGS.whistle}
                                </div>
                                <div>
                                    <h3 class="font-teko text-2xl text-white uppercase leading-none">Briefing Tactique</h3>
                                    <p class="text-[10px] text-orange-400 font-bold uppercase tracking-widest">Revoir le 11 de départ</p>
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center group-hover:bg-orange-500 group-hover:border-orange-500 transition text-white">
                                ➝
                            </div>
                        </div>
                    </div>
                `;

                // Affichage des news dynamiques
                this.state.news.slice(0, 15).forEach(n => {
                   let [category, ...msgParts] = n.text.split(':');
                   let message = msgParts.join(':').trim();
                   if(!message) { message = category; category = "INFO"; }
                   category = category.trim().toUpperCase();

                   let icon = SVGS.mega; let iconColor = "text-white";
                   if (["MERCATO", "TRANSFERT", "OFFICIEL"].some(k => category.includes(k))) { icon = SVGS.briefcase; iconColor = "text-green-400"; }
                   else if (["BLESSURE", "CLASH", "COLÈRE"].some(k => category.includes(k))) { icon = SVGS.alert; iconColor = "text-red-400"; }
                   else if (["VICTOIRE", "TITRE", "MVP", "CHAMPION"].some(k => category.includes(k))) { icon = SVGS.trophy; iconColor = "text-yellow-400"; }
                   else if (["RUMEUR", "BUZZ", "MONDE"].some(k => category.includes(k))) { icon = SVGS.globe; iconColor = "text-blue-400"; }

                    nBox.innerHTML += `
                        <div class="glass-panel p-3 rounded-xl flex items-start gap-3 border border-white/5 hover:bg-slate-800 transition group mb-2">
                            <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700 shrink-0 shadow-lg">
                                <span class="${iconColor}">${icon}</span>
                            </div>
                            <div class="flex-1 min-w-0 pt-0.5">
                                <div class="font-bold text-white uppercase text-xs mb-0.5 tracking-wide">${category}</div>
                                <div class="text-[10px] text-slate-400 font-medium leading-tight">${message}</div>
                            </div>
                        </div>`;
               });
            }
        }


selectTeam(code) {
    const teamData = REAL_SQUADS_DB[code];
    if (!teamData) return this.toast("Erreur : Équipe introuvable");

    const nationInfo = NATIONS_DB.find(n => n.code === code);
    this.state.userTeamCode = code;
    this.state.userTeamName = nationInfo ? nationInfo.n : code;

    // Charger les joueurs et générer leurs stats complètes
    this.state.players = teamData.map(p => {
        const generated = this.generatePlayerStats(p.pos, p.ovr);
        return {
            ...p,
            id: crypto.randomUUID(),
            energy: 100,
            stats: generated.stats,
            style: generated.roleName,
            pot: this.generatePotential(p.age, p.ovr)
        };
    });

    // Mettre à jour le groupe affiché
    const myG = this.state.standings[this.state.userTeamName]?.grp || 'A';
    this.state.viewingGroup = myG;
    this.save();

    // --- MODIFICATION POUR SÉLECTION AVATAR ---

    // 1. Cacher le modal de sélection d'équipe
    const teamModal = document.getElementById('team-selection-modal');
    teamModal.classList.add('hidden');
    teamModal.style.display = 'none'; // Sécurité pour forcer le masquage

    // 2. Préparer la grille d'avatars (C'est ici que la magie opère)
    this.renderManagerSelection();

    // 3. Afficher le modal de bienvenue (Contrat & Avatar)
    const welcomeModal = document.getElementById('welcome-modal');
    welcomeModal.classList.remove('hidden');
    welcomeModal.style.display = 'flex'; // Flex pour centrer le contenu

    // ------------------------------------------

    // Mise à jour visuelle des logos "CIV" temporaires dans le header
    document.querySelectorAll('.font-teko').forEach(el => {
        if (el.innerText === 'CIV') el.innerText = code;
    });

    this.toast(`Vous avez pris les commandes de : ${this.state.userTeamName}`);
}
    // Prépare le menu de sélection d'avatar
renderManagerSelection() {
    const grid = document.getElementById('manager-avatars-grid');
    if(!grid) return;
    grid.innerHTML = '';

    // On génère 5 options différentes
    const options = [101, 202, 303, 404, 505]; // Seeds fixes pour avoir de la variété garantie

    // Valeur par défaut
    this.tempManagerSeed = options[0];

    options.forEach((seed, index) => {
        const svg = this.generateManagerIcon(seed, 60);
        const el = document.createElement('div');
        el.className = `manager-option ${index === 0 ? 'selected' : ''}`;
        el.innerHTML = svg;
        el.onclick = () => {
            // Gestion de la sélection visuelle
            document.querySelectorAll('.manager-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            // Sauvegarde temporaire du choix
            this.tempManagerSeed = seed;
            this.playSound('click');
        };
        grid.appendChild(el);
    });
}

// RETRAITE STRICTE > 35 ANS
processRetirements() {
const retired = [];
this.state.players = this.state.players.filter(p => {
    // Si plus de 35 ans (donc 36, 37...), retraite OBLIGATOIRE
    if (p.age > 35) {
        retired.push(p.name);
        return false; // Supprime le joueur
    }
    return true; // Garde le joueur
});

if (retired.length > 0) {
    this.state.news.unshift({
        id: Date.now(),
        text: `${SVGS.hand} DÉPARTS : ${retired.join(', ')} partent à la retraite (limite d'âge atteinte).`
    });
}

// Le reste du code pour générer les jeunes (Regens) reste identique...
while (this.state.players.length < 22) {
    // ... code existant pour créer des jeunes ...
    // Copiez le code de génération de jeunes de votre fonction actuelle ici
    const age = 17 + Math.floor(Math.random()*3);
    const ovr = 65 + Math.floor(Math.random()*10);
    const pos = ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)];
    const genData = this.generatePlayerStats(pos, ovr);
    this.state.players.push({
        id: crypto.randomUUID(), name: this.generateRealName(),
        pos: pos, age: age, ovr: ovr, stats: genData.stats, style: genData.roleName,
        pot: this.generatePotential(age, ovr), role: 'sub', energy: 100, slot: null
    });
}
}
// --- NOUVEAU : FONCTION SCOUTING VISUEL ---
        viewOpponentTactics() {
    const opp = this.getOpponent();
    if (!opp) return;

    const squad = this.generateOpponent11(opp);

    // 1. DÉFINITION DES COULEURS DES ÉQUIPES (Copie de la logique de renderPitch)
    const NATIONS_DATA = {
        'MAR': { main: '#C1272D', trim: '#006233', region: 'NORTH' },
        'ALG': { main: '#FFFFFF', trim: '#006233', region: 'NORTH' },
        'TUN': { main: '#E70013', trim: '#FFFFFF', region: 'NORTH' },
        'EGY': { main: '#CE1126', trim: '#000000', region: 'NORTH' },
        'MTN': { main: '#00A95C', trim: '#FFD700', region: 'NORTH' },
        'CIV': { main: '#F97316', trim: '#FFFFFF', region: 'SUB' },
        'SEN': { main: '#FFFFFF', trim: '#00853F', region: 'SUB' },
        'NGA': { main: '#008751', trim: '#FFFFFF', region: 'SUB' },
        'GHA': { main: '#FFFFFF', trim: '#000000', region: 'SUB' },
        'MLI': { main: '#FCD116', trim: '#009E49', region: 'SUB' },
        'GUI': { main: '#CE1126', trim: '#FCD116', region: 'SUB' },
        'BFA': { main: '#009E49', trim: '#EF2B2D', region: 'SUB' },
        'GNB': { main: '#CE1126', trim: '#009E49', region: 'SUB' },
        'GAM': { main: '#CE1126', trim: '#0033A0', region: 'SUB' },
        'CMR': { main: '#007A5E', trim: '#CE1126', region: 'SUB' },
        'RDC': { main: '#0070FF', trim: '#CE1126', region: 'SUB' }, // Code corrigé de COD à RDC
        'GNQ': { main: '#CE1126', trim: '#0070FF', region: 'SUB' }, // Code corrigé EQG à GNQ
        'RSA': { main: '#FFB81C', trim: '#007749', region: 'MIXED' },
        'ANG': { main: '#CE1126', trim: '#000000', region: 'SUB' },
        'NAM': { main: '#CE1126', trim: '#0033A0', region: 'SUB' },
        'ZAM': { main: '#FF8200', trim: '#009E49', region: 'SUB' },
        'MOZ': { main: '#CE1126', trim: '#FCD116', region: 'SUB' },
        'TAN': { main: '#00A3DD', trim: '#FCD116', region: 'SUB' },
        'CPV': { main: '#0033A0', trim: '#CE1126', region: 'MIXED' },
        'DEFAULT': { main: '#334155', trim: '#FFFFFF', region: 'SUB' }
    };

    // 2. RÉCUPÉRATION DU KIT DE L'ADVERSAIRE
    // On utilise opp.code (ex: 'NGA') pour trouver les couleurs
    const teamKit = NATIONS_DATA[opp.code] || NATIONS_DATA['DEFAULT'];

    // 3. DÉTECTION FORMATION
    const defCount = squad.filter(p => p.pos === 'DEF').length;
    const midCount = squad.filter(p => p.pos === 'MID').length;
    const fwdCount = squad.filter(p => p.pos === 'FWD').length;

    let fmt = `${defCount}-${midCount}-${fwdCount}`;
    if (!FORMATIONS[fmt]) {
        if (defCount >= 5) fmt = '5-4-1';
        else if (midCount >= 5) fmt = '3-5-2';
        else if (fwdCount >= 3) fmt = '4-3-3';
        else fmt = '4-4-2';
    }

    // Mise à jour Interface
    const modal = document.getElementById('scout-formation-modal');
    const container = document.getElementById('scout-pitch-layer');
    const title = document.getElementById('scout-opp-name');
    const fmtBadge = document.getElementById('scout-opp-fmt');

    if (title) title.innerText = opp.n;
    if (fmtBadge) fmtBadge.innerText = fmt;
    if (modal) modal.classList.remove('hidden');

    // Rendu Visuel sur le terrain
    if (container) {
        container.innerHTML = '';
        const formData = FORMATIONS[fmt] || FORMATIONS['4-3-3'];

        // --- GÉNÉRATEUR D'AVATAR ADAPTÉ (Couleurs dynamiques) ---
        const generateSimpleAvatar = (seedStr) => {
            let hash = 0;
            for (let i = 0; i < seedStr.length; i++) hash = seedStr.charCodeAt(i) + ((hash << 5) - hash);
            const safeHash = Math.abs(hash);

            // ICI : On utilise les couleurs de l'équipe adverse définie plus haut
            const mainColor = teamKit.main;
            const trimColor = teamKit.trim;

            // Gestion réaliste des teintes de peau selon la région de l'équipe
            let skins = ["#5D4037", "#8D6E63", "#4E342E", "#3E2723"]; // Sub-saharien par défaut
            if (teamKit.region === 'NORTH') {
                skins = ["#F2C490", "#E0AC69", "#C68642", "#8D5524"]; // Maghreb
            } else if (teamKit.region === 'MIXED') {
                skins = ["#E0AC69", "#8D5524", "#5D4037", "#3E2723"]; // Cap Vert / RSA
            }

            const skin = skins[safeHash % skins.length];

            return `
            <svg viewBox="0 0 64 64" class="player-face" xmlns="http://www.w3.org/2000/svg" style="position: absolute; bottom: 22px; left: 50%; transform: translateX(-50%); width: 36px; height: 36px; z-index: 5;">
                <path d="M12 54 Q32 50, 52 54 V64 H12 Z" fill="${mainColor}" stroke="#111" stroke-width="0.5"/>
                <path d="M22 38 L22 54 L42 54 L42 38" fill="${skin}"/>
                <path d="M24 53 L32 60 L40 53" fill="none" stroke="${trimColor}" stroke-width="2"/>

                <defs>
                    <linearGradient id="g-${safeHash}" x1="0" x2="1" y1="0" y2="1">
                        <stop offset="0%" stop-color="${skin}"/> <stop offset="100%" stop-color="${skin}"/>
                    </linearGradient>
                </defs>

                <path d="M19 16 C19 6, 45 6, 45 16 V26 C45 36, 40 46, 32 46 C24 46, 19 36, 19 26 V16 Z" fill="${skin}" stroke="#221100" stroke-width="0.5"/>

                <path d="M20 27 Q24 25, 28 27 Q24 29, 20 27 Z" fill="#EEE"/>
                <path d="M36 27 Q40 25, 44 27 Q40 29, 36 27 Z" fill="#EEE"/>
                <circle cx="24" cy="27" r="1.5" fill="#111"/>
                <circle cx="40" cy="27" r="1.5" fill="#111"/>

                <path d="M27 41 Q32 44, 37 41" stroke="#3E2723" stroke-width="1.5" fill="none"/>

                ${ safeHash % 2 === 0
                   ? `<path d="M18 20 C18 9, 46 9, 46 20 L46 22 H18 Z" fill="#111"/>`
                   : `<path d="M16 16 C14 6, 50 6, 48 16 C52 8, 12 8, 16 16 Z" fill="#111"/>`
                }
            </svg>`;
        };

        for (let i = 0; i < 11; i++) {
            const p = squad[i];
            const coord = formData.coords[i] || { x: 50, y: 50 };

            const card = document.createElement('div');

            // Style de la carte (Fond) : On garde le gris neutre pour la carte elle-même
            // pour bien faire ressortir le maillot coloré de l'avatar
            const style = p.isStar
                ? "bg-gradient-to-br from-red-900/80 to-slate-900 border-red-500/50 text-red-100 ring-1 ring-red-500/30"
                : "bg-slate-800 border-slate-600 text-slate-300";

            card.style.left = coord.x + '%';
            card.style.top = coord.y + '%';

            card.className = `player-card ${style} border shadow-xl transition transform hover:scale-110 z-10`;

            card.onclick = (e) => {
                e.stopPropagation();
                // Ouvre la fiche en mode lecture seule (true)
                this.openPlayerSheet(p, true);
            };

            // On génère l'avatar avec les couleurs de l'équipe
            const avatarHTML = generateSimpleAvatar(p.name + i + opp.code);

            card.innerHTML = `
                ${p.isStar ? '<div class="absolute -top-1.5 -right-1.5 text-[8px] animate-pulse">⭐</div>' : ''}

                ${avatarHTML}

                <div class="card-ovr ${p.isStar ? 'text-red-400' : 'text-slate-400'}" style="position:relative; z-index:10;">${p.ovr}</div>
                <div class="card-pos" style="position:relative; z-index:10;">${p.pos}</div>

                <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 whitespace-nowrap bg-black/70 px-1.5 rounded text-[7px] text-white font-bold border border-white/10" style="position:relative; z-index:10; margin-top: auto;">
                    ${p.name.split(' ').pop().substring(0, 8)}
                </div>
            `;
            container.appendChild(card);
        }
    }
}
        // --- AJOUTER CETTE FONCTION DANS LA CLASSE EliteManager ---
renderTacticalButtons(location) {
const c = this.state.instructions;
const bgActive = "bg-orange-600 text-white border-orange-500 shadow-lg";
const bgInactive = "bg-slate-800 text-slate-500 border-slate-700";

const btn = (key, val, label) => `
    <button onclick="app.setInstruction('${key}', '${val}')"
    class="instruction-btn flex-1 py-2 rounded-lg border text-[9px] font-bold uppercase transition ${c[key] === val ? bgActive : bgInactive}">
    ${label}
    </button>`;

// MODIFICATION : On retire la <div class="grid..."> autour.
// On retourne directement la liste des 6 blocs.
return `
    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Style Tactique</span>
        <div class="flex gap-1">${btn('style', 'possession', 'Possession')}${btn('style', 'counter', 'Contre')}</div>
    </div>
    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Intensité Pressing</span>
        <div class="flex gap-1">${btn('pressing', 'normal', 'Normal')}${btn('pressing', 'high', 'Haut')}</div>
    </div>

    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Jeu de Passes</span>
        <div class="flex gap-1">${btn('passing', 'short', 'Courtes')}${btn('passing', 'long', 'Longues')}</div>
    </div>
    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Impact Physique</span>
        <div class="flex gap-1">${btn('aggression', 'safe', 'Prudent')}${btn('aggression', 'hard', 'Mordant')}</div>
    </div>

    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Utilisation Largeur</span>
        <div class="flex gap-1">${btn('width', 'narrow', 'Axial')}${btn('width', 'wide', 'Large')}</div>
    </div>
    <div class="flex flex-col gap-1">
        <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Rythme de jeu</span>
        <div class="flex gap-1">${btn('tempo', 'slow', 'Posé')}${btn('tempo', 'fast', 'Effréné')}</div>
    </div>
`;
}
openTacticalSubModal(subId) {
this.pendingSubId = subId; // On mémorise quel remplaçant veut entrer
const sub = this.state.players.find(p => p.id === subId);

// On prépare le HTML
let listHTML = '';

// On prend les titulaires et on les trie par poste (Gardien, Défense, Milieu, Attaque)
const starters = this.state.players.filter(p => p.role === 'starter')
    .sort((a,b) => {
        const order = { 'GK': 1, 'DEF': 2, 'MID': 3, 'FWD': 4 };
        return order[a.pos] - order[b.pos];
    });

starters.forEach(starter => {
    // Code couleur pour indiquer si c'est le bon poste
    const isSamePos = starter.pos === sub.pos;
    const borderColor = isSamePos ? 'border-green-500/50' : 'border-slate-700';
    const bgClass = isSamePos ? 'bg-green-900/10' : 'bg-slate-800/50';

    listHTML += `
        <button onclick="app.performReverseSwap(${starter.slot})" class="w-full flex items-center justify-between p-2 rounded-lg border ${borderColor} ${bgClass} hover:bg-slate-700 transition mb-2 group">
            <div class="flex items-center gap-3">
                <div class="flex flex-col items-center w-8">
                    <span class="font-teko text-xl text-white">${starter.ovr}</span>
                    <span class="text-[8px] text-slate-500 font-bold uppercase">${starter.pos}</span>
                </div>
                <div class="text-left">
                    <div class="text-[10px] font-bold text-white uppercase group-hover:text-orange-400 transition">${starter.name}</div>
                    <div class="w-12 h-1 bg-slate-800 rounded-full mt-1 overflow-hidden">
                        <div class="h-full ${starter.energy < 60 ? 'bg-red-500' : 'bg-green-500'}" style="width:${starter.energy}%"></div>
                    </div>
                </div>
            </div>
            <div class="text-[9px] text-slate-500 uppercase font-bold tracking-widest group-hover:text-white">Sortir ➝</div>
        </button>
    `;
});

const modalHTML = `
    <div id="tactical-sub-modal" class="fixed inset-0 z-[600] bg-slate-950/90 flex flex-col items-center justify-center p-6 backdrop-blur-md animate-slideIn">
        <div class="w-full max-w-sm bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[80vh]">

            <div class="p-4 border-b border-white/10 bg-slate-800">
                <h3 class="font-teko text-3xl text-white uppercase italic leading-none">Qui remplacer ?</h3>
                <div class="text-[10px] text-green-400 font-bold uppercase tracking-widest">Entrant : ${sub.name} (${sub.pos})</div>
            </div>

            <div class="p-4 overflow-y-auto no-scrollbar flex-1">
                ${listHTML}
            </div>

            <div class="p-3 bg-slate-950 border-t border-slate-800">
                <button onclick="document.getElementById('tactical-sub-modal').remove()" class="w-full py-3 rounded-xl border border-slate-700 text-slate-500 font-bold uppercase text-xs hover:bg-slate-800">Annuler</button>
            </div>
        </div>
    </div>
`;
document.body.insertAdjacentHTML('beforeend', modalHTML);
}
         // Ouvre le modal pour choisir qui va remplacer un titulaire
        openBenchReplacementModal(starterId) {
            const starter = this.state.players.find(p => p.id === starterId);
            if(!starter) return;

            // 1. On récupère les remplaçants disponibles
            // On trie : d'abord ceux du même poste, puis par OVR décroissant
            const subs = this.state.players.filter(p => p.role !== 'starter')
                .sort((a,b) => {
                    const samePosA = a.pos === starter.pos ? 1 : 0;
                    const samePosB = b.pos === starter.pos ? 1 : 0;
                    return (samePosB - samePosA) || (b.ovr - a.ovr);
                });

            let listHTML = '';

            if (subs.length === 0) {
                listHTML = `<div class="text-center text-slate-500 italic py-4">Aucun remplaçant disponible.</div>`;
            } else {
                subs.forEach(sub => {
                    // Code couleur pour indiquer si c'est le bon poste
                    const isSamePos = sub.pos === starter.pos;
                    const borderColor = isSamePos ? 'border-green-500/50' : 'border-slate-700';
                    const bgClass = isSamePos ? 'bg-green-900/10' : 'bg-slate-800/50';

                    listHTML += `
                        <button onclick="app.finalizeSwap('${starter.id}', '${sub.id}')" class="w-full flex items-center justify-between p-2 rounded-lg border ${borderColor} ${bgClass} hover:bg-slate-700 transition mb-2 group active:scale-95">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col items-center w-8">
                                    <span class="font-teko text-xl text-white">${sub.ovr}</span>
                                    <span class="text-[8px] text-slate-500 font-bold uppercase">${sub.pos}</span>
                                </div>
                                <div class="text-left">
                                    <div class="text-[10px] font-bold text-white uppercase group-hover:text-orange-400 transition">${sub.name}</div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-1 bg-slate-800 rounded-full mt-1 overflow-hidden">
                                            <div class="h-full ${sub.energy < 60 ? 'bg-red-500' : 'bg-green-500'}" style="width:${sub.energy}%"></div>
                                        </div>
                                        <span class="text-[8px] text-slate-500">${sub.energy}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-[9px] text-green-500 uppercase font-bold tracking-widest group-hover:text-white">Entrer ➝</div>
                        </button>
                    `;
                });
            }

            // Construction du Modal (Même design que l'autre)
            const modalHTML = `
                <div id="bench-replacement-modal" class="fixed inset-0 z-[600] bg-slate-950/90 flex flex-col items-center justify-center p-6 backdrop-blur-md animate-slideIn">
                    <div class="w-full max-w-sm bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[80vh]">

                        <div class="p-4 border-b border-white/10 bg-slate-800 flex justify-between items-center">
                            <div>
                                <h3 class="font-teko text-3xl text-white uppercase italic leading-none">Remplacement</h3>
                                <div class="text-[10px] text-red-400 font-bold uppercase tracking-widest">Sortant : ${starter.name}</div>
                            </div>
                            <div class="w-10 h-10 flex items-center justify-center bg-slate-900 rounded-lg border border-slate-700 font-teko text-xl text-white">
                                ${starter.pos}
                            </div>
                        </div>

                        <div class="p-4 overflow-y-auto no-scrollbar flex-1">
                            <p class="text-[9px] text-slate-500 uppercase font-bold mb-3">Choisir le remplaçant :</p>
                            ${listHTML}
                        </div>

                        <div class="p-3 bg-slate-950 border-t border-slate-800">
                            <button onclick="document.getElementById('bench-replacement-modal').remove()" class="w-full py-3 rounded-xl border border-slate-700 text-slate-500 font-bold uppercase text-xs hover:bg-slate-800 transition">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        // Effectue l'échange et ferme le modal
        finalizeSwap(starterId, subId) {
            const starter = this.state.players.find(p => p.id === starterId);
            const sub = this.state.players.find(p => p.id === subId);

            if (starter && sub) {
                // 1. On récupère le slot du titulaire
                const slot = starter.slot;

                // 2. Le titulaire devient remplaçant
                starter.role = 'sub';
                starter.slot = null;

                // 3. Le remplaçant devient titulaire (et prend le slot)
                sub.role = 'starter';
                sub.slot = slot;

                // 4. Feedback et Sauvegarde
                this.toast(`Changement : ${sub.name.split(' ').pop()} remplace ${starter.name.split(' ').pop()}`);
                this.save();

                // 5. Mise à jour visuelle
                this.renderPitch('pitch-cards-layer');
                this.renderPitch('pitch-cards-layer-live'); // Au cas où on est en live
            }

            // 6. Fermeture du modal
            const modal = document.getElementById('bench-replacement-modal');
            if(modal) modal.remove();
        }

// Fonction pour sauvegarder le changement (Remplace setTacticalInstruction)
setInstruction(key, val) {
this.state.instructions[key] = val;
this.renderTacticalUI(); // Met à jour l'avant-match
this.updateMatchInstructionsUI(); // Met à jour le live

// Feedback sonore et texte
if(this.match.active) {
    this.addCommentary(`${SVGS.layout} Consigne changée : ${key.toUpperCase()} > ${val.toUpperCase()}`);
    this.toast("Consigne appliquée !");
}
}

       renderInfra() {
const list = document.getElementById('infra-list');
if(!list) return;
list.innerHTML = '';

// --- SECTION 0 : MUSÉE NATIONAL (CORRIGÉ & DYNAMIQUE) ---

// 1. Récupérer l'équipe actuelle
const myName = this.state.userTeamName || "Côte d'Ivoire";
const myNationData = NATIONS_DB.find(n => n.n === myName);

// 2. Récupérer les titres historiques (depuis NATIONS_DB)
const historicalYears = myNationData ? (myNationData.history || []) : [];

// 3. Récupérer les titres gagnés DANS LE JEU
const gameWins = (this.state.pastWinners || [])
    .filter(w => w.n === myName)
    .map(w => w.year);

// 4. Fusionner et trier
const allYears = [...gameWins, ...historicalYears].sort((a,b) => b-a);
const totalWins = allYears.length;

// Le reste de l'affichage HTML reste identique, mais utilise maintenant 'allYears' dynamique
list.innerHTML += `<div class="mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Héritage & Gloire</span><div class="h-px bg-slate-700 flex-1"></div></div>`;

list.innerHTML += `
    <div class="infra-card relative overflow-hidden bg-slate-900 border border-orange-500/40 mb-8 shadow-[0_0_30px_rgba(249,115,22,0.15)]">
        <div class="absolute -right-8 -bottom-8 text-orange-500 opacity-10 scale-[2.5] rotate-12 pointer-events-none">
            ${SVGS.cup}
        </div>

        <div class="flex items-center gap-5 relative z-10">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-800 flex items-center justify-center text-white shadow-2xl border-2 border-white/10 shrink-0">
                ${SVGS.museum}
            </div>

            <div class="flex-1">
                <h3 class="font-teko text-3xl text-white uppercase italic leading-none">Musée National</h3>
                <p class="text-[10px] text-orange-200 font-bold uppercase tracking-widest mb-1">Palmarès : ${myName}</p>
                <div class="text-[9px] text-slate-400 leading-tight pr-4">
                    La nation a régné sur l'Afrique à <span class="text-white font-bold">${totalWins} reprises</span>.
                </div>
            </div>

            <div class="text-right shrink-0">
                <div class="font-teko text-7xl text-white drop-shadow-[0_0_15px_rgba(249,115,22,0.6)] leading-none">${totalWins}</div>
                <div class="text-[8px] text-orange-500 font-bold uppercase tracking-widest text-center mt-[-5px]">Titres</div>
            </div>
        </div>

        <div class="mt-5 pt-4 border-t border-white/10 flex flex-wrap gap-2 relative z-10">
            ${allYears.length > 0 ? allYears.map(y => `
                <span class="px-3 py-1 bg-slate-950 border border-orange-500/30 rounded-lg text-[10px] font-bold text-orange-400 shadow-sm flex items-center gap-1">
                    ${SVGS.star} ${y}
                </span>
            `).join('') : '<span class="text-[9px] text-slate-500 italic">En quête du premier sacre...</span>'}
        </div>
    </div>
`;

// ... La suite de la fonction (Infras et Staff) reste inchangée ...
// (Je ne la remets pas pour économiser de la place, gardez votre code existant pour le staff)

// --- SECTION 1 : INFRASTRUCTURES (BÂTIMENTS) ---
list.innerHTML += `<div class="mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Bâtiments</span><div class="h-px bg-slate-700 flex-1"></div></div>`;

const infras = [
    { id: 'stadium', name: 'Stade National', desc: 'Bonus revenus match (+0.5M/niv.)', icon: SVGS.infraStadium },
    { id: 'training', name: 'Centre Pro', desc: 'Améliore le gain OVR Boost (+1/niv.)', icon: SVGS.infraTraining },
    { id: 'medical', name: 'Clinique Sportive', desc: 'Réduit la fatigue après match (-1.5/niv.)', icon: SVGS.infraMedical }
];

infras.forEach(inf => {
    const data = this.state.infra[inf.id];
    list.innerHTML += this.createUpgradeCard(inf.id, inf.name, data, inf.desc, inf.icon, 'infra');
});

// --- SECTION 2 : STAFF TECHNIQUE (SALAIRES) ---
list.innerHTML += `<div class="mt-8 mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Staff & Salaires</span><div class="h-px bg-slate-700 flex-1"></div></div>`;

const staffs = [
    { id: 'director', icon: SVGS.briefcase },
    { id: 'assistant', icon: SVGS.whistle },
    { id: 'fitness', icon: SVGS.heartpulse }
];

staffs.forEach(st => {
    const data = this.state.staff[st.id];
    const upgradeCost = data.level * 2.5;
    list.innerHTML += `
        <div class="infra-card group relative overflow-hidden transition-all duration-300 hover:bg-slate-800/80 border-l-4 border-l-orange-500">
            <div class="flex justify-between items-start z-10 relative">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-orange-500 shadow-xl">
                        ${st.icon}
                    </div>
                    <div>
                        <div class="text-white font-bold uppercase text-xs tracking-wider font-teko text-xl leading-none">${data.name}</div>
                        <div class="text-[9px] text-orange-500 uppercase font-bold mt-1">Niveau ${data.level} / 5</div>
                    </div>
                </div>
                <div class="flex flex-col items-end">
                    <div class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Salaire / An</div>
                    <div class="text-white font-teko text-xl font-bold bg-slate-900 px-3 py-0.5 rounded-lg border border-red-500/30 text-red-400">
                        -${data.salary.toFixed(1)} M€
                    </div>
                </div>
            </div>

            <p class="text-[9px] text-slate-400 leading-tight my-4 italic pl-1 border-l-2 border-slate-700">
                ${data.desc}
            </p>

            <button onclick="app.upgradeStaff('${st.id}')"
                class="w-full py-3 bg-slate-900 border border-slate-700 hover:bg-orange-600 hover:border-orange-500 hover:text-white rounded-xl text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2 ${data.level >= 5 ? 'opacity-40 pointer-events-none grayscale' : ''}">
                ${data.level >= 5 ? 'Niveau Max' : `Promouvoir (Coût: ${upgradeCost.toFixed(1)} M€)`}
            </button>
        </div>
    `;
});
}

        // Helper pour éviter la duplication de code pour les infras
        createUpgradeCard(id, name, data, desc, icon, type) {
            return `
                <div class="infra-card group relative overflow-hidden transition-all duration-300 hover:bg-slate-800/80">
                    <div class="flex justify-between items-start z-10 relative">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-orange-500 shadow-xl group-hover:scale-110 transition-all duration-300">
                                ${icon}
                            </div>
                            <div>
                                <div class="text-white font-bold uppercase text-xs tracking-wider font-teko text-xl leading-none">${name}</div>
                                <div class="text-[9px] text-slate-500 uppercase font-bold mt-1">Niveau ${data.level} / 5</div>
                            </div>
                        </div>
                        <div class="text-white font-teko text-xl font-bold bg-slate-900 px-3 py-1 rounded-lg border border-slate-700 shadow-inner text-orange-500">
                            ${data.cost.toFixed(1)} M€
                        </div>
                    </div>
                    <div class="mt-4 mb-2 h-1.5 w-full bg-slate-950 rounded-full overflow-hidden border border-slate-800/50">
                        <div class="h-full bg-gradient-to-r from-orange-700 to-orange-500" style="width: ${(data.level/5)*100}%"></div>
                    </div>
                    <p class="text-[9px] text-slate-400 leading-tight mb-4 italic pl-1 border-l-2 border-slate-700">${desc}</p>
                    <button onclick="app.upgradeInfra('${id}')" class="w-full py-3 bg-slate-900 border border-slate-700 hover:bg-orange-600 hover:border-orange-500 hover:text-white rounded-xl text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95 ${data.level >= 5 ? 'opacity-40 pointer-events-none grayscale' : ''}">
                        ${data.level >= 5 ? 'Max' : 'Améliorer'}
                    </button>
                </div>`;
        }

        upgradeInfra(id) {
            const infra = this.state.infra[id];
            if (this.state.budget < infra.cost) return this.toast("Budget insuffisant !");
            if (infra.level >= 5) return this.toast("Niveau maximum atteint.");

            this.state.budget -= infra.cost;
            infra.level++;
            infra.cost *= 1.8;

            this.save(); // Sauvegarde immédiate
            this.renderInfra();
            this.updateUI(); // Met à jour le HUD
            this.toast(`${id.toUpperCase()} amélioré au niveau ${infra.level} !`);
        }

        upgradeStaff(id) {
            const s = this.state.staff[id];
            const cost = s.level * 2.5; // Le coût de promotion augmente

            if (this.state.budget < cost) return this.toast("Budget insuffisant pour la promotion !");
            if (s.level >= 5) return this.toast("Niveau maximum atteint.");

            this.state.budget -= cost;
            s.level++;
            s.salary += 1.5; // Le salaire augmente de 1.5M par niveau ! C'est le piège :)

            this.save();
            this.renderInfra();
            this.updateUI();
            this.toast(`${s.name} promu ! Salaire augmenté.`);
        }


   renderCalendar() {
            const c = document.getElementById('calendar-content');
            if(!c) return;

            let html = `
<div class="mb-8 relative z-10 bg-carbon-foot -mx-5 -mt-5 px-6 py-8 rounded-b-3xl shadow-2xl border-b border-white/5">
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-orange-500/10 rounded-full blur-3xl pointer-events-none"></div>

    <h2 class="font-teko text-5xl md:text-6xl text-white uppercase italic leading-none mb-2 drop-shadow-md">Compétition</h2>

    <div class="flex items-center justify-between border-b border-white/5 pb-2">
        <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold truncate pr-2">Coupe d'Afrique des Nations</p>
        <div class="shrink-0 px-3 py-1 rounded-full bg-orange-600/20 border border-orange-500/30 text-orange-400 text-[9px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(249,115,22,0.2)]">
            ${this.state.stage === 'groups' ? 'Poules' : this.state.stage.toUpperCase().replace('IEMES', 'èmes')}
        </div>
    </div>
</div>
            `;

            // --- CAS 1 : PHASE DE POULES (DESIGN MODERNISÉ) ---
            if (this.state.stage === 'groups') {
                // Onglets des groupes (Pills scrollables)
                html += `<div class="mb-4 overflow-x-auto no-scrollbar pb-2"><div id="group-tabs" class="flex gap-2 pl-1"></div></div>`;

                // Tableau de Classement (Glassmorphism)
                html += `
                    <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 shadow-2xl relative mb-8">
                        <div class="grid grid-cols-12 gap-2 p-3 bg-slate-900/80 border-b border-white/5 text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                            <div class="col-span-1 text-center">#</div>
                            <div class="col-span-6">Nation</div>
                            <div class="col-span-2 text-center">J</div>
                            <div class="col-span-1 text-center">Df</div>
                            <div class="col-span-2 text-center text-orange-500">Pts</div>
                        </div>
                        <div id="cal-body" class="divide-y divide-white/5"></div>
                    </div>
                `;
            }
            // --- CAS 2 : PHASES FINALES (CARTE DUEL) ---
            else {
                const stageConfigs = {
                    '8iemes': { label: 'Huitièmes', sub: 'Le chemin vers la gloire' },
                    'quarts': { label: 'Quarts', sub: 'Le top 8 africain' },
                    'demis': { label: 'Demi-Finale', sub: 'La porte de la finale' },
                    'finale': { label: 'FINALE', sub: 'L\'Histoire s\'écrit ici' }
                };

                const config = stageConfigs[this.state.stage] || { label: 'Phase Finale', sub: 'Match décisif' };
                const oppData = this.state.knockout[this.state.stage];
                const oppName = oppData ? oppData.n : "Adversaire";
                const oppCode = oppData ? oppData.code : "ADV";

                // Carte du Match Principal
                html += `
                    <div class="relative w-full rounded-3xl overflow-hidden border border-white/10 shadow-2xl mb-8 group">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-black"></div>

                        <div class="relative z-10 p-6 flex flex-col items-center">
                            <div class="text-[10px] text-orange-500 font-bold uppercase tracking-[0.2em] mb-4 border border-orange-500/30 px-3 py-1 rounded-full bg-orange-500/10">
                                ${config.label}
                            </div>

                            <div class="flex items-center justify-between w-full mb-6">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-3xl sm:text-4xl border-4 border-slate-800 shadow-[0_0_20px_rgba(249,115,22,0.4)] italic">
                                        CIV
                                    </div>
                                    <span class="text-[9px] font-bold text-white uppercase tracking-widest">CIV</span>
                                </div>

                                <div class="flex flex-col items-center">
                                    <span class="font-teko text-5xl sm:text-7xl text-white italic opacity-10 absolute select-none scale-150">VS</span>
                                    <span class="font-teko text-4xl sm:text-5xl text-white italic relative z-10 drop-shadow-lg">VS</span>
                                </div>

                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-16 h-16 sm:w-20 sm:h-20 bg-slate-800 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-3xl sm:text-4xl border-4 border-slate-700 shadow-xl italic">
                                        ${oppCode}
                                    </div>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${oppCode}</span>
                                </div>
                            </div>

                            <div class="w-full bg-slate-950/50 rounded-xl p-3 text-center border border-white/5">
                                <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Lieu du match</p>
                                <p class="text-xs text-white font-bold uppercase truncate px-2">${this.state.hostStadium || 'Stade National'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-3 px-1">
                            <span class="text-slate-500">${SVGS.layout}</span>
                            <h3 class="font-teko text-2xl text-slate-200 uppercase tracking-wide">Résultats</h3>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                `;

                // Générateur de matchs fictifs stylisés
                const otherTeams = NATIONS_DB.filter(n => n.n !== "Côte d'Ivoire" && n.n !== oppName);
                const matchCount = this.state.stage === '8iemes' ? 7 : (this.state.stage === 'quarts' ? 3 : (this.state.stage === 'demis' ? 1 : 0));

                for(let i = 0; i < matchCount; i++) {
                    if(otherTeams.length >= 2) {
                        const t1 = otherTeams.splice(Math.floor(Math.random() * otherTeams.length), 1)[0];
                        const t2 = otherTeams.splice(Math.floor(Math.random() * otherTeams.length), 1)[0];
                        html += `
                            <div class="flex justify-between items-center bg-slate-800/40 p-3 rounded-xl border border-white/5 hover:bg-slate-800 transition group">
                                <div class="flex items-center gap-3 w-5/12 justify-end">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase text-right truncate group-hover:text-white transition">${t1.code}</span>
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-600"></div>
                                </div>
                                <div class="w-2/12 text-center font-teko text-lg text-slate-600">VS</div>
                                <div class="flex items-center gap-3 w-5/12">
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-600"></div>
                                    <span class="text-[9px] font-bold text-slate-400 uppercase truncate group-hover:text-white transition">${t2.code}</span>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `</div></div>`;
            }

            // DANS renderCalendar()

// 1. Préparez les données
const topScorers = (this.state.goalScorers || []).sort((a,b) => b.c - a.c).slice(0, 5);
const topAssisters = (this.state.assisters || []).sort((a,b) => b.c - a.c).slice(0, 5); // <--- NOUVEAU
const topPlayers = (this.state.playerRatings || []).filter(p => p.matchs >= 1).map(p => ({ ...p, avg: p.total / p.matchs })).sort((a,b) => b.avg - a.avg).slice(0, 5);

// 2. Générez le HTML
html += `
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">

        <div class="glass-panel p-4 rounded-2xl border border-white/5">
            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                <div class="p-1.5 bg-yellow-500/20 rounded-lg text-yellow-500">${SVGS.boot}</div>
                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Buteurs</h3>
            </div>
            <div class="space-y-2">
                ${topScorers.length === 0 ? '<div class="text-xs text-slate-500 italic text-center py-2">Aucune donnée</div>' : ''}
                ${topScorers.map((p, i) => `
                    <div class="flex items-center justify-between p-2 rounded-lg ${i===0 ? 'bg-gradient-to-r from-yellow-900/20 to-transparent border border-yellow-500/20' : 'bg-slate-800/30'}">
                        <div class="flex items-center gap-3">
                            <span class="font-teko text-xl w-6 text-center ${i===0?'text-yellow-400':'text-slate-600'}">#${i+1}</span>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-white uppercase leading-none truncate max-w-[80px]">${p.n}</span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase">${p.t}</span>
                            </div>
                        </div>
                        <span class="font-teko text-xl font-bold ${i===0?'text-yellow-400':'text-slate-400'}">${p.c}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="glass-panel p-4 rounded-2xl border border-white/5">
            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                <div class="p-1.5 bg-green-500/20 rounded-lg text-green-400">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                </div>
                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Passeurs</h3>
            </div>
            <div class="space-y-2">
                ${topAssisters.length === 0 ? '<div class="text-xs text-slate-500 italic text-center py-2">Aucune donnée</div>' : ''}
                ${topAssisters.map((p, i) => `
                    <div class="flex items-center justify-between p-2 rounded-lg ${i===0 ? 'bg-gradient-to-r from-green-900/20 to-transparent border border-green-500/20' : 'bg-slate-800/30'}">
                        <div class="flex items-center gap-3">
                            <span class="font-teko text-xl w-6 text-center ${i===0?'text-green-400':'text-slate-600'}">#${i+1}</span>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-white uppercase leading-none truncate max-w-[80px]">${p.n}</span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase">${p.t}</span>
                            </div>
                        </div>
                        <span class="font-teko text-xl font-bold ${i===0?'text-green-400':'text-slate-400'}">${p.c}</span>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="glass-panel p-4 rounded-2xl border border-white/5">
            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                <div class="p-1.5 bg-blue-500/20 rounded-lg text-blue-400">${SVGS.star}</div>
                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">MVP</h3>
            </div>
            <div class="space-y-2">
                ${topPlayers.length === 0 ? '<div class="text-xs text-slate-500 italic text-center py-2">Aucune donnée</div>' : ''}
                ${topPlayers.map((p, i) => `
                    <div class="flex items-center justify-between p-2 rounded-lg ${i===0 ? 'bg-gradient-to-r from-blue-900/20 to-transparent border border-blue-500/20' : 'bg-slate-800/30'}">
                        <div class="flex items-center gap-3">
                            <span class="font-teko text-xl w-6 text-center ${i===0?'text-blue-400':'text-slate-600'}">#${i+1}</span>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-white uppercase leading-none truncate max-w-[80px]">${p.n}</span>
                                <span class="text-[8px] font-bold text-slate-500 uppercase">${p.t}</span>
                            </div>
                        </div>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${i===0?'bg-blue-500 text-white':'bg-slate-700 text-slate-400'}">${p.avg.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    </div>
`;

            // --- PALMARES (Unique et Corrigé) ---
            const history = this.state.pastWinners || [];
            if(history.length > 0) {
                html += `
                    <div class="mb-20">
                        <h3 class="font-teko text-3xl text-white uppercase italic mb-4 px-1">Hall of Fame</h3>
                        <div class="space-y-2">
                            ${history.slice().reverse().map(h => `
                                <div class="flex items-center justify-between p-3 rounded-xl border ${h.n === this.state.userTeamName ? 'bg-orange-900/20 border-orange-500/40' : 'bg-slate-900 border-slate-800'}">
                                    <div class="flex items-center gap-3">
                                        <span class="text-orange-500">${SVGS.cup}</span>
                                        <span class="text-[10px] font-bold uppercase ${h.n === this.state.userTeamName ? 'text-white' : 'text-slate-400'}">
                                            ${h.n}
                                        </span>
                                    </div>
                                    <span class="font-teko text-xl text-white">${h.year}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                html += `<div class="mb-20"></div>`;
            }

            c.innerHTML = html;

            // --- INTERACTIVITÉ DES ONGLETS (POULES) ---
            if (this.state.stage === 'groups') {
                const tabsContainer = document.getElementById('group-tabs');
                const tbody = document.getElementById('cal-body');

                if (tabsContainer && tbody) {
                    // Génération des boutons
                    Object.keys(this.state.groups).forEach(g => {
                        const isActive = this.state.viewingGroup === g;
                        tabsContainer.innerHTML += `
                            <button onclick="app.setVG('${g}')"
                                class="px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition shrink-0 border ${isActive ? 'bg-orange-600 border-orange-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}">
                                Groupe ${g}
                            </button>
                        `;
                    });

                    // Génération des lignes du tableau
                    const currentGroupTeams = Object.keys(this.state.standings)
                        .filter(k => this.state.standings[k].grp === this.state.viewingGroup)
                        .sort((a,b) => {
                            const tA = this.state.standings[a];
                            const tB = this.state.standings[b];
                            return (tB.pts - tA.pts) || ((tB.gf - tB.ga) - (tA.gf - tA.ga)) || (tB.gf - tA.gf);
                        });

                    currentGroupTeams.forEach((teamName, index) => {
                        const t = this.state.standings[teamName];
                        const diff = t.gf - t.ga;
                        const isQualified = index < 2; // Les 2 premiers

                        // Style ligne
                        const rowClass = isQualified ? "bg-gradient-to-r from-green-900/10 to-transparent" : "";
                        const rankColor = isQualified ? "text-green-400" : "text-slate-600";

                        tbody.innerHTML += `
                            <div class="grid grid-cols-12 gap-2 p-3 items-center hover:bg-white/5 transition ${rowClass}">
                                <div class="col-span-1 flex justify-center">
                                    <span class="font-teko text-lg ${rankColor} w-5 text-center">${index+1}</span>
                                </div>
                                <div class="col-span-6 flex flex-col justify-center">
                                    <span class="text-[10px] font-bold text-white uppercase truncate">${t.n}</span>
                                    <span class="text-[8px] font-bold text-slate-500">${t.code}</span>
                                </div>
                                <div class="col-span-2 text-center text-[10px] font-mono text-slate-400">${t.p}</div>
                                <div class="col-span-1 text-center text-[10px] font-bold ${diff>0?'text-green-400':(diff<0?'text-red-400':'text-slate-500')}">${diff>0?'+':''}${diff}</div>
                                <div class="col-span-2 text-center">
                                    <span class="font-teko text-xl font-bold text-white">${t.pts}</span>
                                </div>
                            </div>
                        `;
                    });
                }
            }
        }
        setVG(g) { this.state.viewingGroup = g; this.renderCalendar(); }

        renderTraining() {
            const c = document.getElementById('training-content'); if(!c) return;

            // En-tête
            let html = `
                <div class="mb-6">
                    <h3 class="font-teko text-4xl text-white uppercase italic leading-none mb-1">Centre d'Entraînement</h3>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Développez le potentiel de vos éléphants.</p>
                </div>
                <div class="space-y-3 pb-20">
            `;

            // Tri : Titulaires d'abord, puis par Note OVR
            const sortedPlayers = this.state.players.sort((a,b) => (a.role === 'starter' ? -1 : 1) || b.ovr - a.ovr);

            sortedPlayers.forEach(p => {
                // Calculs
                const isMaxed = p.ovr >= p.pot;
                const minBase = Math.max(0, p.pot - 15);
                const currentPct = Math.max(0, Math.min(100, ((p.ovr - minBase) / (p.pot - minBase)) * 100));

                // Couleurs
                let barGradient, barShadow, potTextColor, potBorder;
                if (isMaxed) {
                    barGradient = "bg-gradient-to-r from-yellow-600 to-yellow-400";
                    barShadow = "shadow-[0_0_10px_rgba(250,204,21,0.4)]";
                    potTextColor = "text-yellow-400";
                    potBorder = "border-yellow-500/30 bg-yellow-500/10";
                } else {
                    barGradient = "bg-gradient-to-r from-orange-700 to-orange-500";
                    barShadow = "shadow-[0_0_5px_rgba(249,115,22,0.3)]";
                    potTextColor = "text-slate-400";
                    potBorder = "border-slate-700 bg-slate-950/50";
                }

                const btnClass = isMaxed
                    ? `bg-slate-900 border border-slate-700 text-slate-600 cursor-not-allowed opacity-50`
                    : `bg-orange-600 hover:bg-orange-500 border border-orange-500 text-white shadow-lg active:scale-95 hover:shadow-orange-500/20`;

                const btnContent = isMaxed
                    ? `<span class="font-teko uppercase text-sm">Max</span>`
                    : `<span id="icon-zap-mini"></span> <span class="font-bold tracking-wider">BOOSTER</span>`;

                html += `
                    <div class="glass-panel p-3 rounded-xl flex items-center justify-between border border-white/5 hover:bg-slate-800 transition group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-slate-900 via-transparent to-transparent opacity-50 pointer-events-none"></div>

                        <div class="flex items-center gap-4 flex-1 relative z-10 min-w-0">

                            <div class="relative w-12 h-12 shrink-0">
                                <div class="absolute inset-0 rounded-xl bg-slate-900 border border-slate-700 flex items-center justify-center shadow-lg">
                                    <span class="font-teko text-3xl ${isMaxed ? 'text-yellow-400' : 'text-white'} font-bold leading-none mt-1">${p.ovr}</span>
                                </div>
                                ${isMaxed ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border-2 border-slate-900 z-20 shadow-[0_0_8px_rgba(250,204,21,0.8)]"></div>' : ''}
                            </div>

                            <div class="flex-1 min-w-0 pr-2">
                                <div class="flex justify-between items-end mb-1 gap-2">
                                    <div class="flex flex-col min-w-0">
                                        <span class="font-bold text-white uppercase text-xs truncate leading-none">${p.name}</span>
                                        <span class="text-[8px] text-slate-500 font-bold uppercase mt-0.5 truncate">${p.pos} • ${p.age} ans</span>
                                    </div>

                                    <div class="px-1.5 py-0.5 rounded ${potBorder} border flex items-center gap-1 shrink-0">
                                        <span class="text-[7px] text-slate-500 font-bold uppercase">Pot</span>
                                        <span class="font-teko text-sm ${potTextColor} leading-none pt-0.5">${p.pot}</span>
                                    </div>
                                </div>

                                <div class="w-full h-1.5 bg-slate-950 rounded-full overflow-hidden border border-white/5 relative">
                                    <div class="absolute inset-0 bg-slate-900"></div>
                                    <div class="h-full ${barGradient} ${barShadow} transition-all duration-700 relative" style="width: ${currentPct}%">
                                        <div class="absolute top-0 right-0 bottom-0 w-[1px] bg-white/50 blur-[1px]"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onclick="app.boost('${p.id}')" class="px-3 py-2 ml-2 rounded-lg text-[9px] uppercase transition flex items-center gap-1 shrink-0 ${btnClass}" ${isMaxed ? 'disabled' : ''}>
                            ${btnContent}
                        </button>
                    </div>`;
            });

            html += `</div>`;
            c.innerHTML = html;
        }
        boost(id) {
            if(this.state.budget < 0.2) return this.toast("Manque de budget !");

            const p = this.state.players.find(x => x.id === id);
            if(!p) return;

            // NOUVELLE VÉRIFICATION DU POTENTIEL
            if (p.ovr >= p.pot) return this.toast(`Potentiel maximum (${p.pot}) atteint pour ${p.name}.`);
            if (p.ovr >= 99) return this.toast("Niveau absolu atteint !");

            this.state.budget -= 0.2;

            const gain = 1 + this.state.infra.training.level;

            // On s'assure de ne pas dépasser le potentiel avec le boost
            const newOvr = Math.min(p.pot, Math.min(99, p.ovr + gain));
            const realGain = newOvr - p.ovr;

            p.ovr = newOvr;

            // Mise à jour des stats détaillées en conséquence
            if(p.stats) {
                Object.keys(p.stats).forEach(k => {
                    if(p.stats[k] < 99) p.stats[k] += realGain;
                });
            }

            this.renderTraining();
            this.save();
            this.updateUI();
            this.toast(`${p.name} progresse (+${realGain}) !`);
        }

      renderScout() {
const c = document.getElementById('scout-content'); if(!c) return;

c.innerHTML = `
    <div class="space-y-4 mb-8">
        <div class="glass-panel p-5 rounded-3xl text-center bg-green-900/10 shadow-2xl border border-white/5 relative overflow-hidden group hover:border-green-500/30 transition-all">
            <div class="absolute top-0 right-0 p-4 opacity-5 grayscale group-hover:opacity-10 transition">${SVGS.globe}</div>

            <h3 class="text-2xl font-bold uppercase mb-1 font-teko text-green-500">Championnat Local</h3>

            <p class="text-[9px] text-slate-400 mb-4 font-bold uppercase tracking-widest">Dénicher les pépites du pays.</p>
            <button onclick="app.scoutPlayers('standard')" class="w-full py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold uppercase shadow-lg transition active:scale-95 text-[11px] tracking-wide flex items-center justify-center gap-2">
                Financer Détection (3.0 M€)
            </button>
        </div>

        <div class="glass-panel p-5 rounded-3xl text-center bg-blue-900/10 shadow-2xl border border-white/5 relative overflow-hidden group hover:border-blue-500/30 transition-all">
            <div class="absolute top-0 right-0 p-4 opacity-5 grayscale group-hover:opacity-10 transition">${SVGS.plane || SVGS.globe}</div>
            <h3 class="text-2xl font-bold uppercase mb-1 font-teko text-blue-400">Diaspora & Monde</h3>
            <p class="text-[9px] text-slate-400 mb-4 font-bold uppercase tracking-widest">Convaincre les binationaux.</p>
            <button onclick="app.scoutPlayers('elite')" id="btn-scout-elite" class="w-full py-4 ${this.state.rareScoutUsed ? 'bg-slate-800 text-slate-600 cursor-not-allowed border border-slate-700' : 'bg-orange-600 hover:bg-orange-500 text-white'} rounded-xl font-bold uppercase shadow-lg transition active:scale-95 text-[11px] tracking-wide flex items-center justify-center gap-2" ${this.state.rareScoutUsed ? 'disabled' : ''}>
                ${this.state.rareScoutUsed ? 'MISSION DÉJÀ EFFECTUÉE' : 'LANCER LA MISSION (10.0 M€)'}
            </button>
        </div>
    </div>

    <div class="flex items-center gap-2 mb-3 px-1 border-b border-white/5 pb-2">
         <span class="text-orange-500">${SVGS.search}</span>
         <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Joueurs Supervisés</h3>
    </div>

    <div id="scout-list" class="space-y-2 pb-20"></div>
`;

const l = document.getElementById('scout-list');

if (this.state.scoutPool.length === 0) {
    l.innerHTML = `<div class="text-center text-slate-600 italic text-xs py-10">Aucun rapport de scout disponible.<br>Lancez une mission ci-dessus.</div>`;
}

// ... (Le début de la fonction renderScout reste identique jusqu'à l.innerHTML = ...)

        this.state.scoutPool.forEach(p => {
            const origin = p.ovr >= 79 ? "International" : "Local";
            const badgeColor = p.ovr >= 79 ? "text-blue-400 border-blue-500/30 bg-blue-500/10" : "text-green-400 border-green-500/30 bg-green-500/10";

            l.innerHTML += `
                <div class="glass-panel p-3 rounded-xl flex items-center justify-between border border-white/5 hover:bg-slate-800 transition group animate-slideIn">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700 shrink-0">
                            <span class="font-teko text-xl text-white font-bold">${p.ovr}</span>
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-white uppercase text-xs mb-0.5 truncate pr-2">${p.name}</div>
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${badgeColor} border">${p.pos}</span>
                                <span class="text-[9px] text-slate-500 uppercase truncate">${p.age} ans • ${origin}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 shrink-0">
                        <button onclick="app.recruit('${p.id}')" class="px-3 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-[9px] font-bold uppercase shadow-md active:scale-95 transition tracking-widest flex items-center gap-1">
                            <span class="hidden sm:inline transition-all">+</span> Recruter
                        </button>

                        <button onclick="app.dismissScoutTarget('${p.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-900 border border-red-500/30 text-red-500 hover:bg-red-900/20 hover:border-red-500 transition shadow-sm active:scale-90">
                            ✕
                        </button>
                    </div>
                </div>`;
        });
    }
       scoutPlayers(type) {
// 1. Calcul du coût
let baseCost = type === 'elite' ? 10.0 : 3.0;
const directorLevel = this.state.staff ? this.state.staff.director.level : 1;
const discount = (directorLevel - 1) * 0.10;
const finalCost = baseCost * (1 - discount);

if (this.state.budget < finalCost) return this.toast(`Frais de mission insuffisants (${finalCost.toFixed(1)}M€ requis) !`);

this.state.budget -= finalCost;

// 2. RECUPERATION DU NOM DE VOTRE ÉQUIPE (Pour le scout local)
const myTeamName = this.state.userTeamName || "Côte d'Ivoire";

if (type === 'elite') {
    // --- MISSION ÉLITE (INTERNATIONAL) ---
    this.state.rareScoutUsed = true;

    // On pioche une nation AU HASARD dans la base de données
    const randomNation = NATIONS_DB[Math.floor(Math.random() * NATIONS_DB.length)];

    const pos = ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)];
    const ovr = 79 + Math.floor(Math.random()*8);
    const age = 18 + Math.floor(Math.random()*4);
    const elitePot = Math.min(99, ovr + Math.floor(Math.random() * 10) + 5);

    const genData = this.generatePlayerStats(pos, ovr);

    this.state.scoutPool.push({
        id: crypto.randomUUID(),
        // C'est ici la correction : on génère un nom cohérent avec la nation piochée
        name: this.generateRealName(randomNation.n),
        pos: pos, age: age, ovr: ovr,
        stats: genData.stats,
        style: genData.roleName,
        pot: elitePot,
        role: 'sub', energy: 100
    });

} else {
    // --- MISSION STANDARD (LOCAL) ---
    for(let i=0; i<5; i++) {
        const pos = ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)];
        const ovr = 60 + Math.floor(Math.random()*19);
        const age = 17 + Math.floor(Math.random()*8);

        const genData = this.generatePlayerStats(pos, ovr);

        this.state.scoutPool.push({
            id: crypto.randomUUID(),
            // CORRECTION MAJEURE : On force le nom de VOTRE nation
            name: this.generateRealName(myTeamName),
            pos: pos, age: age, ovr: ovr,
            stats: genData.stats,
            style: genData.roleName,
            pot: this.generatePotential(age, ovr),
            role: 'sub', energy: 100
        });
    }
}

this.save();
this.renderScout();
this.updateUI();
this.toast(`Mission terminée (-${finalCost.toFixed(1)} M€)`);
}

        recruit(id) {
            // --- MODIFICATION : BLOQUER SI LE BANC EST PLEIN (20 MAX) ---
            const benchCount = this.state.players.filter(p => p.role !== 'starter').length;

            if (benchCount >= 20) {
                this.playSound('whistle'); // Petit son d'erreur
                return this.toast("Effectif complet ! (Max 20 remplaçants)");
            }
            // ------------------------------------------------------------

            const idx = this.state.scoutPool.findIndex(x => x.id === id);
            if (idx > -1) {
                const p = this.state.scoutPool[idx];

                // On retire le joueur de la liste des scouts
                this.state.scoutPool.splice(idx, 1)[0];

                // On l'ajoute à l'équipe nationale
                this.state.players.push(p);

                this.renderScout();
                this.save();
                this.playSound('click');

                // Flash Info Roleplay
                this.state.news.unshift({
                    id: Date.now(),
                    text: `SÉLECTION : ${p.name} (${p.ovr}) a accepté de rejoindre la selection !`
                });

                this.toast(`${p.name} a rejoint la sélection !`);
            }
        }
        // Fonction pour supprimer un joueur de la liste scout sans le recruter
    dismissScoutTarget(id) {
        const idx = this.state.scoutPool.findIndex(x => x.id === id);

        if (idx > -1) {
            // On le retire simplement de la liste
            this.state.scoutPool.splice(idx, 1)[0];

            this.playSound('click'); // Petit son de validation
            this.renderScout();      // Mise à jour visuelle immédiate
            this.save();             // Sauvegarde

            // Petit feedback discret
            this.toast("Dossier joueur archivé.");
        }
    }

        toggleLiveCoaching() {
this.isLiveCoaching = !this.isLiveCoaching;
const overlay = document.getElementById('live-coach-overlay');
if(overlay) overlay.classList.toggle('active', this.isLiveCoaching);

if(this.isLiveCoaching) {
    this.setLiveFormation(this.state.formation);
    this.renderPitch('pitch-cards-layer-live');

    const c = document.getElementById('live-tactics-container');
    if(c) {
        // AJOUTER CETTE LIGNE : On force l'affichage en grille de 2 colonnes
        c.className = "grid grid-cols-2 gap-3";
        c.innerHTML = this.renderTacticalButtons('live');
    }
}
}
        toggleTacticsPanel() {
const wrapper = document.getElementById('live-controls-wrapper');
const btn = document.getElementById('btn-toggle-tactics');

if (wrapper.classList.contains('hidden')) {
    wrapper.classList.remove('hidden');
    if(btn) {
        btn.innerHTML = "▲ Masquer les options ▲";
        btn.classList.add('bg-orange-600', 'border-orange-500');
        btn.classList.remove('bg-slate-800', 'border-slate-600');
    }
} else {
    wrapper.classList.add('hidden');
    if(btn) {
        btn.innerHTML = "▼ Modifier la Tactique ▼";
        btn.classList.remove('bg-orange-600', 'border-orange-500');
        btn.classList.add('bg-slate-800', 'border-slate-600');
    }
}
}
togglePrematchTactics() {
const wrapper = document.getElementById('prematch-controls-wrapper');
const btn = document.getElementById('btn-toggle-prematch');

if (wrapper.classList.contains('hidden')) {
    wrapper.classList.remove('hidden');
    if(btn) {
        btn.innerHTML = "▲ Masquer les options ▲";
        btn.classList.add('bg-orange-600', 'border-orange-500');
        btn.classList.remove('bg-slate-800', 'border-slate-600');
    }
} else {
    wrapper.classList.add('hidden');
    if(btn) {
        btn.innerHTML = "▼ Tactique & Formation ▼";
        btn.classList.remove('bg-orange-600', 'border-orange-500');
        btn.classList.add('bg-slate-800', 'border-slate-600');
    }
}
}
   openSwapModal(idx) {
    this.currentSwapSlot = idx;
    const form = FORMATIONS[this.state.formation];
    const targetPos = form.zones[idx];

    const titlePos = document.getElementById('swap-target-pos');
    if(titlePos) titlePos.innerText = `Remplacer : ${targetPos}`;

    const list = document.getElementById('swap-candidates-list');
    if(!list) return;

    // GRILLE : 2 colonnes pour bien voir les cartes
    list.className = "p-4 flex-1 overflow-y-auto no-scrollbar grid grid-cols-2 gap-3 content-start";
    list.innerHTML = '';

    const candidates = this.state.players.filter(p => p.role !== 'starter')
        .sort((a,b) => (b.pos === targetPos) - (a.pos === targetPos) || b.ovr - a.ovr);

    candidates.forEach(p => {
        const isGoodPos = p.pos === targetPos;

        // COULEURS DYNAMIQUES (Le coeur de votre demande)
        // Si bonne position : Bordure selon l'ÉNERGIE (Vert/Orange/Rouge)
        // Si mauvaise position : Grisé
        let borderColor = "border-slate-700";
        let textColor = "text-slate-500";
        let bgGradient = "bg-slate-900";
        let energyBarColor = "bg-slate-600";

        if (isGoodPos) {
            if (p.energy > 80) {
                borderColor = "border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.2)]";
                textColor = "text-green-400";
                energyBarColor = "bg-green-500";
                bgGradient = "bg-gradient-to-br from-green-900/20 to-slate-900";
            } else if (p.energy > 50) {
                borderColor = "border-orange-500";
                textColor = "text-orange-400";
                energyBarColor = "bg-orange-500";
                bgGradient = "bg-gradient-to-br from-orange-900/20 to-slate-900";
            } else {
                borderColor = "border-red-500";
                textColor = "text-red-400";
                energyBarColor = "bg-red-500";
                bgGradient = "bg-gradient-to-br from-red-900/20 to-slate-900";
            }
        } else {
            // Joueur hors poste : style éteint
            borderColor = "border-white/5 opacity-60";
        }

        const el = document.createElement('div');

        // On garde la forme rectangulaire horizontale "Carte Compacte"
        el.className = `relative h-[60px] rounded-lg border ${borderColor} ${bgGradient} flex items-center p-2 cursor-pointer transition active:scale-95 hover:bg-slate-800`;

        el.onclick = () => { this.confirmSwap(p.id); };

        el.innerHTML = `
            <div class="flex flex-col items-center justify-center w-10 border-r border-white/5 pr-2 mr-2">
                <span class="font-teko text-2xl ${isGoodPos ? textColor : 'text-slate-600'} font-bold leading-none">${p.ovr}</span>
                <span class="text-[8px] text-slate-500 font-bold uppercase">${p.pos}</span>
            </div>

            <div class="flex flex-col justify-center flex-1 min-w-0">
                <span class="text-[10px] font-bold ${isGoodPos ? 'text-white' : 'text-slate-500'} uppercase truncate">${p.name.split(' ').pop()}</span>

                <div class="flex items-center gap-2 mt-1">
                    <div class="w-full h-1 bg-slate-950 rounded-full overflow-hidden">
                        <div class="h-full ${energyBarColor}" style="width: ${p.energy}%"></div>
                    </div>
                    <span class="text-[8px] ${textColor} font-bold">${p.energy}%</span>
                </div>
            </div>

            ${isGoodPos ? `<div class="absolute top-1 right-1 w-1.5 h-1.5 rounded-full ${energyBarColor}"></div>` : ''}
        `;

        list.appendChild(el);
    });

    const modal = document.getElementById('swap-modal');
    if(modal) modal.classList.remove('hidden');
}

        confirmSwap(id) {
            const old = this.state.players.find(x => x.role === 'starter' && x.slot === this.currentSwapSlot);
            const nw = this.state.players.find(x => x.id === id);
            if (old) { old.role = 'sub'; old.slot = null; }
            if (nw) { nw.role = 'starter'; nw.slot = this.currentSwapSlot; }
            this.closeSwapModal();
            this.renderPitch(this.isLiveCoaching ? 'pitch-cards-layer-live' : 'pitch-cards-layer');
            this.save();
        }

        closeSwapModal() { const m = document.getElementById('swap-modal'); if(m) m.classList.add('hidden'); }

        toast(m) {
            const t = document.getElementById('feedback-toast');
            const msg = document.getElementById('toast-msg');
            if(!t || !msg) return;
            msg.innerText = m;
            t.classList.remove('hidden');
            void t.offsetWidth;
            t.classList.remove('opacity-0', 'translate-y-4');
            t.classList.add('opacity-100', 'translate-y-0');
            if(this.toastTimeout) clearTimeout(this.toastTimeout);
            this.toastTimeout = setTimeout(() => {
                t.classList.remove('opacity-100', 'translate-y-0');
                t.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => { t.classList.add('hidden'); }, 500);
            }, 2500);
        }

        autoPick() {
            this.state.players.forEach(p => { p.role = 'sub'; p.slot = null; });
            const form = FORMATIONS[this.state.formation];
            const pool = [...this.state.players];
            for(let i=0; i<form.zones.length; i++) {
                const targetPos = form.zones[i];
                pool.sort((a, b) => {
                    const scoreA = (a.ovr * 0.8) + (a.energy * 0.2);
                    const scoreB = (b.ovr * 0.8) + (b.energy * 0.2);
                    const bonusPosA = (a.pos === targetPos) ? 1000 : 0;
                    const bonusPosB = (b.pos === targetPos) ? 1000 : 0;
                    return (scoreB + bonusPosB) - (scoreA + bonusPosA);
                });
                const bestPlayer = pool.shift();
                if(bestPlayer) { bestPlayer.role = 'starter'; bestPlayer.slot = i; }
            }
            this.renderPitch('pitch-cards-layer');
            this.toast("Équipe optimisée !");
        }

        setFormation(f) { this.state.formation = f; this.autoPick(); }
       setMatchTactic(t) {
this.match.tactic = t;

// Style de base (Inactif)
const inactiveClass = "bg-slate-800 border-slate-700 text-slate-400 shadow-sm scale-100";

// Style de base (Actif)
const activeBase = "text-white shadow-lg scale-105 border";

// 1. Réinitialiser les 3 boutons
['def', 'bal', 'att'].forEach(key => {
    const btn = document.getElementById('tac-' + key);
    if (btn) {
        btn.className = `py-2 rounded-full text-[9px] font-bold uppercase transition-all active:scale-95 ${inactiveClass}`;
    }
});

// 2. Activer le bouton sélectionné avec les BONNES COULEURS
const target = document.getElementById('tac-' + t);
if(target) {
    let colorClass = "";

    // DÉFENSE : Bleu Nuit (Discret)
    if (t === 'def') colorClass = "bg-blue-900/50 border-blue-500/50 shadow-blue-500/20";

    // ÉQUILIBRE : Blanc/Gris (Neutre)
    else if (t === 'bal') colorClass = "bg-slate-600 border-white/50 shadow-white/10";

    // ATTAQUE : ORANGE (Ta Charte Graphique !)
    else if (t === 'att') colorClass = "bg-orange-600 border-orange-400 shadow-orange-500/40";

    target.className = `py-2 rounded-full text-[9px] font-bold uppercase transition-all active:scale-95 ${activeBase} ${colorClass}`;
}

this.addCommentary(COMMS_TACTICAL[t]);
this.playSound('click');
}

        // --- NOUVELLE MÉTHODE : ATTRIBUTION AUTO DES RÔLES ---
        autoAssignRoles() {
            const starters = this.state.players.filter(p => p.role === 'starter');
            if (starters.length === 0) return;

            // 1. Capitaine : Le plus âgé ou le plus fort mentalement
            const bestCap = [...starters].sort((a,b) => (b.age * 0.7 + b.ovr * 0.3) - (a.age * 0.7 + a.ovr * 0.3))[0];
            this.state.roles.captain = bestCap ? bestCap.id : null;

            // 2. Pénalty : Le meilleur Attaquant avec le plus gros OVR
            const bestPen = [...starters].sort((a,b) => b.ovr - a.ovr)[0];
            this.state.roles.penalty = bestPen ? bestPen.id : null;

            // 3. Coup Franc : Souvent un Milieu ou Attaquant technique
            const bestFK = [...starters].filter(p => p.pos !== 'GK').sort((a,b) => b.ovr - a.ovr)[0];
            this.state.roles.freekick = bestFK ? bestFK.id : null;

            // 4. Corner : Idem
            this.state.roles.corner = bestFK ? bestFK.id : null;
        }

       // Ajoutez une variable pour stocker le timer du but
// (Vous pouvez l'ajouter dans le constructor ou l'utiliser directement ici via this.goalTimer)

showGoalAnim(n) {
const sc = document.getElementById('goal-scorer-name');
const go = document.getElementById('goal-overlay');

if(!go || !sc) return;

// 1. Annuler le timer précédent s'il existe (CORRECTION DU BUG)
if (this.goalTimeout) clearTimeout(this.goalTimeout);

// 2. Mise à jour texte
sc.innerText = n;

// 3. Affichage (Reset des classes pour relancer l'animation si besoin)
go.classList.remove('hidden');
go.classList.remove('active');
void go.offsetWidth; // Force le reflow CSS pour redéclencher l'anim si besoin
go.classList.add('active');

// 4. Masquage après 3.5s
this.goalTimeout = setTimeout(() => {
    go.classList.remove('active');
    setTimeout(() => go.classList.add('hidden'), 300);
}, 3500);
}
        addCommentary(t) {
            const log = document.getElementById('commentary-log');
            if(log) {
                // Récupère le nom du manager, ou met "Coach" par défaut
                const mName = this.state.managerName || "Le Coach";
                // Remplace la balise {MANAGER} par le vrai nom en couleur
                const finalTxt = t.replace(/{MANAGER}/g, `<span class="text-orange-400 font-bold">${mName}</span>`);

                log.insertAdjacentHTML('afterbegin', `<div class="mb-2 p-3 rounded-xl bg-white/5 border border-white/5 animate-news"><span class="opacity-30 text-[9px] mr-2 font-mono italic">${this.match.time}'</span> ${finalTxt}</div>`);
            }
        }
        resetGame() {
        if (confirm("Voulez-vous recommencer cette carrière à zéro ?")) {
            // On garde le slot actuel, mais on écrase les données avec une nouvelle partie
            this.state = this.initNewGame();
            this.save(); // On sauvegarde immédiatement la nouvelle partie vide
            location.reload();
        }
    }

        setTacticalInstruction(type, val) { this.state.instructions[type] = val; this.renderTacticalUI(); }
        renderTacticalUI() {
// MODIFICATION ICI : On cible le nouvel ID
const container = document.getElementById('prematch-tactics-container');
if(container) {
    container.innerHTML = this.renderTacticalButtons('prematch');
}
}
        toggleMatchInstruction(t) {
            if(t==='style') this.state.instructions.style = this.state.instructions.style==='possession'?'counter':'possession';
            if(t==='pressing') this.state.instructions.pressing = this.state.instructions.pressing==='normal'?'high':'normal';
            this.updateMatchInstructionsUI();
        }
        updateMatchInstructionsUI() {
            // On cible le conteneur dans l'overlay "Live Coaching"
            const container = document.getElementById('live-tactics-container');
            if(container) {
                container.innerHTML = this.renderTacticalButtons('live');
            }
        }
        // --- GESTION FORMATION LIVE ---
        setLiveFormation(fmt) {
            // 1. Mise à jour de la donnée
            this.state.formation = fmt;

            // 2. Mise à jour visuelle des boutons (Active/Inactive)
            document.querySelectorAll('.live-fmt-btn').forEach(btn => {
                if (btn.dataset.fmt === fmt) {
                    btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-400');
                    btn.classList.add('bg-orange-600', 'border-orange-500', 'text-white', 'shadow-lg');
                } else {
                    btn.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-400');
                    btn.classList.remove('bg-orange-600', 'border-orange-500', 'text-white', 'shadow-lg');
                }
            });

            // 3. Re-dessiner le terrain immédiatement
            this.renderPitch('pitch-cards-layer-live');

            // 4. Ajouter un commentaire
            this.addCommentary(`${SVGS.layout} Changement tactique : L'équipe passe en <b class="text-white">${fmt}</b>.`);

            this.toast(`Dispositif changé en ${fmt}`);
        }
    // --- MOTEUR SONORE ELECTRONIQUE (A COLLER A LA FIN DE LA CLASSE) ---

playSound(type) {
    if (!this.audioCtx) return;
    if (this.audioCtx.state === 'suspended') this.audioCtx.resume();

    switch (type) {
        case 'click': this.synthClick(); break;
        case 'whistle': this.synthWhistle(); break;
        case 'goal': this.synthGoal(); break;
        case 'opp_goal': this.synthOpponentGoal(); break; // <--- AJOUTER CETTE LIGNE
        case 'stadium': this.synthAmbience(); break;
    }
}
synthClick() {
    const t = this.audioCtx.currentTime;
    const o = this.audioCtx.createOscillator();
    const g = this.audioCtx.createGain();
    o.connect(g); g.connect(this.audioCtx.destination);
    o.type = 'sine';
    o.frequency.setValueAtTime(800, t);
    o.frequency.exponentialRampToValueAtTime(300, t + 0.1);
    g.gain.setValueAtTime(0.1, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
    o.start(); o.stop(t + 0.1);
}

synthWhistle() {
    const t = this.audioCtx.currentTime;
    const o = this.audioCtx.createOscillator();
    const g = this.audioCtx.createGain();
    o.connect(g); g.connect(this.audioCtx.destination);
    o.type = 'triangle';
    o.frequency.setValueAtTime(2500, t);

    // 3 coups de sifflet rapides
    [0, 0.15, 0.3].forEach(d => {
        g.gain.setValueAtTime(0.15, t + d);
        g.gain.linearRampToValueAtTime(0, t + d + 0.1);
    });
    o.start(); o.stop(t + 0.5);
}

synthGoal() {
    const dur = 2.5;
    const buf = this.audioCtx.createBuffer(1, this.audioCtx.sampleRate * dur, this.audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;

    const noise = this.audioCtx.createBufferSource();
    noise.buffer = buf;
    const f = this.audioCtx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 500;
    const g = this.audioCtx.createGain();

    noise.connect(f); f.connect(g); g.connect(this.audioCtx.destination);

    f.frequency.linearRampToValueAtTime(1500, this.audioCtx.currentTime + 1); // Le cri monte
    g.gain.setValueAtTime(0, this.audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0.3, this.audioCtx.currentTime + 0.5);
    g.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + dur);

    noise.start();
}
  // --- À AJOUTER DANS LA SECTION AUDIO (VERS LA FIN DU SCRIPT) ---

synthOpponentGoal() {
    if (!this.audioCtx) return;

    const t = this.audioCtx.currentTime;
    const dur = 2.0;

    // 1. Bruit de foule (Grondement)
    const buf = this.audioCtx.createBuffer(1, this.audioCtx.sampleRate * dur, this.audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1);

    const noise = this.audioCtx.createBufferSource();
    noise.buffer = buf;

    // Filtre Passe-Bas (Lowpass) qui descend pour faire un effet "déception"
    const f = this.audioCtx.createBiquadFilter();
    f.type = 'lowpass';
    f.frequency.setValueAtTime(400, t); // On commence un peu haut
    f.frequency.linearRampToValueAtTime(100, t + dur); // On descend dans les graves

    const g = this.audioCtx.createGain();
    g.gain.setValueAtTime(0.4, t);
    g.gain.exponentialRampToValueAtTime(0.01, t + dur);

    noise.connect(f); f.connect(g); g.connect(this.audioCtx.destination);
    noise.start();

    // 2. Ton Grave (Dissonance)
    const o = this.audioCtx.createOscillator();
    o.type = 'sawtooth';
    o.frequency.setValueAtTime(70, t); // Fréquence très basse (70Hz)
    o.frequency.linearRampToValueAtTime(50, t + 1.5); // Descend encore

    const g2 = this.audioCtx.createGain();
    g2.gain.setValueAtTime(0.15, t);
    g2.gain.exponentialRampToValueAtTime(0.01, t + 1.0);

    o.connect(g2); g2.connect(this.audioCtx.destination);
    o.start(); o.stop(t + dur);
}
synthAmbience() {
    if (this.ambianceNode) return; // Déjà en cours
    const size = this.audioCtx.sampleRate * 2;
    const buf = this.audioCtx.createBuffer(1, size, this.audioCtx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < size; i++) data[i] = (Math.random() * 2 - 1) * 0.5;

    this.ambianceNode = this.audioCtx.createBufferSource();
    this.ambianceNode.buffer = buf;
    this.ambianceNode.loop = true;

    const f = this.audioCtx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.value = 250; // Grondement sourd
    const g = this.audioCtx.createGain();
    g.gain.value = 0.05; // Volume bas

    this.ambianceNode.connect(f); f.connect(g); g.connect(this.audioCtx.destination);
    this.ambianceNode.start();
}

stopAmbience() {
    if (this.ambianceNode) {
        try { this.ambianceNode.stop(); } catch(e){}
        this.ambianceNode = null;
    }
}

startMenuMusic() {
    return;
}

// IL MANQUAIT CETTE FONCTION !
stopMenuMusic() {
    return;
}
// 2. Amélioration de l'ambiance de match (Foule dynamique)
synthCrowdDynamic() {
    if (this.crowdNode) return;

    // Création du bruit rose (plus naturel pour une foule que le bruit blanc)
    const bufferSize = this.audioCtx.sampleRate * 10; // Boucle de 10 sec
    const buffer = this.audioCtx.createBuffer(2, bufferSize, this.audioCtx.sampleRate); // Stéréo !

    for (let channel = 0; channel < 2; channel++) {
        const data = buffer.getChannelData(channel);
        let lastOut = 0;
        for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            // Formule simple pour convertir blanc -> rose
            data[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = data[i];
            data[i] *= 3.5;
        }
    }

    this.crowdNode = this.audioCtx.createBufferSource();
    this.crowdNode.buffer = buffer;
    this.crowdNode.loop = true;

    // Filtre pour étouffer le son (comme si on était dans le stade)
    this.crowdFilter = this.audioCtx.createBiquadFilter();
    this.crowdFilter.type = 'lowpass';
    this.crowdFilter.frequency.value = 600; // Son sourd de base

    this.crowdGain = this.audioCtx.createGain();
    this.crowdGain.gain.value = 0.08; // Volume de base

    this.crowdNode.connect(this.crowdFilter);
    this.crowdFilter.connect(this.crowdGain);
    this.crowdGain.connect(this.audioCtx.destination);

    this.crowdNode.start();

    // Simulation des vagues de foule (LFO maison)
    this.crowdInterval = setInterval(() => {
        if(!this.crowdGain) return;
        // Le volume monte et descend doucement
        const time = this.audioCtx.currentTime;
        const fluctuation = Math.random() * 0.05;
        this.crowdGain.gain.setTargetAtTime(0.08 + fluctuation, time, 1.5);
        // Le filtre s'ouvre quand ça crie plus fort
        this.crowdFilter.frequency.setTargetAtTime(600 + (fluctuation * 4000), time, 1.5);
    }, 2000);
}

stopCrowd() {
    if (this.crowdNode) {
        try { this.crowdNode.stop(); } catch(e){}
        this.crowdNode = null;
    }
    if (this.crowdInterval) {
        clearInterval(this.crowdInterval);
        this.crowdInterval = null;
    }
}
startTutorial() {
        this.tutoIndex = 0;
        this.showTutorialModal();
    }
    nextTutorialStep() {
    this.tutoIndex++;
    if (this.tutoIndex < TUTORIAL_STEPS.length) {
        this.showTutorialModal();
        this.playSound('click');
    } else {
        this.closeTutorial();
    }
}

    // --- NOUVELLE LOGIQUE INTERACTIVE ---

showTutorialModal() {
// 1. Récupération des éléments
const backdrop = document.getElementById('tuto-backdrop');
const overlay = document.getElementById('tutorial-overlay');
const title = document.getElementById('tuto-title');
const text = document.getElementById('tuto-text');

// 2. NETTOYAGE ROBUSTE (Correction ici)
// On annule tout timer en cours pour éviter les bugs si on clique vite
if (this.tutoTimer) clearTimeout(this.tutoTimer);

// On enlève le highlight
document.querySelectorAll('.tuto-highlight').forEach(el => el.classList.remove('tuto-highlight'));

// On enlève TOUTES les flèches existantes (par sécurité)
document.querySelectorAll('.tuto-arrow').forEach(el => el.remove());

// 3. Vérification de fin
if (!TUTORIAL_STEPS || !TUTORIAL_STEPS[this.tutoIndex]) return this.closeTutorial();
const step = TUTORIAL_STEPS[this.tutoIndex];

// 4. Changement de vue
if(step.view) {
    document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
    this.goToView(step.view);
}

// 5. Mise à jour textes
if(title) title.innerText = step.title;
if(text) text.innerText = step.text;

// 6. MISE EN LUMIÈRE (Avec Timer stocké)
if (step.targetId) {
    // On stocke le timer dans 'this.tutoTimer'
    this.tutoTimer = setTimeout(() => {
        const target = document.getElementById(step.targetId);
        if (target) {
            target.classList.add('tuto-highlight');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const rect = target.getBoundingClientRect();
            const arrow = document.createElement('div');
            // On garde l'ID mais on utilise surtout la classe pour le nettoyage
            arrow.id = 'tuto-arrow-el';
            arrow.className = 'tuto-arrow';
            arrow.style.zIndex = "2060";

            if (rect.top > window.innerHeight / 2) {
                arrow.style.left = (rect.left + rect.width/2 - 20) + 'px';
                arrow.style.top = (rect.top - 50) + 'px';
                arrow.innerHTML = '👇';
            } else {
                arrow.style.left = (rect.left + rect.width/2 - 20) + 'px';
                arrow.style.top = (rect.bottom + 10) + 'px';
                arrow.innerHTML = '👆';
            }
            document.body.appendChild(arrow);
        }
    }, 150);
}

// 7. Affichage overlay
if(backdrop) backdrop.classList.remove('hidden');
if(overlay) {
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
}

// 8. Dots
const dots = document.getElementById('tuto-dots');
if(dots) {
    dots.innerHTML = '';
    TUTORIAL_STEPS.forEach((_, i) => {
        const dotClass = i === this.tutoIndex ? "bg-orange-500 w-4" : "bg-slate-700 w-1.5";
        dots.innerHTML += `<div class="h-1.5 rounded-full transition-all duration-300 ${dotClass}"></div>`;
    });
}
}

closeTutorial() {
// 1. ANNULATION DU TIMER (Crucial si on ferme très vite)
if (this.tutoTimer) clearTimeout(this.tutoTimer);

// 2. Nettoyage complet
document.querySelectorAll('.tuto-highlight').forEach(el => el.classList.remove('tuto-highlight'));

// Supprime TOUTES les flèches trouvées dans le document
document.querySelectorAll('.tuto-arrow').forEach(el => el.remove());

// 3. Masquage des panneaux
const backdrop = document.getElementById('tuto-backdrop');
const overlay = document.getElementById('tutorial-overlay');

if(backdrop) backdrop.classList.add('hidden');
if(overlay) overlay.classList.add('hidden');

this.toast("Briefing terminé. Bonne chance !");
this.playSound('whistle');
}
                                      // AFFICHER LA GRILLE DE SÉLECTION
renderTeamSelectionModal() {
const grid = document.getElementById('team-selection-grid');
if (!grid) return;
grid.innerHTML = '';

NATIONS_DB.forEach(nat => {
    // On vérifie que l'équipe existe dans la DB
    if (REAL_SQUADS_DB[nat.code]) {
        let color = "border-slate-700 hover:border-white";
        let iconColor = "from-slate-600 to-slate-800";

        // Couleurs par région
        if (nat.region === 'WEST_FRANCO') { color = "hover:border-orange-500"; iconColor = "from-orange-500 to-orange-700"; }
        if (nat.region === 'NORTH') { color = "hover:border-red-500"; iconColor = "from-red-600 to-red-800"; }
        if (nat.region === 'WEST_ANGLO') { color = "hover:border-green-400"; iconColor = "from-green-400 to-green-600"; }

        grid.innerHTML += `
            <button onclick="app.selectTeam('${nat.code}')" class="group relative bg-slate-900 border ${color} rounded-2xl p-4 transition-all hover:bg-slate-800 hover:scale-[1.02] shadow-xl text-left flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br ${iconColor} flex items-center justify-center font-teko text-xl text-white border-2 border-slate-800 shadow-lg shrink-0 group-hover:scale-110 transition">
                    ${nat.code}
                </div>
                <div>
                    <h3 class="font-teko text-2xl text-white group-hover:text-white transition leading-none">${nat.n}</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-slate-950 text-slate-500 uppercase">${nat.ovr} GEN</span>
                    </div>
                </div>
            </button>
        `;
    }
});
}
    }


    // --- GESTION DU DÉMARRAGE ---
// --- GESTION DU DÉMARRAGE ROBUSTE ---
// --- GESTION DU DÉMARRAGE ROBUSTE ---
window.onload = () => {
try {
    console.log("Démarrage du jeu...");

    // 1. Initialiser le jeu
    window.app = new EliteManager();
    console.log("Jeu initialisé avec succès.");

    // 2. Animation du Splash Screen
    const splash = document.getElementById('splash-screen');
    if(splash) {
        setTimeout(() => {
            splash.classList.add('splash-out');
            setTimeout(() => splash.remove(), 800);
        }, 2500);
    }

} catch (e) {
    // En cas d'erreur fatale
    console.error("ERREUR CRITIQUE :", e);

    // On tente un nettoyage silencieux pour éviter la boucle infinie
    if (!sessionStorage.getItem('retry_done')) {
        sessionStorage.setItem('retry_done', 'true');
        localStorage.clear();
        location.reload();
    } else {
        alert("Erreur technique persistante. Vérifiez la console (F12) pour voir le message d'erreur rouge.");
        sessionStorage.removeItem('retry_done'); // Reset pour la prochaine fois
    }
}
};

</script>
<script>
    // Ecouteur global pour les clics
    document.addEventListener('click', (e) => {
        // Active le son au premier clic (obligatoire sur Chrome)
        if (window.app && window.app.audioCtx && window.app.audioCtx.state === 'suspended') {
            window.app.audioCtx.resume().then(() => {
                // Si on n'est pas en match, on lance la musique du menu !
                if (!window.app.match.active) {
                    window.app.startMenuMusic();
                }
            });
        }

        // Si on clique sur un bouton ou un élément de nav
        if (window.app && (e.target.closest('button') || e.target.closest('.btn-nav') || e.target.closest('.player-card'))) {
             window.app.playSound('click');
        }
    });
</script>
<div id="scout-formation-modal" class="fixed inset-0 z-[600] bg-slate-950/95 flex flex-col items-center justify-center p-6 hidden backdrop-blur-xl animate-slideIn">
    <div class="w-full max-w-sm flex flex-col h-full max-h-[600px]">

        <div class="flex justify-between items-center mb-4 shrink-0">
            <div>
                <h3 class="font-teko text-4xl text-white uppercase italic leading-none">Dispositif Probable</h3>
                <div class="text-[10px] text-blue-400 font-bold uppercase tracking-widest flex items-center gap-2">
                    <span id="scout-opp-name">ADVERSAIRE</span>
                    <span class="bg-blue-900/30 px-1.5 py-0.5 rounded text-blue-300 border border-blue-500/30" id="scout-opp-fmt">4-3-3</span>
                </div>
            </div>
            <button onclick="document.getElementById('scout-formation-modal').classList.add('hidden')" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold shadow-xl border border-slate-700 hover:bg-red-600 transition">X</button>
        </div>

        <div class="flex-1 relative flex justify-center items-center overflow-hidden bg-slate-900/50 rounded-3xl border border-white/5 shadow-2xl">
            <div class="pitch-container scale-[0.9] origin-center shadow-2xl border border-white/10" style="margin: 0;">
                <div class="pitch-midline"></div><div class="pitch-circle"></div>
                <div id="scout-pitch-layer"></div> </div>
        </div>

        <div class="mt-4 p-3 bg-blue-900/10 border border-blue-500/20 rounded-xl flex gap-3 items-center shrink-0">
            <div class="text-blue-400 text-2xl">ℹ️</div>
            <p class="text-[9px] text-slate-400 leading-tight">
                <span class="text-blue-300 font-bold">Note du Scout :</span> Ce dispositif est basé sur leurs derniers matchs. Attention aux changements de dernière minute.
            </p>
        </div>
    </div>
</div>
<div id="job-offers-modal" class="fixed inset-0 z-[3000] bg-black/95 flex flex-col hidden backdrop-blur-md">
    <div class="pt-8 pb-4 text-center shrink-0">
        <h2 class="font-teko text-5xl text-white uppercase italic leading-none text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-yellow-200">
            Mercato <span id="mercato-year">2026</span>
        </h2>
        <p class="text-slate-400 text-xs uppercase tracking-[0.2em] font-bold mt-1">Choisissez votre avenir</p>
    </div>

    <div id="job-cards-container" class="mercato-scroll pb-8">
    </div>
</div>
</body>

</html>