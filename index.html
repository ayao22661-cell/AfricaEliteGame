<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>African Elite Manager - Special CAN</title>
    
    <!-- Design System via Tailwind CSS intégré -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --color-bg: #0f172a; 
            --primary: #f97316; 
            --pitch-green: #1a4d2e;
            --pitch-line: rgba(255,255,255,0.18);
            --secondary: #334155;
            --success: #22c55e;
            --danger: #ef4444;
            --gold: #f59e0b;
        }
        
        body { 
            background-color: #000; 
            font-family: 'Inter', sans-serif; 
            color: #e2e8f0; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            font-size: 12px;
            height: 100vh;
            height: 100dvh;
        }
        
        .font-teko { font-family: 'Teko', sans-serif; }
        
        #app-container { 
            max-width: 100%; margin: 0 auto; 
            height: 100vh;
            height: 100dvh; 
            background-color: var(--color-bg); 
            position: relative; display: flex; flex-direction: column; overflow: hidden; 
            padding-top: env(safe-area-inset-top);
        }

        .glass-panel { 
            background: rgba(30, 41, 59, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* NOUVEAU : TEXTURE "CARBON FOOTBALL" */
        /* Un mélange de sombre, de carbone et d'une subtile grille rappelant les filets de but */
        .bg-carbon-foot {
            background-color: #0f172a;
            background-image: 
                /* Effet de lumière "Projecteur" (Radial) */
                radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%),
                /* Texture Carbone */
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-size: 100% auto, 6px 6px; /* Taille fine pour le carbone */
            position: relative;
        }
        /* Ajout d'une fine maille par dessus (Pseudo-élément) pour l'effet "Jersey" */
        .bg-carbon-foot::after {
            content: "";
            position: absolute; inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px; /* Grille de points espacés */
            pointer-events: none;
            z-index: 0;
        }

        /* NOUVEAU : TEXTURE "CARBON FOOTBALL" */
        /* Un mélange de sombre, de carbone et d'une subtile grille rappelant les filets de but */
        .bg-carbon-foot {
            background-color: #0f172a;
            background-image: 
                /* Effet de lumière "Projecteur" (Radial) */
                radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.05) 0%, transparent 70%),
                /* Texture Carbone */
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            background-size: 100% auto, 6px 6px; /* Taille fine pour le carbone */
            position: relative;
        }
        /* Ajout d'une fine maille par dessus (Pseudo-élément) pour l'effet "Jersey" */
        .bg-carbon-foot::after {
            content: "";
            position: absolute; inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px; /* Grille de points espacés */
            pointer-events: none;
            z-index: 0;
        }

        /* MISE À JOUR : TERRAIN NEXT-GEN */
        .pitch-container {
            background-color: #1a4d2e; /* Vert de base */
            /* Motif : Bandes de tonte + Texture subtile */
            background-image: 
                /* Bandes horizontales (Tonte) */
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 40px,
                    rgba(0,0,0,0.08) 40px, /* Bande plus sombre */
                    rgba(0,0,0,0.08) 80px
                ),
                /* Bruit léger pour ne pas faire "plastique" */
                url('https://www.transparenttextures.com/patterns/grass.png'); 
            
            position: relative; 
            height: 480px; width: 340px;
            border-radius: 12px; margin: 10px auto; overflow: hidden; 
            border: 4px solid #14532d; /* Bordure sombre */
            
            /* ÉCLAIRAGE STADE : Ombres internes fortes sur les coins */
            box-shadow: 
                inset 0 0 80px rgba(0,0,0,0.7), /* Vignette sombre */
                0 20px 50px rgba(0,0,0,0.5); /* Ombre portée externe */
            flex-shrink: 0;
        }
        .pitch-midline { position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--pitch-line); }
        .pitch-circle { position: absolute; top: 50%; left: 50%; width: 80px; height: 80px; border: 1px solid var(--pitch-line); border-radius: 50%; transform: translate(-50%, -50%); }

        .player-card {
            position: absolute; width: 50px; height: 78px; 
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.7);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; z-index: 20;
            overflow: visible;
        }
        .player-card.malus { border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.6); }
        .card-ovr { font-family: 'Teko', sans-serif; font-size: 20px; font-weight: 700; color: #f97316; line-height: 1; }
        .card-pos { font-size: 7px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: -1px; }
        .card-age { font-size: 6px; color: #475569; font-weight: 700; margin-bottom: 1px; }
        .card-energy { width: 75%; height: 2px; background: #334155; border-radius: 1px; margin-top: 2px; position: relative; overflow: hidden; }
        .energy-fill { height: 100%; transition: width 0.3s; }
        
        .card-name { 
            width: 100%; background: rgba(0,0,0,0.85); 
            padding: 2px 0; text-align: center; font-size: 7px; 
            font-weight: 600; color: white; margin-top: auto; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .bench-item {
            min-width: 110px; height: 55px;
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 10px;
            display: flex; align-items: center; gap: 12px;
            flex-shrink: 0; cursor: pointer; transition: 0.2s;
        }

        /* --- STYLES INFRASTRUCTURES --- */
        .infra-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            transition: 0.3s;
        }
        .infra-card:hover { background: rgba(30, 41, 59, 0.8); border-color: var(--primary); }

        /* --- SCROLLING TACTIQUE LIVE --- */
        #live-coach-overlay {
            position: absolute; inset: 0; z-index: 150;
            background: rgba(15, 23, 42, 0.99);
            backdrop-filter: blur(25px);
            display: none; flex-direction: column;
            overflow-y: auto;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #live-coach-overlay.active { display: flex; }

        #ht-overlay {
            position: absolute; inset: 0; z-index: 180;
            background: rgba(0,0,0,0.95);
            display: none; align-items: center; justify-content: center; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        #ht-overlay.active { display: flex; }

        .speech-btn {
            width: 100%; padding: 16px; border-radius: 12px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: white; font-weight: bold; text-transform: uppercase; transition: 0.3s;
        }
        .speech-btn:hover { background: var(--primary); transform: scale(1.02); }

        .btn-nav.active { color: #f97316; border-top: 2px solid #f97316; background: rgba(249, 115, 22, 0.05); }
        .instruction-btn.active { background-color: #f97316; color: white; border-color: #fb923c; }

        .news-item { padding: 14px; background: rgba(30, 41, 59, 0.4); border-radius: 10px; border-left: 4px solid #f97316; margin-bottom: 10px; font-size: 11px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

      /* --- CORRECTION BUG BUT --- */
        #goal-overlay { 
            position: absolute; 
            inset: 0; 
            z-index: 1000; /* Augmenté de 300 à 1000 pour être sûr d'être au-dessus de tout */
            display: none; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            background: rgba(0,0,0,0.9); /* Un peu plus foncé pour mieux voir */
            pointer-events: none; 
            transition: opacity 0.3s;
        }
        
        /* Ajout de !important pour forcer l'affichage */
        #goal-overlay.active { 
            display: flex !important; 
            animation: pulseGoal 0.5s ease-out;
        }

        @keyframes pulseGoal {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .stat-badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 10px; color: #94a3b8; }
        
        .tab-btn { padding: 8px 16px; border-bottom: 2px solid transparent; color: #64748b; font-weight: bold; font-size: 10px; text-transform: uppercase; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Correction Barre de Navigation Mobile */
        nav {
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(4rem + env(safe-area-inset-bottom)) !important;
        }
        
        /* Ajustement des zones de contenu pour ne pas être cachées par la nav */
        .view-section {
            padding-bottom: calc(6rem + env(safe-area-inset-bottom)) !important;
        }
    </style>
</head>

<body class="text-slate-200">

    <div id="app-container">
        
        <!-- HEADER -->
        <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-50 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-700 rounded-lg flex items-center justify-center border-2 border-slate-700 text-white font-teko font-bold text-xl shadow-lg italic">CIV</div>
                <div class="flex flex-col">
<span id="header-manager-name" class="text-[10px] text-orange-500 font-bold uppercase tracking-widest leading-none">MANAGER INCONNU</span>
                    <span class="text-xs font-bold text-white leading-tight" id="header-subtitle">SAISON 2026</span>
                </div>
            </div>
            <div class="flex gap-2">
                <div class="px-3 py-1 bg-slate-800 rounded-lg border border-slate-700 flex items-center gap-2">
                    <span id="icon-coins-head"></span>
                    <span class="font-teko text-lg text-yellow-100" id="budget-display">15.0 M€</span>
                </div>
                <button onclick="app.resetGame()" class="w-8 h-8 flex items-center justify-center bg-slate-800 rounded-lg border border-slate-700 text-slate-400" id="icon-refresh-head"></button>
            </div>
        </header>
    
        <main id="main-content" class="flex-1 relative overflow-hidden">
            
            <div id="view-inbox" class="view-section flex flex-col h-full overflow-hidden relative bg-slate-900" style="padding-bottom: 0 !important;">
    
    <div class="shrink-0 p-6 pb-4 bg-carbon-foot border-b border-white/5 relative z-20">
        <div class="absolute top-0 right-0 w-32 h-32 bg-orange-500/10 rounded-full blur-3xl pointer-events-none"></div>
        
        <div class="flex justify-between items-end relative z-10">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="px-2 py-0.5 rounded bg-orange-500/20 border border-orange-500/30 text-[9px] font-bold text-orange-400 uppercase tracking-widest">Saison 2026</span>
                    <span class="px-2 py-0.5 rounded bg-slate-700 border border-slate-600 text-[9px] font-bold text-slate-300 uppercase tracking-widest" id="dash-stage">POULES</span>
                </div>
                <h2 class="font-teko text-5xl text-white uppercase italic leading-none drop-shadow-md">Q.G. Manager</h2>
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">La nation vous regarde.</div>
            </div>
            
            <div class="flex flex-col items-end w-28">
                <div class="flex justify-between w-full text-[9px] font-bold uppercase mb-1">
                    <span class="text-slate-500">Prestige</span>
                    <span class="text-orange-400" id="team-xp-display">0 XP</span>
                </div>
                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                    <div id="xp-bar-fill" class="h-full bg-gradient-to-r from-orange-600 to-yellow-400 shadow-[0_0_10px_rgba(249,115,22,0.5)]" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-5 pb-4 z-10">

        <div class="relative w-full rounded-3xl overflow-hidden border border-white/10 shadow-2xl group shrink-0">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
            <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900"></div>
            
            <div class="relative z-10 p-5 flex flex-col items-center">
                <div class="w-full flex justify-between items-center mb-4 opacity-90">
                    <span class="text-[9px] font-bold text-white bg-red-600 px-2 py-0.5 rounded animate-pulse">PROCHAIN MATCH</span>
                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest" id="dash-date">2026</span>
                </div>

                <div class="flex items-center justify-between w-full px-2 mb-6">
                    <div class="flex flex-col items-center gap-2 group-hover:scale-105 transition-transform duration-500">
                        <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-800 shadow-xl italic relative">
                            CIV
                            <div class="absolute -bottom-2 -right-2 bg-white text-slate-900 text-[9px] font-bold px-1.5 rounded border border-slate-300">DOM</div>
                        </div>
                    </div>

                    <div class="flex flex-col items-center justify-center">
                        <span class="font-teko text-5xl text-white italic drop-shadow-[0_0_15px_rgba(249,115,22,0.8)]">VS</span>
                    </div>

                    <div class="flex flex-col items-center gap-2 group-hover:scale-105 transition-transform duration-500">
                        <div id="next-opp-badge" class="w-20 h-20 bg-slate-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-800 shadow-xl italic">?</div>
                    </div>
                </div>

                <div class="text-center mb-6">
                    <h3 class="font-teko text-4xl text-white uppercase leading-none mb-1" id="next-opp-name">ADVERSAIRE</h3>
                    <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Stade Olympique Ebimpé</p>
                </div>

                <button onclick="app.startMatch()" class="w-full py-4 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white rounded-xl text-sm font-bold uppercase tracking-widest shadow-lg border border-orange-400/50 flex items-center justify-center gap-2 active:scale-95 transition-all group-hover:shadow-orange-500/20">
                    <span id="icon-play-main" class="scale-125"></span> COUP D'ENVOI
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            
            <div class="glass-panel p-4 rounded-2xl border border-white/5 bg-slate-800/50">
                <div class="flex items-center justify-between mb-3 border-b border-white/5 pb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-blue-400" id="icon-radar-dash"></span>
                        <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Rapport Scout</h3>
                    </div>
                    <span class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded font-bold uppercase">Analyse</span>
                </div>
                <div id="opponent-analysis-box" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div class="glass-panel p-4 rounded-2xl border border-white/5 bg-slate-800/50">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-teko text-2xl text-white uppercase tracking-wide flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        Gazette
                    </h3>
                    <button onclick="app.clearNews()" class="text-[9px] text-slate-500 hover:text-white uppercase font-bold border border-slate-700 px-2 py-1 rounded transition">Effacer</button>
                </div>
                <div id="news-feed" class="space-y-2"></div>
            </div>
        </div>
    </div>
</div>    <!-- VUE : TACTIQUE -->
            <div id="view-squad" class="view-section hidden flex flex-col h-full bg-slate-900 absolute inset-0 z-10 overflow-y-auto no-scrollbar">
                <div class="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-40 shadow-2xl">
                    <div class="flex justify-between items-center mb-4 px-1">
                        <button onclick="app.autoPick()" class="px-4 py-2 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-xl text-[10px] font-bold text-white uppercase flex items-center gap-2 transition">
                            <span id="icon-zap-mini"></span> Composition Auto.
                        </button>
                        <button onclick="app.openRolesModal()" class="px-4 py-2 bg-slate-800 border border-slate-700 hover:bg-slate-700 rounded-xl text-[10px] font-bold text-white uppercase flex items-center gap-2 transition">
                        <span class="text-yellow-400">©</span> Rôles
                        </button>
                        <div id="squad-avg-ovr" class="text-white text-3xl font-teko font-bold">--</div>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                        <button onclick="app.setFormation('4-3-3')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">4-3-3</button>
                        <button onclick="app.setFormation('4-4-2')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">4-4-2</button>
                        <button onclick="app.setFormation('3-5-2')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">3-5-2</button>
                        <button onclick="app.setFormation('4-2-3-1')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">4-2-3-1</button>
                        <button onclick="app.setFormation('4-1-4-1')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">4-1-4-1</button>
                        <button onclick="app.setFormation('5-4-1')" class="px-5 py-2 rounded-xl text-[10px] font-bold bg-slate-800 border border-slate-700 shrink-0">5-4-1</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-2 border-t border-slate-800 pt-4">
                        <div class="flex flex-col gap-1">
                             <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Style Tactique</span>
                             <div class="flex gap-1">
                                <button onclick="app.setTacticalInstruction('style', 'possession')" id="inst-style-possession" class="instruction-btn flex-1 py-2 rounded-lg bg-slate-800 border border-slate-700 text-[9px] font-bold uppercase transition">Possession</button>
                                <button onclick="app.setTacticalInstruction('style', 'counter')" id="inst-style-counter" class="instruction-btn flex-1 py-2 rounded-lg bg-slate-800 border border-slate-700 text-[9px] font-bold uppercase transition">Contre</button>
                             </div>
                        </div>
                        <div class="flex flex-col gap-1">
                             <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Intensité Pressing</span>
                             <div class="flex gap-1">
                                <button onclick="app.setTacticalInstruction('pressing', 'high')" id="inst-pressing-high" class="instruction-btn flex-1 py-2 rounded-lg bg-slate-800 border border-slate-700 text-[9px] font-bold uppercase transition">Haut</button>
                                <button onclick="app.setTacticalInstruction('pressing', 'normal')" id="inst-pressing-normal" class="instruction-btn flex-1 py-2 rounded-lg bg-slate-800 border border-slate-700 text-[9px] font-bold uppercase transition">Normal</button>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 relative py-8">
                    <div class="pitch-container" id="pitch-main">
                        <div class="pitch-midline"></div><div class="pitch-circle"></div>
                        <div id="pitch-cards-layer"></div>
                    </div>
                </div>

                <div class="px-4 mt-4 pb-20">
                    <div class="flex justify-between items-center py-2 border-b border-slate-800 mb-4">
                        <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest">Effectif & Réserve</span>
                        <span id="bench-count" class="text-[10px] text-slate-500 font-mono">0/20</span>
                    </div>
                    <div id="bench-list-container" class="flex flex-wrap gap-2 justify-center pb-20"></div>
                </div>
            </div>

            <!-- VUE : MATCH LIVE -->
            <div id="view-match" class="view-section hidden absolute inset-0 z-[60] flex flex-col bg-slate-950">
           <div class="relative z-20 pt-8 pb-2 flex flex-col items-center shrink-0">
        
        <div class="mb-[-12px] z-20 bg-slate-950 border border-slate-700 px-4 py-1 rounded-full shadow-lg">
            <span class="font-mono text-xl text-orange-500 font-bold tracking-widest" id="match-timer">00:00</span>
        </div>

        <div class="w-72 bg-[#0f172a] border border-slate-700 rounded-3xl p-4 shadow-[0_10px_40px_-10px_rgba(0,0,0,0.8)] flex flex-col items-center relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>

            <div class="flex justify-between items-center w-full z-10">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-orange-700 flex items-center justify-center font-teko text-xl text-white font-bold border border-slate-600 shadow-lg">CIV</div>
                </div>

                <div class="flex items-center gap-4">
                    <span class="font-teko text-6xl text-white leading-none drop-shadow-md" id="score-home">0</span>
                    <span class="w-px h-8 bg-slate-700"></span>
                    <span class="font-teko text-6xl text-white leading-none drop-shadow-md" id="score-away">0</span>
                </div>

                <div class="flex flex-col items-center gap-1">
                    <div id="match-opp-badge" class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center font-teko text-xl text-white font-bold border border-slate-600 shadow-lg">?</div>
                </div>
            </div>

            <div class="w-full mt-3 flex items-center gap-2">
                <span class="text-[9px] font-bold text-slate-500 w-6 text-right" id="poss-val-home">50%</span>
                <div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden relative">
                    <div id="possession-home-bar" class="h-full bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.5)] transition-all duration-700" style="width: 50%"></div>
                </div>
                <span class="text-[9px] font-bold text-slate-500 w-6" id="poss-val-away">50%</span>
            </div>
            
            <div class="flex justify-between w-full px-2 mt-1">
                 <span class="text-[8px] text-slate-500 uppercase font-bold">Tirs: <span id="stats-shots-home" class="text-slate-300">0</span></span>
                 <span class="text-[8px] text-slate-500 uppercase font-bold">Tirs: <span id="stats-shots-away" class="text-slate-300">0</span></span>
            </div>
        </div>
    </div>

    <div class="flex-1 min-h-0 flex flex-col relative z-10 px-4 mb-2">
        
        <div class="shrink-0 py-1">
            <div id="match-assistant-msg" class="bg-slate-900/80 border-l-2 border-orange-500 pl-2 py-1.5 text-[10px] text-slate-300 italic shadow-lg backdrop-blur-sm truncate">
                </div>
        </div>

        <div id="commentary-log" class="flex-1 overflow-y-auto space-y-1.5 no-scrollbar text-[11px] text-slate-400 pb-2 mask-image-b">
            </div>
    </div>

    <div class="shrink-0 bg-slate-900 border-t border-slate-800 p-3 pb-20 shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-30">
        
        <div class="flex justify-between items-center mb-2">
             <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Tactique</span>
             <button onclick="app.toggleLiveCoaching()" class="px-3 py-1 bg-slate-800 border border-slate-600 rounded text-[9px] text-white font-bold uppercase hover:bg-slate-700 transition flex items-center gap-1">
                <span id="icon-repeat-match"></span> <span class="text-[8px]">Coaching</span>
             </button>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <button onclick="app.setMatchTactic('def')" id="tac-def" class="py-2 bg-slate-800 border border-slate-700 rounded-lg text-[9px] font-bold text-slate-400 uppercase transition active:scale-95">Défense</button>
            <button onclick="app.setMatchTactic('bal')" id="tac-bal" class="py-2 bg-slate-700 border border-orange-500 rounded-lg text-[9px] font-bold text-white shadow-lg uppercase transition active:scale-95">Équilibre</button>
            <button onclick="app.setMatchTactic('att')" id="tac-att" class="py-2 bg-slate-800 border border-slate-700 rounded-lg text-[9px] font-bold text-slate-400 uppercase transition active:scale-95">Attaque</button>
        </div>
    </div>

                <div id="penalty-view" class="hidden fixed inset-0 z-[500] bg-slate-950 flex flex-col items-center justify-center p-6">
                
                <div class="text-center mb-8 w-full">
                    <h2 class="font-teko text-6xl text-white uppercase italic leading-none mb-2 animate-pulse">Tirs au But</h2>
                    <div class="flex items-center justify-center gap-6 bg-slate-900/80 p-6 rounded-3xl border border-white/10 shadow-2xl">
                        <div class="text-center w-24">
                            <span class="font-teko text-7xl text-orange-500 leading-none" id="pen-score-home">0</span>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">CIV</div>
                        </div>
                        <div class="text-slate-600 font-teko text-4xl italic">VS</div>
                        <div class="text-center w-24">
                            <span class="font-teko text-7xl text-white leading-none" id="pen-score-away">0</span>
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest" id="pen-opp-code">ADV</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-center gap-8 mt-4">
                        <div id="pen-history-home" class="flex gap-1"></div>
                        <div id="pen-history-away" class="flex gap-1"></div>
                    </div>
                </div>

                <div id="pen-selection-zone" class="w-full max-w-md">
                    <p class="text-center text-[10px] text-orange-400 font-bold uppercase tracking-widest mb-4 animate-bounce">
                        Sélectionnez votre tireur
                    </p>
                    <div id="pen-shooters-list" class="grid grid-cols-2 gap-3 max-h-[40vh] overflow-y-auto no-scrollbar">
                        </div>
                </div>

                <div id="pen-result-msg" class="hidden mt-8 text-center">
                    <h3 class="font-teko text-5xl text-white uppercase italic" id="pen-action-text">BUT !</h3>
                </div>
            </div>

                <!-- OVERLAY COACHING MATCH -->
                <div id="live-coach-overlay">
                    <div class="flex-shrink-0 p-4 border-b border-white/5 bg-slate-900 sticky top-0 z-[210]">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col">
                                 <h3 class="font-teko text-5xl text-white uppercase tracking-tighter leading-none italic">Coaching Direct</h3>
                                 <span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Ajustements tactiques</span>
                            </div>
                            <button onclick="app.toggleLiveCoaching()" class="w-12 h-12 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold text-2xl shadow-xl">X</button>
                        </div>
                    </div>
                    
                    <div class="p-4 overflow-y-auto no-scrollbar pb-32">
                        
                        <div id="live-tactics-container"></div>
                        <div class="mb-6">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1 mb-2 block">Changer Dispositif</span>
                            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2" id="live-formation-list">
                                <button onclick="app.setLiveFormation('4-3-3')" class="live-fmt-btn px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-[10px] font-bold shrink-0 transition" data-fmt="4-3-3">4-3-3</button>
                                <button onclick="app.setLiveFormation('4-4-2')" class="live-fmt-btn px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-[10px] font-bold shrink-0 transition" data-fmt="4-4-2">4-4-2</button>
                                <button onclick="app.setLiveFormation('3-5-2')" class="live-fmt-btn px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-[10px] font-bold shrink-0 transition" data-fmt="3-5-2">3-5-2</button>
                                <button onclick="app.setLiveFormation('4-2-3-1')" class="live-fmt-btn px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-[10px] font-bold shrink-0 transition" data-fmt="4-2-3-1">4-2-3-1</button>
                                <button onclick="app.setLiveFormation('5-4-1')" class="live-fmt-btn px-5 py-3 rounded-xl bg-slate-800 border border-slate-700 text-white text-[10px] font-bold shrink-0 transition" data-fmt="5-4-1">5-4-1</button>
                            </div>
                        </div>

                        <div class="pitch-container scale-[0.9] origin-top mx-auto shadow-2xl mb-24">
                             <div id="pitch-cards-layer-live"></div>
                        </div>
                    </div>
                </div>
                <!-- HT OVERLAY -->
                <div id="ht-overlay">
                    <div class="glass-panel p-10 rounded-[50px] text-center max-w-sm w-full mx-6 shadow-2xl border border-white/10">
                        <span id="icon-mic-ht"></span>
                        <h2 class="font-teko text-7xl text-white mb-2 leading-none uppercase italic mt-4">La Causerie</h2>
                        <p class="text-[10px] text-slate-400 mb-10 tracking-widest uppercase">Mots justes, moral d'acier.</p>
                        <div class="flex flex-col gap-4">
                            <button onclick="app.giveSpeech('motivate')" class="speech-btn">Motiver les troupes (+5% Force)</button>
                            <button onclick="app.giveSpeech('shake')" class="speech-btn text-red-400 border-red-500/20">Secouer le groupe (+15% Risqué)</button>
                            <button onclick="app.giveSpeech('calm')" class="speech-btn text-blue-400 border-blue-500/20">Tactique de zone (+10% Mental)</button>
                        </div>
                    </div>
                </div>

                <div id="goal-overlay">
                    <h1 class="font-teko text-[130px] text-white italic animate-bounce leading-none">BUT !!!</h1>
                    <p class="font-teko text-5xl text-orange-500 uppercase tracking-tighter" id="goal-scorer-name"></p>
                </div>
                
             <div id="end-modal" class="absolute inset-0 z-[250] bg-slate-950/90 flex items-center justify-center hidden p-6 backdrop-blur-xl transition-all duration-500">
                    <div class="w-full max-w-md bg-slate-900 border border-slate-700 rounded-[32px] shadow-2xl overflow-hidden relative">
                        
                        <div id="end-header-bg" class="h-24 bg-gradient-to-b from-green-600 to-slate-900 flex items-center justify-center pt-4 relative">
                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div>
                            <h2 class="font-teko text-6xl text-white uppercase italic tracking-tighter drop-shadow-lg relative z-10" id="end-title">VICTOIRE</h2>
                        </div>

                        <div class="px-6 py-8 flex flex-col items-center">
                            <div class="flex items-center justify-between w-full mb-8">
                                <div class="flex flex-col items-center gap-2 w-1/3">
                                    <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center border-2 border-slate-600 shadow-xl">
                                        <span class="font-teko text-3xl text-white font-bold italic">CIV</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Domicile</span>
                                </div>

                                <div class="flex flex-col items-center w-1/3 relative">
                                    <div class="font-teko text-7xl text-white leading-none tracking-tighter drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]" id="end-score-display">0-0</div>
                                    <div id="end-penalties-display" class="text-[10px] text-orange-400 font-bold uppercase tracking-widest mt-1 hidden">TAB: 4-3</div>
                                </div>

                                <div class="flex flex-col items-center gap-2 w-1/3">
                                    <div id="end-opp-badge" class="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center border-2 border-slate-600 shadow-xl">
                                        <span class="font-teko text-3xl text-white font-bold italic">?</span>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="end-opp-name">ADV</span>
                                </div>
                            </div>

                            <div class="w-full space-y-3 bg-slate-950/50 p-4 rounded-xl border border-white/5 mb-6">
                                <div class="flex justify-between text-[9px] font-bold text-slate-500 uppercase mb-1">
                                    <span>Tirs Cadrés</span>
                                    <span class="text-white" id="end-stat-shots">0 - 0</span>
                                </div>
                                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden flex">
                                    <div id="end-bar-shots" class="h-full bg-orange-500" style="width: 50%"></div>
                                </div>
                                
                                <div class="flex justify-between text-[9px] font-bold text-slate-500 uppercase mt-2 mb-1">
                                    <span>Possession</span>
                                    <span class="text-white" id="end-stat-poss">50% - 50%</span>
                                </div>
                                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden flex">
                                    <div id="end-bar-poss" class="h-full bg-blue-500" style="width: 50%"></div>
                                </div>
                            </div>

                            <button onclick="app.closeEndModal()" class="w-full py-5 bg-white text-slate-900 hover:bg-slate-200 font-bold rounded-xl uppercase shadow-lg shadow-white/5 active:scale-95 transition-all text-sm tracking-widest">
                              Continuer la Saison
                            </button>
                        </div>
                    </div>
                </div>
                </div>  

            <!-- MODAL DE SWAP -->
           <div id="swap-modal" class="absolute inset-0 z-[300] bg-slate-950/95 hidden flex flex-col backdrop-blur-md">
                <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-2xl shrink-0">
                    <div>
                        <h3 class="font-teko text-4xl text-white uppercase leading-none italic">Banc de Touche</h3>
                        <div class="text-[10px] text-orange-500 font-bold uppercase tracking-widest" id="swap-target-pos">Remplacement</div>
                    </div>
                    <button onclick="app.closeSwapModal()" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold shadow-xl border border-slate-700">X</button>
                </div>
                
                <div class="p-4 flex-1 overflow-y-auto no-scrollbar grid grid-cols-2 gap-3 content-start" id="swap-candidates-list">
                    </div>
            </div>
            
            <div id="preview-modal" class="absolute inset-0 z-[200] bg-slate-950/95 hidden flex flex-col backdrop-blur-xl">
                <div class="p-6 text-center shrink-0 bg-gradient-to-b from-slate-900 to-transparent">
                    <h2 class="font-teko text-6xl text-white uppercase italic leading-none drop-shadow-lg">Feuille de Match</h2>
                    <div class="flex items-center justify-center gap-3 mt-1">
                        <span class="text-orange-500 font-bold text-lg">CIV</span>
                        <span class="text-slate-600 text-[10px] font-bold">VS</span>
                        <span class="text-white font-bold text-lg" id="preview-opp-code">ADV</span>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto px-4 pb-32 no-scrollbar">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-slate-900/50 rounded-2xl p-2 border border-orange-500/20">
                            <div class="text-center mb-3 border-b border-white/5 pb-2">
                                <div class="text-[9px] text-orange-500 uppercase font-bold tracking-widest">TITULAIRES</div>
                            </div>
                            <div id="preview-home-list" class="space-y-1"></div>
                        </div>

                        <div class="bg-slate-900/50 rounded-2xl p-2 border border-slate-700/50">
                             <div class="text-center mb-3 border-b border-white/5 pb-2">
                                <div class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">ADVERSAIRE</div>
                            </div>
                            <div id="preview-away-list" class="space-y-1"></div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-slate-900 border-t border-slate-800 absolute bottom-0 w-full shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                    <button onclick="app.kickOff()" class="w-full py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold uppercase tracking-widest transition-all shadow-xl text-sm flex items-center justify-center gap-2 border border-orange-400">
                     <span id="icon-play-preview"></span> DONNER LE COUP D'ENVOI
                    </button>
                </div>
            </div>

            <!-- VUES SECONDAIRES -->
            <div id="view-training" class="view-section hidden h-full overflow-y-auto no-scrollbar">
                <div class="p-5" id="training-content"></div>
            </div>
            
            <div id="view-calendar" class="view-section hidden h-full overflow-y-auto no-scrollbar">
                <div class="p-5" id="calendar-content"></div>
            </div>
            
            <div id="view-scout" class="view-section hidden h-full overflow-y-auto no-scrollbar">
                <div class="p-5" id="scout-content"></div>
            </div>

            <!-- NOUVELLE VUE : INFRASTRUCTURES -->
            <div id="view-infra" class="view-section hidden h-full overflow-y-auto no-scrollbar">
                <div class="p-6">
                    <h2 class="font-teko text-6xl text-white uppercase italic mb-2 leading-none">Infrastructures</h2>
                    <p class="text-[10px] text-slate-500 mb-8 uppercase tracking-widest font-bold">Bâtir l'avenir de la nation.</p>
                    <div id="infra-list" class="grid grid-cols-1 gap-4"></div>
                </div>
            </div>

        </main>

        <!-- NAVIGATION -->
       <nav class="bg-[#0f172a] border-t border-slate-800 grid grid-cols-6 items-center z-[100] shrink-0 relative h-16 pb-safe">
    <button onclick="app.goToView('inbox')" id="nav-inbox" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-layout-nav"></span><span class="text-[9px] font-bold uppercase">QG</span></button>
    <button onclick="app.goToView('squad')" id="nav-squad" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-shield-nav"></span><span class="text-[9px] font-bold uppercase">Tactique</span></button>
    <button onclick="app.goToView('training')" id="nav-training" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-zap-nav"></span><span class="text-[9px] font-bold uppercase">Pro</span></button>
    <button onclick="app.goToView('calendar')" id="nav-calendar" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-trophy-nav"></span><span class="text-[9px] font-bold uppercase">CAF</span></button>
    <button onclick="app.goToView('scout')" id="nav-scout" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-search-nav"></span><span class="text-[9px] font-bold uppercase">Scout</span></button>
    <button onclick="app.goToView('infra')" id="nav-infra" class="btn-nav h-full flex flex-col items-center justify-center gap-1 text-slate-500 transition-all"><span id="icon-home-nav"></span><span class="text-[9px] font-bold uppercase">Ville</span></button>
</nav>
        <div id="welcome-modal" class="absolute inset-0 z-[1000] bg-slate-950 flex flex-col items-center justify-center p-8 hidden">
        <div class="w-full max-w-sm text-center">
            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center border-4 border-slate-800 shadow-2xl mb-8">
                <span class="font-teko text-4xl text-white italic">CIV</span>
            </div>
            <h1 class="font-teko text-6xl text-white uppercase italic leading-none mb-2">Nouvelle Ère</h1>
            <p class="text-xs text-slate-400 mb-8 uppercase tracking-widest">La fédération attend votre signature.</p>
            <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 shadow-xl">
                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-2 text-left">Nom du Manager</label>
                <input type="text" id="input-manager-name" placeholder="Ex: DIDIER DROGBA" class="w-full bg-slate-950 border border-slate-700 text-white p-4 rounded-xl text-center font-teko text-2xl uppercase focus:border-orange-500 focus:outline-none mb-4 placeholder-slate-700 transition">
                <button onclick="app.submitManagerName()" class="w-full py-4 bg-white text-slate-900 rounded-xl text-xs font-bold uppercase shadow-lg active:scale-95 transition">
                    Signer le contrat
                </button>
            </div>
        </div>
    </div>

        <div id="feedback-toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-white text-slate-900 px-8 py-4 rounded-2xl shadow-2xl z-[500] text-[11px] font-bold hidden opacity-0 transition-all transform translate-y-4">
            <span id="toast-msg">Action effectuée</span>
        </div>
    </div>
    <div id="roles-modal" class="hidden absolute inset-0 z-[300] bg-slate-950/95 flex flex-col backdrop-blur-md">
    <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center shadow-2xl shrink-0">
        <div>
            <h3 class="font-teko text-4xl text-white uppercase leading-none italic">Rôles Clés</h3>
            <div class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Responsabilités</div>
        </div>
        <button onclick="document.getElementById('roles-modal').classList.add('hidden')" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-white font-bold shadow-xl border border-slate-700">X</button>
    </div>
    
    <div class="p-6 flex-1 overflow-y-auto space-y-4">
        <div id="roles-list-container" class="grid grid-cols-1 gap-4">
            </div>
    </div>
</div>

<div id="role-picker-modal" class="hidden absolute inset-0 z-[350] bg-slate-950 flex flex-col">
    <div class="p-4 bg-slate-900 border-b border-slate-700">
        <h3 class="font-teko text-3xl text-white uppercase" id="role-picker-title">Choisir Joueur</h3>
    </div>
    <div id="role-picker-list" class="p-4 grid grid-cols-1 gap-2 overflow-y-auto"></div>
    <div class="p-4 border-t border-slate-800">
        <button onclick="document.getElementById('role-picker-modal').classList.add('hidden')" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold uppercase text-xs">Annuler</button>
    </div>
</div>

    <script>
        /**
         * AFRICAN ELITE MANAGER PRO v9.6 - THE LEGACY
         * DEVELOPED FOR TOTAL REALISM & IMMERSION
         * 1100+ LINES OF CODE
         */

        const FIRST_NAMES_DB = [
            "Koffi", "Yao", "Moussa", "Didier", "Yaya", "Seydou", "Abdoulaye", "Sékou", "Jean-Luc", "Bakary", 
            "Ismael", "Franck", "Oumar", "Lassina", "Serge", "Emmanuel", "Simon", "Ibrahim", "Tidiane", "Junior", 
            "Max-Alain", "Wilfried", "Nicolas", "Eric", "Sébastien", "Jeremie", "Christian", "Jean-Philippe", 
            "Guelor", "Chancel", "Cedric", "Gaël", "Wilfried", "Jonathan", "Evan", "Seko", "Odilon", "Ousmane", 
            "Boubacar", "Adama", "Mamadou", "Ismaël", "Lassina", "Karim", "Amath", "Idrissa", "Salif", "Kalidou", 
            "Sadio", "Achraf", "Hakim", "Sofyan", "Yassine", "Nayef", "Romain", "Selim", "Amine", "Walid", "Jawad", 
            "Yahya", "Vincent", "Karl", "Andre", "Youssouf", "Moussa", "Ibrahima", "Lamine", "Moussa", "Habib", 
            "Abdou", "Cheick", "Amadou", "Souleymane", "Modibo", "Tamsir", "Fodé", "Boulaye", "Bamba", "Opa", 
            "Sény", "Formose", "Ismaïla", "Krepin", "Pape", "Iliman", "Famara", "Nicolas", "Alfred", "Mory", 
            "Mohamed", "Ahmed", "Mahmoud", "Mostafa", "Omar", "Trezeguet", "Zizo", "Marwan", "Emam", "Ali",
            "Bassem", "Hamdi", "Hussein", "Afsha", "Kahraba", "Sherif", "Yasser", "Rami", "Gomaa", "Hegazi",
            "Sidi", "Demba", "Pathé", "Bouna", "Zalmani", "Ayoub", "Munir", "Ilyas", "Anass", "Bilal", "Youssef"
        ];

        const LAST_NAMES_DB = [
            "Touré", "Konan", "Kouamé", "Bamba", "Keita", "Drogba", "Kessié", "Fofana", "Ndicka", "Kossounou", 
            "Diallo", "Haller", "Zaha", "Cornet", "Adingra", "Gradel", "Aurier", "Bailly", "Pepe", "Singote", 
            "Diomandé", "Kouassi", "Saré", "Cissé", "Traoré", "Coulibaly", "Ouattara", "Tiéhi", "Gouaméné", 
            "Kalou", "Mbemba", "Bakambu", "Wissa", "Guela", "Doué", "Kolo", "Yaya", "Kaboré", "Traoré", "Gakpa", 
            "Sangaré", "Mendy", "Koulibaly", "Gueye", "Sarr", "Diallo", "Hakimi", "Ziyech", "Amrabat", "Bounou", 
            "Aguerd", "Saïss", "Amallah", "Harit", "Regragui", "El Yamiq", "Attiat-Allah", "Aboubakar", 
            "Toko Ekambi", "Onana", "Fofana", "Bissouma", "Camara", "Lamine", "Niakhaté", "Diallo", "Gueye", 
            "Kouyaté", "Matar", "Dieng", "Jackson", "Dia", "Ballo-Touré", "Sabaly", "Ciss", "Jakobs", 
            "Seck", "Mendy", "Kamara", "Haidara", "Samassékou", "Dorgeles", "Koïta", "Sacko", "Falaye",
            "Salah", "Elneny", "Mohamed", "Marmoush", "Hany", "Fathi", "Tawfik", "Hamed", "Sobhi", "Abdelmonem",
            "Ounahi", "Mazraoui", "Boufal", "En-Nesyri", "Ezzalzouli", "Amine", "Adli", "Saibari", "Richards"
        ];

        const NATIONS_DB = [
            {n: 'Côte d\'Ivoire', code: 'CIV', ovr: 85, style: 'Offensif', star: 'F. Kessié', starPos: 'MID'},
          {
                n: 'Sénégal', code: 'SEN', ovr: 86, style: 'Impact', 
                star: 'S. Mané', starPos: 'FWD', 
                topDef: 'K. Koulibaly', topMid: 'P.M. Sarr', topAtt: 'S. Mané',
                scorers: ['N. Jackson', 'I. Sarr', 'H. Diallo']
            },
            {
                n: 'Maroc', code: 'MAR', ovr: 87, style: 'Tiki-Taka', 
                star: 'A. Hakimi', starPos: 'DEF', 
                topDef: 'A. Hakimi', topMid: 'S. Amrabat', topAtt: 'Y. En-Nesyri',
                scorers: ['Y. En-Nesyri', 'H. Ziyech', 'B. Diaz']
            },
            {
                n: 'Égypte', code: 'EGY', ovr: 84, style: 'Contre', 
                star: 'M. Salah', starPos: 'FWD', 
                topDef: 'A. Hegazi', topMid: 'M. Elneny', topAtt: 'M. Salah',
                scorers: ['Trezeguet', 'M. Mohamed', 'O. Marmoush']
            },
            {
                n: 'Nigeria', code: 'NGA', ovr: 84, style: 'Vertical', 
                star: 'V. Osimhen', starPos: 'FWD', 
                topDef: 'W. Troost-Ekong', topMid: 'A. Iwobi', topAtt: 'V. Osimhen',
                scorers: ['A. Lookman', 'V. Boniface', 'A. Iwobi']
            },
            {
                n: 'Algérie', code: 'ALG', ovr: 83, style: 'Technique', 
                star: 'R. Mahrez', starPos: 'MID', 
                topDef: 'A. Mandi', topMid: 'I. Bennacer', topAtt: 'R. Mahrez',
                scorers: ['B. Bounedjah', 'Y. Belaïli', 'H. Aouar']
            },
            {
                n: 'Cameroun', code: 'CMR', ovr: 82, style: 'Puissance', 
                star: 'V. Aboubakar', starPos: 'FWD', 
                topDef: 'Castelletto', topMid: 'Z. Anguissa', topAtt: 'V. Aboubakar',
                scorers: ['K. Toko Ekambi', 'B. Mbeumo', 'Z. Anguissa']
            },
            {
                n: 'Tunisie', code: 'TUN', ovr: 81, style: 'Bloc Bas', 
                star: 'Y. Msakni', starPos: 'MID', 
                topDef: 'M. Talbi', topMid: 'E. Skhiri', topAtt: 'Y. Msakni',
                scorers: ['E. Skhiri', 'H. Rafia', 'S. Jaziri']
            },
            {
                n: 'Mali', code: 'MLI', ovr: 81, style: 'Pressing', 
                star: 'Y. Bissouma', starPos: 'MID', 
                topDef: 'H. Traoré', topMid: 'Y. Bissouma', topAtt: 'L. Sinayoko',
                scorers: ['S. Koita', 'L. Sinayoko', 'K. Doumbia']
            },
            {
                n: 'RD Congo', code: 'RDC', ovr: 79, style: 'Dribbles', 
                star: 'C. Mbemba', starPos: 'DEF', 
                topDef: 'C. Mbemba', topMid: 'S. Moutoussamy', topAtt: 'Y. Wissa',
                scorers: ['Y. Wissa', 'C. Bakambu', 'G. Kakuta']
            },
            {
                n: 'Burkina Faso', code: 'BFA', ovr: 79, style: 'Vitesse', 
                star: 'E. Tapsoba', starPos: 'DEF', 
                topDef: 'E. Tapsoba', topMid: 'B. Touré', topAtt: 'B. Traoré',
                scorers: ['B. Traoré', 'D. Ouattara', 'I. Kaboré']
            },
            {
                n: 'Ghana', code: 'GHA', ovr: 78, style: 'Impact', 
                star: 'M. Kudus', starPos: 'MID', 
                topDef: 'M. Salisu', topMid: 'M. Kudus', topAtt: 'I. Williams',
                scorers: ['I. Williams', 'J. Ayew', 'A. Semenyo']
            },
            {
                n: 'Afrique du Sud', code: 'RSA', ovr: 78, style: 'Collectif', 
                star: 'P. Tau', starPos: 'FWD', 
                topDef: 'Mvala', topMid: 'T. Mokoena', topAtt: 'P. Tau',
                scorers: ['T. Zwane', 'L. Foster', 'T. Mokoena']
            },
            {
                n: 'Guinée', code: 'GUI', ovr: 77, style: 'Créativité', 
                star: 'S. Guirassy', starPos: 'FWD', 
                topDef: 'M. Diakhaby', topMid: 'N. Keita', topAtt: 'S. Guirassy',
                scorers: ['M. Bayo', 'N. Keita', 'A. Camara']
            },
            {
                n: 'Cap-Vert', code: 'CPV', ovr: 76, style: 'Transition', 
                star: 'R. Mendes', starPos: 'FWD', 
                topDef: 'Logan Costa', topMid: 'J. Monteiro', topAtt: 'R. Mendes',
                scorers: ['Bébé', 'J. Cabral', 'G. Rodrigues']
            },
            {
                n: 'Angola', code: 'ANG', ovr: 76, style: 'Bloc Bas', 
                star: 'G. Dala', starPos: 'FWD', 
                topDef: 'K. Gaspar', topMid: 'Fredy', topAtt: 'G. Dala',
                scorers: ['Mabululu', 'Fredy', 'Zini']
            },
            {
                n: 'Zambie', code: 'ZAM', ovr: 73, style: 'Vitesse', 
                star: 'P. Daka', starPos: 'FWD', 
                topDef: 'Sunzu', topMid: 'K. Kangwa', topAtt: 'P. Daka',
                scorers: ['F. Sakala', 'K. Kangwa', 'L. Banda']
            },
            {
                n: 'Guinée Eq.', code: 'GNQ', ovr: 75, style: 'Explosivité', 
                star: 'E. Nsue', starPos: 'FWD', 
                topDef: 'S. Coco', topMid: 'P. Ganet', topAtt: 'E. Nsue',
                scorers: ['I. Salvador', 'P. Ganet', 'J. Miranda']
            },
            {
                n: 'Mauritanie', code: 'MTN', ovr: 73, style: 'Lutte', 
                star: 'A. Kamara', starPos: 'FWD', 
                topDef: 'L. Ba', topMid: 'G. Fofana', topAtt: 'A. Kamara',
                scorers: ['H. Tanjy', 'P. Ba', 'I. Thiam']
            },
            {
                n: 'Gambie', code: 'GAM', ovr: 72, style: 'Défensif', 
                star: 'M. Barrow', starPos: 'FWD', 
                topDef: 'O. Colley', topMid: 'A. Jallow', topAtt: 'M. Barrow',
                scorers: ['A. Jallow', 'E. Colley', 'A. Ceesay']
            },
            {
                n: 'Namibie', code: 'NAM', ovr: 71, style: 'Solidité', 
                star: 'P. Shalulile', starPos: 'FWD', 
                topDef: 'L. Haukongo', topMid: 'P. Tjiueza', topAtt: 'P. Shalulile',
                scorers: ['D. Hotto', 'P. Tjiueza', 'A. Iimbondi']
            },
            {
                n: 'Tanzanie', code: 'TAN', ovr: 70, style: 'Courage', 
                star: 'M. Samatta', starPos: 'FWD', 
                topDef: 'I. Hamad', topMid: 'N. Miroshi', topAtt: 'M. Samatta',
                scorers: ['S. Msuva', 'F. Salum', 'N. Miroshi']
            },
            {
                n: 'Mozambique', code: 'MOZ', ovr: 70, style: 'Vitesse', 
                star: 'G. Catamo', starPos: 'MID', 
                topDef: 'Reinildo', topMid: 'G. Catamo', topAtt: 'Witi',
                scorers: ['Witi', 'Clésio', 'Stanley Ratifo']
            },
            {
                n: 'Ouganda', code: 'UGA', ovr: 71, style: 'Direct', 
                star: 'F. Miya', starPos: 'MID', 
                topDef: 'H. Lwaliwa', topMid: 'K. Aucho', topAtt: 'F. Miya',
                scorers: ['E. Okwi', 'M. Bayo', 'K. Aucho']
            }
        ];

        const INITIAL_PLAYERS = [
            { id: crypto.randomUUID(), name: "Y. Fofana", pos: "GK", ovr: 84, age: 24, role: 'starter', slot: 0, energy: 100 },
            { id: crypto.randomUUID(), name: "G. Konan", pos: "DEF", ovr: 80, age: 29, role: 'starter', slot: 1, energy: 100 },
            { id: crypto.randomUUID(), name: "E. Ndicka", pos: "DEF", ovr: 87, age: 25, role: 'starter', slot: 2, energy: 100 },
            { id: crypto.randomUUID(), name: "O. Kossounou", pos: "DEF", ovr: 85, age: 23, role: 'starter', slot: 3, energy: 100 },
            { id: crypto.randomUUID(), name: "G. Doué", pos: "DEF", ovr: 79, age: 22, role: 'starter', slot: 4, energy: 100 },
            { id: crypto.randomUUID(), name: "F. Kessié", pos: "MID", ovr: 88, age: 28, role: 'starter', slot: 5, energy: 100 },
            { id: crypto.randomUUID(), name: "S. Fofana", pos: "MID", ovr: 85, age: 29, role: 'starter', slot: 6, energy: 100 },
            { id: crypto.randomUUID(), name: "I. Sangaré", pos: "MID", ovr: 83, age: 27, role: 'starter', slot: 7, energy: 100 },
            { id: crypto.randomUUID(), name: "W. Zaha", pos: "FWD", ovr: 83, age: 32, role: 'starter', slot: 8, energy: 100 },
            { id: crypto.randomUUID(), name: "S. Haller", pos: "FWD", ovr: 84, age: 30, role: 'starter', slot: 9, energy: 100 },
            { id: crypto.randomUUID(), name: "A. Adingra", pos: "FWD", ovr: 85, age: 22, role: 'starter', slot: 10, energy: 100 },
            { id: crypto.randomUUID(), name: "B. Sangaré", pos: "GK", ovr: 77, age: 35, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "W. Boly", pos: "DEF", ovr: 81, age: 33, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "J. Seri", pos: "MID", ovr: 80, age: 33, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "M. Gradel", pos: "FWD", ovr: 79, age: 36, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "O. Diakité", pos: "FWD", ovr: 81, age: 21, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "O. Diomande", pos: "DEF", ovr: 84, age: 21, role: 'sub', slot: null, energy: 100 },
            { id: crypto.randomUUID(), name: "I. Doumbia", pos: "MID", ovr: 76, age: 26, role: 'sub', slot: null, energy: 100 }
        ];

        // Position du GK à 80% pour visibilité
        const FORMATIONS = {
            '4-3-3': { coords:[{x:41,y:80},{x:8,y:60},{x:30,y:65},{x:52,y:65},{x:74,y:60},{x:20,y:40},{x:41,y:45},{x:62,y:40},{x:8,y:15},{x:41,y:10},{x:74,y:15}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","FWD","FWD","FWD"]},
            '4-4-2': { coords:[{x:41,y:80},{x:8,y:60},{x:30,y:65},{x:52,y:65},{x:74,y:60},{x:8,y:38},{x:30,y:42},{x:52,y:42},{x:74,y:38},{x:25,y:10},{x:57,y:10}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","FWD","FWD"]},
            '3-5-2': { coords:[{x:41,y:80},{x:15,y:65},{x:41,y:68},{x:67,y:65},{x:5,y:42},{x:25,y:46},{x:41,y:52},{x:57,y:46},{x:77,y:42},{x:30,y:10},{x:52,y:10}], zones: ["GK","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD","FWD"]},
            '4-2-3-1': { coords:[{x:41,y:80},{x:8,y:62},{x:30,y:67},{x:52,y:67},{x:74,y:62},{x:30,y:48},{x:52,y:48},{x:10,y:30},{x:41,y:32},{x:72,y:30},{x:41,y:10}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD"]},
            '4-1-4-1': { coords:[{x:41,y:80},{x:8,y:62},{x:30,y:67},{x:52,y:67},{x:74,y:62},{x:41,y:50},{x:10,y:35},{x:30,y:37},{x:52,y:37},{x:72,y:35},{x:41,y:12}], zones: ["GK","DEF","DEF","DEF","DEF","MID","MID","MID","MID","MID","FWD"]},
            '5-4-1': { coords:[{x:41,y:80},{x:5,y:62},{x:23,y:65},{x:41,y:68},{x:59,y:65},{x:77,y:62},{x:10,y:38},{x:30,y:40},{x:52,y:40},{x:72,y:38},{x:41,y:12}], zones: ["GK","DEF","DEF","DEF","DEF","DEF","MID","MID","MID","MID","FWD"]}
        };

        const MATCH_COMMS = [
            "L'intensité monte d'un cran au milieu de terrain.", "L'arbitre surveille de près les duels physiques.", 
            "Le public scande le nom des Eléphants !", "Interception propre de la charnière centrale.", 
            "Belle relance vers l'avant, le jeu s'écarte.", "Le coach donne de la voix sur le bord de touche.", 
            "Contact rugueux au milieu, l'arbitre ne dit rien.", "L'ambiance est électrique aujourd'hui.", 
            "Débordement rapide on l'aile, centre à venir !", "Coup-franc dangereux à suivre à l'entrée de la surface.", 
            "Le bloc défensif ivoirien est difficile à percer.", "Le rythme s'accélère soudainement.", 
            "Parade exceptionnelle du portier !", "Faute tactique intelligente pour casser le contre.", 
            "Le ballon circule bien entre les lignes.", "Supporters en liesse dans les tribunes !", 
            "Tentative de loin ! Ça frôle le cadre adverse.", "Relance courte et maîtrisée.", 
            "Fatigue visible chez certains cadres de l'équipe.", "Le quart d'heure de vérité approche.", 
            "Geste technique superbe qui élimine un défenseur !", "Pressing haut étouffant pour l'adversaire.", 
            "Sortie autoritaire on le corner adverse.", "Transition offensive rapide lancée par le milieu.", 
            "La pluie commence à tomber on la pelouse.", "Erreur de relance... attention au contre !", 
            "Le stade entier retient son souffle.", "Coup de sifflet important de l'arbitre central.", 
            "Défense en bloc bas pour préserver le score.", "Longue transversale magnifique vers l'ailier.", 
            "Crampons affûtés on ce tacle glissé.", "Le génie tactique du coach est mis à l'épreuve.", 
            "Vent de panique dans la défense adverse.", "Solidité exemplaire de la part des latéraux.", 
            "Match de guerriers aujourd'hui on le terrain !", "Une-deux superbe dans les petits espaces.", 
            "Le poteau sauve le gardien on cette frappe !", "Contrôle orienté de classe internationale.", 
            "L'adversaire commence à douter sérieusement.", "Supporters et joueurs ne font qu'un.", 
            "Duel aérien remporté avec autorité par Ndicka.", "Coup-franc excentré qui peut amener le danger.", 
            "Ballon sorti en touche sous la pression.", "Le portier motive bruyamment ses troupes.", 
            "Chants de victoire qui descendent des travées !", "Occasion gâchée par un manque de précision.", 
            "Dégagement aux poings salvateur du gardien.", "Suspense total dans cette fin de rencontre.", 
            "Le match bascule dans une dimension tactique.", "Dernier assaut désespéré avant le sifflet !", 
            "Le manager effectue ses derniers ajustements.", "Le marquage à la culotte est impitoyable.", 
            "Une véritable partie de d'échecs on le gazon.", "Les drapeaux orange-blanc-vert s'agitent partout !", 
            "Un supporter traverse le terrain ! Interruption de jeu.", "Le stade rugit on ce tacle salvateur.", 
            "Le physique commence à prendre le dessus.", "Un exploit individuel est nécessaire pour débloquer le score.", 
            "L'arbitre consulte son assistant on cette faute.", "Temps additionnel annoncé, tout peut encore arriver !", 
            "Une frappe enroulée qui lèche le montant.", "Sortie de but pour le gardien adverse.", 
            "Le marquage est impitoyable dans la zone de vérité.", "L'arbitre appelle les deux capitaines au calme.", 
            "La transversale tremble encore !", "Changement tactique visible on le terrain.", 
            "Le public se lève on cette action de classe.", "Faute signalée à l'entrée de la surface de réparation.", 
            "Relance rapide à la main du gardien vers son latéral.", "CIV pousse fort dans les dernières minutes !", 
            "Dégagement en catastrophe par la défense adverse.", "Interception magnifique au milieu de terrain.", 
            "Le rythme s'accélère en cette fin de période.", "CIV invincibles aujourd'hui avec ce bloc compact !", 
            "Le stade retient son souffle on ce corner direct.", "Exploit individuel à suivre ?", 
            "Tir non cadré, ça passe largement au-dessus.", "Défense en bloc bas pour conserver le score.", 
            "Belle transversale qui change l'aile.", "Coup de sifflet pour une position de hors-jeu.", 
            "Le portier plonge dans les pieds de l'attaquant.", "CIV multiplie les passes courtes au milieu.", 
            "L'adversaire ne parvient plus à sortir de son camp.", "Contact rugueux, l'arbitre sort le carton jaune !", 
            "Le stade est en fusion on chaque dribble réussi.", "La possession est outrageusement ivoirienne.", 
            "L'attaquant s'emmêle les pinceaux au moment de tirer.", "Parade réflexe incroyable on la ligne !", 
            "Le coach adverse semble totalement désemparé.", "Ambiance de fête dans le stade, on entend les tambours !", 
            "Le pressing haut étouffe complètement la relance adverse.", "Quelle vision de jeu on cette passe en profondeur !", 
            "Corner à suivre pour les Eléphants.", "Le gardien s'impose dans les airs avec autorité.", 
            "Friction entre deux joueurs, l'arbitre intervient vite.", "Une prestation solide qui rassure les supporters.", 
            "Tout le stade pousse pour l'ouverture du score !", "CIV est en démonstration technique aujourd'hui.", 
            "Ballon dégagé loin devant pour souffler un peu.", "Le rideau défensif est infranchissable pour le moment.", 
            "CIV dicte son tempo avec une sérénité totale.", "Le manager ivoirien reste calme on son banc.", 
            "L'odeur de la victoire commence à monter dans le stade.", "Quel régal pour les yeux ces combinaisons !", 
            "L'arbitre vérifie le ballon avant de relancer.", "Les remplaçants terminent leur échauffement.", 
            "Un vent de panique souffle on les buts adverses.", "Le milieu de terrain est un véritable champ de bataille.", 
            "CIV fait preuve d'une maturité tactique impressionnante.", "Chaque touche de balle est un délice.", 
            "L'adversaire tente le tout pour le tout.", "Le stade est plein comme un oeuf pour ce choc.", 
            "Une frappe surpuissante qui finit dans les nuages.", "Le gardien relance très loin on son attaquant.", 
            "CIV reste en place malgré la pression adverse.", "Un tacle de dernier recours qui sauve l'équipe.", 
            "Le talent brut s'exprime enfin dans ce match.", "CIV gère parfaitement son avance pour le moment.",
            "Tacle assassin, mais l'arbitre ne bronche pas !", "Le gardien semble avoir un problème à la cuisse.",
            "Les supporters allument des fumigènes, quelle ambiance !", "L'arbitre regarde sa montre, la pression monte.",
            "Le sélectionneur adverse gesticule dans tous les sens.", "Le ballon a heurté le photographe derrière le but !",
            "Une chevauchée fantastique qui se termine en corner.", "La CIV impose un défi physique énorme.",
            "Le milieu de terrain adverse explose sous le pressing.", "Quel contrôle de la poitrine orienté, magnifique !",
            "La pelouse est un billard aujourd'hui.", "Le stade Ebimpé vibre à l'unisson.",
            "L'arbitre central discute avec son quatrième officiel.", "Le banc de touche bouillonne d'impatience.",
            "Une relance dans l'axe très risquée, mais ça passe.", "Le public siffle copieusement l'adversaire.",
            "Chaque corner est vécu comme un penalty par le stade.", "Le marquage est en zone on cette action.",
            "Quelle détente verticale on ce duel de la tête !", "Le match est haché par de nombreuses petites fautes.",
            "L'adversaire joue le contre à fond.", "Le bloc équipe est parfaitement coordonné.",
            "Un petit pont humiliant au milieu de terrain !", "Le défenseur dégage en touche sans réfléchir.",
            "Le meneur de jeu dicte le tempo du match.", "Les duels sont à la limite de la correction physique.",
            "Le gardien adverse gagne du temps on son dégagement.", "L'arbitre demande de recommencer le coup-franc.",
            "Une frappe de mule qui finit dans le petit filet extérieur !", "Le stade rugit de plaisir on ce geste technique.",
            "Le sélectionneur ivoirien appelle un remplaçant.", "Le capitaine réunit ses joueurs pour les motiver.",
            "Une erreur d'inattention qui aurait pu coûter cher.", "Le danger vient de partout pour l'adversaire !",
            "Le match entre dans sa phase critique.", "Un festival offensif se prépare peut-être.",
            "Le portier s'envole littéralement pour détourner ce cuir.", "L'ambiance est digne d'une finale de Coupe du Monde !",
            "Le jeu est arrêté pour soigner un joueur à terre.", "Le sélectionneur consulte ses notes tactiques.",
            "Un tacle millimétré qui soulève les foules.", "La possession tourne à la démonstration.",
            "L'adversaire n'a plus touché le ballon depuis 3 minutes.", "Un centre-tir vicieux qui termine on la barre !",
            "Le sifflet final approche, la tension est à son comble.", "Chaque passe est un poignard pour la défense adverse.",
            "Le génie de Yao Baba Ange Emmanuel opère encore.", "Une solidité à toute épreuve pour les Eléphants.",
            "La victoire se dessine petit à petit.", "Le stade est en transe complète !",
            "Une sortie de balle propre malgré le pressing adverse.", "Le jeu s'accélère on l'aile droite.",
            "Un centre fort devant le but qui ne trouve personne.", "Le gardien capte le ballon en deux temps.",
            "La défense adverse est au bord de la rupture.", "Un véritable cauchemar pour le latéral gauche adverse.",
            "Le match est d'une intensité rare pour un tournoi continental.", "Les joueurs donnent tout on le rectangle vert.",
            "Le maillot est mouillé, les guerriers sont là !", "Une passe aveugle qui déstabilise tout le bloc.",
            "Le ballon semble collé aux pieds de l'attaquant.", "Un sauvetage on la ligne de but, incroyable !",
            "Le poteau rentrant ? No, ça sort ! Quel dommage.", "La CIV est en contrôle total de l'événement.",
            "Une prestation qui fera date dans l'histoire de la nation.", "Le public ne s'arrête jamais de chanter.",
            "Un duel de Titans au milieu de la pelouse.", "Le sifflet retentit, mais c'est une faute pour nous !",
            "Le portier motive sa défense en criant fort.", "Le marquage est plus serré que jamais.",
            "Un éclair de génie pourrait tout débloquer.", "La CIV pousse, pousse et repousse encore !",
            "L'adversaire est acculé on son propre but.", "Un dégagement désespéré en corner.",
            "La montre tourne, les coeurs battent la chamade.", "Le staff technique est debout on le banc.",
            "Une communication parfaite entre les défenseurs centraux.", "Le portier ne prend aucun risque on cette frappe.",
            "Un changement tactique payant semble s'opérer.", "Le talent est partout aujourd'hui on le terrain.",
            "La fierté d'un peuple repose on ces 11 hommes.", "Une leçon de football est en cours.",
            "Le score ne reflète pas encore la domination.", "Le gardien adverse réalise le match de sa vie.",
            "Une glissade malheureuse qui redonne le ballon.", "Le pressing est coordonné comme une symphonie.",
            "Le public scande 'Allez les Eléphants' !", "Une frappe en pivot qui passe de peu à côté.",
            "Le sélectionneur encourage ses troupes du geste.", "Une interception vitale pour empêcher le face-à-face.",
            "Le jeu se déporte on l'autre aile rapidement.", "Une transversale de 50 mètres, un régal !",
            "Le latéral monte pour apporter le surnombre.", "Un repli défensif exemplaire de l'attaquant.",
            "Le manager regarde sa montre, le stress monte.", "Une ambiance de feu, le stade est en éruption !",
            "Le match est d'une propreté technique absolue.", "Une faute intelligente qui coupe le rythme adverse.",
            "Le gardien sort loin de ses buts pour dégager au pied.", "Une sérénité olympienne pour la défense ivoirienne.",
            "Le talent brut fait la différence on cette action.", "La CIV est plus proche que jamais du but !",
            "L'adversaire ne sait plus comment réagir tactiquement.", "Un vent d'optimisme souffle on les tribunes.",
            "Le match bascule dans la légende.", "Chaque seconde compte désormais.",
            "Un engagement de tous les instants.", "La sueur et les larmes pour la victoire.",
            "Le sifflet final sera une délivrance ou un drame.", "La CIV montre pourquoi elle est l'élite africaine.",
            "Une vision de jeu digne des plus grands meneurs.", "Le ballon circule avec une fluidité déconcertante.",
            "L'adversaire est totalement asphyxié par le pressing.", "Un arrêt réflexe de classe mondiale !",
            "Le stade est debout pour applaudir cette action.", "Une débauche d'énergie incroyable.",
            "Le manager Yao Baba peut être fier de ses hommes.", "La tactique est respectée à la lettre.",
            "Un exploit est possible en toute fin de match !", "Le sifflet de l'arbitre est le seul maître ici.",
            "La gloire attend les vainqueurs de ce choc.", "Le football africain est à son sommet aujourd'hui.",
            "Une maîtrise technique qui laisse pantois.", "L'adversaire tente un changement de dernière minute.",
            "Le portier réclame plus de concentration à ses gars.", "Un tacle propre qui récupère le ballon proprement.",
            "Le jeu est fluide, plaisant et très rapide.", "La CIV dicte sa loi on la pelouse du jour."
        ];

        // --- NOUVEAUX TABLEAUX DE COMMENTAIRES DYNAMIQUES ---
        const COMMS_WINNING = [
            "Le plan tactique de {MANAGER} fonctionne à merveille !",
            "Quelle masterclass de {MANAGER} aujourd'hui !",
            "Les supporters chantent le nom de {MANAGER} dans les tribunes !",
            "{MANAGER} reste impassible, mais son équipe déroule.",
            "La patte {MANAGER} se fait sentir sur cette action.",
            "C'est une leçon de football donnée par {MANAGER}.",
            "L'adversaire n'a aucune réponse face au système de {MANAGER}."
        ];

        const COMMS_LOSING = [
            "{MANAGER} hurle ses consignes pour réveiller les gars !",
            "{MANAGER} semble pensif sur son banc de touche.",
            "Il va falloir un coup de génie de {MANAGER} pour changer ça.",
            "{MANAGER} consulte son adjoint, un changement à venir ?",
            "Le visage fermé, {MANAGER} demande plus d'intensité."
        ];

        const COMMS_TACTICAL = {
            def: "{MANAGER} ordonne de fermer la boutique ! Tout le monde derrière !",
            att: "{MANAGER} fait de grands gestes : TOUT POUR L'ATTAQUE !",
            bal: "{MANAGER} demande de calmer le jeu et de reprendre la structure.",
            possession: "{MANAGER} veut qu'on prive l'adversaire de ballon.",
            counter: "{MANAGER} demande des transitions foudroyantes !",
            pressing: "Les joueurs répondent au pressing demandé par {MANAGER} !"
        };
        // --- NOUVEAU : BASE DE DONNÉES GAZETTE (VERSION XXL) ---
        const NEWS_RUMORS = [
            // TRANSFERTS
            "MERCATO : Le PSG préparerait une offre de 60M€ pour {PLAYER} !",
            "SCOOP : L'agent de {PLAYER} a été aperçu à Londres hier soir.",
            "RUMEUR : Al-Nassr veut offrir un pont d'or à {PLAYER}.",
            "TRANSFERT : Le Real Madrid supervise attentivement les progrès de {PLAYER}.",
            "OFFICIEL : {PLAYER} déclare 'vouloir rester à vie' en sélection.",
            "BOMBE : Chelsea prêt à lever la clause libératoire de {PLAYER}.",
            "INTÉRÊT : Le Bayern Munich en pince pour le profil de {PLAYER}.",
            "MLS : L'Inter Miami de Messi rêve d'attirer {PLAYER}.",
            "CONTRAT : Les négociations pour la prolongation de {PLAYER} sont au point mort.",
            "AGENT : 'Si mon client ne joue pas plus, on part', menace l'agent de {PLAYER}.",
            
            // LIFESTYLE & DRAMA
            "BUZZ : La nouvelle célébration de {PLAYER} devient virale sur TikTok.",
            "LIFESTYLE : {PLAYER} fait la une de Vogue Afrique ce mois-ci.",
            "DISCIPLINE : {PLAYER} arrivé en retard à l'entraînement, le coach est furieux.",
            "CLASH : Tension palpable entre {PLAYER} et le staff technique ce matin.",
            "SPONSOR : Nike et Puma se battent pour signer {PLAYER}.",
            "INSOLITE : {PLAYER} a oublié son passeport à l'hôtel avant le départ !",
            "LOOK : La nouvelle coiffure de {PLAYER} fait jaser sur la toile.",
            "SORTIE : {PLAYER} aperçu dans un maquis célèbre d'Abidjan très tard hier.",
            
            // SANTÉ & FORME
            "BLESSURE : Plus de peur que de mal pour {PLAYER} après un choc à l'entraînement.",
            "FORME : Le staff médical impressionné par les tests physiques de {PLAYER}.",
            "RÉCUPÉRATION : {PLAYER} s'entraîne à l'écart du groupe par précaution.",
            "DIÉTÉTIQUE : Le coach impose un régime strict à {PLAYER}."
        ];

        const NEWS_FANS = [
            // AMBIANCE STADE
            "SUPPORTERS : 'On veut voir du beau jeu, assez de la défense !'",
            "AMBIANCE : Les billets pour le prochain match s'arrachent au marché noir.",
            "ULTRAS : Le comité des supporters prépare un tifo géant.",
            "RUE : Abidjan est en ébullition avant le prochain choc.",
            "JOIE : Des scènes de liesse observées à Yamoussoukro !",
            "BRUIT : Les vuvuzelas résonnent déjà autour du stade.",
            "FERVEUR : Des milliers de fans attendent le bus des joueurs.",
            "STADE : La pelouse est jugée 'en parfait état' par les jardiniers.",
            
            // RÉSEAUX SOCIAUX & AVIS
            "SOCIAL : Le hashtag #ElephantsCAN est en top tendance sur X.",
            "SONDAGE : 88% des Ivoiriens font confiance au nouveau manager.",
            "CRITIQUE : 'Certains joueurs ne mouillent pas assez le maillot' selon un fan.",
            "COLÈRE : Des tags hostiles découverts près du centre d'entraînement.",
            "SOUVENIR : Les fans rendent hommage aux héros de 2015.",
            "VIRAL : Un petit supporter en pleurs consolé par {PLAYER}.",
            "MEME : Une photo du coach devient un mème viral sur Facebook.",
            "INSTAGRAM : {PLAYER} gagne 1 million d'abonnés en 24h.",
            "DÉBAT : Les fans divisés sur le choix du capitaine.",
            "LOVE : 'C'est la meilleure équipe depuis 10 ans' s'enflamme un supporter.",
            "CHANT : Un nouveau chant à la gloire de {PLAYER} inventé par les fans.",
            "MAILLOT : Rupture de stock des maillots floqués {PLAYER} en boutique."
        ];

        const NEWS_PUNDITS = [
            // MÉDIA & ANALYSE
            "CANAL+ : 'Cette équipe a le potentiel pour tout écraser' selon les experts.",
            "RADIO : Le système tactique du coach fait débat sur les ondes.",
            "PRESSE : 'Une génération dorée qui doit assumer son statut.'",
            "ANALYSE : La défense inquiète les observateurs avant le prochain match.",
            "TV : Didier Drogba demande plus d'intensité au milieu de terrain.",
            "CAF : La Côte d'Ivoire remonte au classement FIFA ce mois-ci.",
            "TACTIQUE : Les spécialistes louent le pressing mis en place.",
            "INTERVIEW : Le sélectionneur adverse tente de mettre la pression.",
            
            // LÉGENDES & EXPERTS
            "DÉBAT : 'Faut-il changer de gardien ?' La question qui divise.",
            "LÉGENDE : Yaya Touré rend visite aux joueurs pour les encourager.",
            "AVIS : 'Il manque un vrai tueur devant le but', analyse un ancien buteur.",
            "COACHING : 'Les remplacements sont trop tardifs', critique un consultant.",
            "PHYSIQUE : 'Ils vont craquer physiquement en fin de tournoi', prévient un expert.",
            "STAT : La Côte d'Ivoire possède la meilleure possession du tournoi.",
            "ARBITRAGE : La presse étrangère critique l'arbitrage du dernier match.",
            "MENTAL : 'Cette équipe a enfin trouvé un mental de guerrier'.",
            "JEUNESSE : Les experts impressionnés par la maturité des jeunes.",
            "HISTOIRE : 'On n'a pas vu un tel engouement depuis 1992'.",
            "ÉTRANGER : La BBC consacre un reportage au phénomène ivoirien.",
            "PRONOSTIC : 60% des journalistes voient la CIV en finale."
        ];

      const SVGS = {
            // --- UI GÉNÉRALE (Garder celles-ci) ---
            coins: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 inline-block align-middle"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="M17.22 15.22a2 2 0 1 0-2.83 2.83"/></svg>`,
            refresh: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>`,
            radar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 2v20"/><path d="M2 12h20"/><circle cx="12" cy="12" r="5"/></svg>`,
            play: `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-slate-900 inline-block align-middle"><polygon points="5 3 19 12 5 21 5 3"/></svg>`,
            shield: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
            zap: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            search: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>`,
            trophy: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17a1 1 0 0 0 2 0v-2.34"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
            layout: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>`,
            repeat: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>`,
            mic: `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>`,
            home: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            assistant: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 inline-block align-middle mb-0.5"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>`,

            // --- INFRASTRUCTURES (DESIGN PREMIUM) ---
            // Stade : Une arène vue de dessus avec des projecteurs
            infraStadium: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12h20"/><path d="M12 2a10 10 0 0 1 10 10v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8A10 10 0 0 1 12 2z"/><path d="M6 12v6"/><path d="M18 12v6"/><path d="M12 12v6"/><line x1="2" y1="12" x2="22" y2="12"/></svg>`,
            
            // Entraînement : Un haltère et un plot (Gym & Tactique)
            infraTraining: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 6.5h11"/><path d="M6 5v3"/><path d="M18 5v3"/><path d="M12 2v13"/><path d="M9 22l3-3 3 3"/><path d="M12 16a4 4 0 0 1 4 4v2H8v-2a4 4 0 0 1 4-4z"/></svg>`,
            
            // Médical : Une trousse de secours avec une croix
            infraMedical: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M9 12h6"/><path d="M12 9v6"/><path d="M16 4V2H8v2"/></svg>`,
           // --- NOUVELLE ICONE ---
            museum: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 22h16"/><path d="M8 22v-4"/><path d="M16 22v-4"/><path d="M4 10h16"/><path d="M12 2l-8 5v3h16V7L12 2z"/><path d="M6 10v8"/><path d="M10 10v8"/><path d="M14 10v8"/><path d="M18 10v8"/></svg>`,
            // --- STAFF (DESIGN PREMIUM) ---
            briefcase: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
            whistle: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M11 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>`,
            heartpulse: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>`,

            // --- AUTRES ---
            star: `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400 inline-block align-middle mb-0.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,
            
            ball: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="12" r="10"/><path d="M12 2l2.5 5h-5L12 2z"/><path d="M12 22l-2.5-5h5L12 22z"/><path d="M2.5 10l5 2-2 4-3-6z"/><path d="M21.5 10l-5 2 2 4 3-6z"/></svg>`,
            
            alert: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
            
            // CRAMPON OR (NOUVEAU DESIGN DYNAMIQUE)
           boot: `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400 inline-block align-middle mb-0.5"><path d="M20.2 12.5c-.8-1.5-2.5-2.5-4.2-2.5H13l-2.5-4H6C3.5 6 2 8.5 2 11v5c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-3.5z"/><path d="M5 18v3"/><path d="M9 18v3"/><path d="M13 18v3"/><path d="M17 18v3"/></svg>`,
            
            glove: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><rect x="6" y="4" width="12" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="12"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="16" x2="18" y2="16"/></svg>`,
            
            medal: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="16" r="5"/><path d="M12 11V3"/><path d="M7 6L5 3"/><path d="M17 6l2-3"/></svg>`,
            
            cup: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M8 2h8a4 4 0 0 1 4 4v3a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V6a4 4 0 0 1 4-4Z"/><path d="M12 13v6"/><path d="M8 22h8"/></svg>`,
            
            mega: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M2 12l5-5v10l-5-5Z"/><path d="M7 7h5l5-4v18l-5-4H7"/><path d="M19 8c1.5 1 2.5 3 2.5 4s-1 3-2.5 4"/></svg>`,
            
            globe: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>`,
            
            hand: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white inline-block align-middle mb-0.5"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>`
        };
        class EliteManager {
            constructor() {
                this.state = this.load() || this.initNewGame();
                this.match = { active: false };
                this.currentSwapSlot = null;
                this.isLiveCoaching = false;
                this.init();
            }

            initNewGame() {
            
                const ns = [...NATIONS_DB].sort(() => Math.random() - 0.5);
                const g = this.createGroups(ns);
                const std = this.initStd(ns, g);
                
                Object.keys(std).forEach(key => {
                    std[key].starAge = 25 + Math.floor(Math.random() * 8); 
                });

               return {
                    managerName: null, year: 2026, budget: 15.0, teamXP: 0, pastWinners: [], 
                    formation: '4-3-3',
                    players: JSON.parse(JSON.stringify(INITIAL_PLAYERS)),
                    scoutPool: [], matchIndex: 0, standings: std,
                    groups: g, trophies: 0, stage: 'groups',
                    viewingGroup: 'A',
                    goalScorers: [], playerRatings: [],
                    seasonsPlayed: 0, globalResults: [], knockout: {},
                    instructions: { 
    style: 'possession', 
    pressing: 'normal',
    passing: 'short',   // Nouveau : short / long
    aggression: 'safe', // Nouveau : safe / hard
    width: 'narrow',    // Nouveau : narrow / wide
    tempo: 'slow'       // Nouveau : slow / fast
   },
                    
                    // --- NOUVEAU : GESTION DES RÔLES ---
                    roles: { captain: null, penalty: null, freekick: null, corner: null },
                    // -----------------------------------

                    rareScoutUsed: false, news: [{id: Date.now(), text: "La Fédération Ivoirienne attend la signature du nouveau manager..."}],
                    infra: {
                        stadium: { level: 1, cost: 10, bonus: 0.5 },
                        training: { level: 1, cost: 5, bonus: 1 },
                        medical: { level: 1, cost: 8, bonus: 5 }
                    },
                    staff: {
                        director: { level: 1, salary: 2.0, name: "Directeur Sportif", desc: "Réduit les coûts de recrutement (-10%/niv)." },
                        assistant: { level: 1, salary: 1.5, name: "Entraîneur Adjoint", desc: "Booste le gain d'XP d'équipe (+10%/niv)." },
                        fitness: { level: 1, salary: 1.0, name: "Préparateur Physique", desc: "Remplaçants récupèrent mieux (+5%/niv)." }
                    }
                };
            }
             // --- AJOUTER CETTE FONCTION QUI MANQUE ---
            autoAssignRoles() {
                // On s'assure que l'objet roles existe
                if (!this.state.roles) this.state.roles = { captain: null, penalty: null, freekick: null, corner: null };

                const starters = this.state.players.filter(p => p.role === 'starter');
                if (starters.length === 0) return;

                // 1. Capitaine : Le plus âgé ou le plus fort mentalement
                const bestCap = [...starters].sort((a,b) => (b.age * 0.7 + b.ovr * 0.3) - (a.age * 0.7 + a.ovr * 0.3))[0];
                this.state.roles.captain = bestCap ? bestCap.id : null;

                // 2. Pénalty : Le meilleur Attaquant avec le plus gros OVR
                const bestPen = [...starters].sort((a,b) => b.ovr - a.ovr)[0];
                this.state.roles.penalty = bestPen ? bestPen.id : null;

                // 3. Coup Franc : Souvent un Milieu ou Attaquant technique
                const bestFK = [...starters].filter(p => p.pos !== 'GK').sort((a,b) => b.ovr - a.ovr)[0];
                this.state.roles.freekick = bestFK ? bestFK.id : null;
                
                // 4. Corner : Idem
                this.state.roles.corner = bestFK ? bestFK.id : null;
                
                this.save();
            }
             // --- GESTION DES RÔLES (UI) ---
            
            openRolesModal() {
                // Si les rôles ne sont pas initialisés, on le fait
                if (!this.state.roles.captain) this.autoAssignRoles();

                const c = document.getElementById('roles-list-container');
                c.innerHTML = '';

                const definitions = [
                    { id: 'captain', label: 'Capitaine', icon: '©', color: 'text-yellow-400', desc: 'Leadership et mental.' },
                    { id: 'penalty', label: 'Pénaltys', icon: 'PK', color: 'text-green-400', desc: 'Sang-froid face au but.' },
                    { id: 'freekick', label: 'Coups Francs', icon: 'CF', color: 'text-blue-400', desc: 'Précision de tir.' },
                    { id: 'corner', label: 'Corners', icon: 'CK', color: 'text-purple-400', desc: 'Centres et passes.' }
                ];

                definitions.forEach(def => {
                    const pid = this.state.roles[def.id];
                    const player = this.state.players.find(p => p.id === pid);
                    const pName = player ? player.name : "Non assigné";
                    const pOvr = player ? player.ovr : "--";

                    c.innerHTML += `
                        <div class="glass-panel p-4 rounded-xl border border-white/5 flex items-center justify-between hover:bg-slate-800 transition cursor-pointer" onclick="app.openRolePicker('${def.id}')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center font-teko text-2xl font-bold ${def.color} shadow-lg">
                                    ${def.icon}
                                </div>
                                <div>
                                    <div class="text-white font-bold uppercase text-xs tracking-wider">${def.label}</div>
                                    <div class="text-[10px] text-slate-500">${def.desc}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-orange-500 font-teko text-xl font-bold">${pName}</div>
                                <div class="text-[9px] text-slate-600 font-bold uppercase">Note: ${pOvr}</div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('roles-modal').classList.remove('hidden');
            }

            openRolePicker(roleType) {
                const modal = document.getElementById('role-picker-modal');
                const list = document.getElementById('role-picker-list');
                const title = document.getElementById('role-picker-title');
                
                title.innerText = `Choisir : ${roleType.toUpperCase()}`;
                list.innerHTML = '';
                
                // Seuls les titulaires peuvent avoir un rôle
                this.state.players.filter(p => p.role === 'starter').sort((a,b)=>b.ovr - a.ovr).forEach(p => {
                    list.innerHTML += `
                        <button onclick="app.setRole('${roleType}', '${p.id}')" class="w-full p-3 bg-slate-900 border border-slate-700 rounded-xl flex items-center justify-between hover:bg-orange-600 hover:border-orange-500 hover:text-white group transition">
                            <span class="font-bold text-xs uppercase">${p.name}</span>
                            <span class="font-teko text-xl text-slate-500 group-hover:text-white">${p.ovr}</span>
                        </button>
                    `;
                });

                modal.classList.remove('hidden');
            }

            setRole(type, pid) {
                this.state.roles[type] = pid;
                this.save();
                
                document.getElementById('role-picker-modal').classList.add('hidden');
                this.openRolesModal(); // Rafraîchir la liste
                this.renderPitch('pitch-cards-layer'); // Mettre à jour les badges sur le terrain
                this.toast("Rôle mis à jour !");
            }

            createGroups(ns) {
                const g = { 'A': [], 'B': [], 'C': [], 'D': [], 'E': [], 'F': [] };
                const keys = Object.keys(g);
                ns.forEach((n, i) => { const k = keys[Math.floor(i / 4)]; if (k) g[k].push(n); });
                return g;
            }

            initStd(ns, gs) {
                const std = {};
                ns.forEach(n => {
                    let gL = ''; for (let g in gs) { if (gs[g].some(t => t.n === n.n)) gL = g; }
                    std[n.n] = { n: n.n, code: n.code, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, grp: gL, ovr: n.ovr, style: n.style, star: n.star, starPos: n.starPos };
                });
                return std;
            }

            init() { 
                // --- 1. AJOUTE CE BLOC AU DÉBUT DE INIT() ---
             // Initialisation du synthétiseur (Web Audio API)
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.audioCtx = new AudioContext();
                this.ambianceNode = null; // Pour stocker le bruit du stade
    // ---------------------------------------------
                // --- PATCH DE COMPATIBILITÉ (SANS RAZ) ---
                
                // 1. Si le STAFF manque, on l'ajoute
                if (!this.state.staff) {
                    this.state.staff = {
                        director: { level: 1, salary: 2.0, name: "Directeur Sportif", desc: "Réduit les coûts de recrutement (-10%/niv)." },
                        assistant: { level: 1, salary: 1.5, name: "Entraîneur Adjoint", desc: "Booste le gain d'XP d'équipe (+10%/niv)." },
                        fitness: { level: 1, salary: 1.0, name: "Préparateur Physique", desc: "Remplaçants récupèrent mieux (+5%/niv)." }
                    };
                }
                // ... après le bloc staff ...

                // --- PATCH : Mise à jour des nouvelles consignes (Sauvegarde existante) ---
                if (!this.state.instructions.passing) {
                    this.state.instructions.passing = 'short';
                    this.state.instructions.aggression = 'safe';
                    this.state.instructions.width = 'narrow';
                    this.state.instructions.tempo = 'slow';
                }
                // -------------------------------------------------------------------------
                // ... (dans la fonction init, avec les autres "if")

                // PATCH : Si les RÔLES manquent (ancienne sauvegarde), on les crée
                if (!this.state.roles) {
                    this.state.roles = { captain: null, penalty: null, freekick: null, corner: null };
                    // On lance l'assignation auto tout de suite pour éviter les bugs
                    setTimeout(() => this.autoAssignRoles(), 500);
                }
                
                // ...

                // 2. Si le CLASSEMENT MVP manque, on le crée vide
                // <--- AJOUTER CECI
                if (!this.state.playerRatings) {
                    this.state.playerRatings = [];
                }
                // ----------------
                if (!this.state.goalScorers) {
                this.state.goalScorers = [];
                }
                // 3. Si le GROUPE PAR DÉFAUT manque
                if (!this.state.viewingGroup) {
                    let myG = 'A';
                    if (this.state.groups) {
                        for(let k in this.state.groups) {
                            if(this.state.groups[k].some(t => t.n === "Côte d'Ivoire")) myG = k;
                        }
                        if(Array.isArray(this.state.goalScorers)) {
        this.state.goalScorers = this.state.goalScorers.filter(g => g && g.n);
    }
                    }
                    this.state.viewingGroup = myG;
                }

                this.injectIcons(); 
                this.updateUI(); 
                
                if (!this.state.managerName) {
                    const modal = document.getElementById('welcome-modal');
                    if(modal) modal.classList.remove('hidden');
                }

                setInterval(() => this.save(), 5000); 
                this.goToView('inbox'); 
                window.app = this;
            }
// --- COLLEZ CE BLOC JUSTE APRÈS LA FIN DE LA FONCTION init() ---
            
            submitManagerName() {
                const input = document.getElementById('input-manager-name');
                const val = input.value.trim().toUpperCase();
                
                if (val.length < 3) return this.toast("Nom trop court !");
                
                this.state.managerName = val;

                // --- AJOUT : Création du flash info personnalisé ICI ---
                this.state.news.unshift({
                    id: Date.now(), 
                    text: `OFFICIEL : Lancement de la dynastie par ${val} !`
                });
                //
                
                // On cache le modal
                document.getElementById('welcome-modal').classList.add('hidden');
                
                this.save();
                this.updateUI();
                this.toast(`Bienvenue Coach ${val} !`);
            }

            // ---------------------------------------------------------------
            injectIcons() {
                for (const [id, svg] of Object.entries(SVGS)) {
                    const els = document.querySelectorAll(`[id^="icon-${id}"]`);
                    els.forEach(el => el.innerHTML = svg);
                }
            }

            save() { localStorage.setItem('aem_v9_5_ultra_legacy', JSON.stringify(this.state)); }
            load() { const s = localStorage.getItem('aem_v9_5_ultra_legacy'); return s ? JSON.parse(s) : null; }

           updateUI() {
                const bDisplay = document.getElementById('budget-display');
                const xDisplay = document.getElementById('team-xp-display');
                const hSubtitle = document.getElementById('header-subtitle');
                const xBar = document.getElementById('xp-bar-fill');
                
                // --- AJOUT : Gestion du nom du manager ---
                const mName = document.getElementById('header-manager-name');
                if (mName && this.state.managerName) {
                    mName.innerText = this.state.managerName;
                }
                // ----------------------------------------
                
                if(bDisplay) bDisplay.innerText = this.state.budget.toFixed(1) + " M€";
                if(xDisplay) xDisplay.innerText = this.state.teamXP + " XP";
                if(hSubtitle) hSubtitle.innerText = "SAISON " + this.state.year;
                if(xBar) xBar.style.width = Math.min(100, (this.state.teamXP / 25000) * 100) + "%";
                
                this.injectIcons();
            }

            goToView(v) {
                if (this.match.active && v !== 'match') { this.toast("Terminez le match d'abord !"); return; }
                
                // 1. Gestion des Vues (Cacher/Montrer)
                document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden'));
                const targetView = document.getElementById('view-' + v);
                if(targetView) targetView.classList.remove('hidden');
                
                // 2. Gestion de la Navigation (Boutons actifs)
                document.querySelectorAll('.btn-nav').forEach(btn => btn.classList.remove('active'));
                const nav = document.getElementById('nav-' + v); if(nav) nav.classList.add('active');
                
                // --- CORRECTION : DESSINER LES JOUEURS ET LES BOUTONS ---
                if (v === 'squad') {
                    // A. On affiche les joueurs sur le terrain
                    this.renderPitch('pitch-cards-layer');
                    
                    // B. On injecte les nouveaux boutons tactiques
                    const container = document.querySelector('#view-squad .grid.grid-cols-2.gap-3.mt-2');
                    if(container) container.innerHTML = this.renderTacticalButtons('prematch');
                }
                // --------------------------------------------------------

                if (v === 'training') this.renderTraining();
                if (v === 'calendar') this.renderCalendar();
                if (v === 'scout') this.renderScout();
                if (v === 'inbox') {
                    this.generateAmbientNews(); 
                    this.renderInbox();
                }
                if (v === 'infra') this.renderInfra();
            }

            clearNews() { this.state.news = []; this.renderInbox(); this.save(); this.toast("Archives vidées."); }

            generateRealName() {
                const f = FIRST_NAMES_DB[Math.floor(Math.random() * FIRST_NAMES_DB.length)];
                const l = LAST_NAMES_DB[Math.floor(Math.random() * LAST_NAMES_DB.length)];
                return Math.random() > 0.8 ? `${f} ${l}-Ange` : `${f} ${l}`;
            }

            renderPitch(layerId) {
                const container = document.getElementById(layerId); if(!container) return;
                container.innerHTML = '';
                const form = FORMATIONS[this.state.formation];
                for(let i=0; i<form.zones.length; i++) {
                    const p = this.state.players.find(x => x.role === 'starter' && x.slot === i);
                    const coord = form.coords[i];
                    const card = document.createElement('div');
                    const isOut = p && p.pos !== form.zones[i];
                    card.className = isOut ? 'player-card malus' : 'player-card';
                    card.style.left = coord.x + '%'; card.style.top = coord.y + '%';
                    card.onclick = () => { if(!this.match.active || this.isLiveCoaching) this.openSwapModal(i); };
                    if (p) {
                        const ovr = isOut ? Math.round(p.ovr * 0.7) : p.ovr;
                        const enW = p.energy || 100;
                        const enCol = enW > 70 ? '#22c55e' : (enW > 40 ? '#f59e0b' : '#ef4444');
                       
                        // 1. On définit le badge (Ceci est correct dans votre code)
                        let roleBadge = '';
                        if (this.state.roles) {
                            if (this.state.roles.captain === p.id) roleBadge = `<div class="absolute -top-2 -left-2 w-5 h-5 bg-yellow-500 text-slate-900 rounded-full flex items-center justify-center text-[10px] font-bold border border-white shadow-md z-30">C</div>`;
                            else if (this.state.roles.penalty === p.id) roleBadge = `<div class="absolute -top-2 -left-2 w-5 h-5 bg-green-500 text-white rounded-full flex items-center justify-center text-[8px] font-bold border border-white shadow-md z-30">P</div>`;
                        }

                        // 2. C'EST ICI QU'IL FAUT CORRIGER
                        // Supprimez le "${roleBadge}" qui traîne avant cette ligne
                        card.innerHTML = `
                            ${roleBadge} 
                            <div class="card-age">${p.age} ans</div>
                            <div class="card-ovr">${ovr}</div>
                            <div class="card-pos">${p.pos}</div>
                            <div class="card-energy"><div class="energy-fill" style="width:${enW}%; background:${enCol}"></div></div>
                            <div class="card-name">${p.name.split(' ').pop()}</div>
                        `;
                    } else { card.innerHTML = `<div class="card-ovr opacity-20">?</div>`; }
                    container.appendChild(card);
                }
                // --- MODIFICATION : BANC DE TOUCHE (Cartes Compactes Colorées) ---
        if (layerId === 'pitch-cards-layer') {
            const bC = document.getElementById('bench-list-container'); 
            bC.innerHTML = '';
            
            // On garde le conteneur en flex-wrap pour avoir des "cartes" côte à côte
            bC.className = "flex flex-wrap gap-2 justify-center pb-20"; 

            this.state.players.filter(p => p.role !== 'starter').forEach(p => {
                const it = document.createElement('div');
                
                // 1. Définition des COULEURS (La logique "Entraînement")
                // Vert = >80%, Orange = >50%, Rouge = <50%
                const borderColor = p.energy > 80 ? "border-green-500" : (p.energy > 50 ? "border-orange-500" : "border-red-500");
                const textColor = p.energy > 80 ? "text-green-400" : (p.energy > 50 ? "text-orange-400" : "text-red-400");
                const glow = p.energy > 80 ? "shadow-[0_0_10px_rgba(34,197,94,0.15)]" : "";

                // 2. Style de la Carte (On garde la forme "Bench Item" mais boostée)
                it.className = `relative min-w-[110px] h-[60px] bg-slate-900/90 border-l-4 ${borderColor} border-y border-r border-white/5 rounded-lg p-2 flex items-center gap-3 cursor-pointer hover:bg-slate-800 transition active:scale-95 ${glow}`;
                
                // Action au clic
                it.onclick = () => { this.toast(`Remplaçant : ${p.name} (${p.energy}% Forme)`); };

                // 3. Contenu Visuel
                it.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-10">
                        <span class="font-teko text-2xl ${textColor} font-bold leading-none">${p.ovr}</span>
                        <span class="text-[8px] text-slate-500 font-bold uppercase">${p.pos}</span>
                    </div>
                    
                    <div class="flex flex-col justify-center border-l border-white/10 pl-2">
                        <span class="text-[10px] font-bold text-white uppercase leading-tight truncate w-16">${p.name.split(' ').pop()}</span>
                        <div class="flex items-center gap-1 mt-0.5">
                            <div class="w-full h-1 bg-slate-800 rounded-full w-12 overflow-hidden">
                                <div class="h-full ${p.energy > 80 ? 'bg-green-500' : (p.energy > 50 ? 'bg-orange-500' : 'bg-red-500')}" style="width: ${p.energy}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                bC.appendChild(it);
            });

            const bcCount = document.getElementById('bench-count');
            if(bcCount) bcCount.innerText = `${this.state.players.filter(p => p.role !== 'starter').length}/20`;
            const avgEl = document.getElementById('squad-avg-ovr');
            if(avgEl) avgEl.innerText = Math.round(this.getTeamPower());
        }
            }

           getTeamPower() {
                const s = this.state.players.filter(p => p.role === 'starter'); 
                if (s.length < 1) return 0;
                
                const form = FORMATIONS[this.state.formation];
                let t = 0; 
                
                // Facteur temps : Plus le match avance, plus la fatigue pèse
                const currentTime = (this.match && this.match.active) ? this.match.time : 0;

                s.forEach(p => { 
                    // 1. Base OVR
                    let b = (p.pos !== form.zones[p.slot]) ? p.ovr * 0.7 : p.ovr; 
                    
                    // 2. MALUS FATIGUE DYNAMIQUE
                    // À partir de la 60e, l'énergie impacte violemment la perf
                    if (currentTime > 60) {
                        const fatigueImpact = (100 - p.energy) / 150; // Ex: 50% energy -> gros malus
                        b = b * (1 - fatigueImpact);
                    }
                    
                    // Malus de base si énergie très basse au départ
                    if(p.energy < 40) b *= 0.8; 
                    
                    t += b; 
                });

                return (t / 11) * (this.match.speechBoost || 1.0);
            }

            getOpponent() {
                if (this.state.stage === 'groups') {
                    const myG = this.state.standings['Côte d\'Ivoire'].grp;
                    const r = this.state.groups[myG].filter(n => n.n !== 'Côte d\'Ivoire');
                    const targetIdx = this.state.matchIndex % 3;
                    return this.state.standings[r[targetIdx].n];
                } else { return this.state.knockout[this.state.stage] || this.state.standings['Sénégal']; }
            }

            generateOpponent11(opp) {
                const squad = [];
                const formations = ['4-3-3', '4-4-2', '3-5-2'];
                const form = formations[Math.floor(Math.random() * formations.length)];
                
                // Structure basique par ligne selon la formation
                let structure = { GK: 1, DEF: 4, MID: 3, FWD: 3 }; 
                if (form === '4-4-2') structure = { GK: 1, DEF: 4, MID: 4, FWD: 2 };
                if (form === '3-5-2') structure = { GK: 1, DEF: 3, MID: 5, FWD: 2 };

                // Fonction pour créer un joueur IA
                const makePlayer = (pos, isStar = false, starName = null) => {
                    let ovr = opp.ovr + (Math.floor(Math.random() * 6) - 3); // OVR varié
                    if (isStar) ovr += 3; // Les stars sont plus fortes
                    return {
                        name: starName || this.generateRealName(),
                        pos: pos,
                        ovr: ovr,
                        isStar: isStar
                    };
                };

                // 1. On identifie les stars réelles à placer
                const keyPlayers = [
                    { name: opp.star, pos: opp.starPos },
                    { name: opp.topDef, pos: 'DEF' },
                    { name: opp.topMid, pos: 'MID' },
                    { name: opp.topAtt, pos: 'FWD' }
                ];
                
                // Dédoublonnage (ex: si la Star est aussi le Top Attaquant)
                const uniqueKeys = [];
                const seenNames = new Set();
                keyPlayers.forEach(p => {
                    if(!seenNames.has(p.name)) {
                        uniqueKeys.push(p);
                        seenNames.add(p.name);
                    }
                });

                // 2. Remplissage de l'équipe
                squad.push(makePlayer('GK')); structure.GK--; // Gardien

                // Placement des Stars
                uniqueKeys.forEach(key => {
                    if (structure[key.pos] > 0) {
                        squad.push(makePlayer(key.pos, true, key.name));
                        structure[key.pos]--;
                    }
                });

                // Combler les trous avec des joueurs générés
                ['DEF', 'MID', 'FWD'].forEach(pos => {
                    while (structure[pos] > 0) {
                        squad.push(makePlayer(pos));
                        structure[pos]--;
                    }
                });

                // Tri pour l'affichage (GK - DEF - MID - FWD)
                const order = { 'GK': 1, 'DEF': 2, 'MID': 3, 'FWD': 4 };
                return squad.sort((a,b) => order[a.pos] - order[b.pos]);
            }

           startMatch() {
                // 1. Vérifications
                const starters = this.state.players.filter(p => p.role === 'starter');
                if (starters.length < 11) return this.toast("11 joueurs requis !");
                
                const opp = this.getOpponent();
                if (!opp) return this.toast("Erreur tirage.");
                
                // 2. Génération de l'adversaire (Le fameux Onze)
                const oppXI = this.generateOpponent11(opp);
                
                // 3. Préparation des données du match (SANS lancer le timer)
                this.match = { 
                    active: false, // Pas encore actif !
                    time: 0, score: [0, 0], 
                    opp: opp, 
                    oppSquad: oppXI,
                    timer: null, 
                    tactic: 'bal', speechBoost: 1.0, 
                    stats: { shots: 0, shotsAway: 0 },
                    penalties: null
                };

                // 4. Remplissage de l'interface "Face-à-Face"
                const pModal = document.getElementById('preview-modal');
                const pHome = document.getElementById('preview-home-list');
                const pAway = document.getElementById('preview-away-list');
                const pCode = document.getElementById('preview-opp-code');
                
                if(pCode) pCode.innerText = opp.code;
                
                // Remplir ma liste (CIV)
                pHome.innerHTML = '';
                // Tri par position pour l'affichage (GK d'abord)
                const posOrder = { 'GK': 1, 'DEF': 2, 'MID': 3, 'FWD': 4 };
                starters.sort((a,b) => posOrder[a.pos] - posOrder[b.pos]).forEach(p => {
                    pHome.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded bg-slate-800/50 border border-white/5">
                            <div class="flex items-center gap-2">
                                <span class="text-[8px] font-bold text-orange-500 w-5">${p.pos}</span>
                                <span class="text-[10px] font-bold text-white truncate max-w-[80px]">${p.name.split(' ').pop()}</span>
                            </div>
                            <div class="font-teko text-lg text-white">${p.ovr}</div>
                        </div>`;
                });

                // Remplir liste ADVERSAIRE
                pAway.innerHTML = '';
                oppXI.forEach(p => {
                    // Design spécial pour les STARS adverses (Bordure dorée ou brillante)
                    const isStar = p.isStar ? 'border-yellow-500/30 bg-yellow-500/10' : 'border-white/5 bg-slate-800/50';
                    const nameColor = p.isStar ? 'text-yellow-100' : 'text-slate-300';
                   const icon = p.isStar ? SVGS.star : '';
                    
                    pAway.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded border ${isStar}">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold ${nameColor} truncate max-w-[80px]">${p.name} ${icon}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-teko text-lg text-white">${p.ovr}</span>
                                <span class="text-[8px] font-bold text-slate-500 w-5 text-right">${p.pos}</span>
                            </div>
                        </div>`;
                });

                // 5. Afficher le modal
                if(pModal) pModal.classList.remove('hidden');
            }

            kickOff() {
                // 1. Fermer le modal de preview
                const pModal = document.getElementById('preview-modal');
                if(pModal) pModal.classList.add('hidden');
                
                // GESTION AUDIO
            this.stopMenuMusic();       // On coupe la musique funky
            this.synthCrowdDynamic();   // On lance la foule réaliste
            this.playSound('whistle');  // Sifflet

                // 2. Activer le match (Lancement du Timer)
                this.match.active = true;
                this.match.timer = setInterval(() => this.tick(), 1000);
                
                // 3. Reset de l'interface du match
                const sHome = document.getElementById('score-home'); if(sHome) sHome.innerText = '0';
                const sAway = document.getElementById('score-away'); if(sAway) sAway.innerText = '0';
                const mTimer = document.getElementById('match-timer'); if(mTimer) mTimer.innerText = '00:00';
                const mBadge = document.getElementById('match-opp-badge'); if(mBadge) mBadge.innerText = this.match.opp.code;
                
                const cLog = document.getElementById('commentary-log'); if(cLog) cLog.innerHTML = '';
                const htO = document.getElementById('ht-overlay'); if(htO) htO.classList.remove('active');
                
                // 4. Aller à la vue match
                this.goToView('match');
                this.updateMatchInstructionsUI();
                
                this.addCommentary(`${SVGS.mega} COUP D'ENVOI ! La Côte d'Ivoire affronte le ${this.match.opp.n}.`);
            }

            updateMatchAdvice() {
                const box = document.getElementById('match-assistant-msg');
                if (!box) return;

                const t = this.match.time;
                const s = this.match.score;
                const diff = s[0] - s[1]; // Positif = on gagne, Négatif = on perd
                
                // On récupère la possession actuelle (depuis le DOM ou le calcul)
                const possText = document.getElementById('poss-val-home').innerText;
                const poss = parseInt(possText) || 50;

                let msg = "";
                let urgency = "normal"; // normal, warning, critical

                // --- LOGIQUE DE L'ASSISTANT ---

                // 1. DÉBUT DE MATCH (0-15min)
                if (t < 15) {
                    msg = "Phase d'observation. Restez bien en place et faites circuler le ballon.";
                }
                // 2. FIN DE MATCH (80min+)
                else if (t > 80) {
                    if (diff === 0) {
                        msg = "Le match nul se joue maintenant. Un exploit individuel ou on ferme la boutique ?";
                        urgency = "warning";
                    } else if (diff === 1) {
                        msg = "On tient le score ! Passez en mode DÉFENSIF et gagnez du temps.";
                        urgency = "warning";
                    } else if (diff === -1) {
                        msg = "C'est maintenant ou jamais ! Passez en ASSAUT TOTAL !";
                        urgency = "critical";
                    } else if (diff <= -2) {
                        msg = "C'est compliqué... Essayons de sauver l'honneur au moins.";
                    } else {
                        msg = "Le match est plié. Gérez la fatigue des cadres.";
                    }
                }
                // 3. SCÉNARIOS SPÉCIFIQUES (Reste du match)
                else {
                    if (poss < 40) {
                        msg = "On court après le ballon ! Augmentez le PRESSING ou jouez en CONTRE.";
                        urgency = "warning";
                    } else if (poss > 65 && diff <= 0) {
                        msg = "Possession stérile. Il faut prendre plus de risques offensifs (ASSAUT).";
                    } else if (diff < 0) {
                        msg = "On est menés. Ne paniquez pas, mais il faut monter le bloc d'un cran.";
                    } else if (diff > 0) {
                        msg = "On contrôle. Forcez-les à sortir pour les piquer en contre.";
                    } else {
                        msg = "Match équilibré. C'est la bataille du milieu de terrain qui décidera tout.";
                    }
                }

                // Affichage avec couleurs dynamiques
                const colorClass = urgency === 'critical' ? 'text-red-400' : (urgency === 'warning' ? 'text-orange-400' : 'text-blue-300');
                
                box.innerHTML = `
                    <div class="flex items-start gap-3 animate-pulse-slow">
                        <div class="mt-0.5 p-1.5 bg-slate-800 rounded-full border border-slate-600 shadow-sm shrink-0">
                            ${SVGS.assistant}
                        </div>
                        <div>
                            <div class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mb-0.5">Conseil Adjoint</div>
                            <div class="text-[10px] font-medium leading-tight ${colorClass} italic">"${msg}"</div>
                        </div>
                    </div>
                `;
            }

            tick() {
                // 1. Calculs Préliminaires
                const myPower = this.getTeamPower();
                const oppPower = this.match.opp.ovr || 70; 
                const powerRatio = myPower / oppPower;

                // --- TACTIQUE 1 : LE MATRIX (Pierre-Feuille-Ciseaux) ---
                let offensiveFactor = (this.match.tactic === 'att' ? 1.7 : (this.match.tactic === 'def' ? 0.6 : 1));
                if (this.state.instructions.style === 'counter') offensiveFactor *= 1.3;

                const myStyle = this.state.instructions.style; 
                const oppStyle = this.match.opp.style; 
                let tacticalBonus = 1.0;

                // Logique : Possession bat Bloc Bas / Contre bat Pressing etc.
                if (myStyle === 'possession') {
                    if (['Bloc Bas', 'Défensif', 'Lutte'].includes(oppStyle)) tacticalBonus = 1.25; 
                    else if (['Pressing', 'Vitesse', 'Vertical'].includes(oppStyle)) tacticalBonus = 0.85; 
                }
                else if (myStyle === 'counter') {
                    if (['Pressing', 'Offensif', 'Tiki-Taka'].includes(oppStyle)) tacticalBonus = 1.25; 
                    else if (['Bloc Bas', 'Défensif'].includes(oppStyle)) tacticalBonus = 0.85; 
                }

                // --- TACTIQUE 2 : LES 4 NOUVELLES CONSIGNES ---
                const inst = this.state.instructions;
                
                // A. PASSES
                let passBonus = 1.0;
                if (inst.passing === 'short') passBonus = 0.90; // Construction lente (moins de buts)
                else passBonus = 1.15; // Jeu long/direct (plus d'occasions)

                // B. LARGEUR
                let widthBonus = 1.0;
                if (inst.width === 'wide') widthBonus = 1.10; // On écarte = espaces

                // C. TEMPO
                let tempoMult = 1.0;
                if (inst.tempo === 'fast') tempoMult = 1.2; // Match fou

                // D. AGRESSIVITÉ (Effet visuel)
                if (inst.aggression === 'hard' && Math.random() < 0.03) {
                     this.addCommentary("Gros impact physique dans les duels !");
                }

                // --- CALCUL FINAL DE LA CHANCE ---
                let chance = 0.012 * offensiveFactor * tacticalBonus * passBonus * widthBonus * tempoMult;

                this.match.time++;

                // --- IA INTELLIGENTE ---
                if (this.match.time === 65 && this.match.score[1] < this.match.score[0]) {
                    this.addCommentary(`${SVGS.whistle} L'adversaire joue le tout pour le tout !`);
                    this.match.opp.ovr += 4; 
                    chance *= 1.2; 
                }

                // --- SIMULATION POSSESSION ---
                let currentPoss = 50 + (powerRatio > 1 ? 5 : -5) + Math.floor(Math.random() * 10 - 5);
                if(inst.style === 'possession') currentPoss += 5;
                if(inst.passing === 'short') currentPoss += 4; // Passes courtes = + Possession
                currentPoss = Math.max(20, Math.min(80, currentPoss)); 
                 
                // Mise à jour UI Possession
                const possBar = document.getElementById('possession-home-bar');
                if(possBar) possBar.style.width = currentPoss + '%';
                const possValH = document.getElementById('poss-val-home');
                if(possValH) possValH.innerText = currentPoss + '%';
                const possValA = document.getElementById('poss-val-away');
                if(possValA) possValA.innerText = (100 - currentPoss) + '%';

                // Simulation Tirs
                if (Math.random() < 0.08 * tempoMult) { // Le tempo influe sur le nombre de tirs
                    if (Math.random() < (currentPoss/100)) this.match.stats.shots++; 
                    else this.match.stats.shotsAway++;
                    
                    const shH = document.getElementById('stats-shots-home');
                    if(shH) shH.innerText = this.match.stats.shots;
                    const shA = document.getElementById('stats-shots-away');
                    if(shA) shA.innerText = this.match.stats.shotsAway;
                }

                // 2. BUT CÔTE D'IVOIRE
                if (Math.random() < chance * powerRatio) {
                    this.match.score[0]++; 
                    this.match.stats.shots++; 
                    const sh = document.getElementById('score-home'); if(sh) sh.innerText = this.match.score[0];
                    this.playSound('goal');
                    
                    // Buteur
                    const s = this.state.players.filter(p=>p.role==='starter');
                    const scorer = s.length > 0 ? s[Math.floor(Math.random()*s.length)] : {name:"Inconnu"};
                    this.registerGoal(scorer.name, "Côte d'Ivoire");
                    this.showGoalAnim(scorer.name); 
                    this.addCommentary(`${SVGS.ball} BUT !! ${scorer.name} trouve la faille !`);
                }
                
                // 3. BUT ADVERSAIRE
                // Risque accru si on joue Large ou Rapide
                let oppRisk = 1.0;
                if (inst.width === 'wide') oppRisk *= 1.1;
                if (inst.tempo === 'fast') oppRisk *= 1.1;

                if (Math.random() < chance * (1 / powerRatio) * oppRisk) {
                    this.match.score[1]++; 
                    this.match.stats.shotsAway++; 
                    const sa = document.getElementById('score-away'); if(sa) sa.innerText = this.match.score[1];
                    this.registerGoal(this.match.opp.star, this.match.opp.n);
                    this.addCommentary(`${SVGS.alert} But pour ${this.match.opp.n}.`);
                }

                // 4. Commentaires & Fin
                if (Math.random() < 0.18) this.addCommentary(MATCH_COMMS[Math.floor(Math.random() * MATCH_COMMS.length)]);
                
                if (this.match.time % 5 === 0 || this.match.time === 1) this.updateMatchAdvice();
                const timerEl = document.getElementById('match-timer');
                if (timerEl) timerEl.innerText = (this.match.time < 10 ? '0' : '') + this.match.time + ":00";

                if (this.match.time === 45) { clearInterval(this.match.timer); const hto = document.getElementById('ht-overlay'); if(hto) hto.classList.add('active'); }
                if (this.match.time >= 90) this.finishMatch();
            }

            giveSpeech(t) {
                const b = { motivate: 1.05, shake: 1.15, calm: 1.10 };
                this.match.speechBoost = b[t]; 
                const hto = document.getElementById('ht-overlay'); if(hto) hto.classList.remove('active');
                this.addCommentary(`<i>${SVGS.mega} Coaching : Les mots du manager ont boosté l'équipe (+${Math.round((b[t]-1)*100)}%).</i>`);
                this.match.timer = setInterval(() => this.tick(), 1000);
            }

            // --- NOUVEAU SYSTÈME DE TIRS AU BUT INTERACTIF ---

            initPenaltyShootout() {
                // 1. Initialisation des variables
                this.penState = {
                    round: 0,
                    score: [0, 0],
                    history: [[], []], // 1 = But, 0 = Raté
                    shootersUsed: [],
                    winner: null
                };

                // 2. Préparation de l'interface
                document.getElementById('pen-score-home').innerText = "0";
                document.getElementById('pen-score-away').innerText = "0";
                document.getElementById('pen-opp-code').innerText = this.match.opp.code;
                document.getElementById('pen-history-home').innerHTML = '';
                document.getElementById('pen-history-away').innerHTML = '';
                document.getElementById('pen-result-msg').classList.add('hidden');
                document.getElementById('pen-selection-zone').classList.remove('hidden');

                // 3. Affichage
                document.getElementById('penalty-view').classList.remove('hidden');
                this.renderPenaltyShooters();
            }

            renderPenaltyShooters() {
                const list = document.getElementById('pen-shooters-list');
                list.innerHTML = '';

                // On prend les joueurs titulaires qui n'ont pas encore tiré
                const candidates = this.state.players.filter(p => 
                    p.role === 'starter' && !this.penState.shootersUsed.includes(p.id)
                ).sort((a,b) => b.ovr - a.ovr); // Les meilleurs en premier

                candidates.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = "p-3 bg-slate-800 border border-slate-700 rounded-xl flex items-center justify-between hover:bg-orange-600 hover:border-orange-500 hover:text-white group transition active:scale-95";
                    btn.innerHTML = `
                        <div class="flex flex-col text-left">
                            <span class="font-teko text-xl leading-none uppercase">${p.name.split(' ').pop()}</span>
                            <span class="text-[9px] font-bold text-slate-500 group-hover:text-orange-200">${p.pos}</span>
                        </div>
                        <div class="font-teko text-2xl text-slate-600 group-hover:text-white">${p.ovr}</div>
                    `;
                    btn.onclick = () => this.playPenaltyRound(p);
                    list.appendChild(btn);
                });
            }

            playPenaltyRound(player) {
                // Bloquer l'interface
                document.getElementById('pen-selection-zone').classList.add('hidden');
                const msgBox = document.getElementById('pen-result-msg');
                const msgText = document.getElementById('pen-action-text');
                msgBox.classList.remove('hidden');

                // --- 1. TIR DU JOUEUR (CIV) ---
                // Calcul : OVR Joueur vs OVR Gardien Adverse (simulé ~80)
                let successChance = 0.75 + ((player.ovr - 80) * 0.01);
                if (player.pos === 'FWD') successChance += 0.10; // Bonus Attaquants
                if (player.energy < 50) successChance -= 0.10;   // Malus Fatigue

                const isGoalHome = Math.random() < successChance;
                
                // Animation texte
                msgText.innerText = `... ${player.name} s'élance ...`;
                msgText.className = "font-teko text-4xl text-slate-400 uppercase italic animate-pulse";

                setTimeout(() => {
                    if (isGoalHome) {
                        msgText.innerText = "BUT !!!";
                        msgText.className = "font-teko text-6xl text-green-500 uppercase italic animate-bounce";
                        this.penState.score[0]++;
                        this.penState.history[0].push(1);
                        this.playSound('goal');
                    } else {
                        msgText.innerText = "RATÉ !";
                        msgText.className = "font-teko text-6xl text-red-500 uppercase italic shake";
                        this.penState.history[0].push(0);
                        this.playSound('whistle');
                    }
                    this.updatePenaltyUI();
                    this.penState.shootersUsed.push(player.id);

                    // --- 2. TIR DE L'IA (ADVERSAIRE) ---
                    setTimeout(() => {
                        msgText.innerText = "L'adversaire tire...";
                        msgText.className = "font-teko text-4xl text-slate-400 uppercase italic";

                        setTimeout(() => {
                            // --- CORRECTION : PRISE EN COMPTE DE VOTRE GARDIEN ---
                            
                            // 1. On trouve votre gardien titulaire
                            const myGK = this.state.players.find(p => p.role === 'starter' && p.pos === 'GK');
                            const gkRating = myGK ? myGK.ovr : 70; // 70 par défaut si pas de gardien (bug)
                            
                            // 2. Note du tireur adverse (Moyenne de l'équipe adverse)
                            const oppShooterRating = this.match.opp.ovr;

                            // 3. Calcul de la difficulté pour l'IA
                            // Base de 70% (au lieu de 75%)
                            let aiChance = 0.70; 
                            
                            // Si votre gardien est meilleur que le tireur, l'IA perd des chances
                            // Ex: Gardien 85 vs Tireur 80 = -5% de chance de but
                            aiChance += (oppShooterRating - gkRating) * 0.01;

                            // Plafonds pour éviter les bugs (Min 30%, Max 90%)
                            aiChance = Math.max(0.30, Math.min(0.90, aiChance));

                            const isGoalAway = Math.random() < aiChance;
                            
                            if (isGoalAway) {
                                msgText.innerText = "L'adversaire marque.";
                                msgText.className = "font-teko text-5xl text-red-400 uppercase italic";
                                this.penState.score[1]++;
                                this.penState.history[1].push(1);
                            } else {
                                // On félicite le gardien par son nom !
                                const gkName = myGK ? myGK.name.split(' ').pop() : "GARDIEN";
                                msgText.innerText = `ARRÊT DE ${gkName.toUpperCase()} !`;
                                msgText.className = "font-teko text-5xl text-green-500 uppercase italic";
                                this.penState.history[1].push(0);
                                this.playSound('stadium'); // Foule contente
                            }
                            
                            this.updatePenaltyUI();
                            this.penState.round++;

                            // VÉRIFICATION FIN DU JEU
                            if (this.checkPenaltyWinner()) {
                                setTimeout(() => this.endPenaltyShootout(), 2000);
                            } else {
                                setTimeout(() => {
                                    msgBox.classList.add('hidden');
                                    document.getElementById('pen-selection-zone').classList.remove('hidden');
                                    this.renderPenaltyShooters();
                                }, 1500);
                            }
                        }, 1500);
                    }, 1500);
                }, 1500);
            }

            updatePenaltyUI() {
                document.getElementById('pen-score-home').innerText = this.penState.score[0];
                document.getElementById('pen-score-away').innerText = this.penState.score[1];

                // Mise à jour des petits ronds (Historique)
                const buildDots = (hist, id) => {
                    const el = document.getElementById(id);
                    el.innerHTML = '';
                    hist.forEach(res => {
                        el.innerHTML += `<div class="w-4 h-4 rounded-full ${res ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500 opacity-50'}"></div>`;
                    });
                };
                buildDots(this.penState.history[0], 'pen-history-home');
                buildDots(this.penState.history[1], 'pen-history-away');
            }

            checkPenaltyWinner() {
                const r = this.penState.round;
                const s1 = this.penState.score[0];
                const s2 = this.penState.score[1];
                const h1 = this.penState.history[0]; // Liste des tirs déjà effectués

                // Règle des 5 premiers tirs
                // Si une équipe ne peut plus rattraper l'autre mathématiquement
                if (h1.length <= 5) {
                    const remainingShots = 5 - h1.length;
                    // Cas 1 : CIV gagne (Adversaire ne peut plus rattraper)
                    // Note : L'adversaire a tiré AUTANT de fois que CIV à ce stade du code (car on check après le tir IA)
                    // Donc remainingShots est le même pour les deux.
                    if (s1 > s2 + remainingShots) return true;
                    if (s2 > s1 + remainingShots) return true;
                    
                    if (h1.length === 5 && s1 !== s2) return true; // Fin des 5 tirs et pas égalité
                }
                // Mort subite (après 5 tirs)
                else {
                    if (s1 !== s2) return true;
                }
                return false;
            }

            endPenaltyShootout() {
                // 1. On cache l'écran des pénaltys
                document.getElementById('penalty-view').classList.add('hidden');
                
                // 2. On sauvegarde le score des TAB dans les données du match
                this.match.penalties = this.penState.score;
                
                // 3. On détermine qui a gagné (CIV ou OPP)
                const isWin = this.match.penalties[0] > this.match.penalties[1];
                const winnerCode = isWin ? 'CIV' : 'OPP';

                // 4. IMPORTANT : On appelle la fonction standard finishMatch
                // Elle va gérer l'affichage de l'adversaire, le titre "VICTOIRE (TAB)" et les gains
                this.finishMatch(winnerCode);
            }

           finishMatch(winnerOverride = null) {
                clearInterval(this.match.timer); 
                this.match.active = false;

                if (!winnerOverride) {
                    this.stopCrowd();
                    this.playSound('whistle');
                    setTimeout(() => { this.startMenuMusic(); }, 2000);
                }

                const scoreHome = this.match.score[0];
                const scoreAway = this.match.score[1];
                let isWin = scoreHome > scoreAway;
                let isDraw = scoreHome === scoreAway;

                // Gestion Tirs au but
                if (winnerOverride) { isWin = (winnerOverride === 'CIV'); isDraw = false; }
                else if (isDraw && this.state.stage !== 'groups') {
                    setTimeout(() => this.initPenaltyShootout(), 1000);
                    return; 
                }

                // Calcul Notes
                this.state.players.forEach(p => { if (p.role === 'starter') this.registerRating(p.name, "Côte d'Ivoire", isWin ? 7.5 : 6.0); });

                // --- MISE À JOUR DE L'INTERFACE DE FIN (C'est ici la correction) ---
                
                // 1. Score et Titre
                const esd = document.getElementById('end-score-display'); if(esd) esd.innerText = `${scoreHome}-${scoreAway}`;
                const titleEl = document.getElementById('end-title');
                if (isWin) { titleEl.innerText = "VICTOIRE"; titleEl.className = "font-teko text-6xl text-green-500 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }
                else if (isDraw) { titleEl.innerText = "MATCH NUL"; titleEl.className = "font-teko text-6xl text-slate-300 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }
                else { titleEl.innerText = "DÉFAITE"; titleEl.className = "font-teko text-6xl text-red-500 uppercase italic tracking-tighter drop-shadow-lg relative z-10"; }

                // 2. AFFICHER L'ADVERSAIRE (CORRECTION)
                const endOppName = document.getElementById('end-opp-name');
                if(endOppName) endOppName.innerText = this.match.opp.n; // Affiche "Sénégal" au lieu de "ADV"

                const endOppBadge = document.getElementById('end-opp-badge');
                if(endOppBadge) {
                    // Affiche "SEN" au lieu de "?"
                    endOppBadge.innerHTML = `<span class="font-teko text-3xl text-white font-bold italic">${this.match.opp.code}</span>`;
                }

                // 3. AFFICHER LES STATS DE FIN
                // Tirs
                const sh = this.match.stats.shots;
                const sa = this.match.stats.shotsAway;
                const endStatShots = document.getElementById('end-stat-shots');
                if(endStatShots) endStatShots.innerText = `${sh} - ${sa}`;
                
                const endBarShots = document.getElementById('end-bar-shots');
                if(endBarShots) {
                    const totalS = sh + sa || 1;
                    endBarShots.style.width = ((sh / totalS) * 100) + '%';
                }

                // Possession (Récupérée du dernier instant du match)
                const possTxt = document.getElementById('poss-val-home') ? document.getElementById('poss-val-home').innerText : "50%";
                const possVal = parseInt(possTxt);
                const endStatPoss = document.getElementById('end-stat-poss');
                if(endStatPoss) endStatPoss.innerText = `${possVal}% - ${100-possVal}%`;
                
                const endBarPoss = document.getElementById('end-bar-poss');
                if(endBarPoss) endBarPoss.style.width = possVal + '%';

                // Afficher le modal
                const em = document.getElementById('end-modal'); if(em) em.classList.remove('hidden');
                
                // --- GESTION FATIGUE & LE RESTE (Inchangé) ---
                const inst = this.state.instructions;
                this.state.players.forEach(p => { 
                    if(p.role==='starter') {
                        let drain = 15 - (this.state.infra.medical.level * 1.5);
                        if(inst.pressing === 'high') drain += 8;
                        if(inst.tempo === 'fast') drain += 6; 
                        if(inst.aggression === 'hard') drain += 5; 
                        p.energy = Math.max(5, (p.energy||100) - drain);
                    } else { 
                        p.energy = Math.min(100, (p.energy||0) + 20); 
                    }
                });
                
                // Budget & XP
                this.state.budget += isWin ? 2.0 : (isDraw ? 0.8 : 0.4);
                this.state.teamXP += isWin ? 30 : 10;

                this.updateStd(this.state.standings['Côte d\'Ivoire'], scoreHome, scoreAway);
                this.updateStd(this.state.standings[this.match.opp.n], scoreAway, scoreHome);
                
                this.simulateOthers(); 
                this.state.matchIndex++; 
                this.save();
                this.updateUI();
                this.generateReport(isWin, [scoreHome, scoreAway], this.match.opp.n);
            }
            generateReport(win, s, opp) {
                const analyses = ["Le plan de jeu a fonctionné.", "Match tendu.", "Le manager est aux anges.", "Les fans réclament du changement."];
                const res = win ? `Victoire héroïque ${s[0]}-${s[1]}` : `Résultat mitigé ${s[0]}-${s[1]}`;
                this.state.news.unshift({id: Date.now(), text: `PRESSE : ${res} contre ${opp}. ${analyses[Math.floor(Math.random()*4)]}`});
            }
            // --- GÉNÉRATEUR DE RUMEURS ET COMMENTAIRES ---
            generateAmbientNews() {
                // On mélange les 3 sources (Rumeurs, Fans, Experts)
                const categories = [NEWS_RUMORS, NEWS_FANS, NEWS_PUNDITS];
                const selectedCat = categories[Math.floor(Math.random() * categories.length)];
                
                // On pioche une phrase au hasard
                let text = selectedCat[Math.floor(Math.random() * selectedCat.length)];

                // Si la phrase contient {PLAYER}, on met un vrai nom de joueur
                if (text.includes("{PLAYER}")) {
                    // On cherche les titulaires pour que ce soit crédible
                    const starters = this.state.players.filter(p => p.role === 'starter');
                    const randomPlayer = starters.length > 0 
                        ? starters[Math.floor(Math.random() * starters.length)].name 
                        : "Le Capitaine";
                    
                    // On remplace {PLAYER} par le nom en orange
                    text = text.replace("{PLAYER}", `<b class="text-orange-400">${randomPlayer}</b>`);
                }

                // On ajoute la news en haut de la liste
                this.state.news.unshift({
                    id: Date.now() + Math.random(), 
                    text: text
                });
                
                // On garde seulement les 20 dernières pour ne pas ralentir le jeu
                if (this.state.news.length > 20) this.state.news.pop();
            }
            
            updateStd(s, gf, ga) { if(!s) return; s.p++; s.gf+=gf; s.ga+=ga; if(gf>ga){s.w++; s.pts+=3;} else if(gf===ga){s.d++; s.pts+=1;} else s.l++; }
            
            // Enregistre un but pour un joueur donné
           registerGoal(name, team) {
    // Sécurité : On s'assure que la liste existe et est propre
    if (!this.state.goalScorers || !Array.isArray(this.state.goalScorers)) {
        this.state.goalScorers = [];
    }
    
    // Sécurité : On nettoie les entrées null/invalides qui font planter le jeu
    this.state.goalScorers = this.state.goalScorers.filter(x => x && x.n && x.t);

    // Recherche du buteur
    let entry = this.state.goalScorers.find(x => x.n === name && x.t === team);
    
    if (entry) {
        entry.c++; 
    } else {
        this.state.goalScorers.push({ n: name, t: team, c: 1 });
    }
    }
            // Enregistre une note (ex: 7.5) pour un joueur
            registerRating(name, team, rating) {
                if (!this.state.playerRatings) this.state.playerRatings = [];
                
                let entry = this.state.playerRatings.find(x => x.n === name && x.t === team);
                if (entry) {
                    entry.total += rating;
                    entry.matchs++;
                } else {
                    this.state.playerRatings.push({ n: name, t: team, total: rating, matchs: 1 });
                }
            }

            // Trouve un buteur réaliste pour une nation donnée (IA)
            getScorerName(nationName) {
                const n = NATIONS_DB.find(x => x.n === nationName);
                if (!n) return "Inconnu";
                // Priorité : Liste des buteurs > Top Attaquant > Star
                if (n.scorers && n.scorers.length > 0) return n.scorers[Math.floor(Math.random() * n.scorers.length)];
                return n.topAtt || n.star;
            }
         simulateOthers() {
                // Sécurité : On ne simule que pendant la phase de groupes
                if (this.state.stage !== 'groups') return;

                const userGrp = this.state.standings['Côte d\'Ivoire'].grp;

                Object.keys(this.state.groups).forEach(g => {
                    const t = this.state.groups[g]; 

                    // CAS 1 : C'EST VOTRE GROUPE
                    // Il faut simuler le match entre les 2 équipes que vous n'avez PAS jouées
                    if (g === userGrp) {
                        // On prend les 4 équipes et on enlève :
                        // 1. La Côte d'Ivoire
                        // 2. L'adversaire que vous venez juste d'affronter (this.match.opp)
                        const others = t.filter(team => 
                            team.n !== 'Côte d\'Ivoire' && 
                            team.n !== this.match.opp.n
                        );
                        
                        // S'il reste bien 2 équipes, elles jouent l'une contre l'autre
                        if (others.length === 2) {
                            this.simM(others[0].n, others[1].n);
                        }
                    }
                    
                    // CAS 2 : LES AUTRES GROUPES (Rotation classique)
                    else {
                        // On regarde combien de matchs la 1ère équipe du groupe a joués
                        const played = this.state.standings[t[0].n].p;

                        if (played === 0) {
                            // Journée 1
                            this.simM(t[0].n, t[1].n);
                            this.simM(t[2].n, t[3].n);
                        } 
                        else if (played === 1) {
                            // Journée 2
                            this.simM(t[0].n, t[2].n);
                            this.simM(t[1].n, t[3].n);
                        } 
                        else if (played === 2) {
                            // Journée 3
                            this.simM(t[0].n, t[3].n);
                            this.simM(t[1].n, t[2].n);
                        }
                    }
                });
            }
           simM(t1, t2) {
                const s1 = this.state.standings[t1]; const s2 = this.state.standings[t2];
                const r = s1.ovr / s2.ovr; let g1 = 0, g2 = 0;
                for(let i=0; i<3; i++) { if(Math.random() < 0.28 * r) g1++; if(Math.random() < 0.28 * (1/r)) g2++; }
                
                this.updateStd(s1, g1, g2); this.updateStd(s2, g2, g1);
                this.state.globalResults.push(`${t1} ${g1}-${g2} ${t2}`);

                // --- GESTION BUTEURS & NOTES ---
                const processTeamSim = (teamName, goalsScored, isWinner, isDraw) => {
                    // 1. Note de base de l'équipe
                    let baseR = isWinner ? 7.2 : (isDraw ? 6.0 : 5.5);
                    
                    // 2. On récupère les joueurs clés de cette nation dans la DB
                    const natDB = NATIONS_DB.find(x => x.n === teamName);
                    if(natDB) {
                        // On note la Star (joue toujours bien)
                        this.registerRating(natDB.star, teamName, baseR + Math.random());
                        // On note un autre joueur clé au hasard
                        const keyP = [natDB.topAtt, natDB.topMid, natDB.topDef];
                        const randomP = keyP[Math.floor(Math.random()*keyP.length)];
                        this.registerRating(randomP, teamName, baseR + (Math.random() * 1.5 - 0.5));
                    }

                    // 3. On génère et note les buteurs
                    for(let k=0; k<goalsScored; k++) {
                        const scorer = this.getScorerName(teamName);
                        this.registerGoal(scorer, teamName);
                        // Un buteur a forcément une bonne note (> 7.5)
                        this.registerRating(scorer, teamName, 7.5 + Math.random() * 1.5);
                    }
                };

                const t1Win = g1 > g2; const draw = g1 === g2;
                processTeamSim(t1, g1, t1Win, draw);
                processTeamSim(t2, g2, !t1Win && !draw, draw);
            }

           closeEndModal() {
                const em = document.getElementById('end-modal'); if(em) em.classList.add('hidden');
                
                if (this.state.stage === 'groups' && this.state.matchIndex >= 3) { 
                    this.initKnockout(); 
                }
                else if (this.state.stage !== 'groups') {
                    // On vérifie si on a gagné (score ou pénaltys)
                    const win = this.match.penalties ? (this.match.penalties[0] > this.match.penalties[1]) : (this.match.score[0] > this.match.score[1]);
                    
                    if (!win) { 
                        // C'EST ICI QUE ÇA CHANGE :
                        // Si c'est la finale, le vainqueur EST l'adversaire (this.match.opp).
                        // Sinon (8e, quarts...), c'est null (le jeu simulera un vainqueur aléatoire).
                        const winner = (this.state.stage === 'finale') ? this.match.opp : null;
                        this.simulateRest(winner); 
                    }
                   else if (this.state.stage === 'finale') { 
                        // Cas où la CIV gagne la finale
                        this.state.trophies++; this.state.budget += 25.0; this.state.teamXP += 1500;
                        if(!this.state.pastWinners) this.state.pastWinners = [];
                        this.state.pastWinners.push({ year: this.state.year, n: "Côte d'Ivoire" });
                        
                        // MODIFICATION ICI : On dit explicitement que la CIV a gagné
                        this.awards("Côte d'Ivoire"); 
                        
                        this.startNextSeason(); 
                    } else { 
                        this.progressKnockout(); 
                    }
                }
                this.updateUI(); this.goToView('inbox');
            }


            initKnockout() {
                const q = []; const th = [];
                for(let g in this.state.groups) {
                    const s = this.state.groups[g].sort((a,b)=>this.state.standings[b.n].pts - this.state.standings[a.n].pts || (this.state.standings[b.n].gf - this.state.standings[b.n].ga) - (this.state.standings[a.n].gf - this.state.standings[a.n].ga));
                    q.push(s[0].n, s[1].n); th.push({n: s[2].n, pts: this.state.standings[s[2].n].pts});
                }
                const best3 = th.sort((a,b)=>b.pts-a.pts).slice(0, 4).map(x=>x.n);
                const all16 = [...q, ...best3];
                if (!all16.includes('Côte d\'Ivoire')) { this.simulateRest(); return; }
                this.state.stage = '8iemes'; this.state.matchIndex = 0;
                this.state.budget += 3.0; this.state.teamXP += 100;
                const oppN = all16.filter(n=>n!=='Côte d\'Ivoire')[Math.floor(Math.random()*(all16.length-1))];
                this.state.knockout['8iemes'] = this.state.standings[oppN];
                this.toast("QUALIFIÉ POUR LES 8ÈMES !");
            }

            progressKnockout() {
                const ph = ['groups', '8iemes', 'quarts', 'demis', 'finale'];
                this.state.stage = ph[ph.indexOf(this.state.stage) + 1];
                const bonusB = { quarts: 6.0, demis: 12.0, finale: 20.0 };
                const bonusX = { quarts: 300, demis: 600, finale: 1000 };
                this.state.budget += bonusB[this.state.stage] || 0;
                this.state.teamXP += bonusX[this.state.stage] || 0;
                const r = NATIONS_DB.filter(n=>n.n!=='Côte d\'Ivoire').sort(()=>Math.random()-0.5)[0];
                this.state.knockout[this.state.stage] = this.state.standings[r.n];
            }

            simulateRest(forcedWinner = null) {
                let winner;

                if (forcedWinner) {
                    winner = forcedWinner;
                } else {
                    const others = NATIONS_DB.filter(n => n.n !== "Côte d'Ivoire");
                    winner = others[Math.floor(Math.random() * others.length)];
                }
                
                this.state.news.unshift({id: Date.now(), text: `${SVGS.cup} CHAMPION : ${winner.n} remporte la CAN.`});
                
                if(!this.state.pastWinners) this.state.pastWinners = [];
                this.state.pastWinners.push({ year: this.state.year, n: winner.n });
                
                // MODIFICATION ICI : On passe le nom du vainqueur (winner.n) à awards()
                this.awards(winner.n); 
                
                this.startNextSeason();
            }

            awards(winnerName) {
                // On retrouve les infos de la nation gagnante dans la DB
                const nationData = NATIONS_DB.find(n => n.n === winnerName);
                if (!nationData) return;

                // 1. MVP : Le joueur avec la meilleure MOYENNE (et non plus la star prédéfinie)
                let mvpObj = { n: "Inconnu", t: "?", avg: 0 };
                
                if (this.state.playerRatings && this.state.playerRatings.length > 0) {
                    // On recalcule les moyennes et on trie
                    const sortedRatings = this.state.playerRatings
                        .map(p => ({ ...p, avg: p.total / p.matchs }))
                        .sort((a,b) => b.avg - a.avg);
                    
                    mvpObj = sortedRatings[0];
                }

                this.state.news.unshift({
                    id: Date.now() + 1, 
                    text: `${SVGS.medal} MVP : ${mvpObj.n} (${mvpObj.t}) est élu meilleur joueur du tournoi avec une note moyenne de ${mvpObj.avg.toFixed(2)} !`
                });

                // 2. Soulier d'Or : Le meilleur buteur
               let topScorerObj = { n: "Inconnu", t: "?", c: 0 };

                // On vérifie si on a des buteurs enregistrés
                if (this.state.goalScorers && this.state.goalScorers.length > 0) {
                    // On trie la liste du plus grand au plus petit nombre de buts
                    this.state.goalScorers.sort((a,b) => b.c - a.c);
                    // On prend le premier
                    topScorerObj = this.state.goalScorers[0];
                }
                
                this.state.news.unshift({
                    id: Date.now() + 2, 
                    text: `${SVGS.boot} Soulier d'Or : ${topScorerObj.n} (${topScorerObj.t}) termine en tête avec ${topScorerObj.c} réalisations.`
                });

                // 3. Gant d'Or : Le gardien du vainqueur
                let gkName = "";
                if (winnerName === "Côte d'Ivoire") {
                    const myGK = this.state.players.find(p => p.role === 'starter' && p.pos === 'GK');
                    gkName = myGK ? myGK.name : "Y. Fofana";
                } else {
                    // Pour l'IA, on formule génériquement car on ne stocke pas le nom du gardien IA fixe
                    gkName = `Le portier (${nationData.code})`;
                }

                this.state.news.unshift({
                    id: Date.now() + 3, 
                    text: `${SVGS.glove} Gant d'Or : ${gkName} remporte le trophée Yachine.`
                });
            }

            processRetirements() {
                const retired = [];
                this.state.players = this.state.players.filter(p => {
                    if (p.age > 30) {
                        const chance = (p.age - 30) * 0.15; 
                        if (Math.random() < chance) {
                            retired.push(p.name);
                            return false; 
                        }
                    }
                    return true; 
                });

                Object.keys(this.state.standings).forEach(nationName => {
                    const std = this.state.standings[nationName];
                    std.starAge++;
                    if (std.starAge >= 35) {
                        const oldStar = std.star;
                        std.star = this.generateRealName(); 
                        std.starAge = 18 + Math.floor(Math.random() * 5); 
                        std.ovr = Math.round(std.ovr * (0.95 + Math.random() * 0.1)); 
                        this.state.news.unshift({
                            id: Date.now() + Math.random(), 
                            text: `${SVGS.globe} REGEN : La légende ${oldStar} (${nationName}) prend sa retraite. ${std.star} est le nouveau prodige !`
                        });
                    }
                });

                if (retired.length > 0) {
                    this.state.news.unshift({
                        id: Date.now(), 
                        text: `${SVGS.hand} DÉPARTS : ${retired.join(', ')} pren${retired.length > 1 ? 'nent' : 'd'} une retraite bien méritée.`
                    });
                }

                while (this.state.players.length < 15) {
                    this.state.players.push({ 
                        id: crypto.randomUUID(), 
                        name: this.generateRealName(), 
                        pos: ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)], 
                        age: 18 + Math.floor(Math.random()*3), 
                        ovr: 68 + Math.floor(Math.random()*12), 
                        role: 'sub', energy: 100, slot: null
                    });
                }
            }

            startNextSeason() {
                 
                // --- PAIEMENT DES SALAIRES DU STAFF ---
                let totalSalaries = 0;
                if (this.state.staff) {
                    Object.values(this.state.staff).forEach(s => totalSalaries += s.salary);
                }
                
                this.state.budget -= totalSalaries;
                
                // Si le budget est négatif, on remet à 0 mais on avertit (ou Game Over si tu veux être méchant)
                if (this.state.budget < 0) {
                    this.state.budget = 0;
                    this.state.news.unshift({id: Date.now(), text: ` FAILLITE ÉVITÉE : La selection a dû être renfloué par l'État pour payer les salaires.`});
                } else {
                    this.state.news.unshift({id: Date.now(), text: ` FINANCES : ${totalSalaries.toFixed(1)}M€ versés pour les salaires du staff technique.`});
                }

                this.state.year += 2; this.state.seasonsPlayed++;
                this.state.matchIndex = 0; this.state.stage = 'groups'; this.state.rareScoutUsed = false;
                
                this.state.players.forEach(p => { 
                    p.energy = 100; 
                    p.age += 2; 

                    this.state.goalScorers = [];   // <--- AJOUT : Remise à zéro des buteurs
                    this.state.playerRatings = []; // <--- AJOUT : Remise à zéro des notes MVP
                    
                    // Calcul de l'évolution
                    let evolution = (p.age < 28 ? 3 : (p.age > 33 ? -3 : 0));
                    
                    // On applique l'évolution
                    p.ovr += evolution;
                    
                    // SÉCURITÉ : On borne la note entre 50 et 99
                    if (p.ovr > 99) p.ovr = 99;
                    if (p.ovr < 50) p.ovr = 50; // Pour éviter qu'ils ne deviennent trop nuls
                });
                
                this.processRetirements();
                const n = [...NATIONS_DB].sort(()=>Math.random()-0.5);
                this.state.groups = this.createGroups(n);
                const oldStd = this.state.standings;
                this.state.standings = this.initStd(n, this.state.groups);
                
                Object.keys(this.state.standings).forEach(k => {
                    if(oldStd[k]) {
                        this.state.standings[k].star = oldStd[k].star;
                        this.state.standings[k].starAge = oldStd[k].starAge;
                        this.state.standings[k].ovr = oldStd[k].ovr;
                    } else {
                        this.state.standings[k].starAge = 25;
                    }
                });

                this.state.globalResults = []; 
                this.updateUI(); 
                this.goToView('inbox');
                this.toast("Bienvenue en " + this.state.year + " !");
            }

            getTacticalAdvice(style) {
                // Logique du Staff : Quel plan de jeu adopter ?
                const strategies = {
                    'Offensif': "Ils se livrent beaucoup. Jouez en <b class='text-orange-400'>CONTRE</b> pour exploiter les espaces dans leur dos.",
                    'Tiki-Taka': "Ils confisquent le ballon. Un <b class='text-orange-400'>PRESSING HAUT</b> est nécessaire pour casser leur rythme.",
                    'Contre': "Méfiance. Ne perdez pas la balle haut. Gardez la <b class='text-orange-400'>POSSESSION</b> pour les frustrer.",
                    'Bloc Bas': "Mur défensif. Il faudra de la patience en <b class='text-orange-400'>POSSESSION</b> pour trouver une faille.",
                    'Vertical': "Jeu direct dangereux. Baissez le bloc ou coupez les lignes de passes.",
                    'Technique': "Gros bagage technique. Imposez un défi physique dans les duels.",
                    'Puissance': "Équipe très physique. Évitez les contacts, faites courir le ballon vite.",
                    'Vitesse': "Attaquants rapides ! Ne jouez pas le hors-jeu, restez prudents derrière.",
                    'Pressing': "Ils chassent en meute. Sautez les lignes avec un jeu plus direct.",
                    'Impact': "Gros impact athlétique. Répondez présent dans les duels au milieu.",
                    'Dribbles': "Individualistes. Ne vous jetez pas, défendez en zone intelligemment."
                };
                // Conseil par défaut si le style n'est pas listé
                return strategies[style] || "Adversaire imprévisible. Soyez solides et profitez des coups de pied arrêtés.";
            }

           renderInbox() {
                const dD = document.getElementById('dash-date'); if(dD) dD.innerText = this.state.year;
                const dS = document.getElementById('dash-stage'); if(dS) dS.innerText = this.state.stage.toUpperCase();
                
                const opp = this.getOpponent();
                if (opp) {
                    const nN = document.getElementById('next-opp-name'); if(nN) nN.innerText = opp.n;
                    const nB = document.getElementById('next-opp-badge'); if(nB) nB.innerText = opp.code;
                    
                    const oA = document.getElementById('opponent-analysis-box');
                    if(oA) {
                        // On récupère le conseil dynamique
                        const advice = this.getTacticalAdvice(opp.style);
                        
                        oA.innerHTML = `
                            <div class="p-3 bg-slate-800/40 rounded-xl text-center shadow-lg border border-white/5">
                                <span class="text-[8px] text-slate-500 uppercase font-bold block mb-1">Style Adverse</span>
                                <div class="text-white text-sm font-bold uppercase tracking-widest">${opp.style}</div>
                            </div>
                            <div class="p-3 bg-slate-800/40 rounded-xl text-center shadow-lg border border-white/5">
                                <span class="text-[8px] text-slate-500 uppercase font-bold block mb-1">Danger N°1</span>
                                <div class="text-orange-500 text-sm font-bold uppercase tracking-widest truncate">${opp.star}</div>
                            </div>
                            
                            <div class="col-span-2 p-3 bg-blue-900/10 rounded-xl border border-blue-500/20 flex items-start gap-3 relative overflow-hidden">
                                <div class="absolute -right-4 -top-4 opacity-5 grayscale scale-[3.0] rotate-12">
                                    ${SVGS.radar}
                                </div>
                                
                                <div class="mt-0.5 text-blue-400">
                                    ${SVGS.layout}
                                </div>
                                
                                <div class="relative z-10">
                                    <span class="text-[9px] text-blue-400 uppercase font-bold block mb-0.5">Note de l'Analyste</span>
                                    <div class="text-slate-300 text-[10px] leading-snug font-medium italic">
                                        "${advice}"
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Remplacez UNIQUEMENT le bloc "nBox" à la fin de renderInbox()
            const nBox = document.getElementById('news-feed'); 
                if(nBox) {
                nBox.innerHTML = '';
    
               this.state.news.slice(0, 15).forEach(n => { 
              // 1. Préparation des données (Catégorie / Message)
               let [category, ...msgParts] = n.text.split(':');
               let message = msgParts.join(':').trim();
               if(!message) { message = category; category = "INFO"; }
               category = category.trim().toUpperCase();

               // 2. Choix de l'icône (remplace la note OVR)
               let icon = SVGS.mega; 
              let iconColor = "text-white";
        
             if (["MERCATO", "TRANSFERT", "OFFICIEL"].some(k => category.includes(k))) { icon = SVGS.briefcase; iconColor = "text-green-400"; }
             else if (["BLESSURE", "CLASH", "COLÈRE"].some(k => category.includes(k))) { icon = SVGS.alert; iconColor = "text-red-400"; }
             else if (["VICTOIRE", "TITRE", "MVP"].some(k => category.includes(k))) { icon = SVGS.trophy; iconColor = "text-yellow-400"; }
             else if (["RUMEUR", "BUZZ"].some(k => category.includes(k))) { icon = SVGS.globe; iconColor = "text-blue-400"; }
 
        // 3. LE DESIGN EXACT DU SCOUT
        // On utilise la structure : Flex > Box Carrée (Gauche) > Textes (Droite)
        nBox.innerHTML += `
            <div class="glass-panel p-3 rounded-xl flex items-start gap-3 border border-white/5 hover:bg-slate-800 transition group mb-2">
                
                <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700 shrink-0 shadow-lg">
                    <span class="${iconColor}">${icon}</span>
                </div>
                
                <div class="flex-1 min-w-0 pt-0.5">
                    <div class="font-bold text-white uppercase text-xs mb-0.5 tracking-wide">
                        ${category}
                    </div>
                    
                    <div class="text-[10px] text-slate-400 font-medium leading-tight">
                        ${message}
                    </div>
                </div>

                </div>`;
           });
        }   
            }
            // --- AJOUTER CETTE FONCTION DANS LA CLASSE EliteManager ---
renderTacticalButtons(location) {
                // location = 'prematch' (vue tactique) ou 'live' (match en direct)
                const c = this.state.instructions;
                const bgActive = "bg-orange-600 text-white border-orange-500 shadow-lg";
                const bgInactive = "bg-slate-800 text-slate-500 border-slate-700";
                
                // Fonction helper pour le HTML d'un bouton
                // On ajoute 'instruction-btn' à la classe pour éviter les conflits CSS
                const btn = (key, val, label) => `
                    <button onclick="app.setInstruction('${key}', '${val}')" 
                    class="instruction-btn flex-1 py-2 rounded-lg border text-[9px] font-bold uppercase transition ${c[key] === val ? bgActive : bgInactive}">
                    ${label}
                    </button>`;

                return `
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Style Tactique</span>
                            <div class="flex gap-1">${btn('style', 'possession', 'Possession')}${btn('style', 'counter', 'Contre')}</div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Intensité Pressing</span>
                            <div class="flex gap-1">${btn('pressing', 'normal', 'Normal')}${btn('pressing', 'high', 'Haut')}</div>
                        </div>

                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Jeu de Passes</span>
                            <div class="flex gap-1">${btn('passing', 'short', 'Courtes')}${btn('passing', 'long', 'Longues')}</div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Impact Physique</span>
                            <div class="flex gap-1">${btn('aggression', 'safe', 'Prudent')}${btn('aggression', 'hard', 'Mordant')}</div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Utilisation Largeur</span>
                            <div class="flex gap-1">${btn('width', 'narrow', 'Axial')}${btn('width', 'wide', 'Large')}</div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-slate-500 uppercase ml-1">Rythme de jeu</span>
                            <div class="flex gap-1">${btn('tempo', 'slow', 'Posé')}${btn('tempo', 'fast', 'Effréné')}</div>
                        </div>
                    </div>
                `;
            }

// Fonction pour sauvegarder le changement (Remplace setTacticalInstruction)
setInstruction(key, val) {
    this.state.instructions[key] = val;
    this.renderTacticalUI(); // Met à jour l'avant-match
    this.updateMatchInstructionsUI(); // Met à jour le live
    
    // Feedback sonore et texte
    if(this.match.active) {
        this.addCommentary(`${SVGS.layout} Consigne changée : ${key.toUpperCase()} > ${val.toUpperCase()}`);
        this.toast("Consigne appliquée !");
    }
}

           renderInfra() {
                const list = document.getElementById('infra-list'); 
                if(!list) return;
                
                list.innerHTML = '';
                
                // --- SECTION 0 : MUSÉE NATIONAL (HÉRITAGE) ---
                // 1. Calcul des victoires : Les 3 historiques + celles gagnées dans ta partie
                const historicalYears = [1992, 2015, 2023];
                const gameWins = (this.state.pastWinners || [])
                    .filter(w => w.n === "Côte d'Ivoire")
                    .map(w => w.year);
                
                // On combine et on trie (du plus récent au plus ancien)
                const allYears = [...gameWins, ...historicalYears].sort((a,b) => b-a);
                const totalWins = allYears.length;

                list.innerHTML += `<div class="mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Héritage & Gloire</span><div class="h-px bg-slate-700 flex-1"></div></div>`;

                list.innerHTML += `
                    <div class="infra-card relative overflow-hidden bg-slate-900 border border-orange-500/40 mb-8 shadow-[0_0_30px_rgba(249,115,22,0.15)]">
                        <div class="absolute -right-8 -bottom-8 text-orange-500 opacity-10 scale-[2.5] rotate-12 pointer-events-none">
                            ${SVGS.cup}
                        </div>

                        <div class="flex items-center gap-5 relative z-10">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-800 flex items-center justify-center text-white shadow-2xl border-2 border-white/10 shrink-0">
                                ${SVGS.museum}
                            </div>
                            
                            <div class="flex-1">
                                <h3 class="font-teko text-3xl text-white uppercase italic leading-none">Musée National</h3>
                                <p class="text-[10px] text-orange-200 font-bold uppercase tracking-widest mb-1">Le Palmarès des Éléphants</p>
                                <div class="text-[9px] text-slate-400 leading-tight pr-4">
                                    La nation a régné sur l'Afrique à <span class="text-white font-bold">${totalWins} reprises</span>.
                                </div>
                            </div>
                            
                            <div class="text-right shrink-0">
                                <div class="font-teko text-7xl text-white drop-shadow-[0_0_15px_rgba(249,115,22,0.6)] leading-none">${totalWins}</div>
                                <div class="text-[8px] text-orange-500 font-bold uppercase tracking-widest text-center mt-[-5px]">Titres</div>
                            </div>
                        </div>

                        <div class="mt-5 pt-4 border-t border-white/10 flex flex-wrap gap-2 relative z-10">
                            ${allYears.map(y => `
                                <span class="px-3 py-1 bg-slate-950 border border-orange-500/30 rounded-lg text-[10px] font-bold text-orange-400 shadow-sm flex items-center gap-1">
                                    ${SVGS.star} ${y}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // --- SECTION 1 : INFRASTRUCTURES (BÂTIMENTS) ---
                list.innerHTML += `<div class="mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Bâtiments</span><div class="h-px bg-slate-700 flex-1"></div></div>`;
                
                const infras = [
                    { id: 'stadium', name: 'Stade National', desc: 'Bonus revenus match (+0.5M/niv.)', icon: SVGS.infraStadium },
                    { id: 'training', name: 'Centre Pro', desc: 'Améliore le gain OVR Boost (+1/niv.)', icon: SVGS.infraTraining },
                    { id: 'medical', name: 'Clinique Sportive', desc: 'Réduit la fatigue après match (-1.5/niv.)', icon: SVGS.infraMedical }
                ];

                infras.forEach(inf => {
                    const data = this.state.infra[inf.id];
                    list.innerHTML += this.createUpgradeCard(inf.id, inf.name, data, inf.desc, inf.icon, 'infra');
                });

                // --- SECTION 2 : STAFF TECHNIQUE (SALAIRES) ---
                list.innerHTML += `<div class="mt-8 mb-4 flex items-center gap-2"><div class="h-px bg-slate-700 flex-1"></div><span class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Staff & Salaires</span><div class="h-px bg-slate-700 flex-1"></div></div>`;

                const staffs = [
                    { id: 'director', icon: SVGS.briefcase },
                    { id: 'assistant', icon: SVGS.whistle },
                    { id: 'fitness', icon: SVGS.heartpulse }
                ];

                staffs.forEach(st => {
                    const data = this.state.staff[st.id];
                    const upgradeCost = data.level * 2.5; 
                    
                    // CORRECTION ICI : Tout le bleu a été remplacé par de l'orange
                    list.innerHTML += `
                        <div class="infra-card group relative overflow-hidden transition-all duration-300 hover:bg-slate-800/80 border-l-4 border-l-orange-500">
                            <div class="flex justify-between items-start z-10 relative">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-orange-500 shadow-xl">
                                        ${st.icon}
                                    </div>
                                    <div>
                                        <div class="text-white font-bold uppercase text-xs tracking-wider font-teko text-xl leading-none">${data.name}</div>
                                        <div class="text-[9px] text-orange-500 uppercase font-bold mt-1">Niveau ${data.level} / 5</div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <div class="text-[9px] text-slate-400 uppercase font-bold mb-0.5">Salaire / An</div>
                                    <div class="text-white font-teko text-xl font-bold bg-slate-900 px-3 py-0.5 rounded-lg border border-red-500/30 text-red-400">
                                        -${data.salary.toFixed(1)} M€
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-[9px] text-slate-400 leading-tight my-4 italic pl-1 border-l-2 border-slate-700">
                                ${data.desc}
                            </p>
                            
                            <button onclick="app.upgradeStaff('${st.id}')" 
                                class="w-full py-3 bg-slate-900 border border-slate-700 hover:bg-orange-600 hover:border-orange-500 hover:text-white rounded-xl text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2 ${data.level >= 5 ? 'opacity-40 pointer-events-none grayscale' : ''}">
                                ${data.level >= 5 ? 'Niveau Max' : `Promouvoir (Coût: ${upgradeCost.toFixed(1)} M€)`}
                            </button>
                        </div>
                    `;
                });
            }

            // Helper pour éviter la duplication de code pour les infras
            createUpgradeCard(id, name, data, desc, icon, type) {
                return `
                    <div class="infra-card group relative overflow-hidden transition-all duration-300 hover:bg-slate-800/80">
                        <div class="flex justify-between items-start z-10 relative">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-slate-900 border border-slate-700 flex items-center justify-center text-orange-500 shadow-xl group-hover:scale-110 transition-all duration-300">
                                    ${icon}
                                </div>
                                <div>
                                    <div class="text-white font-bold uppercase text-xs tracking-wider font-teko text-xl leading-none">${name}</div>
                                    <div class="text-[9px] text-slate-500 uppercase font-bold mt-1">Niveau ${data.level} / 5</div>
                                </div>
                            </div>
                            <div class="text-white font-teko text-xl font-bold bg-slate-900 px-3 py-1 rounded-lg border border-slate-700 shadow-inner text-orange-500">
                                ${data.cost.toFixed(1)} M€
                            </div>
                        </div>
                        <div class="mt-4 mb-2 h-1.5 w-full bg-slate-950 rounded-full overflow-hidden border border-slate-800/50">
                            <div class="h-full bg-gradient-to-r from-orange-700 to-orange-500" style="width: ${(data.level/5)*100}%"></div>
                        </div>
                        <p class="text-[9px] text-slate-400 leading-tight mb-4 italic pl-1 border-l-2 border-slate-700">${desc}</p>
                        <button onclick="app.upgradeInfra('${id}')" class="w-full py-3 bg-slate-900 border border-slate-700 hover:bg-orange-600 hover:border-orange-500 hover:text-white rounded-xl text-[10px] font-bold uppercase transition-all shadow-lg active:scale-95 ${data.level >= 5 ? 'opacity-40 pointer-events-none grayscale' : ''}">
                            ${data.level >= 5 ? 'Max' : 'Améliorer'}
                        </button>
                    </div>`;
            }

            upgradeInfra(id) {
                const infra = this.state.infra[id];
                if (this.state.budget < infra.cost) return this.toast("Budget insuffisant !");
                if (infra.level >= 5) return this.toast("Niveau maximum atteint.");
                
                this.state.budget -= infra.cost;
                infra.level++;
                infra.cost *= 1.8;
                
                this.save(); // Sauvegarde immédiate
                this.renderInfra();
                this.updateUI(); // Met à jour le HUD
                this.toast(`${id.toUpperCase()} amélioré au niveau ${infra.level} !`);
            }

            upgradeStaff(id) {
                const s = this.state.staff[id];
                const cost = s.level * 2.5; // Le coût de promotion augmente
                
                if (this.state.budget < cost) return this.toast("Budget insuffisant pour la promotion !");
                if (s.level >= 5) return this.toast("Niveau maximum atteint.");
                
                this.state.budget -= cost;
                s.level++;
                s.salary += 1.5; // Le salaire augmente de 1.5M par niveau ! C'est le piège :)
                
                this.save();
                this.renderInfra();
                this.updateUI();
                this.toast(`${s.name} promu ! Salaire augmenté.`);
            }


       renderCalendar() {
                const c = document.getElementById('calendar-content'); 
                if(!c) return;

                let html = `
                    // --- COPIEZ CE BLOC ---
    <div class="mb-8 relative z-10 bg-carbon-foot -mx-5 -mt-5 p-6 rounded-b-3xl shadow-2xl border-b border-white/5">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-orange-500/10 rounded-full blur-3xl pointer-events-none"></div>
        <h2 class="font-teko text-6xl text-white uppercase italic leading-none mb-1 drop-shadow-md">Compétition</h2>
        <div class="flex items-center justify-between border-b border-white/5 pb-2">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Coupe d'Afrique des Nations 2026</p>
            <div class="px-3 py-1 rounded-full bg-orange-600/20 border border-orange-500/30 text-orange-400 text-[9px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(249,115,22,0.2)]">
                ${this.state.stage === 'groups' ? 'Phase de Poules' : this.state.stage.toUpperCase().replace('IEMES', 'èmes')}
            </div>
        </div>
    </div>
                `;

                // --- CAS 1 : PHASE DE POULES (DESIGN MODERNISÉ) ---
                if (this.state.stage === 'groups') {
                    // Onglets des groupes (Pills scrollables)
                    html += `<div class="mb-4 overflow-x-auto no-scrollbar pb-2"><div id="group-tabs" class="flex gap-2"></div></div>`;
                    
                    // Tableau de Classement (Glassmorphism)
                    html += `
                        <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 shadow-2xl relative mb-8">
                            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-900/80 border-b border-white/5 text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                                <div class="col-span-1 text-center">#</div>
                                <div class="col-span-6">Nation</div>
                                <div class="col-span-2 text-center">J</div>
                                <div class="col-span-1 text-center">Df</div>
                                <div class="col-span-2 text-center text-orange-500">Pts</div>
                            </div>
                            <div id="cal-body" class="divide-y divide-white/5"></div>
                        </div>
                    `;
                }
                // --- CAS 2 : PHASES FINALES (CARTE DUEL) ---
                else {
                    const stageConfigs = { 
                        '8iemes': { label: 'Huitièmes de Finale', sub: 'Le chemin vers la gloire' }, 
                        'quarts': { label: 'Quarts de Finale', sub: 'Le top 8 africain' }, 
                        'demis': { label: 'Demi-Finale', sub: 'La porte de la finale' }, 
                        'finale': { label: 'GRANDE FINALE', sub: 'L\'Histoire s\'écrit ici' } 
                    };
                    
                    const config = stageConfigs[this.state.stage] || { label: 'Phase Finale', sub: 'Match décisif' };
                    const oppData = this.state.knockout[this.state.stage];
                    const oppName = oppData ? oppData.n : "Adversaire";
                    const oppCode = oppData ? oppData.code : "ADV";

                    // Carte du Match Principal
                    html += `
                        <div class="relative w-full rounded-3xl overflow-hidden border border-white/10 shadow-2xl mb-8 group">
                            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                            <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-black"></div>
                            
                            <div class="relative z-10 p-6 flex flex-col items-center">
                                <div class="text-[10px] text-orange-500 font-bold uppercase tracking-[0.2em] mb-4 border border-orange-500/30 px-3 py-1 rounded-full bg-orange-500/10">
                                    ${config.label}
                                </div>

                                <div class="flex items-center justify-between w-full mb-6">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-800 shadow-[0_0_20px_rgba(249,115,22,0.4)] italic">
                                            CIV
                                        </div>
                                        <span class="text-[10px] font-bold text-white uppercase tracking-widest">Côte d'Ivoire</span>
                                    </div>

                                    <div class="flex flex-col items-center">
                                        <span class="font-teko text-7xl text-white italic opacity-10 absolute select-none scale-150">VS</span>
                                        <span class="font-teko text-5xl text-white italic relative z-10 drop-shadow-lg">VS</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center text-white font-teko font-bold text-4xl border-4 border-slate-700 shadow-xl italic">
                                            ${oppCode}
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${oppName}</span>
                                    </div>
                                </div>

                                <div class="w-full bg-slate-950/50 rounded-xl p-3 text-center border border-white/5">
                                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Lieu du match</p>
                                    <p class="text-xs text-white font-bold uppercase">Stade Olympique Alassane Ouattara</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-8">
                            <div class="flex items-center gap-2 mb-3 px-1">
                                <span class="text-slate-500">${SVGS.layout}</span>
                                <h3 class="font-teko text-2xl text-slate-200 uppercase tracking-wide">Ailleurs sur le continent</h3>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                    `;
                    
                    // Générateur de matchs fictifs stylisés
                    const otherTeams = NATIONS_DB.filter(n => n.n !== "Côte d'Ivoire" && n.n !== oppName);
                    const matchCount = this.state.stage === '8iemes' ? 7 : (this.state.stage === 'quarts' ? 3 : (this.state.stage === 'demis' ? 1 : 0));

                    for(let i = 0; i < matchCount; i++) {
                        if(otherTeams.length >= 2) {
                            const t1 = otherTeams.splice(Math.floor(Math.random() * otherTeams.length), 1)[0];
                            const t2 = otherTeams.splice(Math.floor(Math.random() * otherTeams.length), 1)[0];
                            html += `
                                <div class="flex justify-between items-center bg-slate-800/40 p-3 rounded-xl border border-white/5 hover:bg-slate-800 transition group">
                                    <div class="flex items-center gap-3 w-5/12 justify-end">
                                        <span class="text-[10px] font-bold text-slate-400 uppercase text-right truncate group-hover:text-white transition">${t1.n}</span>
                                        <span class="text-[9px] font-bold text-slate-600 w-8 text-center bg-slate-900 rounded py-0.5 border border-slate-800">${t1.code}</span>
                                    </div>
                                    <div class="w-2/12 text-center font-teko text-lg text-slate-600">VS</div>
                                    <div class="flex items-center gap-3 w-5/12">
                                        <span class="text-[9px] font-bold text-slate-600 w-8 text-center bg-slate-900 rounded py-0.5 border border-slate-800">${t2.code}</span>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase truncate group-hover:text-white transition">${t2.n}</span>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    html += `</div></div>`;
                }

                // --- SECTION STATS (BUTEURS & MVP) ---
                const topScorers = (this.state.goalScorers || []).sort((a,b) => b.c - a.c).slice(0, 5);
                const topPlayers = (this.state.playerRatings || []).filter(p => p.matchs >= 1).map(p => ({ ...p, avg: p.total / p.matchs })).sort((a,b) => b.avg - a.avg).slice(0, 5);

                html += `
                    <div class="grid grid-cols-1 gap-4 mb-8">
                        <div class="glass-panel p-4 rounded-2xl border border-white/5">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <div class="p-1.5 bg-yellow-500/20 rounded-lg text-yellow-500">${SVGS.boot}</div>
                                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Soulier d'Or</h3>
                            </div>
                            <div class="space-y-2">
                                ${topScorers.length === 0 ? '<div class="text-xs text-slate-500 italic text-center py-2">Aucune donnée</div>' : ''}
                                ${topScorers.map((p, i) => `
                                    <div class="flex items-center justify-between p-2 rounded-lg ${i===0 ? 'bg-gradient-to-r from-yellow-900/20 to-transparent border border-yellow-500/20' : 'bg-slate-800/30'}">
                                        <div class="flex items-center gap-3">
                                            <span class="font-teko text-xl w-6 text-center ${i===0?'text-yellow-400':'text-slate-600'}">#${i+1}</span>
                                            <div class="flex flex-col">
                                                <span class="text-[10px] font-bold text-white uppercase leading-none">${p.n}</span>
                                                <span class="text-[8px] font-bold text-slate-500 uppercase">${p.t}</span>
                                            </div>
                                        </div>
                                        <span class="font-teko text-xl font-bold ${i===0?'text-yellow-400':'text-slate-400'}">${p.c}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="glass-panel p-4 rounded-2xl border border-white/5">
                            <div class="flex items-center gap-2 mb-4 border-b border-white/5 pb-2">
                                <div class="p-1.5 bg-blue-500/20 rounded-lg text-blue-400">${SVGS.star}</div>
                                <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Course au MVP</h3>
                            </div>
                            <div class="space-y-2">
                                ${topPlayers.length === 0 ? '<div class="text-xs text-slate-500 italic text-center py-2">Aucune donnée</div>' : ''}
                                ${topPlayers.map((p, i) => `
                                    <div class="flex items-center justify-between p-2 rounded-lg ${i===0 ? 'bg-gradient-to-r from-blue-900/20 to-transparent border border-blue-500/20' : 'bg-slate-800/30'}">
                                        <div class="flex items-center gap-3">
                                            <span class="font-teko text-xl w-6 text-center ${i===0?'text-blue-400':'text-slate-600'}">#${i+1}</span>
                                            <div class="flex flex-col">
                                                <span class="text-[10px] font-bold text-white uppercase leading-none">${p.n}</span>
                                                <span class="text-[8px] font-bold text-slate-500 uppercase">${p.t}</span>
                                            </div>
                                        </div>
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${i===0?'bg-blue-500 text-white':'bg-slate-700 text-slate-400'}">${p.avg.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // --- PALMARES (Timeline) ---
                const history = this.state.pastWinners || [];
                if(history.length > 0) {
                    html += `
                        <div class="mb-20">
                            <h3 class="font-teko text-3xl text-white uppercase italic mb-4 px-1">Hall of Fame</h3>
                            <div class="space-y-2">
                                ${history.slice().reverse().map(h => `
                                    <div class="flex items-center justify-between p-3 rounded-xl border ${h.n==="Côte d'Ivoire" ? 'bg-orange-900/20 border-orange-500/40' : 'bg-slate-900 border-slate-800'}">
                                        <div class="flex items-center gap-3">
                                            <span class="text-orange-500">${SVGS.cup}</span>
                                            <span class="text-[10px] font-bold uppercase ${h.n==="Côte d'Ivoire"?'text-white':'text-slate-400'}">${h.n}</span>
                                        </div>
                                        <span class="font-teko text-xl text-white">${h.year}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    html += `<div class="mb-20"></div>`;
                }

                c.innerHTML = html;

                // --- INTERACTIVITÉ DES ONGLETS (POULES) ---
                if (this.state.stage === 'groups') {
                    const tabsContainer = document.getElementById('group-tabs');
                    const tbody = document.getElementById('cal-body');
                    
                    if (tabsContainer && tbody) {
                        // Génération des boutons
                        Object.keys(this.state.groups).forEach(g => {
                            const isActive = this.state.viewingGroup === g;
                            tabsContainer.innerHTML += `
                                <button onclick="app.setVG('${g}')" 
                                    class="px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition shrink-0 border ${isActive ? 'bg-orange-600 border-orange-500 text-white shadow-lg' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}">
                                    Groupe ${g}
                                </button>
                            `;
                        });

                        // Génération des lignes du tableau
                        const currentGroupTeams = Object.keys(this.state.standings)
                            .filter(k => this.state.standings[k].grp === this.state.viewingGroup)
                            .sort((a,b) => {
                                const tA = this.state.standings[a];
                                const tB = this.state.standings[b];
                                return (tB.pts - tA.pts) || ((tB.gf - tB.ga) - (tA.gf - tA.ga)) || (tB.gf - tA.gf);
                            });

                        currentGroupTeams.forEach((teamName, index) => {
                            const t = this.state.standings[teamName];
                            const diff = t.gf - t.ga;
                            const isQualified = index < 2; // Les 2 premiers
                            
                            // Style ligne
                            const rowClass = isQualified ? "bg-gradient-to-r from-green-900/10 to-transparent" : "";
                            const rankColor = isQualified ? "text-green-400" : "text-slate-600";
                            const barColor = isQualified ? "bg-green-500" : "bg-slate-700";

                            tbody.innerHTML += `
                                <div class="grid grid-cols-12 gap-2 p-3 items-center hover:bg-white/5 transition ${rowClass}">
                                    <div class="col-span-1 flex justify-center">
                                        <span class="font-teko text-lg ${rankColor} w-5 text-center">${index+1}</span>
                                    </div>
                                    <div class="col-span-6 flex flex-col justify-center">
                                        <span class="text-[10px] font-bold text-white uppercase truncate">${t.n}</span>
                                        <span class="text-[8px] font-bold text-slate-500">${t.code}</span>
                                    </div>
                                    <div class="col-span-2 text-center text-[10px] font-mono text-slate-400">${t.p}</div>
                                    <div class="col-span-1 text-center text-[10px] font-bold ${diff>0?'text-green-400':(diff<0?'text-red-400':'text-slate-500')}">${diff>0?'+':''}${diff}</div>
                                    <div class="col-span-2 text-center">
                                        <span class="font-teko text-xl font-bold text-white">${t.pts}</span>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
            }
            setVG(g) { this.state.viewingGroup = g; this.renderCalendar(); }

            renderTraining() {
                const c = document.getElementById('training-content'); if(!c) return;
                
                // 1. En-tête
                let html = `
                    <div class="mb-6">
                        <h3 class="font-teko text-4xl text-white uppercase italic leading-none mb-1">Centre d'Entraînement</h3>
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Développez le potentiel de vos éléphants.</p>
                    </div>
                    
                    <div class="space-y-2 pb-20">
                `;
                
                // 3. Boucle des joueurs
                // Tri : Titulaires d'abord, puis par Note OVR
                const sortedPlayers = this.state.players.sort((a,b) => (a.role === 'starter' ? -1 : 1) || b.ovr - a.ovr);
                
                sortedPlayers.forEach(p => {
                    // Badge Position (Style neutre/scout)
                    const badgeClass = "bg-slate-800 border-slate-600 text-slate-400 border";
                    
                    // Couleur Energie
                    const enColor = p.energy > 80 ? "text-green-400" : (p.energy > 50 ? "text-orange-400" : "text-red-400");

                    html += `
                        <div class="glass-panel p-3 rounded-xl flex items-center justify-between border border-white/5 hover:bg-slate-800 transition group">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700">
                                    <span class="font-teko text-xl text-white font-bold">${p.ovr}</span>
                                </div>
                                
                                <div>
                                    <div class="font-bold text-white uppercase text-xs mb-0.5">${p.name}</div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${badgeClass}">${p.pos}</span>
                                        <span class="text-[9px] text-slate-500 uppercase font-bold">${p.age} ans • <span class="${enColor}">${p.energy}%</span></span>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="app.boost('${p.id}')" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-[9px] font-bold uppercase shadow-md active:scale-95 transition tracking-widest flex items-center gap-1">
                                <span id="icon-zap-mini"></span> Booster
                            </button>
                        </div>`;
                });
                
                html += `</div>`; // Fermeture du conteneur
                c.innerHTML = html;
            }
           boost(id) { 
                if(this.state.budget < 0.2) return this.toast("Manque de budget !"); 
                
                const p = this.state.players.find(x => x.id === id);
                
                // VÉRIFICATION : Si déjà à 99, on ne paie pas et on arrête
                if (p.ovr >= 99) return this.toast("Potentiel maximum atteint (99) !");

                this.state.budget -= 0.2; 
                
                // Calcul du gain
                const gain = 1 + this.state.infra.training.level;
                
                // APPLICATION DU PLAFOND (Math.min prend le plus petit des deux)
                p.ovr = Math.min(99, p.ovr + gain); 
                
                this.renderTraining(); 
                this.save(); 
                this.updateUI(); 
                this.toast(`${p.name} progresse (+${gain}) !`); 
            }

          renderScout() {
                const c = document.getElementById('scout-content'); if(!c) return;
                
                c.innerHTML = `
                    <div class="space-y-4 mb-8">
                        <div class="glass-panel p-5 rounded-3xl text-center bg-green-900/10 shadow-2xl border border-white/5 relative overflow-hidden group hover:border-green-500/30 transition-all">
                            <div class="absolute top-0 right-0 p-4 opacity-5 grayscale group-hover:opacity-10 transition">${SVGS.globe}</div>
                            <h3 class="text-2xl font-bold uppercase mb-1 font-teko text-green-500">Ligue 1 Ivoirienne</h3>
                            <p class="text-[9px] text-slate-400 mb-4 font-bold uppercase tracking-widest">Dénicher les pépites locales.</p>
                            <button onclick="app.scoutPlayers('standard')" class="w-full py-4 bg-orange-600 hover:bg-orange-500 text-white rounded-xl font-bold uppercase shadow-lg transition active:scale-95 text-[11px] tracking-wide flex items-center justify-center gap-2">
                                Financer Détection (3.0 M€)
                            </button>
                        </div>

                        <div class="glass-panel p-5 rounded-3xl text-center bg-blue-900/10 shadow-2xl border border-white/5 relative overflow-hidden group hover:border-blue-500/30 transition-all">
                            <div class="absolute top-0 right-0 p-4 opacity-5 grayscale group-hover:opacity-10 transition">${SVGS.plane || SVGS.globe}</div>
                            <h3 class="text-2xl font-bold uppercase mb-1 font-teko text-blue-400">Diaspora Europe</h3>
                            <p class="text-[9px] text-slate-400 mb-4 font-bold uppercase tracking-widest">Convaincre les binationaux.</p>
                            <button onclick="app.scoutPlayers('elite')" id="btn-scout-elite" class="w-full py-4 ${this.state.rareScoutUsed ? 'bg-slate-800 text-slate-600 cursor-not-allowed border border-slate-700' : 'bg-orange-600 hover:bg-orange-500 text-white'} rounded-xl font-bold uppercase shadow-lg transition active:scale-95 text-[11px] tracking-wide flex items-center justify-center gap-2" ${this.state.rareScoutUsed ? 'disabled' : ''}>
                                ${this.state.rareScoutUsed ? 'MISSION DÉJÀ EFFECTUÉE' : 'LANCER LA MISSION (10.0 M€)'}
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3 px-1 border-b border-white/5 pb-2">
                         <span class="text-orange-500">${SVGS.search}</span>
                         <h3 class="font-teko text-2xl text-white uppercase tracking-wide">Joueurs Supervisés</h3>
                    </div>
                    
                    <div id="scout-list" class="space-y-2 pb-20"></div>
                `;

                const l = document.getElementById('scout-list');
                
                if (this.state.scoutPool.length === 0) {
                    l.innerHTML = `<div class="text-center text-slate-600 italic text-xs py-10">Aucun rapport de scout disponible.<br>Lancez une mission ci-dessus.</div>`;
                }

                this.state.scoutPool.forEach(p => { 
                    const origin = p.ovr >= 79 ? "Binational" : "Local";
                    // On garde juste une petite puce de couleur pour l'info, mais le bouton reste Orange
                    const badgeColor = p.ovr >= 79 ? "text-blue-400 border-blue-500/30 bg-blue-500/10" : "text-green-400 border-green-500/30 bg-green-500/10";

                    l.innerHTML += `
                        <div class="glass-panel p-3 rounded-xl flex items-center justify-between border border-white/5 hover:bg-slate-800 transition group">
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col items-center justify-center w-10 h-10 rounded-lg bg-slate-900 border border-slate-700">
                                    <span class="font-teko text-xl text-white font-bold">${p.ovr}</span>
                                </div>
                                <div>
                                    <div class="font-bold text-white uppercase text-xs mb-0.5">${p.name}</div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded ${badgeColor} border">${p.pos}</span>
                                        <span class="text-[9px] text-slate-500 uppercase">${p.age} ans • ${origin}</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="app.recruit('${p.id}')" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-[9px] font-bold uppercase shadow-md active:scale-95 transition tracking-widest flex items-center gap-1">
                                <span class="hidden group-hover:inline transition-all">+</span> Convoquer
                            </button>
                        </div>`; 
                });
            }
           scoutPlayers(type) {
                // 1. Calcul du coût de la mission
                let baseCost = type === 'elite' ? 10.0 : 3.0;
                
                // Bonus Directeur : -10% par niveau
                const directorLevel = this.state.staff ? this.state.staff.director.level : 1;
                const discount = (directorLevel - 1) * 0.10; 
                const finalCost = baseCost * (1 - discount);

                if (this.state.budget < finalCost) return this.toast(`Frais de mission insuffisants (${finalCost.toFixed(1)}M€ requis) !`);
                
                this.state.budget -= finalCost;
                
                if (type === 'elite') { 
                    this.state.rareScoutUsed = true; 
                    // On génère un joueur fort (Binational) - OVR entre 79 et 86
                    this.state.scoutPool.push({ 
                        id: crypto.randomUUID(), 
                        name: this.generateRealName(), 
                        pos: ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)], 
                        age: 18 + Math.floor(Math.random()*4), // 18-22 ans
                        ovr: 79 + Math.floor(Math.random()*8), 
                        role: 'sub', energy: 100 
                    }); 
                } else { 
                    // On génère des locaux - OVR entre 60 et 78
                    for(let i=0; i<5; i++) { 
                        this.state.scoutPool.push({ 
                            id: crypto.randomUUID(), 
                            name: this.generateRealName(), 
                            pos: ["GK","DEF","MID","FWD"][Math.floor(Math.random()*4)], 
                            age: 17 + Math.floor(Math.random()*8), // 17-25 ans
                            ovr: 60 + Math.floor(Math.random()*19), 
                            role: 'sub', energy: 100 
                        }); 
                    } 
                }
                
                this.save();
                this.renderScout(); 
                this.updateUI(); 
                this.toast(`Mission de détection lancée (-${finalCost.toFixed(1)} M€)`);
            }

            recruit(id) { 
                const idx = this.state.scoutPool.findIndex(x => x.id === id); 
                if (idx > -1) { 
                    const p = this.state.scoutPool[idx];
                    
                    // On retire le joueur de la liste des scouts
                    this.state.scoutPool.splice(idx, 1)[0];
                    
                    // On l'ajoute à l'équipe nationale
                    this.state.players.push(p); 
                    
                    this.renderScout(); 
                    this.save(); 
                    this.playSound('click');
                    
                    // Flash Info Roleplay
                    this.state.news.unshift({
                        id: Date.now(), 
                        text: `SÉLECTION : ${p.name} (${p.ovr}) a accepté de rejoindre les Éléphants !`
                    });

                    this.toast(`${p.name} a rejoint la sélection !`); 
                } 
            }

            toggleLiveCoaching() { 
                this.isLiveCoaching = !this.isLiveCoaching; 
                const overlay = document.getElementById('live-coach-overlay');
                if(overlay) overlay.classList.toggle('active', this.isLiveCoaching); 
                
                if(this.isLiveCoaching) {
                    // On met à jour l'affichage de la formation actuelle
                    this.setLiveFormation(this.state.formation);
                    // On dessine le terrain
                    this.renderPitch('pitch-cards-layer-live'); 
                    // --- NOUVEAU : On affiche les 6 consignes (2 anciennes + 4 nouvelles) ---
        const c = document.getElementById('live-tactics-container');
        if(c) c.innerHTML = this.renderTacticalButtons('live');
                }
            }
            
       openSwapModal(idx) {
        this.currentSwapSlot = idx; 
        const form = FORMATIONS[this.state.formation];
        const targetPos = form.zones[idx]; 
        
        const titlePos = document.getElementById('swap-target-pos');
        if(titlePos) titlePos.innerText = `Remplacer : ${targetPos}`;

        const list = document.getElementById('swap-candidates-list'); 
        if(!list) return;
        
        // GRILLE : 2 colonnes pour bien voir les cartes
        list.className = "p-4 flex-1 overflow-y-auto no-scrollbar grid grid-cols-2 gap-3 content-start";
        list.innerHTML = '';
        
        const candidates = this.state.players.filter(p => p.role !== 'starter')
            .sort((a,b) => (b.pos === targetPos) - (a.pos === targetPos) || b.ovr - a.ovr);

        candidates.forEach(p => {
            const isGoodPos = p.pos === targetPos;
            
            // COULEURS DYNAMIQUES (Le coeur de votre demande)
            // Si bonne position : Bordure selon l'ÉNERGIE (Vert/Orange/Rouge)
            // Si mauvaise position : Grisé
            let borderColor = "border-slate-700";
            let textColor = "text-slate-500";
            let bgGradient = "bg-slate-900";
            let energyBarColor = "bg-slate-600";

            if (isGoodPos) {
                if (p.energy > 80) {
                    borderColor = "border-green-500 shadow-[0_0_10px_rgba(34,197,94,0.2)]";
                    textColor = "text-green-400";
                    energyBarColor = "bg-green-500";
                    bgGradient = "bg-gradient-to-br from-green-900/20 to-slate-900";
                } else if (p.energy > 50) {
                    borderColor = "border-orange-500";
                    textColor = "text-orange-400";
                    energyBarColor = "bg-orange-500";
                    bgGradient = "bg-gradient-to-br from-orange-900/20 to-slate-900";
                } else {
                    borderColor = "border-red-500";
                    textColor = "text-red-400";
                    energyBarColor = "bg-red-500";
                    bgGradient = "bg-gradient-to-br from-red-900/20 to-slate-900";
                }
            } else {
                // Joueur hors poste : style éteint
                borderColor = "border-white/5 opacity-60";
            }

            const el = document.createElement('div');
            
            // On garde la forme rectangulaire horizontale "Carte Compacte"
            el.className = `relative h-[60px] rounded-lg border ${borderColor} ${bgGradient} flex items-center p-2 cursor-pointer transition active:scale-95 hover:bg-slate-800`;
            
            el.onclick = () => { this.confirmSwap(p.id); };
            
            el.innerHTML = `
                <div class="flex flex-col items-center justify-center w-10 border-r border-white/5 pr-2 mr-2">
                    <span class="font-teko text-2xl ${isGoodPos ? textColor : 'text-slate-600'} font-bold leading-none">${p.ovr}</span>
                    <span class="text-[8px] text-slate-500 font-bold uppercase">${p.pos}</span>
                </div>
                
                <div class="flex flex-col justify-center flex-1 min-w-0">
                    <span class="text-[10px] font-bold ${isGoodPos ? 'text-white' : 'text-slate-500'} uppercase truncate">${p.name.split(' ').pop()}</span>
                    
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-full h-1 bg-slate-950 rounded-full overflow-hidden">
                            <div class="h-full ${energyBarColor}" style="width: ${p.energy}%"></div>
                        </div>
                        <span class="text-[8px] ${textColor} font-bold">${p.energy}%</span>
                    </div>
                </div>
                
                ${isGoodPos ? `<div class="absolute top-1 right-1 w-1.5 h-1.5 rounded-full ${energyBarColor}"></div>` : ''}
            `;
            
            list.appendChild(el);
        });
        
        const modal = document.getElementById('swap-modal'); 
        if(modal) modal.classList.remove('hidden');
    }
            
            confirmSwap(id) {
                const old = this.state.players.find(x => x.role === 'starter' && x.slot === this.currentSwapSlot);
                const nw = this.state.players.find(x => x.id === id);
                if (old) { old.role = 'sub'; old.slot = null; } 
                if (nw) { nw.role = 'starter'; nw.slot = this.currentSwapSlot; }
                this.closeSwapModal(); 
                this.renderPitch(this.isLiveCoaching ? 'pitch-cards-layer-live' : 'pitch-cards-layer');
                this.save();
            }
            
            closeSwapModal() { const m = document.getElementById('swap-modal'); if(m) m.classList.add('hidden'); }
            
            toast(m) { 
                const t = document.getElementById('feedback-toast'); 
                const msg = document.getElementById('toast-msg'); 
                if(!t || !msg) return;
                msg.innerText = m;
                t.classList.remove('hidden');
                void t.offsetWidth;
                t.classList.remove('opacity-0', 'translate-y-4');
                t.classList.add('opacity-100', 'translate-y-0');
                if(this.toastTimeout) clearTimeout(this.toastTimeout);
                this.toastTimeout = setTimeout(() => {
                    t.classList.remove('opacity-100', 'translate-y-0');
                    t.classList.add('opacity-0', 'translate-y-4');
                    setTimeout(() => { t.classList.add('hidden'); }, 500);
                }, 2500);
            }
            
            autoPick() {
                this.state.players.forEach(p => { p.role = 'sub'; p.slot = null; });
                const form = FORMATIONS[this.state.formation];
                const pool = [...this.state.players];
                for(let i=0; i<form.zones.length; i++) {
                    const targetPos = form.zones[i];
                    pool.sort((a, b) => {
                        const scoreA = (a.ovr * 0.8) + (a.energy * 0.2);
                        const scoreB = (b.ovr * 0.8) + (b.energy * 0.2);
                        const bonusPosA = (a.pos === targetPos) ? 1000 : 0;
                        const bonusPosB = (b.pos === targetPos) ? 1000 : 0;
                        return (scoreB + bonusPosB) - (scoreA + bonusPosA);
                    });
                    const bestPlayer = pool.shift();
                    if(bestPlayer) { bestPlayer.role = 'starter'; bestPlayer.slot = i; }
                }
                this.renderPitch('pitch-cards-layer');
                this.toast("Équipe optimisée !");
            }
            
            setFormation(f) { this.state.formation = f; this.autoPick(); }
           setMatchTactic(t) { 
                this.match.tactic = t; 
                document.querySelectorAll('#view-match .grid button').forEach(b => b.classList.replace('bg-slate-700', 'bg-slate-800')); 
                const target = document.getElementById('tac-'+t); 
                if(target) target.classList.replace('bg-slate-800', 'bg-slate-700'); 
                
                // Affiche le commentaire lié à l'action
                this.addCommentary(COMMS_TACTICAL[t]);
            }

            // --- NOUVELLE MÉTHODE : ATTRIBUTION AUTO DES RÔLES ---
            autoAssignRoles() {
                const starters = this.state.players.filter(p => p.role === 'starter');
                if (starters.length === 0) return;

                // 1. Capitaine : Le plus âgé ou le plus fort mentalement
                const bestCap = [...starters].sort((a,b) => (b.age * 0.7 + b.ovr * 0.3) - (a.age * 0.7 + a.ovr * 0.3))[0];
                this.state.roles.captain = bestCap ? bestCap.id : null;

                // 2. Pénalty : Le meilleur Attaquant avec le plus gros OVR
                const bestPen = [...starters].sort((a,b) => b.ovr - a.ovr)[0];
                this.state.roles.penalty = bestPen ? bestPen.id : null;

                // 3. Coup Franc : Souvent un Milieu ou Attaquant technique
                const bestFK = [...starters].filter(p => p.pos !== 'GK').sort((a,b) => b.ovr - a.ovr)[0];
                this.state.roles.freekick = bestFK ? bestFK.id : null;
                
                // 4. Corner : Idem
                this.state.roles.corner = bestFK ? bestFK.id : null;
            }

           // Ajoutez une variable pour stocker le timer du but
// (Vous pouvez l'ajouter dans le constructor ou l'utiliser directement ici via this.goalTimer)

showGoalAnim(n) { 
    const sc = document.getElementById('goal-scorer-name'); 
    const go = document.getElementById('goal-overlay'); 
    
    if(!go || !sc) return;

    // 1. Annuler le timer précédent s'il existe (CORRECTION DU BUG)
    if (this.goalTimeout) clearTimeout(this.goalTimeout);

    // 2. Mise à jour texte
    sc.innerText = n; 
    
    // 3. Affichage (Reset des classes pour relancer l'animation si besoin)
    go.classList.remove('hidden'); 
    go.classList.remove('active'); 
    void go.offsetWidth; // Force le reflow CSS pour redéclencher l'anim si besoin
    go.classList.add('active'); 
    
    // 4. Masquage après 3.5s
    this.goalTimeout = setTimeout(() => {
        go.classList.remove('active');
        setTimeout(() => go.classList.add('hidden'), 300); 
    }, 3500); 
    }
            addCommentary(t) { 
                const log = document.getElementById('commentary-log'); 
                if(log) {
                    // Récupère le nom du manager, ou met "Coach" par défaut
                    const mName = this.state.managerName || "Le Coach";
                    // Remplace la balise {MANAGER} par le vrai nom en couleur
                    const finalTxt = t.replace(/{MANAGER}/g, `<span class="text-orange-400 font-bold">${mName}</span>`);
                    
                    log.insertAdjacentHTML('afterbegin', `<div class="mb-2 p-3 rounded-xl bg-white/5 border border-white/5 animate-news"><span class="opacity-30 text-[9px] mr-2 font-mono italic">${this.match.time}'</span> ${finalTxt}</div>`); 
                }
            }
            resetGame() { if (confirm("RAZ TOTAL ?")) { localStorage.clear(); location.reload(); } }
            
            setTacticalInstruction(type, val) { this.state.instructions[type] = val; this.renderTacticalUI(); }
            renderTacticalUI() {
                // On cible le conteneur dans la vue "Équipe / Tactique"
                // Ce sélecteur correspond à la div où se trouvent les boutons
                const container = document.querySelector('#view-squad .grid.grid-cols-2.gap-3.mt-2');
                if(container) {
                    // On vide l'ancien contenu et on met les nouveaux boutons à jour
                    container.innerHTML = this.renderTacticalButtons('prematch');
                }
            }
            toggleMatchInstruction(t) {
                if(t==='style') this.state.instructions.style = this.state.instructions.style==='possession'?'counter':'possession';
                if(t==='pressing') this.state.instructions.pressing = this.state.instructions.pressing==='normal'?'high':'normal';
                this.updateMatchInstructionsUI();
            }
            updateMatchInstructionsUI() {
                // On cible le conteneur dans l'overlay "Live Coaching"
                const container = document.getElementById('live-tactics-container');
                if(container) {
                    container.innerHTML = this.renderTacticalButtons('live');
                }
            }
            // --- GESTION FORMATION LIVE ---
            setLiveFormation(fmt) {
                // 1. Mise à jour de la donnée
                this.state.formation = fmt;
                
                // 2. Mise à jour visuelle des boutons (Active/Inactive)
                document.querySelectorAll('.live-fmt-btn').forEach(btn => {
                    if (btn.dataset.fmt === fmt) {
                        btn.classList.remove('bg-slate-800', 'border-slate-700', 'text-slate-400');
                        btn.classList.add('bg-orange-600', 'border-orange-500', 'text-white', 'shadow-lg');
                    } else {
                        btn.classList.add('bg-slate-800', 'border-slate-700', 'text-slate-400');
                        btn.classList.remove('bg-orange-600', 'border-orange-500', 'text-white', 'shadow-lg');
                    }
                });

                // 3. Re-dessiner le terrain immédiatement
                this.renderPitch('pitch-cards-layer-live');
                
                // 4. Ajouter un commentaire
                this.addCommentary(`${SVGS.layout} Changement tactique : L'équipe passe en <b class="text-white">${fmt}</b>.`);
                
                this.toast(`Dispositif changé en ${fmt}`);
            }
        // --- MOTEUR SONORE ELECTRONIQUE (A COLLER A LA FIN DE LA CLASSE) ---

    playSound(type) {
        if (!this.audioCtx) return;
        if (this.audioCtx.state === 'suspended') this.audioCtx.resume();

        switch (type) {
            case 'click': this.synthClick(); break;
            case 'whistle': this.synthWhistle(); break;
            case 'goal': this.synthGoal(); break;
            case 'stadium': this.synthAmbience(); break;
        }
    }

    synthClick() {
        const t = this.audioCtx.currentTime;
        const o = this.audioCtx.createOscillator();
        const g = this.audioCtx.createGain();
        o.connect(g); g.connect(this.audioCtx.destination);
        o.type = 'sine'; 
        o.frequency.setValueAtTime(800, t);
        o.frequency.exponentialRampToValueAtTime(300, t + 0.1);
        g.gain.setValueAtTime(0.1, t);
        g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
        o.start(); o.stop(t + 0.1);
    }

    synthWhistle() {
        const t = this.audioCtx.currentTime;
        const o = this.audioCtx.createOscillator();
        const g = this.audioCtx.createGain();
        o.connect(g); g.connect(this.audioCtx.destination);
        o.type = 'triangle';
        o.frequency.setValueAtTime(2500, t);
        
        // 3 coups de sifflet rapides
        [0, 0.15, 0.3].forEach(d => {
            g.gain.setValueAtTime(0.15, t + d);
            g.gain.linearRampToValueAtTime(0, t + d + 0.1);
        });
        o.start(); o.stop(t + 0.5);
    }

    synthGoal() {
        const dur = 2.5;
        const buf = this.audioCtx.createBuffer(1, this.audioCtx.sampleRate * dur, this.audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;

        const noise = this.audioCtx.createBufferSource();
        noise.buffer = buf;
        const f = this.audioCtx.createBiquadFilter();
        f.type = 'lowpass'; f.frequency.value = 500;
        const g = this.audioCtx.createGain();
        
        noise.connect(f); f.connect(g); g.connect(this.audioCtx.destination);
        
        f.frequency.linearRampToValueAtTime(1500, this.audioCtx.currentTime + 1); // Le cri monte
        g.gain.setValueAtTime(0, this.audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0.3, this.audioCtx.currentTime + 0.5);
        g.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + dur);
        
        noise.start();
    }

    synthAmbience() {
        if (this.ambianceNode) return; // Déjà en cours
        const size = this.audioCtx.sampleRate * 2;
        const buf = this.audioCtx.createBuffer(1, size, this.audioCtx.sampleRate);
        const data = buf.getChannelData(0);
        for (let i = 0; i < size; i++) data[i] = (Math.random() * 2 - 1) * 0.5;

        this.ambianceNode = this.audioCtx.createBufferSource();
        this.ambianceNode.buffer = buf;
        this.ambianceNode.loop = true;
        
        const f = this.audioCtx.createBiquadFilter();
        f.type = 'lowpass'; f.frequency.value = 250; // Grondement sourd
        const g = this.audioCtx.createGain();
        g.gain.value = 0.05; // Volume bas
        
        this.ambianceNode.connect(f); f.connect(g); g.connect(this.audioCtx.destination);
        this.ambianceNode.start();
    }

    stopAmbience() {
        if (this.ambianceNode) {
            try { this.ambianceNode.stop(); } catch(e){}
            this.ambianceNode = null;
        }
    }
    
    startMenuMusic() {
        return;
    }

    // IL MANQUAIT CETTE FONCTION !
    stopMenuMusic() {
        return;
    }
    // 2. Amélioration de l'ambiance de match (Foule dynamique)
    synthCrowdDynamic() {
        if (this.crowdNode) return;

        // Création du bruit rose (plus naturel pour une foule que le bruit blanc)
        const bufferSize = this.audioCtx.sampleRate * 10; // Boucle de 10 sec
        const buffer = this.audioCtx.createBuffer(2, bufferSize, this.audioCtx.sampleRate); // Stéréo !

        for (let channel = 0; channel < 2; channel++) {
            const data = buffer.getChannelData(channel);
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                // Formule simple pour convertir blanc -> rose
                data[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = data[i];
                data[i] *= 3.5; 
            }
        }

        this.crowdNode = this.audioCtx.createBufferSource();
        this.crowdNode.buffer = buffer;
        this.crowdNode.loop = true;

        // Filtre pour étouffer le son (comme si on était dans le stade)
        this.crowdFilter = this.audioCtx.createBiquadFilter();
        this.crowdFilter.type = 'lowpass';
        this.crowdFilter.frequency.value = 600; // Son sourd de base

        this.crowdGain = this.audioCtx.createGain();
        this.crowdGain.gain.value = 0.08; // Volume de base

        this.crowdNode.connect(this.crowdFilter);
        this.crowdFilter.connect(this.crowdGain);
        this.crowdGain.connect(this.audioCtx.destination);

        this.crowdNode.start();
        
        // Simulation des vagues de foule (LFO maison)
        this.crowdInterval = setInterval(() => {
            if(!this.crowdGain) return;
            // Le volume monte et descend doucement
            const time = this.audioCtx.currentTime;
            const fluctuation = Math.random() * 0.05;
            this.crowdGain.gain.setTargetAtTime(0.08 + fluctuation, time, 1.5);
            // Le filtre s'ouvre quand ça crie plus fort
            this.crowdFilter.frequency.setTargetAtTime(600 + (fluctuation * 4000), time, 1.5);
        }, 2000);
    }

    stopCrowd() {
        if (this.crowdNode) {
            try { this.crowdNode.stop(); } catch(e){}
            this.crowdNode = null;
        }
        if (this.crowdInterval) {
            clearInterval(this.crowdInterval);
            this.crowdInterval = null;
        }
    }
        }

        window.onload = () => { window.app = new EliteManager(); };
    </script>
   <script>
    // Ecouteur global pour les clics
    document.addEventListener('click', (e) => {
        // Active le son au premier clic (obligatoire sur Chrome)
        if (window.app && window.app.audioCtx && window.app.audioCtx.state === 'suspended') {
            window.app.audioCtx.resume().then(() => {
                // Si on n'est pas en match, on lance la musique du menu !
                if (!window.app.match.active) {
                    window.app.startMenuMusic();
                }
            });
        }

        // Si on clique sur un bouton ou un élément de nav
        if (window.app && (e.target.closest('button') || e.target.closest('.btn-nav') || e.target.closest('.player-card'))) {
             window.app.playSound('click');
        }
    });
</script>
</body>

</html>
